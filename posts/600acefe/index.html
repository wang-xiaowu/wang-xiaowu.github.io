<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>elasticsearch聚合使用方式 | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="数据聚合聚合（aggregations) 可以让我们极其方便的实现对数据的统计、分析、运算。例如：  什么品牌的手机最受欢迎？ 这些手机的平均价格、最高价格、最低价格？ 这些手机每月的销售情况如何？  实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。 聚合分类   名称 作用 对比Mysql    分桶类型 (Bucket) 满足特定条件的文档的集合 类似"><meta property="og:type" content="article"><meta property="og:title" content="elasticsearch聚合使用方式"><meta property="og:url" content="https://xiaowu95.wang/posts/600acefe/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="数据聚合聚合（aggregations) 可以让我们极其方便的实现对数据的统计、分析、运算。例如：  什么品牌的手机最受欢迎？ 这些手机的平均价格、最高价格、最低价格？ 这些手机每月的销售情况如何？  实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。 聚合分类   名称 作用 对比Mysql    分桶类型 (Bucket) 满足特定条件的文档的集合 类似"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo17.jpg"><meta property="article:published_time" content="2021-10-20T16:00:00.000Z"><meta property="article:modified_time" content="2023-08-29T01:58:16.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="elasticsearch"><meta property="article:tag" content="elastic stack"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo17.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/600acefe/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.2.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{input_placeholder:"搜索文章",hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"elasticsearch聚合使用方式",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo17.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">elasticsearch聚合使用方式</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">elasticsearch聚合使用方式<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/elasticsearch/elasticseaarch聚合使用方式.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-20T16:00:00.000Z" title="发表于 2021-10-21 00:00:00">2021-10-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-29T01:58:16.000Z" title="更新于 2023-08-29 09:58:16">2023-08-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/elasticsearch/">elasticsearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2023-08-29 09:58:16&quot;}" hidden></div><h1 id="数据聚合"><a href="#数据聚合" class="headerlink" title="数据聚合"></a>数据聚合</h1><p><strong><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">聚合（aggregations)</a></strong> 可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p><ul><li>什么品牌的手机最受欢迎？</li><li>这些手机的平均价格、最高价格、最低价格？</li><li>这些手机每月的销售情况如何？</li></ul><p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p><h1 id="聚合分类"><a href="#聚合分类" class="headerlink" title="聚合分类"></a>聚合分类</h1><table><thead><tr><th>名称</th><th>作用</th><th>对比Mysql</th></tr></thead><tbody><tr><td>分桶类型 (<code>Bucket</code>)</td><td>满足特定条件的文档的集合</td><td>类似<code>GROUP BY</code>语法</td></tr><tr><td>指标分析类型(<code>Metric</code>)</td><td>计算最大值，最小值，平均值等</td><td>类似 <code>COUNT</code> 、 <code>SUM()</code> 、 <code>MAX()</code> 等统计方法</td></tr><tr><td>管道分析类型(<code>Pipeline</code>)</td><td>对聚合结果进行二次分析</td><td></td></tr><tr><td>矩阵分析类型(<code>Matrix</code>)</td><td>支持对多个字段的操作并提供一个结果矩阵</td><td></td></tr></tbody></table><h2 id="Bucket聚合分析"><a href="#Bucket聚合分析" class="headerlink" title="Bucket聚合分析"></a>Bucket聚合分析</h2><p>按照<code>Bucket</code>的分桶策略，常见的<code>Bucket</code>聚合分析如下:</p><table><thead><tr><th>策略</th><th>描述</th></tr></thead><tbody><tr><td><code>Terms</code></td><td>最简单策略，如果是<code>text</code>类型，则按照分词后的结果分桶</td></tr><tr><td><code>Range</code></td><td>按照指定数值的范围来设定分桶规则</td></tr><tr><td><code>Date Range</code></td><td>通过指定日期的范围来设定分桶规则</td></tr><tr><td><code>Histogram</code></td><td>直方图，以固定间隔的策略来分割数据</td></tr><tr><td><code>Date Histogram</code></td><td>针对日期的直方图或者柱状图，是时序数据分析中常用的聚合分析类型</td></tr></tbody></table><h3 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a><code>Terms</code></h3><p>最简单策略，如果是<code>text</code>类型，则按照分词后的结果分桶</p><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="comment">//hits返回的数量,默认20条</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;可自定义分组名&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;指定字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="comment">// 查询的数量</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329105632388.png" title="img"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据名称分组</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;my_name_group&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;terms&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;field&quot;: &quot;name&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 3</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a><code>Range</code></h3><p>按照指定数值的范围来设定分桶规则</p><h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="comment">//hits返回的数量,默认20条</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;可自定义分组名&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// 大于等于</span></span><br><span class="line">            <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="number">20</span> <span class="comment">// 小于</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> <span class="comment">// 大于等于</span></span><br><span class="line">            <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="number">30</span> <span class="comment">// 小于</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          ...</span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329112557566.png" title="image-20210329112557566"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#统计年龄分布在 20 &lt;= x &lt; 30 的人数</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string"> &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">   &quot;age_range&quot;: &#123;</span></span><br><span class="line"><span class="string">     &quot;range&quot;: &#123;</span></span><br><span class="line"><span class="string">       &quot;field&quot;: &quot;age&quot;,</span></span><br><span class="line"><span class="string">       &quot;ranges&quot;: [</span></span><br><span class="line"><span class="string">         &#123;</span></span><br><span class="line"><span class="string">           &quot;from&quot;: 10,</span></span><br><span class="line"><span class="string">           &quot;to&quot;: 20</span></span><br><span class="line"><span class="string">         &#125;,</span></span><br><span class="line"><span class="string">         &#123;</span></span><br><span class="line"><span class="string">           &quot;from&quot;: 20,</span></span><br><span class="line"><span class="string">           &quot;to&quot;: 30</span></span><br><span class="line"><span class="string">         &#125;,</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">           &quot;from&quot;: 30,</span></span><br><span class="line"><span class="string">           &quot;to&quot;: 40</span></span><br><span class="line"><span class="string">         &#125;</span></span><br><span class="line"><span class="string">       ]</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Date-Range"><a href="#Date-Range" class="headerlink" title="Date Range"></a><code>Date Range</code></h3><p>通过指定日期的范围来设定分桶规则</p><h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="comment">//hits返回的数量,默认20条</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;可自定义分组名&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;begin&quot;</span><span class="punctuation">,</span> <span class="comment">//格式为:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">            <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;end&quot;</span> <span class="comment">// 格式为:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now-10d/d&quot;</span><span class="punctuation">,</span> <span class="comment">//当前时间减去10天，格式为:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">            <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now&quot;</span> <span class="comment">// 当前时间,格式为:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329155524048.png" title="image-20210329155524048"><h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a><code>Histogram</code></h3><p>直方图，以固定间隔的策略来分割数据</p><h4 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">//hits返回的数量,默认20条</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;NAME&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// 步长</span></span><br><span class="line">        <span class="attr">&quot;extended_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span><span class="comment">// 最小值 x &gt;= 10 </span></span><br><span class="line">          <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">40</span> <span class="comment">// 最大值 x &lt;= 40</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 0, </span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;NAME&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;histogram&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;field&quot;: &quot;age&quot;,</span></span><br><span class="line"><span class="string">        &quot;interval&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;extended_bounds&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;min&quot;: 10,</span></span><br><span class="line"><span class="string">          &quot;max&quot;: 40</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Date-Histogram"><a href="#Date-Histogram" class="headerlink" title="Date Histogram"></a><code>Date Histogram</code></h3><p>针对日期的直方图或者柱状图，是时序数据分析中常用的聚合分析类型</p><h4 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;NAME&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;day&quot;</span><span class="punctuation">,</span><span class="comment">// 维度</span></span><br><span class="line">        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd&quot;</span><span class="punctuation">,</span><span class="comment">//格式化日期</span></span><br><span class="line">        <span class="attr">&quot;extended_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最小值&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最大值&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>interval的值有: year、month、week、day、hour、minute</p></blockquote><h4 id="使用-4"><a href="#使用-4" class="headerlink" title="使用"></a>使用</h4><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329121336596.png" title="image-20210329121336596"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用日期直方图(date_histogram),统计记录</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 0, </span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;NAME&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;date_histogram&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;field&quot;: &quot;create&quot;,</span></span><br><span class="line"><span class="string">        &quot;interval&quot;: &quot;day&quot;,</span></span><br><span class="line"><span class="string">        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span></span><br><span class="line"><span class="string">        &quot;extended_bounds&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;min&quot;: &quot;2021-03-24&quot;,</span></span><br><span class="line"><span class="string">          &quot;max&quot;: &quot;2021-03-29&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Metric指标分析"><a href="#Metric指标分析" class="headerlink" title="Metric指标分析"></a><code>Metric</code>指标分析</h2><p>计算最大值，最小值，平均值等,类似 <code>COUNT</code> 、 <code>SUM()</code> 、 <code>MAX()</code> 等统计方法。</p><h3 id="单值分析"><a href="#单值分析" class="headerlink" title="单值分析"></a>单值分析</h3><h4 id="最大和最小"><a href="#最大和最小" class="headerlink" title="最大和最小"></a>最大和最小</h4><ul><li><code>max</code>：返回数值类字段的最大值</li><li><code>min</code>: 返回数值类字段的最小值</li></ul><p><strong>语法</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;自定义分组名&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;max/min&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;字段&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>使用</strong></p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329143704000.png" title="image-20210329143704000"><h4 id="平均值、求和"><a href="#平均值、求和" class="headerlink" title="平均值、求和"></a>平均值、求和</h4><ul><li><code>avg</code>: 返回数值类字段的平均值</li><li><code>sum</code>： 返回数值类字段的总和</li></ul><p><strong>使用</strong></p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329144354121.png" title="image-20210329144354121"><h4 id="去重"><a href="#去重" class="headerlink" title="去重"></a>去重</h4><p><code>cardinality</code>: 是指不同数值的个数，类似<code>SQL</code>中的<code>distinct count</code>概念</p><p><strong>使用</strong></p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329155715617.png" title="image-20210329155715617"><h3 id="多值分析"><a href="#多值分析" class="headerlink" title="多值分析"></a>多值分析</h3><h4 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a><code>Stats</code></h4><p>返回一系列数值类型的统计值，包含<code>min，max，avg，sum和count</code>,被分析的字段只能是数字类型</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329160255494.png" title="image-20210329160255494"><h4 id="Extended-Stats"><a href="#Extended-Stats" class="headerlink" title="Extended Stats"></a><code>Extended Stats</code></h4><blockquote><p>对<code>stats</code>的扩展，包含了更多的统计数据，如方差，标准差等</p><p>多值度量聚合计算从汇总文档中提取的数值的统计数据。这些值可以从文档中的特定数值字段中提取，也可以由提供的脚本生成。</p><p>扩展统计聚合是统计聚合（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/search-aggregations-metrics-stats-aggregation.html"><code>stats</code></a> aggregation）的扩展版本，其中额外添加如<code>sum_of_squares</code>, <code>variance</code>, <code>std_deviation</code> and <code>std_deviation_bounds。</code></p></blockquote><p>假设数据由学生的考试成绩（0到100）组成：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;grade&quot;</span> </span><br><span class="line">            <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>上述聚合计算所有文档的分数统计信息。聚合类型为extended_stats，设置文档的数字字段为需要统计的字段为grade，执行上面的语句将返回如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">...</span><br><span class="line"><span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;grade_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">72</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">99</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="number">86</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span> <span class="number">774</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;sum_of_squares&quot;</span><span class="punctuation">:</span> <span class="number">67028</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;variance&quot;</span><span class="punctuation">:</span> <span class="number">51.55555555555556</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;std_deviation&quot;</span><span class="punctuation">:</span> <span class="number">7.180219742846005</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;std_deviation_bounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;upper&quot;</span><span class="punctuation">:</span> <span class="number">100.36043948569201</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lower&quot;</span><span class="punctuation">:</span> <span class="number">71.63956051430799</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>聚合的名称（上面语句中的grades_stats）作为key，通过该key可以从返回的结果中检索出聚集的结果。</p><h5 id="Standard-Deviation-Bounds"><a href="#Standard-Deviation-Bounds" class="headerlink" title="Standard Deviation Bounds"></a>Standard Deviation Bounds</h5><p>默认情况下，扩展统计度量将返回一个对象称为std_deviation_bounds，它提供了平均值加&#x2F;减两个标准差的区间。这可以成为一个用来方式来可视化数据的方差。如果你想要一个不同的边界，例如三个标准偏差，你可以在请求中设置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;grade&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sigma&quot;</span> <span class="punctuation">:</span> <span class="number">3</span>  # <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>控制应显示多少标准偏差+&#x2F;-平均值。</p></blockquote><p>sigma可以是任何非负double类型数字，这意味着你可以要求非整数值，如1.5。值为0也是有效的，但只会返回上下限的平均值。</p><p>提示：默认情况下显示标准偏差和其边界，但它们并不总是适用于所有的数据集。您的数据必须是正常分布的度量才有意义。标准偏差背后的统计数据假设为正常分布的数据，因此如果数据偏斜向左或向右，返回的值将是误导性的。</p><h5 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h5><p>使用下面的脚本计算成绩的统计信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">...<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;script&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;inline&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc[&#x27;grade&#x27;].value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lang&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span></span><br><span class="line">             <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>用下面的语法来使用脚本文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">...<span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;script&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_script&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;grade&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>提示：可以使用id参数代替file参数来使用index的脚本。</p></blockquote><h5 id="Value-Script"><a href="#Value-Script" class="headerlink" title="Value Script"></a>Value Script</h5><p>当考试的难度是高于学生的水平，需要校正学生的成绩，我们可以使用value script获得新的统计：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;grade&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;script&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;lang&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;painless&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;inline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_value * params.correction&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;params&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;correction&quot;</span> <span class="punctuation">:</span> <span class="number">1.2</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="Missing-Value"><a href="#Missing-Value" class="headerlink" title="Missing Value"></a>Missing Value</h5><p>missing参数定义了如何处理缺少值的文档。 默认情况下如果没有指定的字段，这种文档将被忽略，但也可以认为它们具有指定的值：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;grades_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;extended_stats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;grade&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;missing&quot;</span><span class="punctuation">:</span> <span class="number">0</span>  # <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>文档中如果没有grade这个字段，则认为该字段的值是0</p></blockquote><h4 id="top-hits"><a href="#top-hits" class="headerlink" title="top_hits"></a><code>top_hits</code></h4><p>一般用于分桶后获取桶内最匹配的顶部文档列表，即详情数据</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329162148693.png" title="image-20210329162148693"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据年龄分组，并倒序</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;size&quot;:0,</span></span><br><span class="line"><span class="string">    &quot;aggs&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;teterms_demo&quot;:&#123;</span></span><br><span class="line"><span class="string">            &quot;terms&quot;:&#123;</span></span><br><span class="line"><span class="string">                &quot;field&quot;:&quot;age&quot;,</span></span><br><span class="line"><span class="string">                &quot;size&quot;:10</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;aggs&quot;:&#123;</span></span><br><span class="line"><span class="string">                &quot;top_hits_demo&quot;:&#123;</span></span><br><span class="line"><span class="string">                    &quot;top_hits&quot;:&#123;</span></span><br><span class="line"><span class="string">                        &quot;size&quot;:10,</span></span><br><span class="line"><span class="string">                        &quot;sort&quot;:[</span></span><br><span class="line"><span class="string">                            &#123;</span></span><br><span class="line"><span class="string">                                &quot;age&quot;:&#123;</span></span><br><span class="line"><span class="string">                                    &quot;order&quot;:&quot;desc&quot;</span></span><br><span class="line"><span class="string">                                &#125;</span></span><br><span class="line"><span class="string">                            &#125;</span></span><br><span class="line"><span class="string">                        ]</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="聚合附加条件"><a href="#聚合附加条件" class="headerlink" title="聚合附加条件"></a>聚合附加条件</h2><h3 id="设置过滤条件"><a href="#设置过滤条件" class="headerlink" title="设置过滤条件"></a>设置过滤条件</h3><p><code>filter</code>: 为聚合分析设定过滤条件。</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329163851683.png" title="image-20210329163851683"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询家庭在北京，已名字分组的记录</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://elasticsearch:9200/test_db/_search&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 0, </span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;filter_demo&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;match_phrase&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;home&quot;:&quot;北京&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name_group_demo&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;terms&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;field&quot;: &quot;name&quot;,</span></span><br><span class="line"><span class="string">            &quot;size&quot;: 10</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意这里的数据结构嵌套。</p></blockquote><h2 id="聚合后排序"><a href="#聚合后排序" class="headerlink" title="聚合后排序"></a>聚合后排序</h2><p>可以使用自带的关键数据进行排序，如下：</p><ul><li><code>_count</code>: 文档数</li><li><code>_key</code>: 按照key值排序</li></ul><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210329164449638.png" title="image-20210329164449638"><h1 id="RestAPI实现聚合"><a href="#RestAPI实现聚合" class="headerlink" title="RestAPI实现聚合"></a>RestAPI实现聚合</h1><blockquote><p>代码地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/behappy-java-study/heima-distributed-study">https://github.com/behappy-java-study/heima-distributed-study</a></p></blockquote><h2 id="API语法"><a href="#API语法" class="headerlink" title="API语法"></a>API语法</h2><p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p><p>聚合条件的语法：</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210723173057733.png" title="image-20210723173057733"><p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：<img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210723173215728.png" title="image-20210723173215728"></p><h2 id="业务需求"><a href="#业务需求" class="headerlink" title="业务需求"></a>业务需求</h2><p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210723192605566.png" title="image-20210723192605566"><p>分析：</p><p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。</p><p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p><p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p><p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p><p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p><p>因为是对搜索结果聚合，因此聚合是<strong>限定范围的聚合</strong>，也就是说聚合的限定条件跟搜索文档的条件一致。</p><p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210723193730799.png" title="image-20210723193730799"><p>请求<strong>参数与搜索文档的参数完全一致</strong>。</p><p>返回值类型就是页面要展示的最终结果：</p><img src="/img/loading.gif" data-lazy-src="/posts/600acefe/image-20210723203915982.png" title="image-20210723203915982"><p>结果是一个Map结构：</p><ul><li>key是字符串，城市、星级、品牌、价格</li><li>value是集合，例如多个城市的名称</li></ul><h2 id="业务实现"><a href="#业务实现" class="headerlink" title="业务实现"></a>业务实现</h2><p>在<code>cn.itcast.hotel.web</code>包的<code>HotelController</code>中添加一个方法，遵循下面的要求：</p><ul><li>请求方式：<code>POST</code></li><li>请求路径：<code>/hotel/filters</code></li><li>请求参数：<code>RequestParams</code>，与搜索文档的参数一致</li><li>返回值类型：<code>Map&lt;String, List&lt;String&gt;&gt;</code></li></ul><p>代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;filters&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getFilters</span><span class="params">(<span class="meta">@RequestBody</span> RequestParams params)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hotelService.getFilters(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里调用了IHotelService中的getFilters方法，尚未实现。</p><p>在<code>cn.itcast.hotel.service.IHotelService</code>中定义新方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">filters</span><span class="params">(RequestParams params)</span>;</span><br></pre></td></tr></table></figure><p>在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">filters</span><span class="params">(RequestParams params)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.准备Request</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.准备DSL</span></span><br><span class="line">        <span class="comment">// 2.1.query</span></span><br><span class="line">        buildBasicQuery(params, request);</span><br><span class="line">        <span class="comment">// 2.2.设置size</span></span><br><span class="line">        request.source().size(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 2.3.聚合</span></span><br><span class="line">        buildAggregation(request);</span><br><span class="line">        <span class="comment">// 3.发出请求</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 4.解析结果</span></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> response.getAggregations();</span><br><span class="line">        <span class="comment">// 4.1.根据品牌名称，获取品牌结果</span></span><br><span class="line">        List&lt;String&gt; brandList = getAggByName(aggregations, <span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;品牌&quot;</span>, brandList);</span><br><span class="line">        <span class="comment">// 4.2.根据品牌名称，获取品牌结果</span></span><br><span class="line">        List&lt;String&gt; cityList = getAggByName(aggregations, <span class="string">&quot;cityAgg&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;城市&quot;</span>, cityList);</span><br><span class="line">        <span class="comment">// 4.3.根据品牌名称，获取品牌结果</span></span><br><span class="line">        List&lt;String&gt; starList = getAggByName(aggregations, <span class="string">&quot;starAgg&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;星级&quot;</span>, starList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildAggregation</span><span class="params">(SearchRequest request)</span> &#123;</span><br><span class="line">    request.source().aggregation(AggregationBuilders</span><br><span class="line">                                 .terms(<span class="string">&quot;brandAgg&quot;</span>)</span><br><span class="line">                                 .field(<span class="string">&quot;brand&quot;</span>)</span><br><span class="line">                                 .size(<span class="number">100</span>)</span><br><span class="line">                                );</span><br><span class="line">    request.source().aggregation(AggregationBuilders</span><br><span class="line">                                 .terms(<span class="string">&quot;cityAgg&quot;</span>)</span><br><span class="line">                                 .field(<span class="string">&quot;city&quot;</span>)</span><br><span class="line">                                 .size(<span class="number">100</span>)</span><br><span class="line">                                );</span><br><span class="line">    request.source().aggregation(AggregationBuilders</span><br><span class="line">                                 .terms(<span class="string">&quot;starAgg&quot;</span>)</span><br><span class="line">                                 .field(<span class="string">&quot;starName&quot;</span>)</span><br><span class="line">                                 .size(<span class="number">100</span>)</span><br><span class="line">                                );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getAggByName</span><span class="params">(Aggregations aggregations, String aggName)</span> &#123;</span><br><span class="line">    <span class="comment">// 4.1.根据聚合名称获取聚合结果</span></span><br><span class="line">    <span class="type">Terms</span> <span class="variable">brandTerms</span> <span class="operator">=</span> aggregations.get(aggName);</span><br><span class="line">    <span class="comment">// 4.2.获取buckets</span></span><br><span class="line">    List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = brandTerms.getBuckets();</span><br><span class="line">    <span class="comment">// 4.3.遍历</span></span><br><span class="line">    List&lt;String&gt; brandList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">        <span class="comment">// 4.4.获取key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">        brandList.add(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> brandList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/600acefe/">https://xiaowu95.wang/posts/600acefe/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/elasticsearch/">elasticsearch</a><a class="post-meta__tags" href="/tags/elastic-stack/">elastic stack</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo17.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/e9fe0c02/" title="记录docker集群部署es7.x"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo21.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">记录docker集群部署es7.x</div></div><div class="info-2"><div class="info-item-1">三台机器 192.168.56.105192.168.56.106192.168.56.107 所有之前先运行下面指令，（防止jvm报错）12345sysctl -w vm.max_map_count=262144#只是测试，所以临时修改，永久修改使用下面echo vm.max_map_count=262144 &gt;&gt; /etc/sysctl.confsysctl -p es-node1 1234567891011121314151617181920212223242526272829# 集群名称，相同名称为一个集群cluster.name: elasticsearch-cluster# 节点名称，集群模式下每个节点名称唯一node.name: es-node1# 监听地址，用于访问该es，0.0.0.0代表不限制network.host: 0.0.0.0# 表示这个节点是否可以充当主节点node.master: true#...</div></div></div></a><a class="pagination-related" href="/posts/ecf70688/" title="Kibana-dashboard结合Filebeat的使用"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo2.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Kibana-dashboard结合Filebeat的使用</div></div><div class="info-2"><div class="info-item-1">利用Filebeat-Moudule监听&#x2F;传输数据到es并通过Kibana的面板显示 要记得将modules功能打开 filebeat安装完默认会在&#x2F;etc&#x2F;filebeat&#x2F;modules.d下放着许多模块的yml,需要哪个,就执行filebeat modules enable xxx filebeat.yml 1234567891011121314151617181920212223filebeat.config: modules: enabled: true path: modules.d/*.yml reload.enabled: true reload.period: 10s# ------------------------------ kibana Output -------------------------------output.elasticsearch: hosts: [&quot;10.0.2.15:9200&quot;] username:...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/d88b52f3/" title="Too many dynamic script compilations within, max[75&#x2F;5m];"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo14.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-06-16</div><div class="info-item-2">Too many dynamic script compilations within, max[75&#x2F;5m];</div></div><div class="info-2"><div class="info-item-1">ResponseError: search_phase_execution_exception: [circuit_breaking_exception] Reason: [script] Too many dynamic script compilations within, max: [75/5m]; please use indexed, or scripts with parameters instead; this limit can be changed by the [script.context.number_sort.max_compilations_rate] setting</div></div></div></a><a class="pagination-related" href="/posts/9c544337/" title="Elasticsearch：Snapshot备份与恢复"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-10-30</div><div class="info-item-2">Elasticsearch：Snapshot备份与恢复</div></div><div class="info-2"><div class="info-item-1">SnapshotElasticsearch文档里对于snapshot有如下描述： 1The index snapshot process is incremental. In the process of making the index snapshot Elasticsearch analyses the list of the index files that are already stored in the repository and copies only files that were created or changed since the last...</div></div></div></a><a class="pagination-related" href="/posts/3cc5542c/" title="Elasticsearch之缓存"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo11.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-07-19</div><div class="info-item-2">Elasticsearch之缓存</div></div><div class="info-2"><div class="info-item-1">转自：https://www.jianshu.com/p/1ec202148189 Elasticsearch 包含三个类型的缓存，分别为： Node Query Cache 、 Shard Request Cache 、 Fielddata Cache。 Node Query Cache作用域Query Cache是Node级别的，被所有shard共享。 早期版本也叫做为Filter Cache，顾名思义，它的作用是对过滤器的执行结果进行缓存。 Query Cache缓存的是压缩过的bitset，对应满足Query条件的docID列表。添加cache的时候，会注册一个回调，如果Segment被合并或者删除，那么就会被移除缓存 简单来看可以这样理解，一个ES的查询会先被parse 成一系列Lucene 的phrase，这些phrases 中的filter语句，如果对于查询条件是一样的时候，其实结果集是已定的，那么这些phrase 其实就是可以存放在一个地方当做cache用，这个就是 query...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">1.</span> <span class="toc-text">数据聚合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%88%86%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">聚合分类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bucket%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">Bucket聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Terms"><span class="toc-number">2.1.1.</span> <span class="toc-text">Terms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Range"><span class="toc-number">2.1.2.</span> <span class="toc-text">Range</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Date-Range"><span class="toc-number">2.1.3.</span> <span class="toc-text">Date Range</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-2"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Histogram"><span class="toc-number">2.1.4.</span> <span class="toc-text">Histogram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-3"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Date-Histogram"><span class="toc-number">2.1.5.</span> <span class="toc-text">Date Histogram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-4"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-4"><span class="toc-number">2.1.5.2.</span> <span class="toc-text">使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metric%E6%8C%87%E6%A0%87%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">Metric指标分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%80%BC%E5%88%86%E6%9E%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">单值分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E5%92%8C%E6%9C%80%E5%B0%8F"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">最大和最小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%80%BC%E3%80%81%E6%B1%82%E5%92%8C"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">平均值、求和</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">去重</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%80%BC%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">多值分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stats"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">Stats</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extended-Stats"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">Extended Stats</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Standard-Deviation-Bounds"><span class="toc-number">2.2.2.2.1.</span> <span class="toc-text">Standard Deviation Bounds</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Script"><span class="toc-number">2.2.2.2.2.</span> <span class="toc-text">Script</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Value-Script"><span class="toc-number">2.2.2.2.3.</span> <span class="toc-text">Value Script</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Missing-Value"><span class="toc-number">2.2.2.2.4.</span> <span class="toc-text">Missing Value</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#top-hits"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">top_hits</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E9%99%84%E5%8A%A0%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">聚合附加条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%BB%A4%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text">设置过滤条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%90%8E%E6%8E%92%E5%BA%8F"><span class="toc-number">2.4.</span> <span class="toc-text">聚合后排序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RestAPI%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-number">3.</span> <span class="toc-text">RestAPI实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#API%E8%AF%AD%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">API语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82"><span class="toc-number">3.2.</span> <span class="toc-text">业务需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.</span> <span class="toc-text">业务实现</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 TypeScript 创建 Koa 服务器"></a><div class="content"><a class="title" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器">使用 TypeScript 创建 Koa 服务器</a><time datetime="2025-10-11T06:00:11.000Z" title="发表于 2025-10-11 14:00:11">2025-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nodejs应用提取heap并加以分析的一些常用方法"></a><div class="content"><a class="title" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法">Nodejs应用提取heap并加以分析的一些常用方法</a><time datetime="2025-09-28T07:54:43.000Z" title="发表于 2025-09-28 15:54:43">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo17.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 小五</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=document.querySelectorAll("#article-container .chartjs-container");if(0===t.length)return;const e=(t,a)=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach((r=>{const n=t[r];"object"==typeof n&&null!==n&&(n[a]?t[r]=n[a]:e(n,a))}))},a=()=>{window.loadChartJS=!0,Array.from(t).forEach(((t,a)=>{const r=t.firstElementChild,n=t.getAttribute("data-chartjs-id")||"chartjs-"+a,d=t.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),e(i,m),new Chart(h,i)}))},r=()=>{window.loadChartJS?a():btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js").then(a)};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?r():document.addEventListener("DOMContentLoaded",r)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['link[rel="canonical"]','meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>e()))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404")}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.12.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.75.3/dist/instantsearch.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo25.jpg" alt="/img/nba-logo25.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo15.jpg" alt="/img/nba-logo15.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-04-06</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo17.jpg" alt="/img/nba-logo17.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="/img/nba-logo9.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" alt="/img/nba-logo30.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>