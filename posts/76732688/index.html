<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Jenkinsfile的使用 | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="什么是流水线jenkins 有 2 种流水线分为声明式流水线与脚本化流水线，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。 1、声明式流水线在声明式流水线语法中，流水线过程定义在 Pipeline&#123;&#125;中，Pipeline 块定义了整个流水线中完成的所有工作，比如 参数说明：  agent any：在任"><meta property="og:type" content="article"><meta property="og:title" content="Jenkinsfile的使用"><meta property="og:url" content="https://xiaowu95.wang/posts/76732688/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="什么是流水线jenkins 有 2 种流水线分为声明式流水线与脚本化流水线，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。 1、声明式流水线在声明式流水线语法中，流水线过程定义在 Pipeline&#123;&#125;中，Pipeline 块定义了整个流水线中完成的所有工作，比如 参数说明：  agent any：在任"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo3.jpg"><meta property="article:published_time" content="2023-04-12T16:00:00.000Z"><meta property="article:modified_time" content="2023-06-15T10:02:19.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="gitlab"><meta property="article:tag" content="devops"><meta property="article:tag" content="Jenkins"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo3.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/76732688/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.2.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{input_placeholder:"搜索文章",hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Jenkinsfile的使用",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo3.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">Jenkinsfile的使用</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Jenkinsfile的使用<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/devops/Jenkinsfile的使用.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-12T16:00:00.000Z" title="发表于 2023-04-13 00:00:00">2023-04-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-15T10:02:19.000Z" title="更新于 2023-06-15 18:02:19">2023-06-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/devops/">devops</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2023-06-15 18:02:19&quot;}" hidden></div><h1 id="什么是流水线"><a href="#什么是流水线" class="headerlink" title="什么是流水线"></a><strong>什么是流水线</strong></h1><p>jenkins 有 2 种流水线分为<code>声明式流水线</code>与<code>脚本化流水线</code>，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。</p><h2 id="1、声明式流水线"><a href="#1、声明式流水线" class="headerlink" title="1、声明式流水线"></a>1、声明式流水线</h2><p>在声明式流水线语法中，流水线过程定义在 <code>Pipeline&#123;&#125;</code>中，<code>Pipeline 块</code>定义了整个流水线中完成的所有工作，比如</p><p>参数说明：</p><ul><li>agent any：在任何可用的代理上执行流水线或它的任何阶段，也就是执行流水线过程的位置，也可以指定到具体的节点</li><li>stage：定义流水线的执行过程（相当于一个阶段），比如下文所示的 Build、Test、Deploy， 但是这个名字是根据实际情况进行定义的，并非固定的名字</li><li>steps：执行某阶段具体的步骤。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">    <span class="string">stages</span> &#123;</span><br><span class="line">      <span class="string">stage(&#x27;Build&#x27;)</span> &#123;</span><br><span class="line">        <span class="string">steps</span> &#123;</span><br><span class="line">          <span class="string">echo</span> <span class="string">&#x27;Build&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">stage(&#x27;Test&#x27;)</span> &#123;</span><br><span class="line">        <span class="string">steps</span> &#123;</span><br><span class="line">          <span class="string">echo</span> <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">stage(&#x27;Deploy&#x27;)</span> &#123;</span><br><span class="line">        <span class="string">steps</span> &#123;</span><br><span class="line">          <span class="string">echo</span> <span class="string">&#x27;Deploy&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、脚本化流水线"><a href="#2、脚本化流水线" class="headerlink" title="2、脚本化流水线"></a>2、脚本化流水线</h2><p>在脚本化流水线语法中，会有一个或多个 Node（节点）块在整个流水线中执行核心工作</p><p>参数说明:</p><ul><li>node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点</li><li>stage：和声明式的含义一致，定义流水线的阶段。Stage 块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现 stage 块，可以清楚地在 Jenkins UI 界面中显示每个 stage 的任务子集。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Scripted</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">node</span> &#123;</span><br><span class="line">  <span class="string">stage(&#x27;Build&#x27;)</span> &#123;</span><br><span class="line">    <span class="string">echo</span> <span class="string">&#x27;Build&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stage(&#x27;Test&#x27;)</span> &#123;</span><br><span class="line">    <span class="string">echo</span> <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stage(&#x27;Deploy&#x27;)</span> &#123;</span><br><span class="line">    <span class="string">echo</span> <span class="string">&#x27;Deploy&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="声明式流水线"><a href="#声明式流水线" class="headerlink" title="声明式流水线"></a><strong>声明式流水线</strong></h1><p>声明式流水线必须包含在一个 Pipeline 块中，比如是一个 Pipeline 块的格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">/*</span> <span class="string">insert</span> <span class="string">Declarative</span> <span class="string">Pipeline</span> <span class="string">here</span> <span class="string">*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在声明式流水线中有效的基本语句和表达式遵循与 Groovy 的语法同样的规则，但有以下例外</p><ul><li>流水线顶层必须是一个 block，即 pipeline{}</li><li>分隔符可以不需要分号，但是每条语句都必须在自己的行上</li><li>块只能由 Sections、Directives、Steps 或 assignment statements 组成</li><li>属性引用语句被当做是无参数的方法调用，比如 input 会被当做 input()。</li></ul><h2 id="1、Sections"><a href="#1、Sections" class="headerlink" title="1、Sections"></a>1、Sections</h2><p>声明式流水线中的 Sections 不是一个关键字或指令，而是包含一个或多个 Agent、Stages、 post、Directives 和 Steps 的代码区域块。</p><h3 id="1-1-Agent"><a href="#1-1-Agent" class="headerlink" title="1.1 Agent"></a>1.1 Agent</h3><p>Agent 表示整个流水线或特定阶段中的步骤和命令执行的位置，该部分必须在 pipeline 块的顶层被定义，也可以在 stage 中再次定义，但是 stage 级别是可选的。</p><h4 id="any"><a href="#any" class="headerlink" title="any"></a>any</h4><p>在任何可用的代理上执行流水线，配置语法</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="none"><a href="#none" class="headerlink" title="none"></a>none</h4><p>表示该 Pipeline 脚本没有全局的 agent 配置。当顶层的 agent 配置为 none 时， 每个 stage 部分都需要包含它自己的 agent。配置语法</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">none</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Stage</span> <span class="string">For</span> <span class="string">Build&#x27;)</span>&#123;</span><br><span class="line">      <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="label"><a href="#label" class="headerlink" title="label"></a>label</h4><p>以节点标签形式选择某个具体的节点执行 Pipeline 命令，例如：<code>agent &#123; label &#39;my-defined-label&#39; &#125;</code>。节点需要提前配置标签。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">none</span></span><br><span class="line">    <span class="string">stages</span> &#123;</span><br><span class="line">      <span class="string">stage(&#x27;Stage</span> <span class="string">For</span> <span class="string">Build&#x27;)</span>&#123;</span><br><span class="line">        <span class="string">agent</span> &#123; <span class="string">label</span> <span class="string">&#x27;role-master&#x27;</span> &#125;</span><br><span class="line">        <span class="string">steps</span> &#123;</span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;role-master&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="node"><a href="#node" class="headerlink" title="node"></a>node</h4><p>和 label 配置类似，只不过是可以添加一些额外的配置，比如 customWorkspace(设置默认工作目录)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">none</span></span><br><span class="line">    <span class="string">stages</span> &#123;</span><br><span class="line">      <span class="string">stage(&#x27;Stage</span> <span class="string">For</span> <span class="string">Build&#x27;)</span>&#123;</span><br><span class="line">        <span class="string">agent</span> &#123;</span><br><span class="line">          <span class="string">node</span> &#123;</span><br><span class="line">            <span class="string">label</span> <span class="string">&#x27;role-master&#x27;</span></span><br><span class="line">            <span class="string">customWorkspace</span> <span class="string">&quot;/tmp/zhangzhuo/data&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">steps</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;echo role-master &gt; 1.txt&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h4><p>使用从源码中包含的 Dockerfile 所构建的容器执行流水线或 stage。此时对应的 agent 写法如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">agent</span> &#123;</span><br><span class="line">   <span class="string">dockerfile</span> &#123;</span><br><span class="line">     <span class="string">filename</span> <span class="string">&#x27;Dockerfile.build&#x27;</span>  <span class="string">//dockerfile文件名称</span></span><br><span class="line">     <span class="string">dir</span> <span class="string">&#x27;build&#x27;</span>                  <span class="string">//执行构建镜像的工作目录</span></span><br><span class="line">     <span class="string">label</span> <span class="string">&#x27;role-master&#x27;</span>          <span class="string">//执行的node节点，标签选择</span></span><br><span class="line">     <span class="string">additionalBuildArgs</span> <span class="string">&#x27;--build-arg version=1.0.2&#x27;</span> <span class="string">//构建参数</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><p>相当于 dockerfile，可以直接使用 docker 字段指定外部镜像即可，可以省去构建的时间。比如使用 maven 镜像进行打包，同时可以指定 args</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">agent&#123;</span></span><br><span class="line">  <span class="string">docker&#123;</span></span><br><span class="line">    <span class="string">image</span> <span class="string">&#x27;192.168.10.15/kubernetes/alpine:latest&#x27;</span>   <span class="string">//镜像地址</span></span><br><span class="line">    <span class="string">label</span> <span class="string">&#x27;role-master&#x27;</span> <span class="string">//执行的节点，标签选择</span></span><br><span class="line">    <span class="string">args</span> <span class="string">&#x27;-v /tmp:/tmp&#x27;</span>      <span class="string">//启动镜像的参数</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h4><p>需要部署 kubernetes 相关的插件，官方文档：</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jenkinsci/kubernetes-plugin/">https://github.com/jenkinsci/kubernetes-plugin/</a></p><p>Jenkins 也支持使用 Kubernetes 创建 Slave，也就是常说的动态 Slave。配置示例如下</p><ul><li>cloud: Configure Clouds 的名称，指定到其中一个 k8s</li><li>slaveConnectTimeout: 连接超时时间</li><li>yaml: pod 定义文件，jnlp 容器的配置必须有配置无需改变，其余 containerd 根据自己情况指定</li><li>workspaceVolume：持久化 jenkins 的工作目录。</li><li>persistentVolumeClaimWorkspaceVolume：挂载已有 pvc。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspaceVolume persistentVolumeClaimWorkspaceVolume(claimName: &quot;jenkins-agent&quot;, mountPath: &quot;/&quot;, readOnly: &quot;false&quot;)</span><br></pre></td></tr></table></figure><ul><li>nfsWorkspaceVolume：挂载 nfs 服务器目录</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.10.254&quot;, serverPath: &quot;/nfs&quot;, readOnly: &quot;false&quot;)</span><br></pre></td></tr></table></figure><ul><li>dynamicPVC：动态申请 pvc，任务执行结束后删除</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspaceVolume dynamicPVC(storageClassName: &quot;nfs-client&quot;, requestsSize: &quot;1Gi&quot;, accessModes: &quot;ReadWriteMany&quot;)</span><br></pre></td></tr></table></figure><ul><li>emptyDirWorkspaceVolume：临时目录，任务执行结束后会随着 pod 删除被删除，主要功能多个任务 container 共享 jenkins 工作目录。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspaceVolume emptyDirWorkspaceVolume()</span><br></pre></td></tr></table></figure><ul><li>hostPathWorkspaceVolume：挂载 node 节点本机目录，注意挂载本机目录注意权限问题，可以先创建设置 777 权限，否则默认 kubelet 创建的目录权限为 755 默认其他用户没有写权限，执行流水线会报错。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspaceVolume hostPathWorkspaceVolume(hostPath: &quot;/opt/workspace&quot;, readOnly: false)</span><br></pre></td></tr></table></figure><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">agent</span> &#123;</span><br><span class="line">  <span class="string">kubernetes</span> &#123;</span><br><span class="line">      <span class="string">cloud</span> <span class="string">&#x27;kubernetes&#x27;</span></span><br><span class="line">      <span class="string">slaveConnectTimeout</span> <span class="number">1200</span></span><br><span class="line">      <span class="string">workspaceVolume</span> <span class="string">emptyDirWorkspaceVolume()</span></span><br><span class="line">      <span class="string">yaml</span> <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: jenkins-agent</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - args: [\&#x27;$(JENKINS_SECRET)\&#x27;, \&#x27;$(JENKINS_NAME)\&#x27;]</span></span><br><span class="line"><span class="string">    image: &#x27;</span><span class="number">192.168</span><span class="number">.10</span><span class="number">.15</span><span class="string">/kubernetes/jnlp:alpine&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jnlp</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;cat&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;192.168.10.15/kubernetes/alpine:latest&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-agent-的配置示例"><a href="#1-2-agent-的配置示例" class="headerlink" title="1.2 agent 的配置示例"></a>1.2 agent 的配置示例</h3><h4 id="kubernetes-示例"><a href="#kubernetes-示例" class="headerlink" title="kubernetes 示例"></a>kubernetes 示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> &#123;</span><br><span class="line">    <span class="string">kubernetes</span> &#123;</span><br><span class="line">      <span class="string">cloud</span> <span class="string">&#x27;kubernetes&#x27;</span></span><br><span class="line">      <span class="string">slaveConnectTimeout</span> <span class="number">1200</span></span><br><span class="line">      <span class="string">workspaceVolume</span> <span class="string">emptyDirWorkspaceVolume()</span></span><br><span class="line">      <span class="string">yaml</span> <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: jenkins-agent</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - args: [\&#x27;$(JENKINS_SECRET)\&#x27;, \&#x27;$(JENKINS_NAME)\&#x27;]</span></span><br><span class="line"><span class="string">    image: &#x27;</span><span class="number">192.168</span><span class="number">.10</span><span class="number">.15</span><span class="string">/kubernetes/jnlp:alpine&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jnlp</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;cat&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;192.168.10.15/kubernetes/alpine:latest&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;cat&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;192.168.10.15/kubernetes/kubectl:apline&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;kubectl&quot;</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  environment &#123;</span></span><br><span class="line"><span class="string">    MY_KUBECONFIG = credentials(&#x27;</span><span class="string">kubernetes-cluster&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Data&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">container(name:</span> <span class="string">&#x27;date&#x27;</span><span class="string">)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">            date</span></span><br><span class="line"><span class="string">          &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;echo&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">container(name:</span> <span class="string">&#x27;date&#x27;</span><span class="string">)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">            echo &#x27;k8s is pod&#x27;</span></span><br><span class="line"><span class="string">          &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;kubectl&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">container(name:</span> <span class="string">&#x27;kubectl&#x27;</span><span class="string">)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG</span></span><br><span class="line"><span class="string">          &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="docker-的示例"><a href="#docker-的示例" class="headerlink" title="docker 的示例"></a>docker 的示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">none</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Build&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">agent</span> &#123; <span class="string">docker</span> <span class="string">&#x27;maven:3-alpine&#x27;</span> &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello, Maven&#x27;</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">&#x27;mvn --version&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Test&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">agent</span> &#123; <span class="string">docker</span> <span class="string">&#x27;openjdk:8-jre&#x27;</span> &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello, JDK&#x27;</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">&#x27;java -version&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-Post"><a href="#1-3-Post" class="headerlink" title="1.3 Post"></a>1.3 Post</h3><p>Post 一般用于流水线结束后的进一步处理，比如错误通知等。Post 可以针对流水线不同的结果做出不同的处理，就像开发程序的错误处理，比如 Python 语言的 try catch。</p><p>Post 可以定义在 Pipeline 或 stage 中，目前支持以下条件</p><ul><li><code>always</code>：无论 Pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令；</li><li><code>changed</code>：只有当前 Pipeline 或 stage 的完成状态与它之前的运行不同时，才允许在该 post 部分运行该步骤；</li><li><code>fixed</code>：当本次 Pipeline 或 stage 成功，且上一次构建是失败或不稳定时，允许运行该 post 中定义的指令；</li><li><code>regression</code>：当本次 Pipeline 或 stage 的状态为失败、不稳定或终止，且上一次构建的 状态为成功时，允许运行该 post 中定义的指令；</li><li><code>failure</code>：只有当前 Pipeline 或 stage 的完成状态为失败（failure），才允许在 post 部分运行该步骤，通常这时在 Web 界面中显示为红色</li><li><code>success</code>：当前状态为成功（success），执行 post 步骤，通常在 Web 界面中显示为蓝色 或绿色</li><li><code>unstable</code>：当前状态为不稳定（unstable），执行 post 步骤，通常由于测试失败或代码 违规等造成，在 Web 界面中显示为黄色</li><li><code>aborted</code>：当前状态为终止（aborted），执行该 post 步骤，通常由于流水线被手动终止触发，这时在 Web 界面中显示为灰色；</li><li><code>unsuccessful</code>：当前状态不是 success 时，执行该 post 步骤；</li><li><code>cleanup</code>：无论 pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令。和 always 的区别在于，cleanup 会在其它执行之后执行。</li></ul><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>一般情况下 post 部分放在流水线的底部，比如本实例，无论 stage 的完成状态如何，都会输出一条 I will always say Hello again!信息</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World1&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;Example2&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World2&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">post</span> &#123;</span><br><span class="line">    <span class="string">always</span> &#123;</span><br><span class="line">      <span class="string">echo</span> <span class="string">&#x27;I will always say Hello again!&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以将 post 写在 stage，下面示例表示 Example1 执行失败执行 post。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&#x27;ip a&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">post</span> &#123;</span><br><span class="line">        <span class="string">failure</span> &#123;</span><br><span class="line">          <span class="string">echo</span> <span class="string">&#x27;I will always say Hello again!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-sepes"><a href="#1-4-sepes" class="headerlink" title="1.4 sepes"></a>1.4 sepes</h3><p>Steps 部分在给定的 stage 指令中执行的一个或多个步骤，比如在 steps 定义执行一条 shell 命令</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者是使用 sh 字段执行多条指令</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">           echo &#x27;Hello World1&#x27;</span></span><br><span class="line"><span class="string">           echo &#x27;Hello World2&#x27;</span></span><br><span class="line"><span class="string">        &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、Directives"><a href="#2、Directives" class="headerlink" title="2、Directives"></a>2、Directives</h2><p>Directives 可用于一些执行 stage 时的条件判断或预处理一些数据，和 Sections 一致，Directives 不是一个关键字或指令，而是包含了 environment、options、parameters、triggers、stage、tools、 input、when 等配置。</p><h3 id="2-1-Environment"><a href="#2-1-Environment" class="headerlink" title="2.1 Environment"></a>2.1 Environment</h3><p>Environment 主要用于在流水线中配置的一些环境变量，根据配置的位置决定环境变量的作用域。可以定义在 pipeline 中作为全局变量，也可以配置在 stage 中作为该 stage 的环境变量。该指令支持一个特殊的方法 credentials()，该方法可用于在 Jenkins 环境中通过标识符访问预定义的凭证。对于类型为 Secret Text 的凭证，credentials()可以将该 Secret 中的文本内容赋值给环境变量。对于类型为标准的账号密码型的凭证，指定的环境变量为 username 和 password，并且也会定义两个额外的环境变量，分别为MYVARNAME_USR和MYVARNAME_PSW。</p><p>基本变量使用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//示例</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;   <span class="string">//全局变量，会在所有stage中生效</span></span><br><span class="line">    <span class="string">NAME=</span> <span class="string">&#x27;zhangzhuo&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">environment</span> &#123; <span class="string">//定义在stage中的变量只会在当前stage生效，其他的stage不会生效</span></span><br><span class="line">        <span class="string">HARBOR</span> <span class="string">=</span> <span class="string">&#x27;https://192.168.10.15&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;env2&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用变量引用 secret 的凭证</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//这里使用k8s的kubeconfig文件示例</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">KUBECONFIG</span> <span class="string">=</span> <span class="string">credentials(&#x27;kubernetes-cluster&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span>  <span class="string">//默认情况下输出的变量内容会被加密</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用变量引用类型为标准的账号密码型的凭证</p><p>这里使用 HARBOR 变量进行演示，默认情况下账号密码型的凭证会自动创建 3 个变量</p><ul><li>HARBOR_USR:会把凭证中 username 值赋值给这个变量</li><li>HARBOR_PSW:会把凭证中 password 值赋值给这个变量</li><li>HARBOR:默认情况下赋值的值为usernamme:password</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//这里使用k8s的kubeconfig文件示例</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">HARBOR</span> <span class="string">=</span> <span class="string">credentials(&#x27;harbor-account&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-Options"><a href="#2-2-Options" class="headerlink" title="2.2 Options"></a>2.2 Options</h3><p>Jenkins 流水线支持很多内置指令，比如 retry 可以对失败的步骤进行重复执行 n 次，可以根据不同的指令实现不同的效果。比较常用的指令如下:</p><ul><li><code>buildDiscarder</code> ：保留多少个流水线的构建记录</li><li><code>disableConcurrentBuilds</code>：禁止流水线并行执行，防止并行流水线同时访问共享资源导致流水线失败。</li><li><code>disableResume</code> ：如果控制器重启，禁止流水线自动恢复。</li><li><code>newContainerPerStage</code>：agent 为 docker 或 dockerfile 时，每个阶段将在同一个节点的新容器中运行，而不是所有的阶段都在同一个容器中运行。</li><li><code>quietPeriod</code>：流水线静默期，也就是触发流水线后等待一会在执行。</li><li><code>retry</code>：流水线失败后重试次数。</li><li><code>timeout</code>：设置流水线的超时时间，超过流水线时间，job 会自动终止。如果不加 unit 参数默认为 1 分。</li><li><code>timestamps</code>：为控制台输出时间戳。</li></ul><p>定义在 pipeline 中</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">options</span> &#123;</span><br><span class="line">    <span class="string">timeout(time:</span> <span class="number">1</span>, <span class="attr">unit:</span> <span class="string">&#x27;HOURS&#x27;</span><span class="string">)</span>  <span class="string">//超时时间1小时，如果不加unit参数默认为1分</span></span><br><span class="line">    <span class="string">timestamps()</span>                     <span class="string">//所有输出每行都会打印时间戳</span></span><br><span class="line">    <span class="string">buildDiscarder(logRotator(numToKeepStr:</span> <span class="string">&#x27;3&#x27;</span><span class="string">))</span> <span class="string">//保留三个历史构建版本</span></span><br><span class="line">    <span class="string">quietPeriod(10)</span>  <span class="string">//注意手动触发的构建不生效</span></span><br><span class="line">    <span class="string">retry(3)</span>    <span class="string">//流水线失败后重试次数</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">        <span class="string">sleep</span> <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;env2&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义在 stage 中</p><p>Option 除了写在 Pipeline 顶层，还可以写在 stage 中，但是写在 stage 中的 option 仅支持 retry、 timeout、timestamps，或者是和 stage 相关的声明式选项，比如 skipDefaultCheckout。处于 stage 级别的 options 写法如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">options</span> &#123;   <span class="string">//定义在这里这对这个stage生效</span></span><br><span class="line">        <span class="string">timeout(time:</span> <span class="number">2</span>, <span class="attr">unit:</span> <span class="string">&#x27;SECONDS&#x27;</span><span class="string">)</span> <span class="string">//超时时间2秒</span></span><br><span class="line">        <span class="string">timestamps()</span>                     <span class="string">//所有输出每行都会打印时间戳</span></span><br><span class="line">        <span class="string">retry(3)</span>    <span class="string">//流水线失败后重试次数</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env &amp;&amp; sleep 2&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;env2&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-Parameters"><a href="#2-3-Parameters" class="headerlink" title="2.3 Parameters"></a>2.3 Parameters</h3><p>Parameters 提供了一个用户在触发流水线时应该提供的参数列表，这些用户指定参数的值可以通过 params 对象提供给流水线的 step（步骤）。只能定义在 pipeline 顶层。</p><h4 id="目前支持的参数类型如下"><a href="#目前支持的参数类型如下" class="headerlink" title="目前支持的参数类型如下"></a>目前支持的参数类型如下</h4><ul><li><code>string</code>：字符串类型的参数。</li><li><code>text</code>：文本型参数，一般用于定义多行文本内容的变量。</li><li><code>booleanParam</code>：布尔型参数。</li><li><code>choice</code>：选择型参数，一般用于给定几个可选的值，然后选择其中一个进行赋值。</li><li><code>password</code>：密码型变量，一般用于定义敏感型变量，在 Jenkins 控制台会输出为*。</li></ul><h4 id="插件-Parameters"><a href="#插件-Parameters" class="headerlink" title="插件 Parameters"></a>插件 Parameters</h4><ul><li><code>imageTag</code>：镜像 tag，需要安装 Image Tag Parameter 插件后使用</li><li><code>gitParameter</code>：获取 git 仓库分支，需要 Git Parameter 插件后使用</li></ul><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">parameters</span> &#123;</span><br><span class="line">    <span class="string">string(name:</span> <span class="string">&#x27;DEPLOY_ENV&#x27;</span>, <span class="attr">defaultValue:</span>  <span class="string">&#x27;staging&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;1&#x27;</span><span class="string">)</span>   <span class="string">//执行构建时需要手动配置字符串类型参数，之后赋值给变量</span></span><br><span class="line">    <span class="string">text(name:</span>  <span class="string">&#x27;DEPLOY_TEXT&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;One\nTwo\nThree\n&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;2&#x27;</span><span class="string">)</span>  <span class="string">//执行构建时需要提供文本参数，之后赋值给变量</span></span><br><span class="line">    <span class="string">booleanParam(name:</span> <span class="string">&#x27;DEBUG_BUILD&#x27;</span>,  <span class="attr">defaultValue:</span> <span class="literal">true</span>, <span class="attr">description:</span> <span class="string">&#x27;3&#x27;</span><span class="string">)</span>   <span class="string">//布尔型参数</span></span><br><span class="line">    <span class="string">choice(name:</span> <span class="string">&#x27;CHOICES&#x27;</span>, <span class="attr">choices:</span> [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;4&#x27;</span><span class="string">)</span>  <span class="string">//选择形式列表参数</span></span><br><span class="line">    <span class="string">password(name:</span> <span class="string">&#x27;PASSWORD&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;SECRET&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;A  secret password&#x27;</span><span class="string">)</span>  <span class="string">//密码类型参数，会进行加密</span></span><br><span class="line">    <span class="string">imageTag(name:</span> <span class="string">&#x27;DOCKER_IMAGE&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;kubernetes/kubectl&#x27;</span>, <span class="attr">filter:</span> <span class="string">&#x27;.*&#x27;</span>, <span class="attr">defaultTag:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">registry:</span> <span class="string">&#x27;https://192.168.10.15&#x27;</span>, <span class="attr">credentialId:</span> <span class="string">&#x27;harbor-account&#x27;</span>, <span class="attr">tagOrder:</span> <span class="string">&#x27;NATURAL&#x27;</span><span class="string">)</span>   <span class="string">//获取镜像名称与tag</span></span><br><span class="line">    <span class="string">gitParameter(branch:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">branchFilter:</span> <span class="string">&#x27;origin/(.*)&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Branch for build and deploy&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;BRANCH&#x27;</span>, <span class="attr">quickFilterEnabled:</span> <span class="literal">false</span>, <span class="attr">selectedValue:</span> <span class="string">&#x27;NONE&#x27;</span>, <span class="attr">sortMode:</span> <span class="string">&#x27;NONE&#x27;</span>,  <span class="attr">tagFilter:</span> <span class="string">&#x27;*&#x27;</span>, <span class="attr">type:</span> <span class="string">&#x27;PT_BRANCH&#x27;</span><span class="string">)</span></span><br><span class="line">  &#125;  <span class="string">//获取git仓库分支列表，必须有git引用</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;env1&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;git&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="attr">git branch:</span> <span class="string">&quot;$BRANCH&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-key&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git@192.168.10.14:root/env.git&#x27;</span>   <span class="string">//使用gitParameter，必须有这个</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-Triggers"><a href="#2-4-Triggers" class="headerlink" title="2.4 Triggers"></a>2.4 Triggers</h3><p>在 Pipeline 中可以用 triggers 实现自动触发流水线执行任务，可以通过 Webhook、Cron、 pollSCM 和 upstream 等方式触发流水线。</p><h4 id="Cron"><a href="#Cron" class="headerlink" title="Cron"></a>Cron</h4><p>定时构建假如某个流水线构建的时间比较长，或者某个流水线需要定期在某个时间段执行构建，可以 使用 cron 配置触发器，比如周一到周五每隔四个小时执行一次</p><p>注意：H 的意思不是 HOURS 的意思，而是 Hash 的缩写。主要为了解决多个流水线在同一时间同时运行带来的系统负载压力。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">triggers</span> &#123;</span><br><span class="line">    <span class="string">cron(&#x27;H</span> <span class="string">*/4</span> <span class="string">*</span> <span class="string">*</span> <span class="number">1</span><span class="number">-5</span><span class="string">&#x27;)   //周一到周五每隔四个小时执行一次</span></span><br><span class="line"><span class="string">    cron(&#x27;</span><span class="string">H/12</span> <span class="string">*</span> <span class="string">*</span> <span class="string">*</span> <span class="string">*&#x27;)</span>   <span class="string">//每隔12分钟执行一次</span></span><br><span class="line">    <span class="string">cron(&#x27;H</span> <span class="string">*</span> <span class="string">*</span> <span class="string">*</span> <span class="string">*&#x27;)</span>   <span class="string">//每隔1小时执行一次</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Upstream"><a href="#Upstream" class="headerlink" title="Upstream"></a>Upstream</h4><p>Upstream 可以根据上游 job 的执行结果决定是否触发该流水线。比如当 job1 或 job2 执行成功时触发该流水线</p><p>目前支持的状态有 <code>SUCCESS</code>、<code>UNSTABLE</code>、<code>FAILURE</code>、<code>NOT_BUILT</code>、<code>ABORTED</code> 等。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">triggers</span> &#123;</span><br><span class="line">    <span class="string">upstream(upstreamProjects:</span> <span class="string">&#x27;env&#x27;</span>, <span class="attr">threshold:</span> <span class="string">hudson.model.Result.SUCCESS)</span>  <span class="string">//当env构建成功时构建这个流水线</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-Input"><a href="#2-5-Input" class="headerlink" title="2.5 Input"></a>2.5 Input</h3><p>Input 字段可以实现在流水线中进行交互式操作，比如选择要部署的环境、是否继续执行某个阶段等。</p><h4 id="配置-Input-支持以下选项"><a href="#配置-Input-支持以下选项" class="headerlink" title="配置 Input 支持以下选项"></a>配置 Input 支持以下选项</h4><ul><li>message：必选，需要用户进行 input 的提示信息，比如：“是否发布到生产环境？”；</li><li>id：可选，input 的标识符，默认为 stage 的名称；</li><li>ok：可选，确认按钮的显示信息，比如：“确定”、“允许”；</li><li>submitter：可选，允许提交 input 操作的用户或组的名称，如果为空，任何登录用户均可提交 input；</li><li>parameters：提供一个参数列表供 input 使用。</li></ul><p>假如需要配置一个提示消息为“还继续么”、确认按钮为“继续”、提供一个 PERSON 的变量的参数，并且只能由登录用户为 alice 和 bob 提交的 input 流水线</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">input</span> &#123;</span><br><span class="line">        <span class="string">message</span> <span class="string">&quot;还继续么?&quot;</span></span><br><span class="line">        <span class="string">ok</span> <span class="string">&quot;继续&quot;</span></span><br><span class="line">        <span class="string">submitter</span> <span class="string">&quot;alice,bob&quot;</span></span><br><span class="line">        <span class="string">parameters</span> &#123;</span><br><span class="line">          <span class="string">string(name:</span> <span class="string">&#x27;PERSON&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;Mr Jenkins&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Who should I say hello to?&#x27;</span><span class="string">)</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&quot;Hello, $&#123;PERSON&#125;, nice to meet you.&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-6-when"><a href="#2-6-when" class="headerlink" title="2.6 when"></a>2.6 when</h3><p>When 指令允许流水线根据给定的条件决定是否应该执行该 stage，when 指令必须包含至少 一个条件。如果 when 包含多个条件，所有的子条件必须都返回 True，stage 才能执行。</p><p>When 也可以结合 not、allOf、anyOf 语法达到更灵活的条件匹配。</p><h4 id="目前比较常用的内置条件如下"><a href="#目前比较常用的内置条件如下" class="headerlink" title="目前比较常用的内置条件如下"></a>目前比较常用的内置条件如下</h4><ul><li><code>branch</code>：当正在构建的分支与给定的分支匹配时，执行这个 stage。注意，branch 只适用于多分支流水线</li><li><code>changelog</code>：匹配提交的 changeLog 决定是否构建，例如:<code>when &#123; changelog &#39;.*^\\[DEPENDENCY\\] .+$&#39; &#125;</code></li><li><code>environment</code>：当指定的环境变量和给定的变量匹配时，执行这个 stage，例如：<code>when &#123; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; &#125;</code></li><li><code>equals</code>：当期望值和实际值相同时，执行这个 stage，例如：<code>when &#123; equals expected: 2, actual: currentBuild.number &#125;</code>；</li><li><code>expression</code>：当指定的 Groovy 表达式评估为 True，执行这个 stage，例如：<code>when &#123; expression &#123; return params.DEBUG_BUILD &#125; &#125;</code>；</li><li><code>tag</code>：如果 TAG_NAME 的值和给定的条件匹配，执行这个 stage，例如：<code>when &#123; tag &quot;release-&quot; &#125;</code>；</li><li><code>not</code>：当嵌套条件出现错误时，执行这个 stage，必须包含一个条件，例如：<code>when &#123; not &#123; branch &#39;master&#39; &#125; &#125;</code>；</li><li><code>allOf</code>：当所有的嵌套条件都正确时，执行这个 stage，必须包含至少一个条件，例如：<code>when &#123; allOf &#123; branch &#39;master&#39;; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; &#125; &#125;</code>；</li><li><code>anyOf</code>：当至少有一个嵌套条件为 True 时，执行这个 stage，例如：<code>when &#123; anyOf &#123; branch &#39;master&#39;; branch &#39;staging&#39; &#125; &#125;</code>。</li></ul><p>示例：当分支为 main 时执行 Example Deploy 步骤</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Build&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Deploy&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">when</span> &#123;</span><br><span class="line">        <span class="string">branch</span> <span class="string">&#x27;main&#x27;</span> <span class="string">//多分支流水线，分支为才会执行。</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以同时配置多个条件，比如分支是 production，而且 DEPLOY_TO 变量的值为 main 时，才执行 Example Deploy</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">DEPLOY_TO</span> <span class="string">=</span> <span class="string">&quot;main&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Deploy&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">when</span> &#123;</span><br><span class="line">        <span class="string">branch</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">        <span class="attr">environment name:</span> <span class="string">&#x27;DEPLOY_TO&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以使用 anyOf 进行匹配其中一个条件即可，比如分支为 main 或 DEPLOY_TO 为 main 或 master 时执行 Deploy</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Deploy&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">when</span> &#123;</span><br><span class="line">        <span class="string">anyOf</span> &#123;</span><br><span class="line">          <span class="string">branch</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">          <span class="attr">environment name:</span> <span class="string">&#x27;DEPLOY_TO&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">          <span class="attr">environment name:</span> <span class="string">&#x27;DEPLOY_TO&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;master&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以使用 expression 进行正则匹配，比如当 BRANCH_NAME 为 main 或 master，并且 DEPLOY_TO 为 master 或 main 时才会执行 Example Deploy</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Deploy&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">when</span> &#123;</span><br><span class="line">        <span class="string">expression</span> &#123; <span class="string">BRANCH_NAME</span> <span class="string">==~</span> <span class="string">/(main|master)/</span> &#125;</span><br><span class="line">        <span class="string">anyOf</span> &#123;</span><br><span class="line">          <span class="attr">environment name:</span> <span class="string">&#x27;DEPLOY_TO&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">          <span class="attr">environment name:</span> <span class="string">&#x27;DEPLOY_TO&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;master&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认情况下，如果定义了某个 stage 的 agent，在进入该 stage 的 agent 后，该 stage 的 when 条件才会被评估，但是可以通过一些选项更改此选项。比如在进入 stage 的 agent 前评估 when， 可以使用 beforeAgent，当 when 为 true 时才进行该 stage</p><h4 id="目前支持的前置条件如下"><a href="#目前支持的前置条件如下" class="headerlink" title="目前支持的前置条件如下"></a>目前支持的前置条件如下</h4><ul><li><code>beforeAgent</code>：如果 beforeAgent 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入该 stage</li><li><code>beforeInput</code>：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 input 阶段；</li><li><code>beforeOptions</code>：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 options 阶段；</li><li>beforeOptions 优先级<code>大于</code> beforeInput <code>大于</code> beforeAgent</li></ul><p>示例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">none</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Build&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">Deploy&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">when</span> &#123;</span><br><span class="line">        <span class="string">beforeAgent</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">branch</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、Parallel"><a href="#3、Parallel" class="headerlink" title="3、Parallel"></a>3、Parallel</h2><p>在声明式流水线中可以使用 Parallel 字段，即可很方便的实现并发构建，比如对分支 A、B、 C 进行并行处理</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Non-Parallel</span> <span class="string">Stage&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">echo</span> <span class="string">&#x27;This stage will be executed first.&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;Parallel</span> <span class="string">Stage&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">failFast</span> <span class="literal">true</span>         <span class="string">//表示其中只要有一个分支构建执行失败，就直接推出不等待其他分支构建</span></span><br><span class="line">      <span class="string">parallel</span> &#123;</span><br><span class="line">        <span class="string">stage(&#x27;Branch</span> <span class="string">A&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">steps</span> &#123;</span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;On Branch A&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">stage(&#x27;Branch</span> <span class="string">B&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">steps</span> &#123;</span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;On Branch B&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">stage(&#x27;Branch</span> <span class="string">C&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">stages</span> &#123;</span><br><span class="line">            <span class="string">stage(&#x27;Nested</span> <span class="number">1</span><span class="string">&#x27;) &#123;</span></span><br><span class="line"><span class="string">              steps &#123;</span></span><br><span class="line"><span class="string">                echo &quot;In stage Nested 1 within Branch C&quot;</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            stage(&#x27;</span><span class="string">Nested</span> <span class="number">2</span><span class="string">&#x27;) &#123;</span></span><br><span class="line"><span class="string">              steps &#123;</span></span><br><span class="line"><span class="string">               echo &quot;In stage Nested 2 within Branch C&quot;</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="Jenkinsfile-的使用"><a href="#Jenkinsfile-的使用" class="headerlink" title="Jenkinsfile 的使用"></a><strong>Jenkinsfile 的使用</strong></h1><p>上面讲过流水线支持两种语法，即声明式和脚本式，这两种语法都支持构建持续交付流水线。并且都可以用来在 Web UI 或 Jenkinsfile 中定义流水线，不过通常将 Jenkinsfile 放置于代码仓库中（当然也可以放在单独的代码仓库中进行管理）。</p><p>创建一个 Jenkinsfile 并将其放置于代码仓库中，有以下好处</p><ul><li>方便对流水线上的代码进行复查&#x2F;迭代</li><li>对管道进行审计跟踪</li><li>流水线真正的源代码能够被项目的多个成员查看和编辑</li></ul><h2 id="1、环境变量"><a href="#1、环境变量" class="headerlink" title="1、环境变量"></a>1、环境变量</h2><h3 id="1-1-静态变量"><a href="#1-1-静态变量" class="headerlink" title="1.1 静态变量"></a><strong>1.1 静态变量</strong></h3><p>Jenkins 有许多内置变量可以直接在 Jenkinsfile 中使用，可以通过 <code>JENKINS_URL/pipeline/syntax/globals#env</code> 获取完整列表。目前比较常用的环境变量如下</p><ul><li><code>BUILD_ID</code>：当前构建的 ID，与 Jenkins 版本 1.597+中的 BUILD_NUMBER 完全相同</li><li><code>BUILD_NUMBER</code>：当前构建的 ID，和 BUILD_ID 一致</li><li><code>BUILD_TAG</code>：用来标识构建的版本号，格式为：jenkins-{BUILD_NUMBER}， 可以对产物进行命名，比如生产的 jar 包名字、镜像的 TAG 等；</li><li><code>BUILD_URL</code>：本次构建的完整 URL，比如：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B">http://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B</a></li><li><code>JOB_NAME</code>：本次构建的项目名称</li><li><code>NODE_NAME</code>：当前构建节点的名称；</li><li><code>JENKINS_URL</code>：Jenkins 完整的 URL，需要在 SystemConfiguration 设置；</li><li><code>WORKSPACE</code>：执行构建的工作目录。</li></ul><p>示例如果一个流水线名称为print_env，第 2 次构建，各个变量的值。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">BUILD_ID：2</span></span><br><span class="line"><span class="string">BUILD_NUMBER：2</span></span><br><span class="line"><span class="string">BUILD_TAG：jenkins-print_env-2</span></span><br><span class="line"><span class="string">BUILD_URL：http://192.168.10.16:8080/job/print_env/2/</span></span><br><span class="line"><span class="string">JOB_NAME：print_env</span></span><br><span class="line"><span class="string">NODE_NAME：built-in</span></span><br><span class="line"><span class="string">JENKINS_URL：http://192.168.10.16:8080/</span></span><br><span class="line"><span class="string">WORKSPACE：/bitnami/jenkins/home/workspace/print_env</span></span><br></pre></td></tr></table></figure><p>上述变量会保存在一个 Map 中，可以使用 env.BUILD_ID 或 env.JENKINS_URL 引用某个内置变量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;print</span> <span class="string">env&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">parallel</span> &#123;</span><br><span class="line">        <span class="string">stage(&#x27;BUILD_ID&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">steps</span> &#123;</span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$env.BUILD_ID&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">stage(&#x27;BUILD_NUMBER&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">steps</span> &#123;</span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$env.BUILD_NUMBER&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">stage(&#x27;BUILD_TAG&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">steps</span> &#123;</span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$env.BUILD_TAG&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-动态变量"><a href="#1-2-动态变量" class="headerlink" title="1.2 动态变量"></a>1.2 动态变量</h3><p>动态变量是根据某个指令的结果进行动态赋值，变量的值根据指令的执行结果而不同。如下所示</p><ul><li><code>returnStdout</code>：将命令的执行结果赋值给变量，比如下述的命令返回的是 clang，此时 CC 的值为“clang”。</li><li><code>returnStatus</code>：将命令的执行状态赋值给变量，比如下述命令的执行状态为 1，此时 EXIT_STATUS 的值为 1。</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">//</span> <span class="string">使用</span> <span class="string">returnStdout</span></span><br><span class="line">    <span class="string">CC</span> <span class="string">=</span> <span class="string">&quot;&quot;</span><span class="string">&quot;$&#123;sh(</span></span><br><span class="line"><span class="string">         returnStdout: true,</span></span><br><span class="line"><span class="string">         script: &#x27;echo -n &quot;</span><span class="string">clang&quot;&#x27;</span>   <span class="string">//如果使用shell命令的echo赋值变量最好加-n取消换行</span></span><br><span class="line">         <span class="string">)</span>&#125;<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    // 使用 returnStatus</span></span><br><span class="line"><span class="string">    EXIT_STATUS = &quot;</span><span class="string">&quot;&quot;</span><span class="string">$</span>&#123;<span class="string">sh(</span></span><br><span class="line">         <span class="attr">returnStatus:</span> <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">script:</span> <span class="string">&#x27;exit 1&#x27;</span></span><br><span class="line">         <span class="string">)</span>&#125;<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  stages &#123;</span></span><br><span class="line"><span class="string">    stage(&#x27;Example&#x27;) &#123;</span></span><br><span class="line"><span class="string">      environment &#123;</span></span><br><span class="line"><span class="string">        DEBUG_FLAGS = &#x27;-g&#x27;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      steps &#123;</span></span><br><span class="line"><span class="string">        sh &#x27;printenv&#x27;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="2、凭证管理"><a href="#2、凭证管理" class="headerlink" title="2、凭证管理"></a>2、凭证管理</h2><p>Jenkins 的声明式流水线语法有一个 credentials()函数，它支持 secret text（加密文本）、username 和 password（用户名和密码）以及 secret file（加密文件）等。接下来看一下一些常用的凭证处理方法。</p><h3 id="2-1-加密文本"><a href="#2-1-加密文本" class="headerlink" title="2.1 加密文本"></a>2.1 加密文本</h3><p>本实例演示将两个 Secret 文本凭证分配给单独的环境变量来访问 Amazon Web 服务，需要 提前创建这两个文件的 credentials（实践的章节会有演示），Jenkinsfile 文件的内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">AWS_ACCESS_KEY_ID</span> <span class="string">=</span> <span class="string">credentials(&#x27;txt1&#x27;)</span></span><br><span class="line">    <span class="string">AWS_SECRET_ACCESS_KEY</span> <span class="string">=</span> <span class="string">credentials(&#x27;txt2&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;Example</span> <span class="string">stage</span> <span class="number">1</span><span class="string">&#x27;) &#123;</span></span><br><span class="line"><span class="string">      steps &#123;</span></span><br><span class="line"><span class="string">        echo &quot;$AWS_ACCESS_KEY_ID&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    stage(&#x27;</span><span class="string">Example</span> <span class="string">stage</span> <span class="number">2</span><span class="string">&#x27;) &#123;</span></span><br><span class="line"><span class="string">      steps &#123;</span></span><br><span class="line"><span class="string">        echo &quot;$AWS_SECRET_ACCESS_KEY&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-用户名密码"><a href="#2-2-用户名密码" class="headerlink" title="2.2 用户名密码"></a>2.2 用户名密码</h3><p>本示例用来演示 credentials 账号密码的使用，比如使用一个公用账户访问 Bitbucket、GitLab、 Harbor 等。假设已经配置完成了用户名密码形式的 credentials，凭证 ID 为 harbor-account</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> <span class="string">any</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">    <span class="string">BITBUCKET_COMMON_CREDS</span> <span class="string">=</span> <span class="string">credentials(&#x27;harbor-account&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;printenv&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">sh</span> <span class="string">&quot;env&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述的配置会自动生成 3 个环境变量</p><ul><li><code>BITBUCKET_COMMON_CREDS</code>：包含一个以冒号分隔的用户名和密码，格式为 username:password</li><li><code>BITBUCKET_COMMON_CREDS_USR</code>：仅包含用户名的附加变量</li><li><code>BITBUCKET_COMMON_CREDS_PSW</code>：仅包含密码的附加变量。</li></ul><h3 id="2-3-加密文件"><a href="#2-3-加密文件" class="headerlink" title="2.3 加密文件"></a>2.3 加密文件</h3><p>需要加密保存的文件，也可以使用 credential，比如链接到 Kubernetes 集群的 kubeconfig 文件等。</p><p>假如已经配置好了一个 kubeconfig 文件，此时可以在 Pipeline 中引用该文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//Jenkinsfile</span> <span class="string">(Declarative</span> <span class="string">Pipeline)</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">agent</span> &#123;</span><br><span class="line">    <span class="string">kubernetes</span> &#123;</span><br><span class="line">      <span class="string">cloud</span> <span class="string">&#x27;kubernetes&#x27;</span></span><br><span class="line">      <span class="string">slaveConnectTimeout</span> <span class="number">1200</span></span><br><span class="line">      <span class="string">workspaceVolume</span> <span class="string">emptyDirWorkspaceVolume()</span></span><br><span class="line">      <span class="string">yaml</span> <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: jenkins-agent</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - args: [\&#x27;$(JENKINS_SECRET)\&#x27;, \&#x27;$(JENKINS_NAME)\&#x27;]</span></span><br><span class="line"><span class="string">    image: &#x27;</span><span class="number">192.168</span><span class="number">.10</span><span class="number">.15</span><span class="string">/kubernetes/jnlp:alpine&#x27;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jnlp</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;cat&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;192.168.10.15/kubernetes/kubectl:apline&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;kubectl&quot;</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  environment &#123;</span></span><br><span class="line"><span class="string">    MY_KUBECONFIG = credentials(&#x27;</span><span class="string">kubernetes-cluster&#x27;)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">stages</span> &#123;</span><br><span class="line">    <span class="string">stage(&#x27;kubectl&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">        <span class="string">container(name:</span> <span class="string">&#x27;kubectl&#x27;</span><span class="string">)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG</span></span><br><span class="line"><span class="string">          &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/76732688/">https://xiaowu95.wang/posts/76732688/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/gitlab/">gitlab</a><a class="post-meta__tags" href="/tags/devops/">devops</a><a class="post-meta__tags" href="/tags/Jenkins/">Jenkins</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/a0871582/" title="CentOS7下使用yum安装Nginx"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">CentOS7下使用yum安装Nginx</div></div><div class="info-2"><div class="info-item-1">下载对应当前系统版本的nginx包(package)安装 openssl 、 zlib 、 gcc 、pcre依赖1yum -y install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel pcre-devel 安装 pcre 依赖：1234wget https://nchc.dl.sourceforge.net/project/pcre/pcre/8.45/pcre-8.45.tar.gztar -xvf pcre-8.45.tar.gz &amp;&amp; cd pcre-8.45./configuremake &amp;&amp; make install 下载nginx的rpm包：1wget http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm 建立nginx的yum仓库1rpm -ivh...</div></div></div></a><a class="pagination-related" href="/posts/2e1f9495/" title="LDAP学习总结"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">LDAP学习总结</div></div><div class="info-2"><div class="info-item-1">摘自：https://lework.github.io/2019/07/18/ldap/ 安装使用参考： http://ldapdoc.eryajf.net/pages/f081dc/ https://github.com/behappy-project/behappy-docker-application/tree/master/ldap LDAP概念LDAP是轻量目录访问协议,英文全称是Lightweight Directory Access Protocol,一般都简称为LDAP.它是基于X.500标准的,但是简单多了并且可以根据需要定制.与X.500不同,LDAP支持TCP/IP,这对访问Internet是必须的.LDAP的核心规范在RFC中都有定义,所有与LDAP相关的RFC都可以在LDAPman RFC网页中找到.简单说来,LDAP是一个得到关于人或者资源的集中、静态数据的快速方式....</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/33cccd9d/" title="Docker部署Jenkins以及更新版本"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-06-15</div><div class="info-item-2">Docker部署Jenkins以及更新版本</div></div><div class="info-2"><div class="info-item-1">安装Jenkinsdocker-compose.yml 1234567891011121314151617181920212223version: &#x27;3.1&#x27;services: jenkins: restart: always image: jenkins/jenkins:2.395 container_name: jenkins user: root ports: # 发布端口 - 12012:8080 # 基于 JNLP 的 Jenkins 代理通过 TCP 端口 50000 与 Jenkins master 进行通信 #- 50000:50000 environment: - &quot;TZ=Asia/Shanghai&quot; - &quot;PATH=$PATH:$HOME/bin:/var/local/apache-maven-3.6.3/bin&quot; volumes: # jenkins...</div></div></div></a><a class="pagination-related" href="/posts/c07af8db/" title="GitLabPipeline语法"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo19.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-06-16</div><div class="info-item-2">GitLabPipeline语法</div></div><div class="info-2"><div class="info-item-1">GitLabPipeline语法</div></div></div></a><a class="pagination-related" href="/posts/82de9aa1/" title="Jenkins监听gitlab的提交并执行流水线"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-06-15</div><div class="info-item-2">Jenkins监听gitlab的提交并执行流水线</div></div><div class="info-2"><div class="info-item-1">结合Gitlab Plugin的方式监听gitlab操作第一步（gitlab）创建gitlab的访问令牌 第二步 （Jenkins）Jenkins安装gitlab&#x2F;gitlab hook插件 安装gitlab 和gitlab hook，gitlab hook的作用是可以接收gitlab hook传过来的参数 这里注意：新版jenkins中不再支持gitlab hook插件，如果插件管理中没看到gitlab hook，可以换成Generic Webhook Trigger，下文中有介绍 第三步（Jenkins）配置gitlab的凭证 第四步（Jenkins） 配置gitlab的连接 第五步（Jenkins）创建jenkins构建项目 第六步（gitlab）配置Hook 允许hook和服务访问本地网络 新版的gitlab为了安全默认禁止了本地局域网地址调用web hook 我们在设置里允许就行，具体步骤如下： 第七步 测试触发1234touch 1.txtgit add .git commit -m...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">1.</span> <span class="toc-text">什么是流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">1.1.</span> <span class="toc-text">1、声明式流水线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%84%9A%E6%9C%AC%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">1.2.</span> <span class="toc-text">2、脚本化流水线</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">2.</span> <span class="toc-text">声明式流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Sections"><span class="toc-number">2.1.</span> <span class="toc-text">1、Sections</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Agent"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#any"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">any</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#none"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">none</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#label"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">label</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#node"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dockerfile"><span class="toc-number">2.1.1.5.</span> <span class="toc-text">dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker"><span class="toc-number">2.1.1.6.</span> <span class="toc-text">docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes"><span class="toc-number">2.1.1.7.</span> <span class="toc-text">kubernetes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.1.8.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-agent-%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 agent 的配置示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">kubernetes 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">docker 的示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Post"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 Post</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-sepes"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4 sepes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Directives"><span class="toc-number">2.2.</span> <span class="toc-text">2、Directives</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Environment"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 Environment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Options"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 Options</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Parameters"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3 Parameters</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E7%9A%84%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E5%A6%82%E4%B8%8B"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">目前支持的参数类型如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6-Parameters"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">插件 Parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Triggers"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4 Triggers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cron"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">Cron</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Upstream"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">Upstream</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Input"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5 Input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Input-%E6%94%AF%E6%8C%81%E4%BB%A5%E4%B8%8B%E9%80%89%E9%A1%B9"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">配置 Input 支持以下选项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-when"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.6 when</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E6%AF%94%E8%BE%83%E5%B8%B8%E7%94%A8%E7%9A%84%E5%86%85%E7%BD%AE%E6%9D%A1%E4%BB%B6%E5%A6%82%E4%B8%8B"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">目前比较常用的内置条件如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E7%9A%84%E5%89%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6%E5%A6%82%E4%B8%8B"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">目前支持的前置条件如下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Parallel"><span class="toc-number">2.3.</span> <span class="toc-text">3、Parallel</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkinsfile-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">Jenkinsfile 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.1.</span> <span class="toc-text">1、环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1 静态变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%8A%A8%E6%80%81%E5%8F%98%E9%87%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">1.2 动态变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%87%AD%E8%AF%81%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">2、凭证管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8A%A0%E5%AF%86%E6%96%87%E6%9C%AC"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1 加密文本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2 用户名密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3 加密文件</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 TypeScript 创建 Koa 服务器"></a><div class="content"><a class="title" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器">使用 TypeScript 创建 Koa 服务器</a><time datetime="2025-10-11T06:00:11.000Z" title="发表于 2025-10-11 14:00:11">2025-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nodejs应用提取heap并加以分析的一些常用方法"></a><div class="content"><a class="title" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法">Nodejs应用提取heap并加以分析的一些常用方法</a><time datetime="2025-09-28T07:54:43.000Z" title="发表于 2025-09-28 15:54:43">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo3.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 小五</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=document.querySelectorAll("#article-container .chartjs-container");if(0===t.length)return;const e=(t,a)=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach((r=>{const n=t[r];"object"==typeof n&&null!==n&&(n[a]?t[r]=n[a]:e(n,a))}))},a=()=>{window.loadChartJS=!0,Array.from(t).forEach(((t,a)=>{const r=t.firstElementChild,n=t.getAttribute("data-chartjs-id")||"chartjs-"+a,d=t.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),e(i,m),new Chart(h,i)}))},r=()=>{window.loadChartJS?a():btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js").then(a)};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?r():document.addEventListener("DOMContentLoaded",r)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['link[rel="canonical"]','meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>e()))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404")}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.12.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.75.3/dist/instantsearch.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo25.jpg" alt="/img/nba-logo25.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo15.jpg" alt="/img/nba-logo15.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-04-06</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo17.jpg" alt="/img/nba-logo17.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="/img/nba-logo9.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" alt="/img/nba-logo30.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>