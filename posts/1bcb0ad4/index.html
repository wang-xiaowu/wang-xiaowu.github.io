<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>单环境,多分支并行开发方案(流量染色/istio) | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="需求 同一套环境, 两个微服务serviceA和serviceB, 且分别有2个版本original, v1 调用链路: serviceA -&gt; serviceB 具体分为以下几种情况  如果serviceA和serviceB都有v1版本 serviceA(v1) -&gt; serviceB(v1)  如果serviceA有v1版本, serviceB没有 serviceA(v1) -&amp;g"><meta property="og:type" content="article"><meta property="og:title" content="单环境,多分支并行开发方案(流量染色&#x2F;istio)"><meta property="og:url" content="https://xiaowu95.wang/posts/1bcb0ad4/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="需求 同一套环境, 两个微服务serviceA和serviceB, 且分别有2个版本original, v1 调用链路: serviceA -&gt; serviceB 具体分为以下几种情况  如果serviceA和serviceB都有v1版本 serviceA(v1) -&gt; serviceB(v1)  如果serviceA有v1版本, serviceB没有 serviceA(v1) -&amp;g"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo25.jpg"><meta property="article:published_time" content="2024-02-02T07:43:36.000Z"><meta property="article:modified_time" content="2025-05-15T08:50:40.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="云原生"><meta property="article:tag" content="k8s"><meta property="article:tag" content="istio"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo25.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/1bcb0ad4/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.2.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{input_placeholder:"搜索文章",hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"单环境,多分支并行开发方案(流量染色/istio)",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo25.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">单环境,多分支并行开发方案(流量染色/istio)</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">单环境,多分支并行开发方案(流量染色/istio)<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/ServiceMesh/istio/单环境,多分支并行开发方案.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-02T07:43:36.000Z" title="发表于 2024-02-02 15:43:36">2024-02-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-15T08:50:40.000Z" title="更新于 2025-05-15 16:50:40">2025-05-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/istio/">istio</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2025-05-15 16:50:40&quot;}" hidden></div><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><blockquote><p>同一套环境, 两个微服务serviceA和serviceB, 且分别有2个版本original, v1</p><p>调用链路: serviceA -&gt; serviceB</p><p>具体分为以下几种情况</p><ol><li><p>如果serviceA和serviceB都有v1版本</p><p>serviceA(v1) -&gt; serviceB(v1)</p></li><li><p>如果serviceA有v1版本, serviceB没有</p><p>serviceA(v1) -&gt; serviceB(original)</p></li><li><p>如果serviceA没有v1版本, 而serviceB有</p><p>serviceA(original) -&gt; serviceB(v1)</p></li></ol></blockquote><h3 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h3><h4 id="流量染色"><a href="#流量染色" class="headerlink" title="流量染色"></a>流量染色</h4><blockquote><p><strong>什么是流量染色</strong></p><p>在元数据中心(这里可以代指我们的k8s集群)，维护每个环境对应的服务列表；在流量的入口处，对请求添加标识；在基础框架层，对流量标识进行解析、透传 和 服务路由。</p><p>实际操作一般是在我们的 HTTP 请求中，加入对应环境，用户等变量标识，使请求可以根据这些标识做分类，转发等操作</p><p><strong>为什么需要流量染色</strong></p><ol><li><p>使不同的服务，共享环境</p></li><li><p>可以本地调试特定的服务，而不阻碍服务的正常运行</p></li></ol><p><strong>总结: 降成本, 测试提效, 环境治理，可控</strong></p></blockquote><h4 id="istio-路由控制"><a href="#istio-路由控制" class="headerlink" title="istio - 路由控制"></a>istio - 路由控制</h4><p>istio版本: 1.14.1</p><blockquote><p>路由这个功能是流量控制里面非常重要，也是最常用的一个功能。在Istio里一般通过Virtual Service（虚拟服务）以及Destination Rule（目标规则）这两个API资源进行动态路由的设置。</p></blockquote><p>虚拟服务（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://preliminary.istio.io/latest/docs/concepts/traffic-management#virtual-services">Virtual Service</a>）：</p><ul><li>定义路由规则，匹配请求</li><li>描述满足条件的请求去哪里</li></ul><p>目标规则（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://preliminary.istio.io/latest/docs/concepts/traffic-management#destination-rules">Destination Rule</a>）：</p><ul><li>定义子集、策略</li><li>描述到达目标的请求怎么处理</li></ul><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221020145206419.png" title="image-20221020145206419"><p><strong>我们的方案是, 添加一个request header(project-version), 每次请求会把此header发到下个服务, 保证整个请求链路都带着这个标识</strong></p><p><strong>那么整个流程就是这个样子</strong></p><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221020141011267.png" title="image-20221020141011267"><h3 id="技术实现-包含测试需要"><a href="#技术实现-包含测试需要" class="headerlink" title="技术实现(包含测试需要)"></a>技术实现(包含测试需要)</h3><table><thead><tr><th>功能</th><th>技术栈</th></tr></thead><tbody><tr><td>ci&#x2F;cd</td><td>gitlab-runner</td></tr><tr><td>流量控制(路由规则)</td><td>istio(VirtualService&#x2F;DestinationRule)</td></tr><tr><td>两个微服务(serviceA, serviceB)</td><td>nodejs, koa</td></tr><tr><td>serviceA的外挂访问配置</td><td>istio ingressgateway</td></tr><tr><td>作为VirtualService&#x2F;DestinationRule的管理工具</td><td>Rancher</td></tr><tr><td>传递标识(传递 request header)</td><td>axios</td></tr></tbody></table><h3 id="测试流程梳理"><a href="#测试流程梳理" class="headerlink" title="测试流程梳理"></a>测试流程梳理</h3><h4 id="准备两个nodejs微服务-testaaa和testbbb"><a href="#准备两个nodejs微服务-testaaa和testbbb" class="headerlink" title="准备两个nodejs微服务(testaaa和testbbb)"></a>准备两个nodejs微服务(testaaa和testbbb)</h4><p>testaaa服务需要做的是把从上游获取到的header发给下游</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> header = ctx.<span class="property">headers</span>[<span class="string">&#x27;project-version&#x27;</span>];</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> ctx.<span class="property">rest</span>.<span class="title function_">get</span>(<span class="string">`<span class="subst">$&#123;bbbUrl&#125;</span>`</span>,&#123;&#125;,&#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;<span class="string">&#x27;project-version&#x27;</span>: header || <span class="string">&#x27;-&#x27;</span>&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  ctx.<span class="property">body</span> = res;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>testbbb服务将当前pod的版本号作为结果返回给testaaa</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = process.<span class="property">env</span>.<span class="property">PROJECT_VERSION</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="准备好两个服务的配置资源文件"><a href="#准备好两个服务的配置资源文件" class="headerlink" title="准备好两个服务的配置资源文件"></a>准备好两个服务的配置资源文件</h4><p>Dockerfile(两个项目一样)</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">12.22</span>.<span class="number">0</span>-alpine3.<span class="number">12</span> as build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /user/src/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apk add --no-cache curl gcc g++ make linux-headers python2 python3 python3-dev</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package.json package-lock.json ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">12.22</span>.<span class="number">0</span>-alpine3.<span class="number">12</span> as runtime</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /user/src/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apk add --no-cache tzdata \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apk del tzdata</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /user/src/app/node_modules ./node_modules/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;npm&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;start&quot;</span> ]</span></span><br></pre></td></tr></table></figure><p>testaaa, deployment.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testaaa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">testaaa</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">31000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">31000</span></span><br><span class="line">      <span class="comment"># 最好配置协议/或者配置name属性,然后值为&lt;protocol-suffix&gt;， 见https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/</span></span><br><span class="line">      <span class="attr">appProtocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testaaa-$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">testaaa</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">testaaa</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># 可以单独配置此属性来指定当前部署单元是否需要istio接管</span></span><br><span class="line">        <span class="attr">sidecar.istio.io/inject:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">testaaa</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">$REGISTRY_ADDRESS/$&#123;NODE_ENV&#125;/$&#123;CI_PROJECT_NAME&#125;:v$&#123;CI_PIPELINE_ID&#125;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">development</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROJECT_VERSION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">31000</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">31000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">testaaa</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">31000</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>testbbb, deployment.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testbbb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">testbbb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">32000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">32000</span></span><br><span class="line">      <span class="comment"># 必须配置协议/也可以写name,然后配置为&lt;protocol-suffix&gt;</span></span><br><span class="line">      <span class="attr">appProtocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testbbb-$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">testbbb</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">testbbb</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># 此处优先级高于namespace下的注入配置</span></span><br><span class="line">        <span class="attr">sidecar.istio.io/inject:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        <span class="comment"># sidecar.istio.io/logLevel: debug</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">testbbb</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">$REGISTRY_ADDRESS/$&#123;NODE_ENV&#125;/$&#123;CI_PROJECT_NAME&#125;:v$&#123;CI_PIPELINE_ID&#125;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ENV</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">development</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROJECT_VERSION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">$&#123;CI_COMMIT_REF_NAME&#125;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">32000</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">32000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">testbbb</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">32000</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><h4 id="因为istio-sidecar要运行到每个POD中进行流量管控，所以我们需要为所需的namespace开启POD自动注入istio-sidecar的功能【必须】"><a href="#因为istio-sidecar要运行到每个POD中进行流量管控，所以我们需要为所需的namespace开启POD自动注入istio-sidecar的功能【必须】" class="headerlink" title="因为istio sidecar要运行到每个POD中进行流量管控，所以我们需要为所需的namespace开启POD自动注入istio sidecar的功能【必须】"></a>因为istio sidecar要运行到每个POD中进行流量管控，所以我们需要为所需的namespace开启POD自动注入istio sidecar的功能【必须】</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启istio自动注入</span></span><br><span class="line">kubectl label namespace test-istio istio-injection=enabled</span><br></pre></td></tr></table></figure><h4 id="准备gitlab-ci配置文件-并部署两个项目的release版本和release-v1版本"><a href="#准备gitlab-ci配置文件-并部署两个项目的release版本和release-v1版本" class="headerlink" title="准备gitlab-ci配置文件, 并部署两个项目的release版本和release-v1版本"></a>准备gitlab-ci配置文件, 并部署两个项目的<code>release</code>版本和<code>release-v1</code>版本</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="attr">build-release:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">IMAGE:</span> <span class="string">release/$&#123;CI_PROJECT_NAME&#125;:v$&#123;CI_PIPELINE_ID&#125;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Building application...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$REGISTRY_PASSWORD&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">$&#123;REGISTRY_USERNAME&#125;</span> <span class="string">--password-stdin</span> <span class="string">$&#123;REGISTRY_ADDRESS&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;registry login success&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sudo</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$&#123;REGISTRY_ADDRESS&#125;/$&#123;IMAGE&#125;</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sudo</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$&#123;REGISTRY_ADDRESS&#125;/$&#123;IMAGE&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;docker push &amp;&amp; push success&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build-runner</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">release</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/^release-.*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-release:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">NODE_ENV:</span> <span class="string">release</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Deploying application...&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">envsubst</span> <span class="string">&lt;</span> <span class="string">deployment.yaml</span> <span class="string">&gt;</span> <span class="string">deployment_new.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">-p</span> <span class="string">$&#123;RELEASE_CI_PORT&#125;</span> <span class="string">-tt</span> <span class="string">$&#123;RELEASE_CI_USER&#125;@$&#123;RELEASE_CI_IP&#125;</span> <span class="string">&quot;[ -d $&#123;DEPLOY_PATH&#125; ] &amp;&amp; echo ok || mkdir -p $&#123;DEPLOY_PATH&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">scp</span> <span class="string">deployment_new.yaml</span> <span class="string">$&#123;RELEASE_CI_USER&#125;@$&#123;RELEASE_CI_IP&#125;:$&#123;DEPLOY_PATH&#125;/deployment_$&#123;CI_PROJECT_NAME&#125;.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">-p</span> <span class="string">$&#123;RELEASE_CI_PORT&#125;</span> <span class="string">-tt</span> <span class="string">$&#123;RELEASE_CI_USER&#125;@$&#123;RELEASE_CI_IP&#125;</span> <span class="string">&quot;cd $&#123;DEPLOY_PATH&#125; &amp;&amp; kubectl apply -f deployment_$&#123;CI_PROJECT_NAME&#125;.yaml&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Application successfully deployed.&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">back-release</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">release</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/^release-.*/</span></span><br></pre></td></tr></table></figure><p>如下</p><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221020134208052.png" title="image-20221020134208052"><h4 id="配置ingress-使testaaa可以对外访问-下一步会在vs中结合配置"><a href="#配置ingress-使testaaa可以对外访问-下一步会在vs中结合配置" class="headerlink" title="配置ingress, 使testaaa可以对外访问(下一步会在vs中结合配置)"></a>配置ingress, 使testaaa可以对外访问(下一步会在vs中结合配置)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio test-istio controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><h4 id="准备两个服务各自的DestinationRule-和VirtualService"><a href="#准备两个服务各自的DestinationRule-和VirtualService" class="headerlink" title="准备两个服务各自的DestinationRule, 和VirtualService"></a>准备两个服务各自的DestinationRule, 和VirtualService</h4><ul><li>testaaa</li></ul><p>管理当前服务所有子集(版本)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testaaa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">testaaa.test-istio.svc.cluster.local</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">release</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">release</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">release-v1</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">release-v1</span></span><br></pre></td></tr></table></figure><p>管理当前服务路由规则(流量控制)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testaaa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">project-version:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">release-v1</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">testaaa.test-istio.svc.cluster.local</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">release-v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">testaaa.test-istio.svc.cluster.local</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">release</span></span><br></pre></td></tr></table></figure><ul><li>testbbb</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testbbb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">testbbb.test-istio.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">project-version:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">release-v1</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">testbbb.test-istio.svc.cluster.local</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">release-v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">testbbb.test-istio.svc.cluster.local</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">release</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testbbb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-istio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">testbbb.test-istio.svc.cluster.local</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">release</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">release</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">release-v1</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">release-v1</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h4 id="部署好所有服务，会发现在当前命名空间部署的所有pod内都会多一个容器，和一个初始化容器"><a href="#部署好所有服务，会发现在当前命名空间部署的所有pod内都会多一个容器，和一个初始化容器" class="headerlink" title="部署好所有服务，会发现在当前命名空间部署的所有pod内都会多一个容器，和一个初始化容器"></a>部署好所有服务，会发现在当前命名空间部署的所有pod内都会多一个容器，和一个初始化容器</h4><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221026145353080.png" title="image-20221026145353080"><h4 id="测试访问（注：这个测试的访问流量是非本集群内出去的，但是先走了istio-ingressgateway，所以testaaa和testbbb的路由规则一定会生效）"><a href="#测试访问（注：这个测试的访问流量是非本集群内出去的，但是先走了istio-ingressgateway，所以testaaa和testbbb的路由规则一定会生效）" class="headerlink" title="测试访问（注：这个测试的访问流量是非本集群内出去的，但是先走了istio ingressgateway，所以testaaa和testbbb的路由规则一定会生效）"></a>测试访问（注：这个测试的访问流量是非本集群内出去的，但是先走了istio ingressgateway，所以testaaa和testbbb的路由规则一定会生效）</h4><h5 id="先得到ingress的ip和端口"><a href="#先得到ingress的ip和端口" class="headerlink" title="先得到ingress的ip和端口"></a>先得到ingress的ip和端口</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#x27;&#123;.spec.ports[?(@.name==&quot;http2&quot;)].nodePort&#125;&#x27;</span></span><br><span class="line">31380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假如有2个ingressgateway副本，.items下就可以得到&#123;.items[0].status.hostIP&#125;和&#123;.items[1].status.hostIP&#125;，上游拿到进行负载配置即可</span></span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment"># kubectl get pod -l istio=ingressgateway -n istio-system -o jsonpath=&#x27;&#123;.items[0].status.hostIP&#125;&#x27;</span></span><br><span class="line">10.1.4.5</span><br></pre></td></tr></table></figure><h5 id="访问不带header-得到的结果是original版本-release"><a href="#访问不带header-得到的结果是original版本-release" class="headerlink" title="访问不带header, 得到的结果是original版本(release)"></a>访问不带header, 得到的结果是original版本(release)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># curl &quot;http://10.1.4.5:31380/&quot; -w &#x27;\n&#x27;</span></span><br><span class="line">release</span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h5 id="带上release-v1的header后-得到的结果是release-v1版本"><a href="#带上release-v1的header后-得到的结果是release-v1版本" class="headerlink" title="带上release-v1的header后, 得到的结果是release-v1版本"></a>带上release-v1的header后, 得到的结果是release-v1版本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># curl &quot;http://10.1.4.5:31380/&quot; --header &#x27;project-version: release-v1&#x27; -w &#x27;\n&#x27;</span></span><br><span class="line">release-v1</span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><h5 id="带着未部署过的版本-header进行访问-得到的结果是original版本-release"><a href="#带着未部署过的版本-header进行访问-得到的结果是original版本-release" class="headerlink" title="带着未部署过的版本 header进行访问, 得到的结果是original版本(release)"></a>带着未部署过的版本 header进行访问, 得到的结果是original版本(release)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># curl &quot;http://10.1.4.5:31380/&quot; --header &#x27;project-version: release-v3&#x27; -w &#x27;\n&#x27;</span></span><br><span class="line">release</span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><h5 id="紧接着我们为testaaa部署一个release-v2版本-并且配置好DestinationRule和VirtualService-但是testbbb不做更改-带着release-v2的header再发起访问-得到的结果是orginal版本-release"><a href="#紧接着我们为testaaa部署一个release-v2版本-并且配置好DestinationRule和VirtualService-但是testbbb不做更改-带着release-v2的header再发起访问-得到的结果是orginal版本-release" class="headerlink" title="紧接着我们为testaaa部署一个release-v2版本, 并且配置好DestinationRule和VirtualService, 但是testbbb不做更改, 带着release-v2的header再发起访问, 得到的结果是orginal版本(release)"></a>紧接着我们为testaaa部署一个release-v2版本, 并且配置好DestinationRule和VirtualService, 但是testbbb不做更改, 带着release-v2的header再发起访问, 得到的结果是orginal版本(release)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># curl &quot;http://10.1.4.5:31380/&quot; --header &#x27;project-version: release-v2&#x27; -w &#x27;\n&#x27;</span></span><br><span class="line">release</span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><h5 id="如果我们为testbbb部署一个release-v3版本-并且配置好DestinationRule和VirtualService-但是testaaa不做更改-带着release-v3的header再发起访问-得到的结果是release-v3版本"><a href="#如果我们为testbbb部署一个release-v3版本-并且配置好DestinationRule和VirtualService-但是testaaa不做更改-带着release-v3的header再发起访问-得到的结果是release-v3版本" class="headerlink" title="如果我们为testbbb部署一个release-v3版本, 并且配置好DestinationRule和VirtualService, 但是testaaa不做更改, 带着release-v3的header再发起访问, 得到的结果是release-v3版本"></a>如果我们为testbbb部署一个release-v3版本, 并且配置好DestinationRule和VirtualService, 但是testaaa不做更改, 带着release-v3的header再发起访问, 得到的结果是release-v3版本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k3s-release-server1 ~]<span class="comment"># curl &quot;http://10.1.4.5:31380/&quot; --header &#x27;project-version: release-v3&#x27; -w &#x27;\n&#x27;</span></span><br><span class="line">release-v3</span><br><span class="line">[root@k3s-release-server1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><h4 id="testaaa服务的链路图"><a href="#testaaa服务的链路图" class="headerlink" title="testaaa服务的链路图"></a>testaaa服务的链路图</h4><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221026151919066.png" title="image-20221026151919066"><h4 id="testbbb服务的链路图"><a href="#testbbb服务的链路图" class="headerlink" title="testbbb服务的链路图"></a>testbbb服务的链路图</h4><img src="/img/loading.gif" data-lazy-src="/posts/1bcb0ad4/image-20221026151908923.png" title="image-20221026151908923"><h3 id="延申（vs如果不加gateway字段，默认会配置，值是mesh，表示集群内部所有-Sidecar，也就表示此-VirutualService-规则针对集群内的访问生效）"><a href="#延申（vs如果不加gateway字段，默认会配置，值是mesh，表示集群内部所有-Sidecar，也就表示此-VirutualService-规则针对集群内的访问生效）" class="headerlink" title="延申（vs如果不加gateway字段，默认会配置，值是mesh，表示集群内部所有 Sidecar，也就表示此 VirutualService 规则针对集群内的访问生效）"></a>延申（vs如果不加gateway字段，默认会配置，值是mesh，表示集群内部所有 Sidecar，也就表示此 <code>VirutualService</code> 规则针对集群内的访问生效）</h3><p>小结</p><blockquote><p><strong>以上测试效果仅适合上游请求也是从当前namespace进来的,</strong></p><p><strong>假如在非当前namespace内访问testaaa服务, 不经过gateway, 它呈现出的效果就是testaaa服务规则不会生效, 但是testbbb的规则生效,</strong></p><p><strong>假如在非当前namespace内直接访问testbbb服务, 那么testbbb的规则不会生效，</strong></p><p><strong>假如在当前namespace直接访问testbbb, 那么testbbb的规则则会生效</strong></p></blockquote><blockquote><p><strong>直接在主机上访问service是会不生效的，istio的灰度规则是通过请求端的sidecar生效的。可以在一个注入了sidecar的pod(或者请求需流经注入了sidecar的pod)里访问service。以使得流量规则生效</strong></p></blockquote><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>目前这种方案可以满足我们绝大部分场景下的多分支并行开发, 但是对于个别情况, 例如第三方回调, 还存在问题. 除非回调可以由我们来控制请求报文, 否则回调只能落到original版本</p><h4 id="内容更新"><a href="#内容更新" class="headerlink" title="内容更新"></a>内容更新</h4><p>此处我们后续改成利用Istio提供的EnvoyFilter解决，以下为样例</p><blockquote><p>控制所有<code>pod-lable</code>为<code>orange-gateway-a</code>的工作负载（<strong>即网关</strong>），监听其入站流量，对<code>:authority</code> header和<code>project-version</code> header加以判断，是否需要额外添加<code>project-version</code> header</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">header-envoy-filter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sopei-biz</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">orange-gateway-a</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">SIDECAR_INBOUND</span></span><br><span class="line">        <span class="attr">listener:</span></span><br><span class="line">          <span class="attr">filterChain:</span></span><br><span class="line">            <span class="attr">filter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">              <span class="attr">subFilter:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br><span class="line">      <span class="attr">patch:</span></span><br><span class="line">        <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">        <span class="attr">value:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">envoy.filters.http.lua</span></span><br><span class="line">          <span class="attr">typed_config:</span></span><br><span class="line">            <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">&quot;type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua&quot;</span></span><br><span class="line">            <span class="attr">inlineCode:</span> <span class="string">|</span></span><br><span class="line"><span class="string">              function envoy_on_request(request_handle)</span></span><br><span class="line"><span class="string">                local authority = request_handle:headers():get(&quot;:authority&quot;)</span></span><br><span class="line"><span class="string">                local version_header = request_handle:headers():get(&quot;project-version&quot;)</span></span><br><span class="line"><span class="string">                if authority == &quot;aaa.com&quot; then</span></span><br><span class="line"><span class="string">                  if version_header == nil then</span></span><br><span class="line"><span class="string">                    request_handle:headers():add(&quot;project-version&quot;, &quot;release-aaa&quot;)</span></span><br><span class="line"><span class="string">                  end</span></span><br><span class="line"><span class="string">                elseif authority == &#x27;bbb.com&#x27; then</span></span><br><span class="line"><span class="string">                  if version_header == nil then</span></span><br><span class="line"><span class="string">                    request_handle:headers():add(&quot;project-version&quot;, &quot;release-bbb&quot;)</span></span><br><span class="line"><span class="string">                  end</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">              end</span></span><br></pre></td></tr></table></figure><h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>Istio 使用 Envoy 作为数据面转发 HTTP 请求，而 Envoy 默认要求使用 HTTP&#x2F;1.1 或 HTTP&#x2F;2，当客户端使用 HTTP&#x2F;1.0 时就会返回 <code>426 Upgrade Required</code>。</p><p>而我们的网关是基于openresty开发, 而openresty又基于nginx, nginx默认http version是1.0, 所以这里最后是改了网关的<code>proxy_http_version 1.1;</code></p><h3 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/istio/istio/issues/41709">https://github.com/istio/istio/issues/41709</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://discuss.istio.io/t/nginx-proxy-pass-to-istio-ingress-gateway-404/4330/3">https://discuss.istio.io/t/nginx-proxy-pass-to-istio-ingress-gateway-404/4330/3</a></p><p>当使用nginx作为服务网关时, 可能在代理服务前配置了<code>proxy_set_header Host xxx;</code>, 需要注意这里会影响到下游请求的路由规则, 因为VirtualService会根据<code>hosts</code>来判断当前流量规则是否生效</p><p>所以如果proxy_pass结合upstream使用, 需要在nginx中配置<code>proxy_set_header Host &lt;service-name&gt;;</code>, 如果不是结合upstream使用可以配置<code>proxy_set_header Host $proxy_host</code></p><h3 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h3><p>参考:</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/istio/istio/issues/41826">https://github.com/istio/istio/issues/41826</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/envoyproxy/envoy/issues/14981">https://github.com/envoyproxy/envoy/issues/14981</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/luo15242208310/article/details/96480095">https://blog.csdn.net/luo15242208310/article/details/96480095</a></p><p>偶现访问超时, 然后报503的问题</p><p>页面响应消息: <code>upstream connect error or disconnect/reset before headers. reset reason: connection termination</code></p><p>一个在istio中经常见到的问题, 但是引起的原因很多, 这次问题的起因我也没摸清, 只能按着kiali提供的链路图去看, 发现问题是外界流量到服务网关这里引起, 然后查看服务网关的envoy日志, 如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;downstream_local_address&quot;</span><span class="punctuation">:</span><span class="string">&quot;10.42.2.122:80&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bytes_received&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;route_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;downstream_remote_address&quot;</span><span class="punctuation">:</span><span class="string">&quot;10.42.1.0:0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_cluster&quot;</span><span class="punctuation">:</span><span class="string">&quot;inbound|80||&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_local_address&quot;</span><span class="punctuation">:</span><span class="string">&quot;127.0.0.6:48839&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_transport_failure_reason&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;connection_termination_details&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span><span class="number">3825</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x_forwarded_for&quot;</span><span class="punctuation">:</span><span class="string">&quot;175.162.8.253,10.42.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;/xxxxxx/api/weapp/v2.0/products?product_type=BEST_SELL&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-11-08T07:23:09.887Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requested_server_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;outbound_.80_.release-k3s_.orange-gateway-a.sopei-biz.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user_agent&quot;</span><span class="punctuation">:</span><span class="string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.3 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1 wechatdevtools/1.06.2210310 MicroMessenger/8.0.5 Language/zh_CN webview/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_host&quot;</span><span class="punctuation">:</span><span class="string">&quot;10.42.2.122:80&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span><span class="string">&quot;HTTP/1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bytes_sent&quot;</span><span class="punctuation">:</span><span class="number">95</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;response_code_details&quot;</span><span class="punctuation">:</span><span class="string">&quot;upstream_reset_before_response_started&#123;connection_termination&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;response_flags&quot;</span><span class="punctuation">:</span><span class="string">&quot;UC&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;authority&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_service_time&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;request_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;717b6d28-3cfc-40a1-88c2-dec26f9b54b8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;response_code&quot;</span><span class="punctuation">:</span><span class="number">503</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>关键字<code>upstream_reset_before_response_started&#123;connection_termination&#125;</code></p><p>如issue14981, 这类问题的一个可能的解释是，当代理开始发送请求时，上游服务器关闭了连接。了解上游连接在发送第一个请求之前打开了多长时间可能会有所帮助。</p><p>大概意思就是说, 请求到了服务网关, 后续api服务响应时间过长, 导致网关关闭了连接(其实这个接口确实响应时间过长)</p><p><strong>最后的解决办法:</strong></p><blockquote><p>本着试试的心. 在服务网关上面加了层<code>ingressgateway</code>, 然后进行测试, 发现这个问题解决了</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http-orange</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">orange-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">orange-gateway-a</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">release-k3s</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">orange-gateway-a</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">orange-gateway-a</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">release-k3s</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">release-k3s</span></span><br></pre></td></tr></table></figure><h4 id="问题4-更新"><a href="#问题4-更新" class="headerlink" title="问题4 更新"></a><strong>问题4 更新</strong></h4><p>针对503问题基本上可通过如下4中方式进行优化：<br>（1）修改VirtualService中HTTPRetry(attempts, perTryTimeout,retryOn)，设置错误重试策略<br>（注：在envoy中需要同时设置timeout（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_filters/router_filter#config-http-filters-router">Envoy参考</a>），即重试的总时间要小于timeout，<br>在Istio中需同时设置HttpRoute.timeout即可）；</p><p>（2）修改DestinationRule中HTTPSettings.idleTimeout，设置envoy连接池中连接的空闲缓存时间；</p><p>（3）修改DestinationRule中HTTPSettings.maxRequestsPerConnection为1（关闭Keeplive，连接不重用，性能下降）；</p><p>（4）修改tomcat connectionTimeout（Springboot配置server.connectionTimeout），增加web容器空闲连接超时时间；</p><p>同时关于Istio中503的问题排查方法可以参考如下文章：</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://karlstoney.com/2019/05/31/istio-503s-ucs-and-tcp-fun-times/index.html">【英文版】Istio: 503&#39;s with UC&#39;s and TCP Fun Times</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.fleeto.us/post/istio-503-uc-debug/">【中文版】Istio：503、UC 和 TCP</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/1bcb0ad4/">https://xiaowu95.wang/posts/1bcb0ad4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/istio/">istio</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo25.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/2081c65b/" title="查看Envoy访问日志"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">查看Envoy访问日志</div></div><div class="info-2"><div class="info-item-1">简介： istio-proxy也是我们常说的sidecar，istio默认使用envoy注入的，envoy的日志级别包括trace, debug, info, warning, error, critical, off Envoy 访问日志记录了通过 Envoy 进行请求 &#x2F; 响应交互的相关记录，可以方便地了解具体通信过程和调试定位问题。 修改日志级别的几种方式全局配置istio配置都是在configmap中的，可以通过修改configmap来修改全局的proxy日志级别： 开启 Envoy 访问日志，执行以下命令修改 istio 配置1kubectl -n istio-system edit configmap istio 1234data: mesh: |- accessLogEncoding: JSON accessLogFile: /dev/stdout 其中，accessLogEncoding表示 accesslog 输出格式，Istio 预定义了 TEXT 和 JSON 两种日志输出格式。默认使用 TEXT，通常改成 JSON...</div></div></div></a><a class="pagination-related" href="/posts/d3a1efad/" title="istio问题整理"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo20.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">istio问题整理</div></div><div class="info-2"><div class="info-item-1">1. Service 端口命名约束Istio 支持多平台，不过 Istio 和 Kubernetes 的兼容性是最优的，不管是设计理念，核心团队还是社区，都有一脉相承的意思。但 Istio 和 Kubernetes 的适配并非完全没有冲突，一个典型问题就是 Istio 需要 Kubernetes service 按照协议进行端口命名（port naming）。 端口命名不满足约束而导致的流量异常，是使用 mesh 过程中最常见的问题，其现象是协议相关的流控规则不生效，这通常可以通过检查该 port LDS 中 filter 的类型来定位。 原因Kubernetes 的网络对应用层是无感知的，Kubernetes 的主要流量转发逻辑发生在 node 上，由 iptables&#x2F;ipvs 来实现，这些规则并不关心应用层里是什么协议。 Istio 的核心能力是对 7 层流量进行管控，但前提条件是 Istio 必须知道每个受管控的服务是什么协议，istio 会根据端口协议的不同，下发不同的流控功能（envoy filter），而 Kubernetes...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/a28b97ff/" title="EnvoyFilter-ChatGPT译文"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-02-02</div><div class="info-item-2">EnvoyFilter-ChatGPT译文</div></div><div class="info-2"><div class="info-item-1">介绍 EnvoyFilter 提供了一种机制，可以自定义 Istio Pilot 生成的 Envoy 配置。使用 EnvoyFilter 修改某些字段的值、添加特定过滤器，甚至添加全新的监听器、集群等。这个功能必须小心使用，因为不正确的配置可能会破坏整个网格。与其他 Istio 网络对象不同，EnvoyFilters 是附加应用的。在特定命名空间中给定工作负载可以存在任意数量的 EnvoyFilters 。这些 EnvoyFilters 的应用顺序如下：所有位于配置根命名空间中的 EnvoyFilters ，然后是匹配工作负载命名空间中所有匹配到的 EnvoyFilters。 注意点注意1：此 API 的某些方面与 Istio 网络子系统以及Envoy XDS API 的内部实现密切相关。虽然EnvoyFilter API本身将保持向后兼容性，但通过此机制提供的任何 envoy 配置都应该在Istio代理版本升级时进行仔细监控，以确保已弃用字段被适当地删除和替换。 注意2：当多个Envoy Filters...</div></div></div></a><a class="pagination-related" href="/posts/fa103d3a/" title="idea添加对istio的智能提示"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo2.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-02-02</div><div class="info-item-2">idea添加对istio的智能提示</div></div><div class="info-2"><div class="info-item-1">转自: https://blog.51cto.com/u_15127588/3305078 JetBrains 系列 IDE 有一个非常好用的 Kubernetes 的官方插件：JetBrains Kubernetes Plugin 。该插件支持资源对象关键字的自动补全和语法检查，这对于编写或者修改 YAML 文件非常方便。但是此前版本不支持 自定义的 CRD 对象，这对于该插件的易用性来说，略有一些遗憾。 现在新版的 Kubernetes 插件已经支持通过文件导入或者 URL 导入 CRD 定义文件，从而支持任意 CRD 资源对象的关键字自动补全和语法检查。 12Custom resource definition (CRD) supportCustom resources can be validated by providing complementary OpenAPI 2.0 files with CRD schemas and/or CRD resource definitions (YAML) (limited support). 下面以服务网格 Istio...</div></div></div></a><a class="pagination-related" href="/posts/46b7d67b/" title="关于Sidecar注入以及问题记录"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo28.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-05-29</div><div class="info-item-2">关于Sidecar注入以及问题记录</div></div><div class="info-2"><div class="info-item-1">安装 Sidecar注入为了充分利用 Istio 的所有特性，网格中的 Pod 必须运行一个 Istio Sidecar 代理。 下面的章节描述了向 Pod 中注入 Istio Sidecar 的两种方法：使用 istioctl 手动注入或启用 Pod 所属命名空间的 Istio Sidecar 注入器自动注入。 当 Pod 所属命名空间启用自动注入后，自动注入器会使用准入控制器在创建 Pod 时自动注入代理配置。 手动注入直接修改配置，如 Deployment，并将代理配置注入其中。 如果您不确定使用哪一种方法，建议使用自动注入。 自动注入 Sidecar使用 Istio 提供的准入控制器变更 Webhook， 可以将 Sidecar 自动添加到可用的 Kubernetes Pod 中。 虽然准入控制器默认情况下是启用的，但一些 Kubernetes 发行版会禁用这些控制器。 如果出现这种情况，根据指示说明来启用准入控制器。 当您在一个命名空间中设置了 istio-injection=enabled 标签，且 Injection Webhook 被启用后，任何新的 Pod...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%9F%93%E8%89%B2"><span class="toc-number">2.1.</span> <span class="toc-text">流量染色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#istio-%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">istio - 路由控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0-%E5%8C%85%E5%90%AB%E6%B5%8B%E8%AF%95%E9%9C%80%E8%A6%81"><span class="toc-number">3.</span> <span class="toc-text">技术实现(包含测试需要)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">测试流程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%A4%E4%B8%AAnodejs%E5%BE%AE%E6%9C%8D%E5%8A%A1-testaaa%E5%92%8Ctestbbb"><span class="toc-number">4.1.</span> <span class="toc-text">准备两个nodejs微服务(testaaa和testbbb)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%A5%BD%E4%B8%A4%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">准备好两个服务的配置资源文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%A0%E4%B8%BAistio-sidecar%E8%A6%81%E8%BF%90%E8%A1%8C%E5%88%B0%E6%AF%8F%E4%B8%AAPOD%E4%B8%AD%E8%BF%9B%E8%A1%8C%E6%B5%81%E9%87%8F%E7%AE%A1%E6%8E%A7%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E4%B8%BA%E6%89%80%E9%9C%80%E7%9A%84namespace%E5%BC%80%E5%90%AFPOD%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5istio-sidecar%E7%9A%84%E5%8A%9F%E8%83%BD%E3%80%90%E5%BF%85%E9%A1%BB%E3%80%91"><span class="toc-number">4.3.</span> <span class="toc-text">因为istio sidecar要运行到每个POD中进行流量管控，所以我们需要为所需的namespace开启POD自动注入istio sidecar的功能【必须】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87gitlab-ci%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-%E5%B9%B6%E9%83%A8%E7%BD%B2%E4%B8%A4%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84release%E7%89%88%E6%9C%AC%E5%92%8Crelease-v1%E7%89%88%E6%9C%AC"><span class="toc-number">4.4.</span> <span class="toc-text">准备gitlab-ci配置文件, 并部署两个项目的release版本和release-v1版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEingress-%E4%BD%BFtestaaa%E5%8F%AF%E4%BB%A5%E5%AF%B9%E5%A4%96%E8%AE%BF%E9%97%AE-%E4%B8%8B%E4%B8%80%E6%AD%A5%E4%BC%9A%E5%9C%A8vs%E4%B8%AD%E7%BB%93%E5%90%88%E9%85%8D%E7%BD%AE"><span class="toc-number">4.5.</span> <span class="toc-text">配置ingress, 使testaaa可以对外访问(下一步会在vs中结合配置)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%A4%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%90%84%E8%87%AA%E7%9A%84DestinationRule-%E5%92%8CVirtualService"><span class="toc-number">4.6.</span> <span class="toc-text">准备两个服务各自的DestinationRule, 和VirtualService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%A5%BD%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%8E%B0%E5%9C%A8%E5%BD%93%E5%89%8D%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%83%A8%E7%BD%B2%E7%9A%84%E6%89%80%E6%9C%89pod%E5%86%85%E9%83%BD%E4%BC%9A%E5%A4%9A%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%EF%BC%8C%E5%92%8C%E4%B8%80%E4%B8%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8"><span class="toc-number">4.7.</span> <span class="toc-text">部署好所有服务，会发现在当前命名空间部署的所有pod内都会多一个容器，和一个初始化容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%EF%BC%88%E6%B3%A8%EF%BC%9A%E8%BF%99%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%9A%84%E8%AE%BF%E9%97%AE%E6%B5%81%E9%87%8F%E6%98%AF%E9%9D%9E%E6%9C%AC%E9%9B%86%E7%BE%A4%E5%86%85%E5%87%BA%E5%8E%BB%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E5%85%88%E8%B5%B0%E4%BA%86istio-ingressgateway%EF%BC%8C%E6%89%80%E4%BB%A5testaaa%E5%92%8Ctestbbb%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E4%B8%80%E5%AE%9A%E4%BC%9A%E7%94%9F%E6%95%88%EF%BC%89"><span class="toc-number">4.8.</span> <span class="toc-text">测试访问（注：这个测试的访问流量是非本集群内出去的，但是先走了istio ingressgateway，所以testaaa和testbbb的路由规则一定会生效）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%88%E5%BE%97%E5%88%B0ingress%E7%9A%84ip%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="toc-number">4.8.1.</span> <span class="toc-text">先得到ingress的ip和端口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%B8%A6header-%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E6%98%AForiginal%E7%89%88%E6%9C%AC-release"><span class="toc-number">4.8.2.</span> <span class="toc-text">访问不带header, 得到的结果是original版本(release)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%A6%E4%B8%8Arelease-v1%E7%9A%84header%E5%90%8E-%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E6%98%AFrelease-v1%E7%89%88%E6%9C%AC"><span class="toc-number">4.8.3.</span> <span class="toc-text">带上release-v1的header后, 得到的结果是release-v1版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%A6%E7%9D%80%E6%9C%AA%E9%83%A8%E7%BD%B2%E8%BF%87%E7%9A%84%E7%89%88%E6%9C%AC-header%E8%BF%9B%E8%A1%8C%E8%AE%BF%E9%97%AE-%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E6%98%AForiginal%E7%89%88%E6%9C%AC-release"><span class="toc-number">4.8.4.</span> <span class="toc-text">带着未部署过的版本 header进行访问, 得到的结果是original版本(release)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A7%E6%8E%A5%E7%9D%80%E6%88%91%E4%BB%AC%E4%B8%BAtestaaa%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AArelease-v2%E7%89%88%E6%9C%AC-%E5%B9%B6%E4%B8%94%E9%85%8D%E7%BD%AE%E5%A5%BDDestinationRule%E5%92%8CVirtualService-%E4%BD%86%E6%98%AFtestbbb%E4%B8%8D%E5%81%9A%E6%9B%B4%E6%94%B9-%E5%B8%A6%E7%9D%80release-v2%E7%9A%84header%E5%86%8D%E5%8F%91%E8%B5%B7%E8%AE%BF%E9%97%AE-%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E6%98%AForginal%E7%89%88%E6%9C%AC-release"><span class="toc-number">4.8.5.</span> <span class="toc-text">紧接着我们为testaaa部署一个release-v2版本, 并且配置好DestinationRule和VirtualService, 但是testbbb不做更改, 带着release-v2的header再发起访问, 得到的结果是orginal版本(release)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E4%B8%BAtestbbb%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AArelease-v3%E7%89%88%E6%9C%AC-%E5%B9%B6%E4%B8%94%E9%85%8D%E7%BD%AE%E5%A5%BDDestinationRule%E5%92%8CVirtualService-%E4%BD%86%E6%98%AFtestaaa%E4%B8%8D%E5%81%9A%E6%9B%B4%E6%94%B9-%E5%B8%A6%E7%9D%80release-v3%E7%9A%84header%E5%86%8D%E5%8F%91%E8%B5%B7%E8%AE%BF%E9%97%AE-%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E6%98%AFrelease-v3%E7%89%88%E6%9C%AC"><span class="toc-number">4.8.6.</span> <span class="toc-text">如果我们为testbbb部署一个release-v3版本, 并且配置好DestinationRule和VirtualService, 但是testaaa不做更改, 带着release-v3的header再发起访问, 得到的结果是release-v3版本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#testaaa%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%93%BE%E8%B7%AF%E5%9B%BE"><span class="toc-number">4.9.</span> <span class="toc-text">testaaa服务的链路图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#testbbb%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%93%BE%E8%B7%AF%E5%9B%BE"><span class="toc-number">4.10.</span> <span class="toc-text">testbbb服务的链路图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E7%94%B3%EF%BC%88vs%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0gateway%E5%AD%97%E6%AE%B5%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%BC%9A%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%80%BC%E6%98%AFmesh%EF%BC%8C%E8%A1%A8%E7%A4%BA%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E6%89%80%E6%9C%89-Sidecar%EF%BC%8C%E4%B9%9F%E5%B0%B1%E8%A1%A8%E7%A4%BA%E6%AD%A4-VirutualService-%E8%A7%84%E5%88%99%E9%92%88%E5%AF%B9%E9%9B%86%E7%BE%A4%E5%86%85%E7%9A%84%E8%AE%BF%E9%97%AE%E7%94%9F%E6%95%88%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">延申（vs如果不加gateway字段，默认会配置，值是mesh，表示集群内部所有 Sidecar，也就表示此 VirutualService 规则针对集群内的访问生效）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%981"><span class="toc-number">6.</span> <span class="toc-text">问题1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E6%9B%B4%E6%96%B0"><span class="toc-number">6.1.</span> <span class="toc-text">内容更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%982"><span class="toc-number">7.</span> <span class="toc-text">问题2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%983"><span class="toc-number">8.</span> <span class="toc-text">问题3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%984"><span class="toc-number">9.</span> <span class="toc-text">问题4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%984-%E6%9B%B4%E6%96%B0"><span class="toc-number">9.1.</span> <span class="toc-text">问题4 更新</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 TypeScript 创建 Koa 服务器"></a><div class="content"><a class="title" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器">使用 TypeScript 创建 Koa 服务器</a><time datetime="2025-10-11T06:00:11.000Z" title="发表于 2025-10-11 14:00:11">2025-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nodejs应用提取heap并加以分析的一些常用方法"></a><div class="content"><a class="title" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法">Nodejs应用提取heap并加以分析的一些常用方法</a><time datetime="2025-09-28T07:54:43.000Z" title="发表于 2025-09-28 15:54:43">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo25.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 小五</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=document.querySelectorAll("#article-container .chartjs-container");if(0===t.length)return;const e=(t,a)=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach((r=>{const n=t[r];"object"==typeof n&&null!==n&&(n[a]?t[r]=n[a]:e(n,a))}))},a=()=>{window.loadChartJS=!0,Array.from(t).forEach(((t,a)=>{const r=t.firstElementChild,n=t.getAttribute("data-chartjs-id")||"chartjs-"+a,d=t.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),e(i,m),new Chart(h,i)}))},r=()=>{window.loadChartJS?a():btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js").then(a)};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?r():document.addEventListener("DOMContentLoaded",r)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['link[rel="canonical"]','meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>e()))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404")}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.12.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.75.3/dist/instantsearch.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo25.jpg" alt="/img/nba-logo25.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo15.jpg" alt="/img/nba-logo15.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-04-06</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo17.jpg" alt="/img/nba-logo17.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="/img/nba-logo9.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" alt="/img/nba-logo30.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>