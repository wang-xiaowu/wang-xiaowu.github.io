<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>istio问题整理 | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="1. Service 端口命名约束Istio 支持多平台，不过 Istio 和 Kubernetes 的兼容性是最优的，不管是设计理念，核心团队还是社区，都有一脉相承的意思。但 Istio 和 Kubernetes 的适配并非完全没有冲突，一个典型问题就是 Istio 需要 Kubernetes service 按照协议进行端口命名（port naming）。 端口命名不满足约束而导致的流量异常，"><meta property="og:type" content="article"><meta property="og:title" content="istio问题整理"><meta property="og:url" content="https://xiaowu95.wang/posts/d3a1efad/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="1. Service 端口命名约束Istio 支持多平台，不过 Istio 和 Kubernetes 的兼容性是最优的，不管是设计理念，核心团队还是社区，都有一脉相承的意思。但 Istio 和 Kubernetes 的适配并非完全没有冲突，一个典型问题就是 Istio 需要 Kubernetes service 按照协议进行端口命名（port naming）。 端口命名不满足约束而导致的流量异常，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo26.jpg"><meta property="article:published_time" content="2024-02-02T07:43:36.000Z"><meta property="article:modified_time" content="2024-02-02T07:43:36.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="云原生"><meta property="article:tag" content="k8s"><meta property="article:tag" content="istio"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo26.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "istio问题整理",
  "url": "https://xiaowu95.wang/posts/d3a1efad/",
  "image": "https://xiaowu95.wang/img/nba-logo26.jpg",
  "datePublished": "2024-02-02T07:43:36.000Z",
  "dateModified": "2024-02-02T07:43:36.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "小五",
      "url": "https://xiaowu95.wang"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/d3a1efad/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0.33/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyloadPlugin:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"istio问题整理",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">554</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">168</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://gemini.google.com/"><span>🚀 Gemini</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo26.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">istio问题整理</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i> <span>返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://gemini.google.com/"><span>🚀 Gemini</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">istio问题整理<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/ServiceMesh/istio/istio问题整理.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-02T07:43:36.000Z" title="发表于 2024-02-02 15:43:36">2024-02-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-02T07:43:36.000Z" title="更新于 2024-02-02 15:43:36">2024-02-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/istio/">istio</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2024-02-02 15:43:36&quot;}" hidden></div><h1 id="1-Service-端口命名约束"><a href="#1-Service-端口命名约束" class="headerlink" title="1. Service 端口命名约束"></a>1. Service 端口命名约束</h1><p>Istio 支持多平台，不过 Istio 和 Kubernetes 的兼容性是最优的，不管是设计理念，核心团队还是社区，都有一脉相承的意思。但 Istio 和 Kubernetes 的适配并非完全没有冲突，一个典型问题就是 Istio 需要 Kubernetes service 按照协议进行端口命名（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://istio.io/latest/docs/ops/deployment/requirements/">port naming</a>）。</p><p>端口命名不满足约束而导致的流量异常，是使用 mesh 过程中最常见的问题，其现象是协议相关的流控规则不生效，这通常可以通过检查该 port LDS 中 filter 的类型来定位。</p><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>Kubernetes 的网络对应用层是无感知的，Kubernetes 的主要流量转发逻辑发生在 node 上，由 iptables&#x2F;ipvs 来实现，这些规则并不关心应用层里是什么协议。</p><p>Istio 的核心能力是对 7 层流量进行管控，但前提条件是 Istio 必须知道每个受管控的服务是什么协议，istio 会根据端口协议的不同，下发不同的流控功能（envoy filter），而 Kubernetes 资源定义里并不包括七层协议信息，所以 Istio 需要用户显式提供。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-11cec90ad0a9622e5cf95693ba1ce98a_720w.webp" title="img"><h2 id="istio-的解决方案：Protocol-sniffing"><a href="#istio-的解决方案：Protocol-sniffing" class="headerlink" title="istio 的解决方案：Protocol sniffing"></a>istio 的解决方案：Protocol sniffing</h2><p>协议嗅探概要：</p><ul><li>检测 TLS <code>CLIENT_HELLO</code> 提取 SNI、ALPN、NPN 等信息</li><li>基于常见协议的已知典型结构，尝试检测应用层 plaintext 内容 a. 基于<a target="_blank" rel="noopener external nofollow noreferrer" href="https://http2.github.io/http2-spec/#ConnectionHeader">HTTP2 spec: Connection Preface</a>，判断是否为 HTTP&#x2F;2 b. 基于 HTTP header 结构，判断是否是 HTTP&#x2F;1.x</li><li>过程中会设置超时控制和检测包大小限制， 默认按照协议 TCP 处理</li></ul><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>Protocol sniffing 减少了新手使用 istio 所需的配置，但是可能会带来不确定的行为。不确定的行为在生产环境中是应该尽量避免的。</p><p>一些嗅探失效的例子：</p><ul><li>客户端和服务端使用着某类非标准的七层协议，客户端和服务端都可以正确解析，但是不能确保 istio 自动嗅探逻辑认可这类非标准协议。比如对于 http 协议，标准的换行分隔是用 CRLF （<code>0x0d 0x0a</code>）, 但是大部分 http 类库会使用并认可 LF （<code>0x0a</code>）作为分隔。</li><li>某些自定义私有协议，数据流的起始格式和 http 报文格式类似，但是后续数据流是自定义格式：</li><li>未开启嗅探时：数据流按照 L4 TCP 进行路由，符合用户期望。</li><li>如果开启嗅探：数据流最开始会被认定为 L7 http 协议，但是后续数据不符合 http 格式，流量将被中断。</li></ul><p>建议生产环境不使用协议嗅探, 接入 mesh 的 service 应该按照约定使用协议前缀进行命名。</p><h1 id="2-流控规则下发顺序问题"><a href="#2-流控规则下发顺序问题" class="headerlink" title="2. 流控规则下发顺序问题"></a>2. 流控规则下发顺序问题</h1><h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>在批量更新流量规则的过程中，偶尔会出现流量异常（503），envoy 日志中 <code>RESPONSE_FLAGS</code> 包含「NR」标志(No route configured)，持续时间不长，会自动恢复。</p><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>当用户使用 <code>kubectl apply -f multiple-virtualservice-destinationrule.yaml</code> 时，这些对象的传播和生效先后顺序是不保证的，所谓最终一致性，比如 VirtualService 中引用了某一个 DestinationRule 定义的子版本，但是这个 DestinationRule 资源的传播和生效可能在时间上落后于 该 VirtualService 资源。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-8b3f434e90232fa2ce212ceb7b5cc4c3_720w.webp" title="img"><h2 id="最佳实践：make-before-break"><a href="#最佳实践：make-before-break" class="headerlink" title="最佳实践：make before break"></a>最佳实践：make before break</h2><p>将更新过程从批量单步拆分为多步骤，确保整个过程中不会引用不存在的 subset：</p><p>当新增 DestinationRule subset 时，应该先 apply DestinationRule subset，等待 subset 生效后，再 apply 引用了该 subset 的 VirtualService。</p><p>当删除 DestinationRule subset 时，应该先 删除 VirtualService 中对 该 subset 的引用，等待 VirtualService 的修改生效后，在执行删除 DestinationRule subset。</p><h1 id="3-请求中断分析"><a href="#3-请求中断分析" class="headerlink" title="3. 请求中断分析"></a>3. 请求中断分析</h1><p>请求异常，到底是 istio 流控规则导致，还是业务应用的返回，流量断点出现在哪个具体的 pod？</p><p>这是使用 mesh 最常见的困境，在微服务中引入 envoy 作为代理后，当流量访问和预期行为不符时，用户很难快速确定问题是出在哪个环节。客户端收到的异常响应，诸如 403、404、503 或者连接中断等，可能是链路中任一 sidecar 执行流量管控的结果， 但也有可能是来自某个服务的合理逻辑响应。</p><h2 id="Envoy-流量模型"><a href="#Envoy-流量模型" class="headerlink" title="Envoy 流量模型"></a>Envoy 流量模型</h2><p>Envoy 接受请求流量叫做 <strong>Downstream</strong>，Envoy 发出请求流量叫做<strong>Upstream</strong>。在处理Downstream 和 Upstream 过程中， 分别会涉及2个流量端点，即请求的发起端和接收端：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-1bee9b0f29a984427527c8af54656372_720w.webp" title="img"><p>在这个过程中， envoy 会根据用户规则，计算出符合条件的转发目的主机集合，这个集合叫做 <strong>UPSTREAM_CLUSTER</strong>, 并根据负载均衡规则，从这个集合中选择一个 host 作为流量转发的接收端点，这个 host 就是 <strong>UPSTREAM_HOST</strong>。</p><p>以上就是 envoy 请求处理的 <strong>流量五元组信息</strong>， 这是 envoy 日志里最重要的部分，通过这个五元组我们可以准确的观测流量「从哪里来」和「到哪里去」。</p><ul><li>UPSTREAM_CLUSTER</li><li>DOWNSTREAM_REMOTE_ADDRESS</li><li>DOWNSTREAM_LOCAL_ADDRESS</li><li>UPSTREAM_LOCAL_ADDRESS</li><li>UPSTREAM_HOST</li></ul><h2 id="日志分析示例"><a href="#日志分析示例" class="headerlink" title="日志分析示例"></a>日志分析示例</h2><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-d5e89db9712ed2fbd0c943a463b2a8d2_720w.webp" title="img"><p>通过日志重点观测 2 个信息：</p><ul><li>断点是在哪里 ？</li><li>原因是什么？</li></ul><p>示例一：一次正常的 client-server 请求：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-df70ab71879a8f468941ee4f676c691c_720w.jpeg" title="img"><p>可以看到 2 端日志包含相同的 request ID，因此可以将流量分析串联起来。</p><p>示例二：no healthy upstream, 比如目标 deployment 健康副本数为 0</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-3c4f66684d714fe6e6e98e1ad3453136_720w.webp" title="img"><p>日志中 flag「UH」表示 upstream cluster 中没有健康的 host。</p><p>示例三：No route configured , 比如 DestinationRule 缺乏对应的 subset</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-70b0011cda71e471928288aaeec1f75a_720w.webp" title="img"><p>日志中 flag「NR」表示找不到路由。</p><p>示例四，Upstream connection failure，比如服务未正常监听端口。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-08f71207cc96235764f7cf2aec21c8f5_720w.webp" title="img"><p>日志中 flag「UF」表示 Upstream 连接失败，据此可以判断出流量断点位置。</p><h1 id="4-sidecar-和-user-container-启动顺序"><a href="#4-sidecar-和-user-container-启动顺序" class="headerlink" title="4. sidecar 和 user container 启动顺序"></a>4. sidecar 和 user container 启动顺序</h1><h2 id="异常描述-1"><a href="#异常描述-1" class="headerlink" title="异常描述"></a>异常描述</h2><p>Sidecar 模式在 kubernetes 世界很流行，在1.18中之后有了 sidecar 的概念，sidecar 容器的角色是用户主观赋予的。</p><p>对 Istio 用户来说，一个常见的困扰是：sidecar 和用户容器的启动顺序：</p><p>sidecar（envoy） 和用户容器的启动顺序是不确定的，如果用户容器先启动了，envoy 还未完成启动，这时候用户容器往外发送请求，请求仍然会被拦截，发往未启动的 envoy，请求异常。</p><p>在 Pod 终止阶段，也会有类似的异常，根源仍然是 sidecar 和普通容器的生命周期的不确定性。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-f8fd212ef4ad162b9986ca5655ee9886_720w.webp" title="img"><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>目前常规的规避方案主要是有这样几种：</p><ul><li>业务容器延迟几秒启动, 或者失败重试</li><li>启动脚本中主动探测 envoy 是否ready，如 <code>127.0.0.1:15020/healthz/ready</code></li></ul><p>无论哪种方案都显得很蹩脚，为了彻底解决上述痛点，从 kubernetes 1.18版本开始，kubernetes 内置的 Sidecar 功能将确保 sidecar 在正常业务流程开始之前就启动并运行，即通过更改pod的启动生命周期，在init容器完成后启动sidecar容器，在sidecar容器就绪后启动业务容器，从启动流程上保证顺序性。而 Pod 终止阶段，只有当所有普通容器都已到达终止状态（Succeeded for restartPolicy&#x3D;OnFailure 或 Succeeded&#x2F;Failed for restartPolicy&#x3D;Never），才会向sidecar 容器发送 SIGTERM 信号。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-065b3bf15ee802feec8455a908f9d46a_720w.webp" title="img"><h1 id="5-Ingress-Gateway-和-Service-端口联动"><a href="#5-Ingress-Gateway-和-Service-端口联动" class="headerlink" title="5. Ingress Gateway 和 Service 端口联动"></a>5. Ingress Gateway 和 Service 端口联动</h1><p>Ingress Gateway 规则不生效的一个常见原因是：Gateway 的监听端口在对应的 kubernetes Service 上没有开启，首先我们需要理解 Istio Ingress Gateway 和 kubernetes Service 的关系：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-6c6642e6dcab9feb3d2965718692563c_720w.webp" title="img"><p>上图中，虽然 gateway 定义期望管控端口 b 和 c，但是它对应的 service （通过腾讯云CLB）只开启了端口 a 和 b，因此最终从 LB 端口 b 进来的流量才能被 istio gateway 管控。</p><ul><li>Istio Gateway 和 kubernetes Service 没有直接的关联，二者都是通过 selector 去绑定 pod，实现间接关联。</li><li>Istio CRD Gateway 只实现了将用户流控规则下发到网格边缘节点，流量仍需要通过 LB 控制才能进入网格。</li><li>腾讯云 tke mesh 实现了 Gateway-Service 定义中的 Port 动态联动，让用户聚焦在网格内的配置。</li></ul><h1 id="6-VirtualService-作用域"><a href="#6-VirtualService-作用域" class="headerlink" title="6. VirtualService 作用域"></a>6. VirtualService 作用域</h1><p>VirtualService 包含了大部分 outbound 端的流量规则，它既可以应用到网格内部数据面代理中， 也可以应用到网格边缘的代理中。</p><p>VirtualService 的属性<code>gateways</code>用于指定 VirtualService 的生效范围：</p><ul><li>如果 <code>VirtualService.gateways</code>为空，则 istio 为其赋默认值 <code>mesh</code>, 代表生效范围为网格内部。</li><li>如果希望 VirtualService 应用到具体边缘网关上，则需要显示为其赋值：<code>gateway-name1,gateway-name2...</code>。</li><li>如果希望 VirtualService 同时应用到网格内部和边缘网关上，则需要显示地把<code>mesh</code>值加入<code>VirtualService.gateways</code>， 如 <code>mesh,gateway-name1,gateway-name2...</code>。</li></ul><p>一个常见的问题是以上的第三种情况，VirtualService 最开始作用于网关内部，后续要将其规则扩展到边缘网关上，用户往往只会添加具体 gateway name，而遗漏 <code>mesh</code>:</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-649e4f1574b37fb4ca2c5aa1d8d28cb4_720w.webp" title="img"><p>Istio 自动给<code>VirtualService.gateways</code>设置默认值， 本意是为了简化用户的配置，但是往往会导致用户应用不当，一个 feature 一不小心会被用成了 bug。</p><h1 id="7-VirtualService-不支持-host-fragment"><a href="#7-VirtualService-不支持-host-fragment" class="headerlink" title="7. VirtualService 不支持 host fragment"></a>7. VirtualService 不支持 host fragment</h1><h2 id="异常案例："><a href="#异常案例：" class="headerlink" title="异常案例："></a>异常案例：</h2><p>对某一 host 新增、修改 VirtualService，发现规则始终无法生效，排查发现存在其他 VirtualService 也对该 host 应用了其他规则，规则内容可能不冲突，但还是可能出现其中一些规则无法生效的情况。</p><h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><ul><li>VirtualService 里的规则，按照 host 进行聚合。</li><li>随着业务的增长，VirtualService 的内容会快速增长，一个 host 的流控规则，可能会由不同的团队分布维护。如安全规则和业务规则分开，不同业务按照子 path 分开。</li></ul><p>目前 istio 对 cross-resource VirtualService 的支持情况：</p><ul><li>在网格边缘（gateway），同一个 host 的流控规则，支持分布到多个 VirtualService 对象中，istio 自动聚合，但依赖定义顺序以及用户自行避免冲突。</li><li>在网格内部（for sidecar），同一个 host 的流控规则，不支持分布到多个 VirtualService 对象中，如果同一个 host 存在多个 VirtualService，只有第一个 VirtualService 生效，且没有冲突检测。</li></ul><p>VirtualService 不能很好支持 host 规则分片，使得团队的维护职责不能很好的解耦，配置人员需要知悉目标 host 的所有流控规则，才有信心去修改 VirtualService。</p><h2 id="Istio-解决方案：VirtualService-chaining（plan-in-1-6）"><a href="#Istio-解决方案：VirtualService-chaining（plan-in-1-6）" class="headerlink" title="Istio 解决方案：VirtualService chaining（plan in 1.6）"></a>Istio 解决方案：VirtualService chaining（plan in 1.6）</h2><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-9652d1d5cdb45bb58d879ef0581c69ec_720w.webp" title="img"><p>Istio 在 1.6 中支持了 VirtualService 代理链：</p><ul><li>VirtualService 支持分片定义 + 代理链</li><li>支持团队对同一 host 的 VirtualService 进行灵活分片，比如按照 SecOps&#x2F;Netops&#x2F;Business 特性分离，各团队维护各种独立的 VirtualService</li></ul><h1 id="8-全链路跟踪并非完全透明接入"><a href="#8-全链路跟踪并非完全透明接入" class="headerlink" title="8. 全链路跟踪并非完全透明接入"></a>8. 全链路跟踪并非完全透明接入</h1><h2 id="异常案例"><a href="#异常案例" class="headerlink" title="异常案例"></a>异常案例</h2><p>微服务接入后 service mesh 后，链路跟踪数据没有形成串联。</p><h2 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h2><p>service mesh 遥测系统中，对调用链跟踪的实现，并非完全的零入侵，需要用户业务作出少量的修改才能支持，具体地，在用户发出（http&#x2F;grpc） RPC 时， 需要主动将上游请求中存在的 <code>B3 trace headers</code>写入下游 RPC 请求头中，这些 headers 包括：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-00e0b200a33460978c31c5d8578beb40_720w.jpeg" title="img"><p>有部分用户难以理解：既然 inbound 流量和 outbound 流量已经完全被拦截到 envoy，envoy 可以实现完全的流量管控和修改，为什么还需要应用显示第传递 headers？</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-b2bd42dafee291404226e3e053f47bf6_720w.webp" title="img"><p>对于 envoy 来说，inbound 请求和 outbound 请求完全是独立的，envoy 无法感知请求之间的关联。实际上这些请求到底有无上下级关联，完全由应用自己决定。</p><p>举一个特殊的业务场景，如果 Pod X 接收到 请求 A，触发的业务逻辑是：每隔 10 秒 发送一个请求到 Pod Y，如 B1，B2，B3，那么这些扇出的请求 Bx（x&#x3D;1,2,3...），和请求 A 是什么关系？业务可能有不同的决策：认为 A 是 Bx 的父请求，或者认为 Bx 是独立的顶层请求。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-11a39f7504ee8a2d83a06c0fac001111_720w.webp" title="img"><h1 id="9-mTLS-导致连接中断"><a href="#9-mTLS-导致连接中断" class="headerlink" title="9. mTLS 导致连接中断"></a>9. mTLS 导致连接中断</h1><p>在开启 istio mTLS 的用户场景中，访问出现 <code>connection termination</code> 是一个高频的异常：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl helloworld:4000/hello -i</span></span><br><span class="line">HTTP/1.1 503 Service Unavailable</span><br><span class="line"></span><br><span class="line">upstream connect error or disconnect/reset before headers</span><br><span class="line">reset reason: connection termination</span><br></pre></td></tr></table></figure><p>Envoy 访问日志中可以看到 &quot;UC&quot; 错误标识：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;upstrean_local_address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;downstrean_local_address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.16.254.233:4000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;route_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;response_codo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;503&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user_agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/7.64.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;response_flags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-02-12T04:30:21.628Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request.id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;e116814a-e689-9d26-81eb-5455fal09571&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.16.0.15:5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|4000|vl|helloworld.default.svc.cluster.local&quot;</span></span><br><span class="line">    ......</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这个异常的原因和 DestinationRule 中的 mTLS 配置有关，是 istio 中一个不健壮的接口设计。</p><ul><li>当通过 MeshPolicy 开启全局 mTLS， 如果网格中没有定义其他的 DestinationRule，mTLS 正常运行</li><li>如果后续网格中新增了 DestinationRule，而 DestinationRule 中可以覆盖子版本的 mTLS 值(默认是不开启！), 用户在使用 DestinationRule 时，往往很少去关注 mTLS 属性（留空）。最终导致增 DestinationRule 后 mTLS 变成了不开启，导致<code>connection termination</code></li><li>为了修复以上问题，用户不得不在所有 DestinationRule 中增加 mTLS 属性并设置为开启</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/vlalpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">helloworld</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br><span class="line">   <span class="attr">subsets:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vl</span></span><br><span class="line">       <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">version:</span> <span class="string">vl</span></span><br></pre></td></tr></table></figure><p>这种 istio mtls 用户接口极度不友好，虽然 mtls 默认做到了全局透明， 业务感知不到 mtls 的存在， 但是一旦业务定义了 DestinationRule，DestinationRule 就必须要知道当前 mtls 是否开启，并作出调整。试想 mtls 配置交由安全团队负责，而业务团队负责各自的 DestinationRule，团队间的耦合会非常严重。</p><h1 id="10-用户服务监听地址限制"><a href="#10-用户服务监听地址限制" class="headerlink" title="10. 用户服务监听地址限制"></a>10. 用户服务监听地址限制</h1><h2 id="异常描述-2"><a href="#异常描述-2" class="headerlink" title="异常描述"></a>异常描述</h2><p>如果用户容器中业务进程监听的地址是具体ip (pod ip)，而不是<code>0.0.0.0</code>, 该用户容器无法正常接入 istio，流量路由失败。</p><p>这是又一个挑战 Istio 最大透明化（Maximize Transparency）<a target="_blank" rel="noopener external nofollow noreferrer" href="https://istio.io/docs/ops/deployment/architecture/#design-goals">设计目标</a> 的场景。</p><h2 id="原因分析-1"><a href="#原因分析-1" class="headerlink" title="原因分析"></a>原因分析</h2><p><code>istio-proxy</code> 中的一段 iptables:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Chain ISTIO_OUTPUT &#123;1 references)</span><br><span class="line">   target      port  opt <span class="built_in">source</span>       destination</span><br><span class="line">1. RETURN      all   —- 127.0.0.6     anywhere</span><br><span class="line">2. ISTIO_IN_REDIRECT all -— anywhere  !localhost</span><br><span class="line">3. RETURN      all   -— anywhere      anywhere  owner UID match istio-proxy</span><br><span class="line">4. RETURN      all   -— anywhere      anywhere  owner GID match istio-proxy</span><br><span class="line">5. RETURN      all   -— anywhere      localhost</span><br><span class="line">6. ISTIO_REDIRECT all -— anywhere     anywhere</span><br></pre></td></tr></table></figure><p>其中，<code>ISTIO_IN_REDIRECT</code> 是 virtualInbound, 端口 15006；<code>ISTIO_REDIRECT</code> 是 virtualOutbound，端口 15001。</p><p>关键点是规则二：如果destination不是127.0.0.1&#x2F;32, 转给15006(virtualInbound, envoy监听)，这里导致了对 pod ip 的流量始终会回到 envoy。</p><p>对该规则的解释：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Redirect app calls back to itself via Envoy when using the service VIP or endpoint</span><br><span class="line">address, e.g. appN =&gt; Envoy (client) =&gt; Envoy (server) =&gt; appN.</span><br></pre></td></tr></table></figure><p>该规则是希望在这里起作用: 假设当前Pod a属于service A, Pod 中用户容器通过服务名访问服务A, envoy中负载均衡逻辑将这次访问转发到了当前的pod ip, istio 希望这种场景服务端仍然有流量管控能力. 如图示:</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-0aef8a578857af69f23eee4d62f6b567_720w.webp" title="img"><h2 id="改造建议"><a href="#改造建议" class="headerlink" title="改造建议"></a>改造建议</h2><p>建议应用在接入 istio 之前，调整服务监听地址，使用 <code>0.0.0.0</code> 而不是具体 IP。 如果业务方认为改造难度大，可以参考另一篇istio中问题解决方案：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://zhonghua.io/2019/07/11/istio-xds-podip/">服务监听pod ip 在 istio 中路由异常分析</a></p><h1 id="11-状态码404-Not-Found-或是nginx下游服务路由规则不生效"><a href="#11-状态码404-Not-Found-或是nginx下游服务路由规则不生效" class="headerlink" title="11. 状态码404: Not Found, 或是nginx下游服务路由规则不生效"></a>11. 状态码404: Not Found, 或是nginx下游服务路由规则不生效</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>前端pod1静态资源访问正常，但请求通过pod1中的nginx配置转发到后端pod2后，返回404；</p><h2 id="有问题的nginx配置"><a href="#有问题的nginx配置" class="headerlink" title="有问题的nginx配置"></a>有问题的nginx配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /v1/ &#123;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host  <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://ppap.test.svc.cluster.local.:8080/v1/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="方案1-修改nginx配置"><a href="#方案1-修改nginx配置" class="headerlink" title="方案1: 修改nginx配置"></a>方案1: 修改nginx配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /v1/ &#123;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="string">&quot;ppap&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://ppap.test.svc.cluster.local.:8080/v1/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="方案2-修改VS配置-配置多host支持"><a href="#方案2-修改VS配置-配置多host支持" class="headerlink" title="方案2: 修改VS配置, 配置多host支持"></a>方案2: 修改VS配置, 配置多host支持</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ppap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ppap.test.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">$http_host(这里的httphost代指对外提供访问的域名/ip)</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>将$http_host修改为对应service名后，问题解决了，但这个问题因人而异，只能提供一个思路</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://discuss.istio.io/t/nginx-proxy-pass-to-istio-ingress-gateway-404/4330/6">Nginx Proxy Pass to Istio Ingress Gateway 404</a></p><h1 id="12-istio-常见问题-返回-426-状态码"><a href="#12-istio-常见问题-返回-426-状态码" class="headerlink" title="12. istio 常见问题: 返回 426 状态码"></a>12. istio 常见问题: 返回 426 状态码</h1><blockquote><p>本文摘自 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://imroc.cc/learning-istio/faq/426-status-code.html">istio 学习笔记</a></p></blockquote><h2 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h2><p>Istio 使用 Envoy 作为数据面转发 HTTP 请求，而 Envoy 默认要求使用 HTTP&#x2F;1.1 或 HTTP&#x2F;2，当客户端使用 HTTP&#x2F;1.0 时就会返回 <code>426 Upgrade Required</code>。</p><h2 id="常见的-nginx-场景"><a href="#常见的-nginx-场景" class="headerlink" title="常见的 nginx 场景"></a>常见的 nginx 场景</h2><p>如果用 nginx 进行 <code>proxy_pass</code> 反向代理，默认会用 HTTP&#x2F;1.0，你可以显示指定 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version">proxy_http_version</a> 为 <code>1.1</code>:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> http_backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive</span> <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /http/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://http_backend;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="压测场景"><a href="#压测场景" class="headerlink" title="压测场景"></a>压测场景</h2><p>ab 压测时会发送 HTTP&#x2F;1.0 的请求，Envoy 固定返回 426 Upgrade Required，根本不会进行转发，所以压测的结果也不会准确。可以换成其它压测工具，如 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wg/wrk">wrk</a> 。</p><h2 id="让-istio-支持-HTTP-1-0"><a href="#让-istio-支持-HTTP-1-0" class="headerlink" title="让 istio 支持 HTTP&#x2F;1.0"></a>让 istio 支持 HTTP&#x2F;1.0</h2><p><del>有些 SDK 或框架可能会使用 HTTP&#x2F;1.0 协议，比如使用 HTTP&#x2F;1.0 去资源中心&#x2F;配置中心拉取配置信息，在不想改动代码的情况下让服务跑在 istio 上，也可以修改 istiod 配置，加上 <code>PILOT_HTTP10: 1</code> 的环境变量来启用 HTTP&#x2F;1.0。</del></p><p>使用<code>istioctl manifest apply --set values.pilot.env.PILOT_HTTP10=1</code></p><p>参考:</p><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/istio/istio/issues/13085">issue相关</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://istio.io/latest/zh/docs/reference/config/istio.operator.v1alpha1/#KubernetesResourcesSpec">资源属性</a></li></ul><h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://istio.io/latest/docs/ops/common-problems/network-issues/#envoy-won-t-connect-to-my-http-1-0-service">Envoy won’t connect to my HTTP&#x2F;1.0 service</a></li></ul><h1 id="13-前端js文件报错"><a href="#13-前端js文件报错" class="headerlink" title="13. 前端js文件报错"></a>13. 前端js文件报错</h1><h2 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h2><p>前端两个版本的deployment，由一个service代理；不通过istio网关时，访问前端页面js报错，且每次刷新错误的js不同</p><h2 id="原因-2"><a href="#原因-2" class="headerlink" title="原因"></a>原因</h2><p>两个版本的前端podA和podB不通过istio网关对版本进行路由时，静态资源请求会负载均衡的进入podA和podB。</p><p>但是podB中并没有podA的静态资源，podA中也没有podB的静态资源，所以当对podA访问podB的静态资源时会报错。</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/v2-f1077b068c24a24b4d28871f4d47b797_720w.webp" title="img"><h1 id="14-no-healthy-upstream"><a href="#14-no-healthy-upstream" class="headerlink" title="14. no healthy upstream"></a>14. no healthy upstream</h1><h2 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h2><blockquote><p>upstream是Envoy中的术语，Envoy就是istio所使用的sidecar</p></blockquote><ul><li><p>Downstream&#x2F;下游：下游主机连接到 Envoy，发送请求并接收响应。</p></li><li><p>Upstream&#x2F;上游：上游主机接收来自 Envoy 的连接和请求，并返回响应。</p></li></ul><h2 id="原因-3"><a href="#原因-3" class="headerlink" title="原因"></a>原因</h2><p>no healthy upstream的原因有很多，但是归根结底是Envoy找不到目标了~</p><p>原因之一</p><ul><li>两个VirtualService都配了gateways，导致流量进来不知道去哪个svc，因此删掉一个gateways即可</li></ul><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-frontend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ppap</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ppap-gateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">user_id:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="number">952795279527</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">test-frontend</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">test-frontend</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ppap</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test-backend</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">user_id:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="number">952795279527</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">test-backend</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">test-backend</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><blockquote><p>两个VirtualService区别之处就在</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ppap-gateway</span></span><br></pre></td></tr></table></figure><p>当两个VirtualService挂载同一个gateways便会报错</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://link.zhihu.com/?target=https://www.servicemesher.com/envoy/about_docs.html" rel="external nofollow noreferrer">Envoy中文文档</a></li></ul><h1 id="15-如何在隔离环境安装istio"><a href="#15-如何在隔离环境安装istio" class="headerlink" title="15. 如何在隔离环境安装istio"></a>15. 如何在隔离环境安装istio</h1><blockquote><p>通常现网机器不能直连外网，所以istio的安装是个问题，下面是一个思路</p></blockquote><ul><li>将镜像传到可以访问的镜像仓库</li><li>通过设定istioctl安装的hub进行安装</li><li>istioctl本身通过文件直接传到对应的机器上即可</li></ul><h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> hub=my-hub.cn/istio --<span class="built_in">set</span> namespace=istio-system --<span class="built_in">set</span> components.pilot.k8s.hpaSpec.minReplicas=2 --<span class="built_in">set</span> components.ingressGateways[0].name=istio-ingressgateway --<span class="built_in">set</span> components.ingressGateways[0].k8s.hpaSpec.minReplicas=2 --<span class="built_in">set</span> components.ingressGateways[0].k8s.service.type=NodePort -y</span><br></pre></td></tr></table></figure><h1 id="16-解决istio-proxy使用了资源配额导致新建pod处于pending状态的问题-No-preemption-victims-found-for-incoming-pod"><a href="#16-解决istio-proxy使用了资源配额导致新建pod处于pending状态的问题-No-preemption-victims-found-for-incoming-pod" class="headerlink" title="16. 解决istio-proxy使用了资源配额导致新建pod处于pending状态的问题(No preemption victims found for incoming pod)"></a>16. 解决istio-proxy使用了资源配额导致新建pod处于pending状态的问题(<code>No preemption victims found for incoming pod</code>)</h1><h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>创建的pod一直在pending状态</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/2746159402ee468abdd38e4ebd4256c8.png" title="在这里插入图片描述"><p>使用 kubectl describe po 查看下原因</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe po istio-springboot-demo-b-v1-7cf6979bbd-ct8kr -n istio-demos</span><br></pre></td></tr></table></figure><p>输出的原因部分如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  3m    default-scheduler  0/1 nodes are available: 1 Insufficient cpu. preemption: 0/1 nodes are available: 1 No preemption victims found <span class="keyword">for</span> incoming pod.</span><br></pre></td></tr></table></figure><p>从Message看，很明显是cpu不够不了，无法调度。为什么会这样呢？<br>通过下面的步骤查看下node的信息<br>先查看node</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get nodes</span><br><span class="line">NAME             STATUS   ROLES           AGE   VERSION</span><br><span class="line">xxx   Ready    control-plane   21d   v1.24.1</span><br></pre></td></tr></table></figure><p>再通过下面的命令的查看po使用cpu和内在的情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node xxx</span><br><span class="line">Capacity:</span><br><span class="line">  cpu:                2</span><br><span class="line">  ephemeral-storage:  61255492Ki</span><br><span class="line">  hugepages-1Gi:      0</span><br><span class="line">  hugepages-2Mi:      0</span><br><span class="line">  memory:             8049416Ki</span><br><span class="line">  pods:               110</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                2</span><br><span class="line">  ephemeral-storage:  56453061334</span><br><span class="line">  hugepages-1Gi:      0</span><br><span class="line">  hugepages-2Mi:      0</span><br><span class="line">  memory:             7947016Ki</span><br><span class="line">  pods:               110</span><br><span class="line">System Info:</span><br><span class="line">  Machine ID:                 7679dc44-ba20-41de-afe7-6131f6cdfb01</span><br><span class="line">  System UUID:                25cc4672-0000-0000-aaf7-f9f722a48b3c</span><br><span class="line">  Boot ID:                    72f1a678-b1e3-435a-a235-409592f5bf2b</span><br><span class="line">  Kernel Version:             5.10.104-linuxkit</span><br><span class="line">  OS Image:                   Docker Desktop</span><br><span class="line">  Operating System:           linux</span><br><span class="line">  Architecture:               amd64</span><br><span class="line">  Container Runtime Version:  docker://20.10.17</span><br><span class="line">  Kubelet Version:            v1.24.1</span><br><span class="line">  Kube-Proxy Version:         v1.24.1</span><br><span class="line">Non-terminated Pods:          (20 <span class="keyword">in</span> total)</span><br><span class="line">  Namespace                   Name                                               CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age</span><br><span class="line">  ---------                   ----                                               ------------  ----------  ---------------  -------------  ---</span><br><span class="line">  istio-demos                 demo-istio-h5-latest-848b989c99-7rbv7              100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6m34s</span><br><span class="line">  istio-demos                 demo-istio-h5-v1-7fc5575845-5r28k                  100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6m34s</span><br><span class="line">  istio-demos                 istio-springboot-demo-a-latest-64d5cf969f-6r7pf    100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6m22s</span><br><span class="line">  istio-demos                 istio-springboot-demo-a-v1-7d64cc6578-n6rs7        100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6m22s</span><br><span class="line">  istio-system                grafana-6787c6fb46-jklbh                           0 (0%)        0 (0%)      0 (0%)           0 (0%)         6d13h</span><br><span class="line">  istio-system                istio-egressgateway-679565ff87-g8lq7               100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6d14h</span><br><span class="line">  istio-system                istio-ingressgateway-b67d7948d-wfxgb               100m (5%)     2 (100%)    128Mi (1%)       1Gi (13%)      6d14h</span><br><span class="line">  istio-system                istiod-645c8d8598-qmslz                            500m (25%)    0 (0%)      2Gi (26%)        0 (0%)         6d14h</span><br><span class="line">  istio-system                jaeger-5b994f64f4-gvcqt                            10m (0%)      0 (0%)      0 (0%)           0 (0%)         6d13h</span><br><span class="line">  istio-system                kiali-565bff499-bfrhr                              0 (0%)        0 (0%)      0 (0%)           0 (0%)         6d13h</span><br><span class="line">  istio-system                prometheus-74cd54db7f-flppp                        0 (0%)        0 (0%)      0 (0%)           0 (0%)         6d13h</span><br><span class="line">  kube-system                 coredns-6d4b75cb6d-5rqbc                           100m (5%)     0 (0%)      70Mi (0%)        170Mi (2%)     21d</span><br><span class="line">  kube-system                 coredns-6d4b75cb6d-wdh6b                           100m (5%)     0 (0%)      70Mi (0%)        170Mi (2%)     6d14h</span><br><span class="line">  kube-system                 etcd-docker-desktop                                100m (5%)     0 (0%)      100Mi (1%)       0 (0%)         21d</span><br><span class="line">  kube-system                 kube-apiserver-docker-desktop                      250m (12%)    0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">  kube-system                 kube-controller-manager-docker-desktop             200m (10%)    0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">  kube-system                 kube-proxy-tnb9q                                   0 (0%)        0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">  kube-system                 kube-scheduler-docker-desktop                      100m (5%)     0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">  kube-system                 storage-provisioner                                0 (0%)        0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">  kube-system                 vpnkit-controller                                  0 (0%)        0 (0%)      0 (0%)           0 (0%)         21d</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  Resource           Requests      Limits</span><br><span class="line">  --------           --------      ------</span><br><span class="line">  cpu                1960m (98%)   12 (600%)</span><br><span class="line">  memory             3056Mi (39%)  6484Mi (83%)</span><br><span class="line">  ephemeral-storage  0 (0%)        0 (0%)</span><br><span class="line">  hugepages-1Gi      0 (0%)        0 (0%)</span><br><span class="line">  hugepages-2Mi      0 (0%)        0 (0%)</span><br><span class="line">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure><p>可以看到几个用于istio测试的demo的pod都有使用配额，从其中挑选一个pod进行查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe po istio-springboot-demo-a-latest-64d5cf969f-6r7pf -n istio-demos</span><br></pre></td></tr></table></figure><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/fa1f9b1c5900431886b6b57470ae975d.png" title="在这里插入图片描述"><p>找到了使用配额的容器，原来是istio的代理容器(sidecar) : istio-proxy</p><h2 id="调整istio关于sidecar的资源配额参数"><a href="#调整istio关于sidecar的资源配额参数" class="headerlink" title="调整istio关于sidecar的资源配额参数"></a>调整istio关于sidecar的资源配额参数</h2><h2 id="查找参数配置"><a href="#查找参数配置" class="headerlink" title="查找参数配置"></a>查找参数配置</h2><p>后来在istio安装包找到关于proxy相关的资源配额参数，文件路径：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/istio/istio/tree/master/manifests/charts/istio-control/istio-discovery/values.yaml">https://github.com/istio/istio/tree/master/manifests/charts/istio-control/istio-discovery/values.yaml</a><br>resources相关参数：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/6b9f6b69a5834c0fb4111db99ee8f4bd.png" title="在这里插入图片描述"><h2 id="动态调整"><a href="#动态调整" class="headerlink" title="动态调整"></a>动态调整</h2><p>然后找到了参数所在的文件对于已经在运行的istio环境也无能为力，因为改文件中的参数并不能应用于正在运行的istio环境中，后面找了好久，终于找到一篇华为的文章： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://support.huaweicloud.com/asm_faq/asm_faq_0027.html">如何调整istio-proxy容器resources requests取值？</a></p><p>这里记录一下</p><h3 id="方法一：调整网格中的所有服务"><a href="#方法一：调整网格中的所有服务" class="headerlink" title="方法一：调整网格中的所有服务"></a>方法一：调整网格中的所有服务</h3><p>调整后，对已经创建的istio-proxy并不会做改动，但是之后创建的istio-proxy将会使用调整后的参数。</p><ol><li><p>执行以下命令修改comfigmap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm istio-sidecar-injector -n istio-system</span><br></pre></td></tr></table></figure></li></ol><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/0feeb7bdf80f40f5afdde20c124069e0.png" title="在这里插入图片描述"><p>可以调整配额大小，<del>也可以删除掉</del>, 这里最好是调整配额, 我使用rancher安装istio, 删除了这里后启动服务失败了。</p><ol><li>重启istio-sidecar-injector Pod。</li><li>重启业务服务Pod，多实例滚动升级不会断服。</li></ol><h3 id="方法二：调整网格中的某个服务"><a href="#方法二：调整网格中的某个服务" class="headerlink" title="方法二：调整网格中的某个服务"></a>方法二：调整网格中的某个服务</h3><ol start="0"><li>通过value.yaml发现，默认资源使用几个annoation调整的，如下</li></ol><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/image-20230524140423848.png" title="image-20230524140423848"><p>如果是通过rancher安装，可以按如下步骤找到values.yaml</p><blockquote><ol><li>登录 Rancher 界面，选择 Istio 所在的项目；</li><li>在左侧导航栏中选择 &quot;Apps &amp; Marketplaces&quot;，然后选择 &quot;Installed Apps&quot;；</li><li>找到 Istio 应用程序，然后单击它；</li><li>在右侧的面板中，选择 &quot;View YAML&quot;；</li><li>在打开的 YAML 文件中，你可以找到和修改 <code>values.yaml</code> 文件。</li></ol></blockquote><ol><li><p>所以我们可以修改服务的yaml文件<br>命令格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deploy &lt;nginx&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure><p>本次实验在namespace istio-demos进行，查看namespace下的deployment</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy -n istio-demos</span><br></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">saleson@SalesondeMacBook-Pro istio-discovery % kubectl get deploy -n istio-demos</span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">demo-istio-h5-latest             1/1     1            1           3h59m</span><br><span class="line">demo-istio-h5-v1                 1/1     1            1           3h59m</span><br><span class="line">istio-springboot-demo-a-latest   1/1     1            1           3h58m</span><br><span class="line">istio-springboot-demo-a-v1       1/1     1            1           3h58m</span><br><span class="line">istio-springboot-demo-b-latest   1/1     1            1           27m</span><br><span class="line">istio-springboot-demo-b-v1       1/1     1            1           27m</span><br></pre></td></tr></table></figure><p>使用下命令进入istio-springboot-demo-b-v1的编辑面板：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deploy istio-springboot-demo-b-v1 -n istio-demos</span><br><span class="line">在spec.template.metadata.annotations下添加如下配置（大小仅供参考，请自行替换）</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sidecar.istio.io/proxyCPU: 100m</span><br><span class="line">   sidecar.istio.io/proxyCPULimit: 100m</span><br><span class="line">   sidecar.istio.io/proxyMemory: 500Mi</span><br><span class="line">   sidecar.istio.io/proxyMemoryLimit: 500Mi</span><br></pre></td></tr></table></figure><p>编辑保存后的结果如下：</p><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/98af76954ed0416ab788e781c9accef3.png" title="在这里插入图片描述"></li><li><p>修改后服务滚动升级，确保不会断服<br>执行如下命令重启deployment</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart deployment istio-springboot-demo-b-v1 -n istio-demos</span><br></pre></td></tr></table></figure></li><li><p>查看修改后的结果<br>使用下面的命令查看修改后的配额</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node docker-desktop</span><br></pre></td></tr></table></figure><img src="/img/loading.gif" data-lazy-src="/posts/d3a1efad/5f574a71b2e24deeb13fb077ec266870.png" title="在这里插入图片描述"></li></ol><h2 id="提前规划"><a href="#提前规划" class="headerlink" title="提前规划"></a>提前规划</h2><p>先调整 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/istio/istio/tree/master/manifests/charts/istio-control/istio-discovery/values.yaml">https://github.com/istio/istio/tree/master/manifests/charts/istio-control/istio-discovery/values.yaml</a> 中关于proxy的配额，再安装istio-discovery</p><h1 id="17-在Istio中使用preStop钩子时，可能会出现sleep命令不起作用的情况"><a href="#17-在Istio中使用preStop钩子时，可能会出现sleep命令不起作用的情况" class="headerlink" title="17. 在Istio中使用preStop钩子时，可能会出现sleep命令不起作用的情况"></a>17. 在Istio中使用<code>preStop</code>钩子时，可能会出现<code>sleep</code>命令不起作用的情况</h1><p>在Kubernetes中，Pod中的<code>preStop</code>钩子会在Pod被终止之前被调用。<code>preStop</code>钩子可以用来在Pod终止之前执行一些清理操作，例如保存状态、关闭连接、删除临时文件等等。</p><p>在Istio中使用<code>preStop</code>钩子时，如果在<code>preStop</code>钩子中使用了<code>sleep</code>命令，可能会出现<code>sleep</code>命令不起作用的情况。这是由于Istio的<code>sidecar</code>代理会在<code>preStop</code>钩子执行期间发送<code>SIGTERM</code>信号给Pod，以便Pod可以进行优雅的终止。然而，<code>sleep</code>命令在收到<code>SIGTERM</code>信号时会立即退出，而不是等待指定的时间。</p><p>为了解决这个问题，可以使用<code>trap</code>命令来捕获<code>SIGTERM</code>信号，并在收到信号时执行一些操作。例如，可以使用以下命令来在<code>preStop</code>钩子中等待30秒钟，然后执行一些清理操作：</p><blockquote><p>注：trap指令的详细用法可以参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.tencent.com/developer/article/1640249">https://cloud.tencent.com/developer/article/1640249</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">preStop:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;trap &#x27;echo \&quot;Caught SIGTERM signal\&quot; &amp;&amp; sleep 30 &amp;&amp; echo \&quot;Performing cleanup...\&quot;&#x27; SIGTERM&quot;</span></span><br></pre></td></tr></table></figure><p>在上面的示例中，我们使用<code>trap</code>命令捕获了<code>SIGTERM</code>信号，并打印了一条消息。然后，我们使用<code>sleep</code>命令等待30秒钟，然后打印另一条消息，表示我们正在执行清理操作。</p><p>请注意，如果的清理操作需要更长的时间来完成，可以根据需要增加<code>sleep</code>命令的等待时间。同时，还可以使用<code>kubectl logs</code>命令来查看Pod的日志，以确定<code>preStop</code>钩子是否执行成功。</p><h1 id="18-istio-envoy-log显示block-all"><a href="#18-istio-envoy-log显示block-all" class="headerlink" title="18. istio envoy log显示block_all"></a>18. istio envoy log显示block_all</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nginx-ingress日志</span><br><span class="line"><span class="number">5</span>ab10<span class="number">.133</span><span class="number">.0</span><span class="number">.10</span> -- <span class="punctuation">[</span><span class="number">31</span>/Aug/<span class="number">2023</span><span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">48</span> +<span class="number">0000</span><span class="punctuation">]</span> <span class="string">&quot;GET HTTP/.1&quot;</span> <span class="number">502</span> <span class="number">0</span> <span class="string">&quot;&quot;</span><span class="string">&quot;Mozila/5.0 (windows NT 10.0; Win64; x64) ApleWebKit/537.36 (KHTML， like Gecko) Chrome/116.0.0.0 Safari/537.36Eda/116.0.1938.62&quot;</span> <span class="number">923</span> <span class="number">0001</span> <span class="punctuation">[</span>kevcloak-kevcloak-http-htt<span class="punctuation">]</span> <span class="number">7</span> <span class="number">10.130</span> <span class="number">7.82</span><span class="punctuation">:</span><span class="number">8080</span> <span class="number">0</span> <span class="number">0</span> <span class="number">004</span> <span class="number">502</span> <span class="number">42</span>ecdfa48c7c186f4d494cda9ae320310<span class="number">.133</span><span class="number">.0</span><span class="number">.10</span> - -<span class="punctuation">[</span><span class="number">31</span>/Aug/<span class="number">2023</span><span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">49</span> +<span class="number">0000</span><span class="punctuation">]</span> <span class="string">&quot;GET HTTP/1&quot;</span> <span class="number">502</span> <span class="number">0</span> <span class="string">&quot;&quot;</span><span class="string">&quot;Mozilla/5.0 (windo.s NT 10.0; Win64; x64) ApleWebKit/537.36 (KHTML， like Gecko) Chrome/116.0.0.0 Safari/537.36Edg/116.0.1938.62&quot;</span> <span class="number">923</span> <span class="number">.001</span> <span class="punctuation">[</span>keycloak-keycloak-http-htt<span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">]</span> <span class="number">10.130</span><span class="number">.7</span><span class="number">.82</span><span class="punctuation">:</span><span class="number">8080</span> <span class="number">0</span> <span class="number">0.000</span> <span class="number">502</span> <span class="number">122</span>c4ff573cae0e9bcb235fef198282200 <span class="number">205</span><span class="string">&quot;&quot;</span><span class="string">&quot;Mozilla/5.0 (windows NT 10.0; Win64; x64) AppleWebKi10.130.5.96 - - [31/Aug/2023:03:03:49 +0000]&quot;</span>GET /proxy/otification/notifications/unread-count?channel=WEB HTTP/<span class="number">1.1</span></span><br><span class="line"></span><br><span class="line"># nainx-ingress istio-proxy日志</span><br><span class="line"><span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML，Tike Gecko)Chrome/<span class="number">116.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span><span class="string">&quot; &quot;</span>c3785224a5b953b12250d0b691a35ab<span class="string">&quot;&quot;</span>hkaa-cargo-auth-proxy-appchart.app.svc.cluster.local<span class="string">&quot;&quot;</span><span class="number">10</span>rt.app.svc.cluster.local <span class="number">10.130</span><span class="number">.20</span><span class="number">.170</span><span class="punctuation">:</span><span class="number">36466</span> <span class="number">172.20</span><span class="number">.151</span><span class="number">.10313041</span><span class="number">.210</span><span class="punctuation">:</span><span class="number">8080</span><span class="string">&quot; outboundl80l hkaa-cargo-auth-proxy-appchi:80 10.130.5.96:0 - default2023-08-31T03:03:48.229Z] &quot;</span>GET HTTP/<span class="number">1.1</span><span class="string">&quot; 502  directesponse - &quot;</span><span class="string">&quot; 0 0 0 - &quot;</span><span class="number">10.133</span><span class="number">.0</span><span class="number">.10</span><span class="string">&quot; &quot;</span>Mozilla/<span class="number">5.0</span> (windows T <span class="number">10.0</span><span class="punctuation">:</span> Win64<span class="punctuation">:</span> x64) AppleWebkit/<span class="number">537.36</span> (KHTML，like Gecko) Chrome/<span class="number">116</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> Safari/<span class="number">537</span> <span class="number">36</span> Eda/<span class="number">116</span> <span class="number">0</span> <span class="number">1038</span> <span class="number">62</span><span class="string">&quot; &quot;</span><span class="number">42</span>ocdfa48c7c18fAd404cda00ao3203<span class="string">&quot; &quot;</span>owcloak.bttn kowcloak swc cluctor <span class="number">10</span> <span class="number">130</span> <span class="number">7</span> <span class="number">82</span><span class="punctuation">:</span><span class="number">8080</span> <span class="number">10</span> <span class="number">133</span> <span class="number">0</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">0</span> - <span class="number">61</span>ock a171oc<span class="punctuation">[</span><span class="number">2023</span><span class="number">-08</span><span class="number">-31</span>T03<span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">49.458</span>Z<span class="punctuation">]</span> <span class="string">&quot;GET HTTP/1.1&quot;</span> <span class="number">502</span> - directesponse - <span class="string">&quot;&quot;</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> - <span class="string">&quot;10.133.0.10&quot;</span> <span class="string">&quot;Mozilla/5.0 (windowsT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML， like Gecko) Chrome/116.0.0.0 Safari/537.36 Edg/116.0.1938.62&quot;</span> <span class="string">&quot;0122c4ff573caee9bcb235fef198282&quot;</span><span class="string">&quot;keycloak-http.keycloak.svc.cluster.Toc0- - 10.130.7.82:8080 10.133.0.10:0 - block all</span></span><br></pre></td></tr></table></figure><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://istio.io/latest/zh/blog/2019/monitoring-external-service-traffic/">https://istio.io/latest/zh/blog/2019/monitoring-external-service-traffic/</a></li></ul><blockquote><p>文章中提到如果<code>global.outboundTrafficPolicy.mode</code>设置为<code>REGISTRY_ONLY</code>，这种模式下除非为每个服务显式的添加了service entries，否则所有到外部服务的流量都会被阻止</p></blockquote><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://my.f5.com/manage/s/article/K000132518">https://my.f5.com/manage/s/article/K000132518</a></li></ul><blockquote><p>ServiceEntry需要列出与HTTP请求匹配正确的Host</p></blockquote><h1 id="19-upstream-reset-before-response-started-connection-failure-delayed-connect-error-111-或upstream-reset-before-response-started-connection-termination"><a href="#19-upstream-reset-before-response-started-connection-failure-delayed-connect-error-111-或upstream-reset-before-response-started-connection-termination" class="headerlink" title="19.upstream_reset_before_response_started{connection_failure,delayed_connect_error:_111}或upstream_reset_before_response_started{connection_termination}"></a>19.upstream_reset_before_response_started{connection_failure,delayed_connect_error:_111}或upstream_reset_before_response_started{connection_termination}</h1><p>参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/envoyproxy/envoy/issues/14981">https://github.com/envoyproxy/envoy/issues/14981</a></p><p>此问题可能是因为下游服务主动断开连接导致。我的场景则是服务发生堆分配不足错误</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/d3a1efad/">https://xiaowu95.wang/posts/d3a1efad/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/istio/">istio</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo26.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/fa103d3a/" title="idea添加对istio的智能提示"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">idea添加对istio的智能提示</div></div><div class="info-2"><div class="info-item-1">转自: https://blog.51cto.com/u_15127588/3305078 JetBrains 系列 IDE 有一个非常好用的 Kubernetes 的官方插件：JetBrains Kubernetes Plugin 。该插件支持资源对象关键字的自动补全和语法检查，这对于编写或者修改 YAML 文件非常方便。但是此前版本不支持 自定义的 CRD 对象，这对于该插件的易用性来说，略有一些遗憾。 现在新版的 Kubernetes 插件已经支持通过文件导入或者 URL 导入 CRD 定义文件，从而支持任意 CRD 资源对象的关键字自动补全和语法检查。 12Custom resource definition (CRD) supportCustom resources can be validated by providing complementary OpenAPI 2.0 files with CRD schemas and/or CRD resource definitions (YAML) (limited support). 下面以服务网格 Istio ...</div></div></div></a><a class="pagination-related" href="/posts/43409a5/" title="利用istio实现灰度发布"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">利用istio实现灰度发布</div></div><div class="info-2"><div class="info-item-1">Kubernetes 中如何实现灰度发布当你Kubernetes 集群中部署业务时，可以利用 Kubernetes 原生提供的灰度发布的方式去上线业务。这种方式是通过在旧版本和新版本的服务之间，定义一个差异化的 Label，根据不同版本之间的公共 Label 负载流量到后端 Pod，最终实现根据 Pod 的副本数控制流量的百分比。 如下图所示：用户定义了两个 Deployment 对象，其中旧版本名为 frontend-stable，有3个副本。新版本为 frontend-canary，有1个副本。此时定义了一个 Service 对象，使用它们之间公共的 Label 进行选择。这就使得用户访问 frontend 这个 Service 时，能以 3:1 的比例同时访问到两个版本。并且还可以通过调整副本数持续控制流量比例，最终达到完整上线。 Kubernetes 默认的实现方式在简单的部署场景下很有效，但是在一些复杂场景中，仍然会有较大的局限，如： 业务配置自动伸缩后，会直接影响灰度发布的流量比例 低百分比的流量控制占用资源高，如 1 % 的流量到达新版本，则至少需要 100 ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/a28b97ff/" title="EnvoyFilter-ChatGPT译文"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo14.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-02-02</div><div class="info-item-2">EnvoyFilter-ChatGPT译文</div></div><div class="info-2"><div class="info-item-1">介绍 EnvoyFilter 提供了一种机制，可以自定义 Istio Pilot 生成的 Envoy 配置。使用 EnvoyFilter 修改某些字段的值、添加特定过滤器，甚至添加全新的监听器、集群等。这个功能必须小心使用，因为不正确的配置可能会破坏整个网格。与其他 Istio 网络对象不同，EnvoyFilters 是附加应用的。在特定命名空间中给定工作负载可以存在任意数量的 EnvoyFilters 。这些 EnvoyFilters 的应用顺序如下：所有位于配置根命名空间中的 EnvoyFilters ，然后是匹配工作负载命名空间中所有匹配到的 EnvoyFilters。 注意点注意1：此 API 的某些方面与 Istio 网络子系统以及Envoy XDS API 的内部实现密切相关。虽然EnvoyFilter API本身将保持向后兼容性，但通过此机制提供的任何 envoy 配置都应该在Istio代理版本升级时进行仔细监控，以确保已弃用字段被适当地删除和替换。 注意2：当多个Envoy Filters 绑定到给定名称空间中相同工作负载时，在创建时间顺序上按顺序处理所有补丁。...</div></div></div></a><a class="pagination-related" href="/posts/fa103d3a/" title="idea添加对istio的智能提示"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-02-02</div><div class="info-item-2">idea添加对istio的智能提示</div></div><div class="info-2"><div class="info-item-1">转自: https://blog.51cto.com/u_15127588/3305078 JetBrains 系列 IDE 有一个非常好用的 Kubernetes 的官方插件：JetBrains Kubernetes Plugin 。该插件支持资源对象关键字的自动补全和语法检查，这对于编写或者修改 YAML 文件非常方便。但是此前版本不支持 自定义的 CRD 对象，这对于该插件的易用性来说，略有一些遗憾。 现在新版的 Kubernetes 插件已经支持通过文件导入或者 URL 导入 CRD 定义文件，从而支持任意 CRD 资源对象的关键字自动补全和语法检查。 12Custom resource definition (CRD) supportCustom resources can be validated by providing complementary OpenAPI 2.0 files with CRD schemas and/or CRD resource definitions (YAML) (limited support). 下面以服务网格 Istio ...</div></div></div></a><a class="pagination-related" href="/posts/46b7d67b/" title="关于Sidecar注入以及问题记录"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-05-29</div><div class="info-item-2">关于Sidecar注入以及问题记录</div></div><div class="info-2"><div class="info-item-1">安装 Sidecar注入为了充分利用 Istio 的所有特性，网格中的 Pod 必须运行一个 Istio Sidecar 代理。 下面的章节描述了向 Pod 中注入 Istio Sidecar 的两种方法：使用 istioctl 手动注入或启用 Pod 所属命名空间的 Istio Sidecar 注入器自动注入。 当 Pod 所属命名空间启用自动注入后，自动注入器会使用准入控制器在创建 Pod 时自动注入代理配置。 手动注入直接修改配置，如 Deployment，并将代理配置注入其中。 如果您不确定使用哪一种方法，建议使用自动注入。 自动注入 Sidecar使用 Istio 提供的准入控制器变更 Webhook， 可以将 Sidecar 自动添加到可用的 Kubernetes Pod 中。 虽然准入控制器默认情况下是启用的，但一些 Kubernetes 发行版会禁用这些控制器。 如果出现这种情况，根据指示说明来启用准入控制器。 当您在一个命名空间中设置了 istio-injection=enabled 标签，且 Injection Webhook 被启用后，任何新的 Pod 都有...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">554</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">168</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Service-%E7%AB%AF%E5%8F%A3%E5%91%BD%E5%90%8D%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.</span> <span class="toc-text">1. Service 端口命名约束</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.1.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#istio-%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9AProtocol-sniffing"><span class="toc-number">1.2.</span> <span class="toc-text">istio 的解决方案：Protocol sniffing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.3.</span> <span class="toc-text">最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E4%B8%8B%E5%8F%91%E9%A1%BA%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">2. 流控规则下发顺序问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">异常描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9Amake-before-break"><span class="toc-number">2.3.</span> <span class="toc-text">最佳实践：make before break</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%AF%B7%E6%B1%82%E4%B8%AD%E6%96%AD%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 请求中断分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-%E6%B5%81%E9%87%8F%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Envoy 流量模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.2.</span> <span class="toc-text">日志分析示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-sidecar-%E5%92%8C-user-container-%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">4.</span> <span class="toc-text">4. sidecar 和 user container 启动顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">4.1.</span> <span class="toc-text">异常描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Ingress-Gateway-%E5%92%8C-Service-%E7%AB%AF%E5%8F%A3%E8%81%94%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">5. Ingress Gateway 和 Service 端口联动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-VirtualService-%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">6.</span> <span class="toc-text">6. VirtualService 作用域</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-VirtualService-%E4%B8%8D%E6%94%AF%E6%8C%81-host-fragment"><span class="toc-number">7.</span> <span class="toc-text">7. VirtualService 不支持 host fragment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%A1%88%E4%BE%8B%EF%BC%9A"><span class="toc-number">7.1.</span> <span class="toc-text">异常案例：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%EF%BC%9A"><span class="toc-number">7.2.</span> <span class="toc-text">背景：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Istio-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9AVirtualService-chaining%EF%BC%88plan-in-1-6%EF%BC%89"><span class="toc-number">7.3.</span> <span class="toc-text">Istio 解决方案：VirtualService chaining（plan in 1.6）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E5%85%A8%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%B9%B6%E9%9D%9E%E5%AE%8C%E5%85%A8%E9%80%8F%E6%98%8E%E6%8E%A5%E5%85%A5"><span class="toc-number">8.</span> <span class="toc-text">8. 全链路跟踪并非完全透明接入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%A1%88%E4%BE%8B"><span class="toc-number">8.1.</span> <span class="toc-text">异常案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-1"><span class="toc-number">8.2.</span> <span class="toc-text">原因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-mTLS-%E5%AF%BC%E8%87%B4%E8%BF%9E%E6%8E%A5%E4%B8%AD%E6%96%AD"><span class="toc-number">9.</span> <span class="toc-text">9. mTLS 导致连接中断</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E7%9B%91%E5%90%AC%E5%9C%B0%E5%9D%80%E9%99%90%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">10. 用户服务监听地址限制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">10.1.</span> <span class="toc-text">异常描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-1"><span class="toc-number">10.2.</span> <span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E5%BB%BA%E8%AE%AE"><span class="toc-number">10.3.</span> <span class="toc-text">改造建议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E7%8A%B6%E6%80%81%E7%A0%81404-Not-Found-%E6%88%96%E6%98%AFnginx%E4%B8%8B%E6%B8%B8%E6%9C%8D%E5%8A%A1%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E4%B8%8D%E7%94%9F%E6%95%88"><span class="toc-number">11.</span> <span class="toc-text">11. 状态码404: Not Found, 或是nginx下游服务路由规则不生效</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">11.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.</span> <span class="toc-text">有问题的nginx配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%881-%E4%BF%AE%E6%94%B9nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">11.3.</span> <span class="toc-text">方案1: 修改nginx配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%882-%E4%BF%AE%E6%94%B9VS%E9%85%8D%E7%BD%AE-%E9%85%8D%E7%BD%AE%E5%A4%9Ahost%E6%94%AF%E6%8C%81"><span class="toc-number">11.4.</span> <span class="toc-text">方案2: 修改VS配置, 配置多host支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">11.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">11.6.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-istio-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-%E8%BF%94%E5%9B%9E-426-%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">12.</span> <span class="toc-text">12. istio 常见问题: 返回 426 状态码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-1"><span class="toc-number">12.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-nginx-%E5%9C%BA%E6%99%AF"><span class="toc-number">12.2.</span> <span class="toc-text">常见的 nginx 场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%8B%E6%B5%8B%E5%9C%BA%E6%99%AF"><span class="toc-number">12.3.</span> <span class="toc-text">压测场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9-istio-%E6%94%AF%E6%8C%81-HTTP-1-0"><span class="toc-number">12.4.</span> <span class="toc-text">让 istio 支持 HTTP&#x2F;1.0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1"><span class="toc-number">12.5.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%89%8D%E7%AB%AFjs%E6%96%87%E4%BB%B6%E6%8A%A5%E9%94%99"><span class="toc-number">13.</span> <span class="toc-text">13. 前端js文件报错</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-2"><span class="toc-number">13.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-2"><span class="toc-number">13.2.</span> <span class="toc-text">原因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-no-healthy-upstream"><span class="toc-number">14.</span> <span class="toc-text">14. no healthy upstream</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-3"><span class="toc-number">14.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-3"><span class="toc-number">14.2.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">14.3.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">14.4.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-%E5%A6%82%E4%BD%95%E5%9C%A8%E9%9A%94%E7%A6%BB%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85istio"><span class="toc-number">15.</span> <span class="toc-text">15. 如何在隔离环境安装istio</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">15.1.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16-%E8%A7%A3%E5%86%B3istio-proxy%E4%BD%BF%E7%94%A8%E4%BA%86%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E5%AF%BC%E8%87%B4%E6%96%B0%E5%BB%BApod%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81%E7%9A%84%E9%97%AE%E9%A2%98-No-preemption-victims-found-for-incoming-pod"><span class="toc-number">16.</span> <span class="toc-text">16. 解决istio-proxy使用了资源配额导致新建pod处于pending状态的问题(No preemption victims found for incoming pod)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">16.1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%95%B4istio%E5%85%B3%E4%BA%8Esidecar%E7%9A%84%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E5%8F%82%E6%95%B0"><span class="toc-number">16.2.</span> <span class="toc-text">调整istio关于sidecar的资源配额参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">16.3.</span> <span class="toc-text">查找参数配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4"><span class="toc-number">16.4.</span> <span class="toc-text">动态调整</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E8%B0%83%E6%95%B4%E7%BD%91%E6%A0%BC%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1"><span class="toc-number">16.4.1.</span> <span class="toc-text">方法一：调整网格中的所有服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E8%B0%83%E6%95%B4%E7%BD%91%E6%A0%BC%E4%B8%AD%E7%9A%84%E6%9F%90%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">16.4.2.</span> <span class="toc-text">方法二：调整网格中的某个服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%89%8D%E8%A7%84%E5%88%92"><span class="toc-number">16.5.</span> <span class="toc-text">提前规划</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17-%E5%9C%A8Istio%E4%B8%AD%E4%BD%BF%E7%94%A8preStop%E9%92%A9%E5%AD%90%E6%97%B6%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%87%BA%E7%8E%B0sleep%E5%91%BD%E4%BB%A4%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">17.</span> <span class="toc-text">17. 在Istio中使用preStop钩子时，可能会出现sleep命令不起作用的情况</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-istio-envoy-log%E6%98%BE%E7%A4%BAblock-all"><span class="toc-number">18.</span> <span class="toc-text">18. istio envoy log显示block_all</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#19-upstream-reset-before-response-started-connection-failure-delayed-connect-error-111-%E6%88%96upstream-reset-before-response-started-connection-termination"><span class="toc-number">19.</span> <span class="toc-text">19.upstream_reset_before_response_started{connection_failure,delayed_connect_error:_111}或upstream_reset_before_response_started{connection_termination}</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d31147a5/" title="Clawdbot完整配置指南"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Clawdbot完整配置指南"></a><div class="content"><a class="title" href="/posts/d31147a5/" title="Clawdbot完整配置指南">Clawdbot完整配置指南</a><time datetime="2026-02-11T10:15:08.000Z" title="发表于 2026-02-11 18:15:08">2026-02-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/4d3a9a89/" title="处理 Rancher 连接节点 &quot;Cluster agent is not connected&quot;"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="处理 Rancher 连接节点 &quot;Cluster agent is not connected&quot;"></a><div class="content"><a class="title" href="/posts/4d3a9a89/" title="处理 Rancher 连接节点 &quot;Cluster agent is not connected&quot;">处理 Rancher 连接节点 &quot;Cluster agent is not connected&quot;</a><time datetime="2026-02-03T06:02:28.000Z" title="发表于 2026-02-03 14:02:28">2026-02-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo26.jpg)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2019 - 2026 By 小五</span><span class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.5.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.5.1/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.5.1/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=(e,a)=>{"object"==typeof e&&null!==e&&Object.keys(e).forEach((r=>{const n=e[r];"object"==typeof n&&null!==n&&(n[a]?e[r]=n[a]:t(n,a))}))},e=e=>{window.loadChartJS=!0,Array.from(e).forEach(((e,a)=>{const r=e.firstElementChild,n=e.getAttribute("data-chartjs-id")||"chartjs-"+a,d=e.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),t(i,m),new Chart(h,i)}))},a=()=>{const t=document.querySelectorAll("#article-container .chartjs-container");0!==t.length&&(window.loadChartJS?e(t):btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js").then((()=>e(t))))};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?a():document.addEventListener("DOMContentLoaded",a)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:description"]','link[rel="canonical"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>{try{e()}catch(e){console.debug("Pjax callback failed:",e)}}))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{if(404===e.request.status){!0?pjax.loadUrl("/404"):window.location.href="/404"}}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div id="algolia-search-input"><div class="ais-SearchBox"><form class="ais-SearchBox-form" action="" role="search" novalidate><input class="ais-SearchBox-input" type="search" placeholder="搜索文章" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" maxlength="512" aria-label="Search"><button class="ais-SearchBox-submit" type="submit" title="Submit the search query" style="display:none"><svg class="ais-SearchBox-submitIcon" width="10" height="10" viewBox="0 0 40 40" aria-hidden="true"><path d="M26.804 29.01c-2.832 2.34-6.465 3.746-10.426 3.746C7.333 32.756 0 25.424 0 16.378 0 7.333 7.333 0 16.378 0c9.046 0 16.378 7.333 16.378 16.378 0 3.96-1.406 7.594-3.746 10.426l10.534 10.534c.607.607.61 1.59-.004 2.202-.61.61-1.597.61-2.202.004L26.804 29.01zm-10.426.627c7.323 0 13.26-5.936 13.26-13.26 0-7.32-5.937-13.257-13.26-13.257C9.056 3.12 3.12 9.056 3.12 16.378c0 7.323 5.936 13.26 13.258 13.26z"></path></svg></button></form></div><hr><div id="algolia-search-results"><div id="algolia-hits"><div id="algolia-hits-empty" style="display:none"></div><div class="ais-Hits" style="display:none"><ol class="ais-Hits-list"></ol></div></div><div class="ais-Pagination" id="algolia-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="algolia-info"><span class="ais-Stats-text"></span><a class="algolia-poweredBy" href="https://www.algolia.com/?utm_source=algoliasearch.js&amp;utm_medium=website&amp;utm_content=localhost&amp;utm_campaign=poweredby" target="_blank" aria-label="Search by Algolia" rel="noopener noreferrer"><svg class="ais-PoweredBy-logo" height="1.2em" viewBox="0 0 572 64" style="width:auto"><path fill="#36395A" d="M16 48.3c-3.4 0-6.3-.6-8.7-1.7A12.4 12.4 0 0 1 1.9 42C.6 40 0 38 0 35.4h6.5a6.7 6.7 0 0 0 3.9 6c1.4.7 3.3 1.1 5.6 1.1 2.2 0 4-.3 5.4-1a7 7 0 0 0 3-2.4 6 6 0 0 0 1-3.4c0-1.5-.6-2.8-1.9-3.7-1.3-1-3.3-1.6-5.9-1.8l-4-.4c-3.7-.3-6.6-1.4-8.8-3.4a10 10 0 0 1-3.3-7.9c0-2.4.6-4.6 1.8-6.4a12 12 0 0 1 5-4.3c2.2-1 4.7-1.6 7.5-1.6s5.5.5 7.6 1.6a12 12 0 0 1 5 4.4c1.2 1.8 1.8 4 1.8 6.7h-6.5a6.4 6.4 0 0 0-3.5-5.9c-1-.6-2.6-1-4.4-1s-3.2.3-4.4 1c-1.1.6-2 1.4-2.6 2.4-.5 1-.8 2-.8 3.1a5 5 0 0 0 1.5 3.6c1 1 2.6 1.7 4.7 1.9l4 .3c2.8.2 5.2.8 7.2 1.8 2.1 1 3.7 2.2 4.9 3.8a9.7 9.7 0 0 1 1.7 5.8c0 2.5-.7 4.7-2 6.6a13 13 0 0 1-5.6 4.4c-2.4 1-5.2 1.6-8.4 1.6Zm35.6 0c-2.6 0-4.8-.4-6.7-1.3a13 13 0 0 1-4.7-3.5 17.1 17.1 0 0 1-3.6-10.4v-1c0-2 .3-3.8 1-5.6a13 13 0 0 1 7.3-8.3 15 15 0 0 1 6.3-1.4A13.2 13.2 0 0 1 64 24.3c1 2.2 1.6 4.6 1.6 7.2V34H39.4v-4.3h21.8l-1.8 2.2c0-2-.3-3.7-.9-5.1a7.3 7.3 0 0 0-2.7-3.4c-1.2-.7-2.7-1.1-4.6-1.1s-3.4.4-4.7 1.3a8 8 0 0 0-2.9 3.6c-.6 1.5-.9 3.3-.9 5.4 0 2 .3 3.7 1 5.3a7.9 7.9 0 0 0 2.8 3.7c1.3.8 3 1.3 5 1.3s3.8-.5 5.1-1.3c1.3-1 2.1-2 2.4-3.2h6a11.8 11.8 0 0 1-7 8.7 16 16 0 0 1-6.4 1.2ZM80 48c-2.2 0-4-.3-5.7-1a8.4 8.4 0 0 1-3.7-3.3 9.7 9.7 0 0 1-1.3-5.2c0-2 .5-3.8 1.5-5.2a9 9 0 0 1 4.3-3.1c1.8-.7 4-1 6.7-1H89v4.1h-7.5c-2 0-3.4.5-4.4 1.4-1 1-1.6 2.1-1.6 3.6s.5 2.7 1.6 3.6c1 1 2.5 1.4 4.4 1.4 1.1 0 2.2-.2 3.2-.7 1-.4 1.9-1 2.6-2 .6-1 1-2.4 1-4.2l1.7 2.1c-.2 2-.7 3.8-1.5 5.2a9 9 0 0 1-3.4 3.3 12 12 0 0 1-5.3 1Zm9.5-.7v-8.8h-1v-10c0-1.8-.5-3.2-1.4-4.1-1-1-2.4-1.4-4.2-1.4a142.9 142.9 0 0 0-10.2.4v-5.6a74.8 74.8 0 0 1 8.6-.4c3 0 5.5.4 7.5 1.2s3.4 2 4.4 3.6c1 1.7 1.4 4 1.4 6.7v18.4h-5Zm12.9 0V17.8h5v12.3h-.2c0-4.2 1-7.4 2.8-9.5a11 11 0 0 1 8.3-3.1h1v5.6h-2a9 9 0 0 0-6.3 2.2c-1.5 1.5-2.2 3.6-2.2 6.4v15.6h-6.4Zm34.4 1a15 15 0 0 1-6.6-1.3c-1.9-.9-3.4-2-4.7-3.5a15.5 15.5 0 0 1-2.7-5c-.6-1.7-1-3.6-1-5.4v-1c0-2 .4-3.8 1-5.6a15 15 0 0 1 2.8-4.9c1.3-1.5 2.8-2.6 4.6-3.5a16.4 16.4 0 0 1 13.3.2c2 1 3.5 2.3 4.8 4a12 12 0 0 1 2 6H144c-.2-1.6-1-3-2.2-4.1a7.5 7.5 0 0 0-5.2-1.7 8 8 0 0 0-4.7 1.3 8 8 0 0 0-2.8 3.6 13.8 13.8 0 0 0 0 10.3c.6 1.5 1.5 2.7 2.8 3.6s2.8 1.3 4.8 1.3c1.5 0 2.7-.2 3.8-.8a7 7 0 0 0 2.6-2c.7-1 1-2 1.2-3.2h6.2a11 11 0 0 1-2 6.2 15.1 15.1 0 0 1-11.8 5.5Zm19.7-1v-40h6.4V31h-1.3c0-3 .4-5.5 1.1-7.6a9.7 9.7 0 0 1 3.5-4.8A9.9 9.9 0 0 1 172 17h.3c3.5 0 6 1.1 7.9 3.5 1.7 2.3 2.6 5.7 2.6 10v16.8h-6.4V29.6c0-2.1-.6-3.8-1.8-5a6.4 6.4 0 0 0-4.8-1.8c-2 0-3.7.7-5 2a7.8 7.8 0 0 0-1.9 5.5v17h-6.4Zm63.8 1a12.2 12.2 0 0 1-10.9-6.2 19 19 0 0 1-1.8-7.3h1.4v12.5h-5.1v-40h6.4v19.8l-2 3.5c.2-3.1.8-5.7 1.9-7.7a11 11 0 0 1 4.4-4.5c1.8-1 3.9-1.5 6.1-1.5a13.4 13.4 0 0 1 12.8 9.1c.7 1.9 1 3.8 1 6v1c0 2.2-.3 4.1-1 6a13.6 13.6 0 0 1-13.2 9.4Zm-1.2-5.5a8.4 8.4 0 0 0 7.9-5c.7-1.5 1.1-3.3 1.1-5.3s-.4-3.8-1.1-5.3a8.7 8.7 0 0 0-3.2-3.6 9.6 9.6 0 0 0-9.2-.2 8.5 8.5 0 0 0-3.3 3.2c-.8 1.4-1.3 3-1.3 5v2.3a9 9 0 0 0 1.3 4.8 9 9 0 0 0 3.4 3c1.4.7 2.8 1 4.4 1Zm27.3 3.9-10-28.9h6.5l9.5 28.9h-6Zm-7.5 12.2v-5.7h4.9c1 0 2-.1 2.9-.4a4 4 0 0 0 2-1.4c.4-.7.9-1.6 1.2-2.7l8.6-30.9h6.2l-9.3 32.4a14 14 0 0 1-2.5 5 8.9 8.9 0 0 1-4 2.8c-1.5.6-3.4.9-5.6.9h-4.4Zm9-12.2v-5.2h6.4v5.2H248Z"></path><path fill="#003DFF" d="M534.4 9.1H528a.8.8 0 0 1-.7-.7V1.8c0-.4.2-.7.6-.8l6.5-1c.4 0 .8.2.9.6v7.8c0 .4-.4.7-.8.7zM428 35.2V.8c0-.5-.3-.8-.7-.8h-.2l-6.4 1c-.4 0-.7.4-.7.8v35c0 1.6 0 11.8 12.3 12.2.5 0 .8-.4.8-.8V43c0-.4-.3-.7-.6-.8-4.5-.5-4.5-6-4.5-7zm106.5-21.8H528c-.4 0-.7.4-.7.8v34c0 .4.3.8.7.8h6.5c.4 0 .8-.4.8-.8v-34c0-.5-.4-.8-.8-.8zm-17.7 21.8V.8c0-.5-.3-.8-.8-.8l-6.5 1c-.4 0-.7.4-.7.8v35c0 1.6 0 11.8 12.3 12.2.4 0 .8-.4.8-.8V43c0-.4-.3-.7-.7-.8-4.4-.5-4.4-6-4.4-7zm-22.2-20.6a16.5 16.5 0 0 1 8.6 9.3c.8 2.2 1.3 4.8 1.3 7.5a19.4 19.4 0 0 1-4.6 12.6 14.8 14.8 0 0 1-5.2 3.6c-2 .9-5.2 1.4-6.8 1.4a21 21 0 0 1-6.7-1.4 15.4 15.4 0 0 1-8.6-9.3 21.3 21.3 0 0 1 0-14.4 15.2 15.2 0 0 1 8.6-9.3c2-.8 4.3-1.2 6.7-1.2s4.6.4 6.7 1.2zm-6.7 27.6c2.7 0 4.7-1 6.2-3s2.2-4.3 2.2-7.8-.7-6.3-2.2-8.3-3.5-3-6.2-3-4.7 1-6.1 3c-1.5 2-2.2 4.8-2.2 8.3s.7 5.8 2.2 7.8 3.5 3 6.2 3zm-88.8-28.8c-6.2 0-11.7 3.3-14.8 8.2a18.6 18.6 0 0 0 4.8 25.2c1.8 1.2 4 1.8 6.2 1.7s.1 0 .1 0h.9c4.2-.7 8-4 9.1-8.1v7.4c0 .4.3.7.8.7h6.4a.7.7 0 0 0 .7-.7V14.2c0-.5-.3-.8-.7-.8h-13.5zm6.3 26.5a9.8 9.8 0 0 1-5.7 2h-.5a10 10 0 0 1-9.2-14c1.4-3.7 5-6.3 9-6.3h6.4v18.3zm152.3-26.5h13.5c.5 0 .8.3.8.7v33.7c0 .4-.3.7-.8.7h-6.4a.7.7 0 0 1-.8-.7v-7.4c-1.2 4-4.8 7.4-9 8h-.1a4.2 4.2 0 0 1-.5.1h-.9a10.3 10.3 0 0 1-7-2.6c-4-3.3-6.5-8.4-6.5-14.2 0-3.7 1-7.2 3-10 3-5 8.5-8.3 14.7-8.3zm.6 28.4c2.2-.1 4.2-.6 5.7-2V21.7h-6.3a9.8 9.8 0 0 0-9 6.4 10.2 10.2 0 0 0 9.1 13.9h.5zM452.8 13.4c-6.2 0-11.7 3.3-14.8 8.2a18.5 18.5 0 0 0 3.6 24.3 10.4 10.4 0 0 0 13 .6c2.2-1.5 3.8-3.7 4.5-6.1v7.8c0 2.8-.8 5-2.2 6.3-1.5 1.5-4 2.2-7.5 2.2l-6-.3c-.3 0-.7.2-.8.5l-1.6 5.5c-.1.4.1.8.5 1h.1c2.8.4 5.5.6 7 .6 6.3 0 11-1.4 14-4.1 2.7-2.5 4.2-6.3 4.5-11.4V14.2c0-.5-.4-.8-.8-.8h-13.5zm6.3 8.2v18.3a9.6 9.6 0 0 1-5.6 2h-1a10.3 10.3 0 0 1-8.8-14c1.4-3.7 5-6.3 9-6.3h6.4zM291 31.5A32 32 0 0 1 322.8 0h30.8c.6 0 1.2.5 1.2 1.2v61.5c0 1.1-1.3 1.7-2.2 1l-19.2-17a18 18 0 0 1-11 3.4 18.1 18.1 0 1 1 18.2-14.8c-.1.4-.5.7-.9.6-.1 0-.3 0-.4-.2l-3.8-3.4c-.4-.3-.6-.8-.7-1.4a12 12 0 1 0-2.4 8.3c.4-.4 1-.5 1.6-.2l14.7 13.1v-46H323a26 26 0 1 0 10 49.7c.8-.4 1.6-.2 2.3.3l3 2.7c.3.2.3.7 0 1l-.2.2a32 32 0 0 1-47.2-28.6z"></path></svg></a></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.39.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.5.1/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo22.jpg" alt="/img/nba-logo22.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo22.jpg" alt="/img/nba-logo22.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo22.jpg" alt="/img/nba-logo22.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo5.jpg" alt="/img/nba-logo5.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo26.jpg" alt="/img/nba-logo26.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo22.jpg" alt="/img/nba-logo22.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo26.jpg" alt="/img/nba-logo26.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2026-01-28</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>