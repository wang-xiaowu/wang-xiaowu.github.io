<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>关于mysql死锁 | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="关于MySQL的死锁 MySQL的死锁指的是两个事务互相等待的场景，这种循环等待理论上不会有尽头。  比如事务A持有行1的锁，事务B持有行2的锁，然后事务A试图获取行2的锁，事务B试图获取行1的锁，这样事务A要等待事务B释放行2的锁，事务B要等待事务A释放行1的锁，两个事务互相等待，谁也提交不了。  这种情况下MySQL会选择中断并回滚其中一个事务，使得另一个事务可以提交。MySQL会记录死锁的日"><meta property="og:type" content="article"><meta property="og:title" content="关于mysql死锁"><meta property="og:url" content="https://xiaowu95.wang/posts/9ccf3750/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="关于MySQL的死锁 MySQL的死锁指的是两个事务互相等待的场景，这种循环等待理论上不会有尽头。  比如事务A持有行1的锁，事务B持有行2的锁，然后事务A试图获取行2的锁，事务B试图获取行1的锁，这样事务A要等待事务B释放行2的锁，事务B要等待事务A释放行1的锁，两个事务互相等待，谁也提交不了。  这种情况下MySQL会选择中断并回滚其中一个事务，使得另一个事务可以提交。MySQL会记录死锁的日"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo17.jpg"><meta property="article:published_time" content="2024-01-30T09:56:28.000Z"><meta property="article:modified_time" content="2024-01-30T09:56:28.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="数据库"><meta property="article:tag" content="mysql"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo17.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/9ccf3750/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.2.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{input_placeholder:"搜索文章",hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"关于mysql死锁",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo17.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">关于mysql死锁</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">关于mysql死锁<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/mysql/关于mysql死锁.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-30T09:56:28.000Z" title="发表于 2024-01-30 17:56:28">2024-01-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-30T09:56:28.000Z" title="更新于 2024-01-30 17:56:28">2024-01-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/">mysql</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2024-01-30 17:56:28&quot;}" hidden></div><h2 id="关于MySQL的死锁"><a href="#关于MySQL的死锁" class="headerlink" title="关于MySQL的死锁"></a>关于MySQL的死锁</h2><blockquote><p>MySQL的死锁指的是两个事务互相等待的场景，这种循环等待理论上不会有尽头。</p></blockquote><p>比如事务A持有行1的锁，事务B持有行2的锁，然后事务A试图获取行2的锁，事务B试图获取行1的锁，这样事务A要等待事务B释放行2的锁，事务B要等待事务A释放行1的锁，两个事务互相等待，谁也提交不了。</p><p>这种情况下MySQL会选择中断并回滚其中一个事务，使得另一个事务可以提交。MySQL会记录死锁的日志。</p><h2 id="制造一个死锁的场景"><a href="#制造一个死锁的场景" class="headerlink" title="制造一个死锁的场景"></a>制造一个死锁的场景</h2><p>新建一个表，添加两条数据：</p><img src="/img/loading.gif" data-lazy-src="/posts/9ccf3750/20200924194021432.png" title="img"><p>创建两个事务，事务执行的sql分别是：</p><p>事务A：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">update</span> medicine_control <span class="keyword">set</span> current_count<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> medicine_control <span class="keyword">set</span> current_count<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;2&#x27;</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><p>事务B：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">update</span> medicine_control <span class="keyword">set</span> current_count<span class="operator">=</span><span class="number">2</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;2&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> medicine_control <span class="keyword">set</span> current_count<span class="operator">=</span><span class="number">2</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><p>可见，事务A先改id&#x3D;1的数据再改id&#x3D;2的数据，事务B相反，先改id&#x3D;2的数据再改id&#x3D;1的数据。</p><p>两个事务sql的执行顺序如下：</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td><code>set autocommit=0;</code></td><td></td></tr><tr><td><code>update medicine_control set current_count=1 where id=&#39;1&#39;;</code></td><td></td></tr><tr><td></td><td><code>set autocommit=0;</code></td></tr><tr><td></td><td><code>update medicine_control set current_count=2 where id=&#39;2&#39;;</code></td></tr><tr><td><code>update medicine_control set current_count=1 where id=&#39;2&#39;;</code></td><td></td></tr><tr><td></td><td><code>update medicine_control set current_count=2 where id=&#39;1&#39;;</code></td></tr></tbody></table><p>对每一步的说明：</p><p>1，事务A开始事务。</p><p>2，事务A修改id&#x3D;1的数据，持有了该行的锁。</p><p>3，事务B开始事务。</p><p>4，事务B修改id&#x3D;2的数据，持有了该行的锁。</p><p>5，事务A试图修改id&#x3D;2的数据，此行的锁被事务B持有，于是事务A等待事务B释放锁。</p><p>事务B提交或回滚都能释放锁。</p><p>6，事务B试图修改id&#x3D;1的数据，此行的锁被事务A持有，于是事务B等待事务A释放锁。</p><p>事务A提交或回滚都能释放锁。当执行到这一步时，MySQL会立即检测到死锁，并且中断并回滚其中一个事务。此次回滚的是事务B，执行SQL的返回信息是这样的：</p><blockquote><p>[SQL]update medicine_control set current_count&#x3D;2 where id&#x3D;&#39;1&#39;;</p><p>[Err] 1213 - Deadlock found when trying to get lock; try restarting transaction</p></blockquote><h2 id="查看最近一次死锁的日志"><a href="#查看最近一次死锁的日志" class="headerlink" title="查看最近一次死锁的日志"></a>查看最近一次死锁的日志</h2><p>执行sql命令：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS;</span><br></pre></td></tr></table></figure><p>执行结果如下：</p><img src="/img/loading.gif" data-lazy-src="/posts/9ccf3750/20200924194243353.png" title="img"><p>其中的status字段里包含了最近一次死锁的日志。</p><h3 id="注-直接使用show-engine-innodb-status查看，无法获取阻塞锁线程"><a href="#注-直接使用show-engine-innodb-status查看，无法获取阻塞锁线程" class="headerlink" title="注: 直接使用show engine innodb status查看，无法获取阻塞锁线程"></a>注: 直接使用show engine innodb status查看，无法获取阻塞锁线程</h3><blockquote><p>直接使用show engine innodb status查看，无法判断到问题的根因；</p><p>需要使用innodb_lock_monitor来获取阻塞锁线程；</p><p><strong>随便在一个数据库中创建这个表<code>innodb_lock_monitor</code>，就会打开lock monitor</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> innodb_lock_monitor (a <span class="type">INT</span>) ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.07</span> sec)  </span><br><span class="line">  </span><br><span class="line">MySQL [test]<span class="operator">&gt;</span> <span class="keyword">show</span> warnings\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">  Level: Warning  </span><br><span class="line">   Code: <span class="number">131</span>  </span><br><span class="line">Message: <span class="keyword">Using</span> the <span class="keyword">table</span> name innodb_lock_monitor <span class="keyword">to</span> enable diagnostic output <span class="keyword">is</span> deprecated <span class="keyword">and</span> may be removed <span class="keyword">in</span> future releases. Use INFORMATION_SCHEMA <span class="keyword">or</span> PERFORMANCE_SCHEMA tables <span class="keyword">or</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_status_output<span class="operator">=</span>ON.  </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br></pre></td></tr></table></figure><p>说明：这个在5.6中有一个warning，但不影响使用。</p></blockquote><h2 id="死锁日志的内容"><a href="#死锁日志的内容" class="headerlink" title="死锁日志的内容"></a>死锁日志的内容</h2><h3 id="注-关于日志展示的0-11字段信息"><a href="#注-关于日志展示的0-11字段信息" class="headerlink" title="注: 关于日志展示的0-11字段信息"></a>注: 关于日志展示的0-11字段信息</h3><blockquote><p>hex和asc的关系：asc值转成16进制为hex的值</p><p>但这就意味着可能asc值会乱码（例如值过长或者为中文等情况）</p></blockquote><p>上面制造的死锁，其死锁日志的内容是这样的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">=====================================</span><br><span class="line">2020-09-15 14:46:28 0x7f732fcff700 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 37 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 609 srv_active, 0 srv_shutdown, 23969851 srv_idle</span><br><span class="line">srv_master_thread log flush and writes: 0</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 100</span><br><span class="line">OS WAIT ARRAY INFO: signal count 98</span><br><span class="line">RW-shared spins 0, rounds 0, OS waits 0</span><br><span class="line">RW-excl spins 29, rounds 870, OS waits 25</span><br><span class="line">RW-sx spins 1, rounds 30, OS waits 0</span><br><span class="line">Spin rounds per wait: 0.00 RW-shared, 30.00 RW-excl, 30.00 RW-sx</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2020-09-15 14:46:15 0x7f7350cf3700</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 10298, ACTIVE 11 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 7623, OS thread handle 140132789073664, query id 6006191 127.0.0.1 root updating</span><br><span class="line">update medicine_control set current_count=1 where id=&#x27;2&#x27;</span><br><span class="line">*** (1) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table `jeecg-boot`.`medicine_control` trx id 10298 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 21 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</span><br><span class="line"> 0: len 1; hex 31; asc 1;;</span><br><span class="line"> 1: len 6; hex 00000000283a; asc     (:;;</span><br><span class="line"> 2: len 7; hex 020000012510db; asc     %  ;;</span><br><span class="line"> 3: len 6; hex e5a5b6e5a5b6; asc       ;;</span><br><span class="line"> 4: len 12; hex e79b98e5b0bce8a5bfe69e97; asc             ;;</span><br><span class="line"> 5: len 4; hex 80000001; asc     ;;</span><br><span class="line"> 6: len 4; hex 80000005; asc     ;;</span><br><span class="line"> 7: len 4; hex 80000000; asc     ;;</span><br><span class="line"> 8: len 5; hex 6a65656367; asc jeecg;;</span><br><span class="line"> 9: len 5; hex 99a60eadf7; asc      ;;</span><br><span class="line"> 10: len 3; hex 6a6f62; asc job;;</span><br><span class="line"> 11: len 5; hex 99a75e0780; asc   ^  ;;</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table `jeecg-boot`.`medicine_control` trx id 10298 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 4 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</span><br><span class="line"> 0: len 1; hex 32; asc 2;;</span><br><span class="line"> 1: len 6; hex 00000000283b; asc     (;;;</span><br><span class="line"> 2: len 7; hex 01000002012bd8; asc      + ;;</span><br><span class="line"> 3: len 6; hex e788b7e788b7; asc       ;;</span><br><span class="line"> 4: len 6; hex e69f90e69f90; asc       ;;</span><br><span class="line"> 5: len 4; hex 80000002; asc     ;;</span><br><span class="line"> 6: len 4; hex 80000002; asc     ;;</span><br><span class="line"> 7: len 4; hex 80000000; asc     ;;</span><br><span class="line"> 8: len 5; hex 6c6979616e; asc liyan;;</span><br><span class="line"> 9: len 5; hex 99a67b3730; asc   &#123;70;;</span><br><span class="line"> 10: len 3; hex 6a6f62; asc job;;</span><br><span class="line"> 11: len 5; hex 99a75e0780; asc   ^  ;;</span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 10299, ACTIVE 7 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 7625, OS thread handle 140133576603392, query id 6006195 127.0.0.1 root updating</span><br><span class="line">update medicine_control set current_count=2 where id=&#x27;1&#x27;</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table `jeecg-boot`.`medicine_control` trx id 10299 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 4 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</span><br><span class="line"> 0: len 1; hex 32; asc 2;;</span><br><span class="line"> 1: len 6; hex 00000000283b; asc     (;;;</span><br><span class="line"> 2: len 7; hex 01000002012bd8; asc      + ;;</span><br><span class="line"> 3: len 6; hex e788b7e788b7; asc       ;;</span><br><span class="line"> 4: len 6; hex e69f90e69f90; asc       ;;</span><br><span class="line"> 5: len 4; hex 80000002; asc     ;;</span><br><span class="line"> 6: len 4; hex 80000002; asc     ;;</span><br><span class="line"> 7: len 4; hex 80000000; asc     ;;</span><br><span class="line"> 8: len 5; hex 6c6979616e; asc liyan;;</span><br><span class="line"> 9: len 5; hex 99a67b3730; asc   &#123;70;;</span><br><span class="line"> 10: len 3; hex 6a6f62; asc job;;</span><br><span class="line"> 11: len 5; hex 99a75e0780; asc   ^  ;;</span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table `jeecg-boot`.`medicine_control` trx id 10299 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 21 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</span><br><span class="line"> 0: len 1; hex 31; asc 1;;</span><br><span class="line"> 1: len 6; hex 00000000283a; asc     (:;;</span><br><span class="line"> 2: len 7; hex 020000012510db; asc     %  ;;</span><br><span class="line"> 3: len 6; hex e5a5b6e5a5b6; asc       ;;</span><br><span class="line"> 4: len 12; hex e79b98e5b0bce8a5bfe69e97; asc             ;;</span><br><span class="line"> 5: len 4; hex 80000001; asc     ;;</span><br><span class="line"> 6: len 4; hex 80000005; asc     ;;</span><br><span class="line"> 7: len 4; hex 80000000; asc     ;;</span><br><span class="line"> 8: len 5; hex 6a65656367; asc jeecg;;</span><br><span class="line"> 9: len 5; hex 99a60eadf7; asc      ;;</span><br><span class="line"> 10: len 3; hex 6a6f62; asc job;;</span><br><span class="line"> 11: len 5; hex 99a75e0780; asc   ^  ;;</span><br><span class="line">*** WE ROLL BACK TRANSACTION (2)</span><br><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter 10301</span><br><span class="line">Purge done for trx&#x27;s n:o &lt; 10301 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 61</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION 421608706154464, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706153592, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706152720, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706151848, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706150976, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706150104, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706148360, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706147488, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706146616, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706145744, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706144872, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421608706144000, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 10298, ACTIVE 24 sec</span><br><span class="line">3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2</span><br><span class="line">MySQL thread id 7623, OS thread handle 140132789073664, query id 6006198 127.0.0.1 root</span><br><span class="line">--------</span><br><span class="line">FILE I/O</span><br><span class="line">--------</span><br><span class="line">I/O thread 0 state: waiting for completed aio requests (insert buffer thread)</span><br><span class="line">I/O thread 1 state: waiting for completed aio requests (log thread)</span><br><span class="line">I/O thread 2 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 3 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 4 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 5 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 6 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 7 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 8 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 9 state: waiting for completed aio requests (write thread)</span><br><span class="line">Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,</span><br><span class="line"> ibuf aio reads:, log i/o&#x27;s:, sync i/o&#x27;s:</span><br><span class="line">Pending flushes (fsync) log: 0; buffer pool: 0</span><br><span class="line">2048 OS file reads, 24777 OS file writes, 11472 OS fsyncs</span><br><span class="line">0.00 reads/s, 0 avg bytes/read, 0.59 writes/s, 0.54 fsyncs/s</span><br><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 0, seg size 2, 0 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 34679, node heap has 1 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 3 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 1 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 1 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 1 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 1 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 2 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 5 buffer(s)</span><br><span class="line">0.00 hash searches/s, 0.27 non-hash searches/s</span><br><span class="line">---</span><br><span class="line">LOG</span><br><span class="line">---</span><br><span class="line">Log sequence number          2246453180</span><br><span class="line">Log buffer assigned up to    2246453180</span><br><span class="line">Log buffer completed up to   2246453180</span><br><span class="line">Log written up to            2246453180</span><br><span class="line">Log flushed up to            2246453180</span><br><span class="line">Added dirty pages up to      2246453180</span><br><span class="line">Pages flushed up to          2246453180</span><br><span class="line">Last checkpoint at           2246453180</span><br><span class="line">9242 log i/o&#x27;s done, 0.14 log i/o&#x27;s/second</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total large memory allocated 137363456</span><br><span class="line">Dictionary memory allocated 835752</span><br><span class="line">Buffer pool size   8192</span><br><span class="line">Free buffers       6046</span><br><span class="line">Database pages     2131</span><br><span class="line">Old database pages 788</span><br><span class="line">Modified db pages  0</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 0, not young 0</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 1923, created 208, written 13739</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 2131, unzip_LRU len: 0</span><br><span class="line">I/O sum[0]:cur[0], unzip sum[0]:cur[0]</span><br><span class="line">--------------</span><br><span class="line">ROW OPERATIONS</span><br><span class="line">--------------</span><br><span class="line">0 queries inside InnoDB, 0 queries in queue</span><br><span class="line">0 read views open inside InnoDB</span><br><span class="line">Process ID=920, Main thread ID=140133220153088 , state=sleeping</span><br><span class="line">Number of rows inserted 416, updated 2599, deleted 440, read 821958</span><br><span class="line">0.00 inserts/s, 0.08 updates/s, 0.00 deletes/s, 0.11 reads/s</span><br><span class="line">----------------------------</span><br><span class="line">END OF INNODB MONITOR OUTPUT</span><br><span class="line">============================</span><br></pre></td></tr></table></figure><p>其中：</p><blockquote><p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><p>2020-09-15 14:46:28 0x7f732fcff700 INNODB MONITOR OUTPUT</p><p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p></blockquote><p>这段记录的是查询死锁日志的时间</p><blockquote><p>------------------------</p><p>LATEST DETECTED DEADLOCK</p><p>------------------------</p></blockquote><p>这段后面记录的就是此次死锁的信息，分为几部分</p><h3 id="事务1信息"><a href="#事务1信息" class="headerlink" title="事务1信息"></a>事务1信息</h3><p>也就是这一部分：</p><blockquote><p>*** (1) TRANSACTION:</p><p>TRANSACTION 10298, ACTIVE 11 sec starting index read</p><p>mysql tables in use 1, locked 1</p><p>LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</p><p>MySQL thread id 7623, OS thread handle 140132789073664, query id 6006191 127.0.0.1 root updating</p><p>update medicine_control set current_count&#x3D;1 where id&#x3D;&#39;2&#39;</p></blockquote><p>其中：</p><p><strong>TRANSACTION 10298</strong>，是此事务的id。</p><p><strong>ACTIVE 11 sec</strong>，活跃时间11秒。</p><p><strong>starting index read</strong>，事务当前正在根据索引读取数据。</p><p>starting index read这个描述还有其他情况：</p><blockquote><ol><li><strong>fetching rows</strong> 表示事务状态在row_search_for_mysql中被设置，表示正在查找记录。</li><li><strong>updating or deleting</strong> 表示事务已经真正进入了Update&#x2F;delete的函数逻辑（row_update_for_mysql）</li><li><strong>thread declared inside InnoDB</strong> 说明事务已经进入innodb层。通常而言 不在innodb层的事务大部分是会被回滚的。</li></ol></blockquote><p><strong>mysql tables in use 1, locked 1</strong>，表示此事务修改了一个表，锁了一行数据。</p><p><strong>MySQL thread id 7623</strong>，这是线程id</p><p><strong>query id 6006191</strong>，这是查询id</p><p><strong>127.0.0.1 root updating</strong>，数据库ip地址，账号，更新语句。</p><p>**update medicine_control set current_count&#x3D;1 where id&#x3D;&#39;2&#39;**，这是正在执行的sql。</p><h3 id="事务1持有的锁"><a href="#事务1持有的锁" class="headerlink" title="事务1持有的锁"></a>事务1持有的锁</h3><p>也就是这段：</p><blockquote><p>*** (1) HOLDS THE LOCK(S):</p><p>RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table <code>jeecg-boot</code>.<code>medicine_control</code> trx id 10298 lock_mode X locks rec but not gap</p><p>Record lock, heap no 21 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</p><p>0: len 1; hex 31; asc 1;;</p><p>1: len 6; hex 00000000283a; asc (:;;</p><p>2: len 7; hex 020000012510db; asc % ;;</p><p>3: len 6; hex e5a5b6e5a5b6; asc ;;</p><p>4: len 12; hex e79b98e5b0bce8a5bfe69e97; asc ;;</p><p>5: len 4; hex 80000001; asc ;;</p><p>6: len 4; hex 80000005; asc ;;</p><p>7: len 4; hex 80000000; asc ;;</p><p>8: len 5; hex 6a65656367; asc jeecg;;</p><p>9: len 5; hex 99a60eadf7; asc ;;</p><p>10: len 3; hex 6a6f62; asc job;;</p><p>11: len 5; hex 99a75e0780; asc ^ ;;</p></blockquote><p>其中：</p><p><strong>RECORD LOCKS</strong>，表示持有的是行级锁。</p><p><strong>index PRIMARY</strong>，表示锁的是主键索引。</p><p>**table <code>jeecg-boot</code>.<code>medicine_control</code>**，表示锁的具体是哪个表。</p><p><strong>trx id 10298</strong>，事务id，和上面的TRANSACTION相同。</p><p><strong>lock_mode X locks</strong>，锁模式：排它锁。（X：排他锁，S：共享锁）</p><p><strong>but not gap</strong>，非间隙锁</p><p><strong>后面的0至11</strong>，代表锁的具体哪一行，0至11指的是表的第1至第12个字段，0开头的这行表示id列，可见锁的是id&#x3D;1的那一行，可知这里的事务1就是上面的事务A。【<code>0开头的这列对应本示例中的id字段这一列</code>】</p><h3 id="事务1正在等待的锁"><a href="#事务1正在等待的锁" class="headerlink" title="事务1正在等待的锁"></a>事务1正在等待的锁</h3><p>也就是这段：</p><blockquote><p>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</p><p>RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table <code>jeecg-boot</code>.<code>medicine_control</code> trx id 10298 lock_mode X locks rec but not gap waiting</p><p>Record lock, heap no 4 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</p><p>0: len 1; hex 32; asc 2;;</p><p>1: len 6; hex 00000000283b; asc (;;;</p><p>2: len 7; hex 01000002012bd8; asc + ;;</p><p>3: len 6; hex e788b7e788b7; asc ;;</p><p>4: len 6; hex e69f90e69f90; asc ;;</p><p>5: len 4; hex 80000002; asc ;;</p><p>6: len 4; hex 80000002; asc ;;</p><p>7: len 4; hex 80000000; asc ;;</p><p>8: len 5; hex 6c6979616e; asc liyan;;</p><p>9: len 5; hex 99a67b3730; asc {70;;</p><p>10: len 3; hex 6a6f62; asc job;;</p><p>11: len 5; hex 99a75e0780; asc ^ ;;</p></blockquote><p>其中：</p><p><strong>index PRIMARY</strong>，表示等待的是主键的锁。</p><p>**table <code>jeecg-boot</code>.<code>medicine_control</code>**，表示等待的表。</p><p><strong>trx id 10298</strong>，当前事务1的id。注意这里不是持有目标锁的事务的id，而是当前事务id。</p><p><strong>lock_mode X locks</strong>，表示目标锁是排它锁。</p><p><strong>but not gap</strong>，表示非间隙锁。</p><p><strong>waiting</strong>，表示当前事务正在等待。</p><p><strong>后面的0至11</strong>，表示等待的行，可见等待的是id&#x3D;2的行的锁。</p><h3 id="事务2信息"><a href="#事务2信息" class="headerlink" title="事务2信息"></a>事务2信息</h3><p>也就是这一段：</p><blockquote><p>*** (2) TRANSACTION:</p><p>TRANSACTION 10299, ACTIVE 7 sec starting index read</p><p>mysql tables in use 1, locked 1</p><p>LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</p><p>MySQL thread id 7625, OS thread handle 140133576603392, query id 6006195 127.0.0.1 root updating</p><p>update medicine_control set current_count&#x3D;2 where id&#x3D;&#39;1&#39;</p></blockquote><p>格式和事务1信息相同。</p><p><strong>TRANSACTION 10299</strong>，表示事务id是10299。</p><p>**update medicine_control set current_count&#x3D;2 where id&#x3D;&#39;1&#39;**，表示事务2正在执行的sql。</p><h3 id="事务2正在持有的锁"><a href="#事务2正在持有的锁" class="headerlink" title="事务2正在持有的锁"></a>事务2正在持有的锁</h3><p>也就是这段：</p><blockquote><p>*** (2) HOLDS THE LOCK(S):</p><p>RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table <code>jeecg-boot</code>.<code>medicine_control</code> trx id 10299 lock_mode X locks rec but not gap</p><p>Record lock, heap no 4 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</p><p>0: len 1; hex 32; asc 2;;</p><p>1: len 6; hex 00000000283b; asc (;;;</p><p>2: len 7; hex 01000002012bd8; asc + ;;</p><p>3: len 6; hex e788b7e788b7; asc ;;</p><p>4: len 6; hex e69f90e69f90; asc ;;</p><p>5: len 4; hex 80000002; asc ;;</p><p>6: len 4; hex 80000002; asc ;;</p><p>7: len 4; hex 80000000; asc ;;</p><p>8: len 5; hex 6c6979616e; asc liyan;;</p><p>9: len 5; hex 99a67b3730; asc {70;;</p><p>10: len 3; hex 6a6f62; asc job;;</p><p>11: len 5; hex 99a75e0780; asc ^ ;;</p></blockquote><p>可见事务2持有id&#x3D;2的行锁，也就是说这里的事务2就是上面的事务B。</p><h3 id="事务2正在等待的锁"><a href="#事务2正在等待的锁" class="headerlink" title="事务2正在等待的锁"></a>事务2正在等待的锁</h3><p>也就是这段：</p><blockquote><p>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</p><p>RECORD LOCKS space id 55 page no 4 n bits 88 index PRIMARY of table <code>jeecg-boot</code>.<code>medicine_control</code> trx id 10299 lock_mode X locks rec but not gap waiting</p><p>Record lock, heap no 21 PHYSICAL RECORD: n_fields 12; compact format; info bits 0</p><p>0: len 1; hex 31; asc 1;;</p><p>1: len 6; hex 00000000283a; asc (:;;</p><p>2: len 7; hex 020000012510db; asc % ;;</p><p>3: len 6; hex e5a5b6e5a5b6; asc ;;</p><p>4: len 12; hex e79b98e5b0bce8a5bfe69e97; asc ;;</p><p>5: len 4; hex 80000001; asc ;;</p><p>6: len 4; hex 80000005; asc ;;</p><p>7: len 4; hex 80000000; asc ;;</p><p>8: len 5; hex 6a65656367; asc jeecg;;</p><p>9: len 5; hex 99a60eadf7; asc ;;</p><p>10: len 3; hex 6a6f62; asc job;;</p><p>11: len 5; hex 99a75e0780; asc ^ ;;</p></blockquote><p>可见事务2正在等待id&#x3D;1的行锁。</p><h3 id="死锁处理结果"><a href="#死锁处理结果" class="headerlink" title="死锁处理结果"></a>死锁处理结果</h3><p>也就是这段：</p><blockquote><p>*** WE ROLL BACK TRANSACTION (2)</p></blockquote><p>表示MySQL最终决定回滚事务2，也就是上面的事务B，这和上面事务B返回的死锁信息是一致的。</p><p>另外，日志里还记录的当前SESSION和事务列表，也就是这段：</p><blockquote><p>------------</p><p>TRANSACTIONS</p><p>------------</p><p>Trx id counter 10301</p><p>Purge done for trx&#39;s n:o &lt; 10301 undo n:o &lt; 0 state: running but idle</p><p>History list length 61</p><p>LIST OF TRANSACTIONS FOR EACH SESSION:</p><p>---TRANSACTION 421608706154464, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706153592, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706152720, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706151848, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706150976, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706150104, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706148360, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706147488, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706146616, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706145744, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706144872, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 421608706144000, not started</p><p>0 lock struct(s), heap size 1136, 0 row lock(s)</p><p>---TRANSACTION 10298, ACTIVE 24 sec</p><p>3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2</p><p>MySQL thread id 7623, OS thread handle 140132789073664, query id 6006198 127.0.0.1 root</p></blockquote><p>可见多数的SESSION下的事务都没开始，注意最后的这段：</p><blockquote><p>--- TRANSACTION 10298, ACTIVE 24 sec</p><p>3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2</p></blockquote><p>表示id为10298的事务（也就是事务1）还没提交。</p><h2 id="关于mysql的八种锁"><a href="#关于mysql的八种锁" class="headerlink" title="关于mysql的八种锁"></a>关于mysql的八种锁</h2><h3 id="行锁（Record-Locks）"><a href="#行锁（Record-Locks）" class="headerlink" title="行锁（Record Locks）"></a>行锁（Record Locks）</h3><p>行锁是作用在索引上的。</p><h3 id="间隙锁（Gap-Locks）"><a href="#间隙锁（Gap-Locks）" class="headerlink" title="间隙锁（Gap Locks）"></a>间隙锁（Gap Locks）</h3><p>间隙锁是锁住一个区间的锁。</p><p>这个区间是一个开区间，范围是从某个存在的值向左直到比他小的第一个存在的值，所以间隙锁包含的内容就是在查询范围内，而又不存在的数据区间。</p><p>比如有id分别是1,10,20，要修改id&lt;15的数据，那么生成的间隙锁有以下这些：(-∞,1)，(1,10)，(10,20)，此时若有其他事务想要插入id&#x3D;11的数据，则需要等待。</p><p>间隙锁是不互斥的。</p><p>作用是防止其他事务在区间内添加记录，而本事务可以在区间内添加记录，从而防止幻读。</p><p>在可重复读这种隔离级别下会启用间隙锁，而在读未提交和读已提交两种隔离级别下，即使使用select ... in share mode或select ... for update，也不会有间隙锁，无法防止幻读。</p><h3 id="临键锁（Next-key-Locks）"><a href="#临键锁（Next-key-Locks）" class="headerlink" title="临键锁（Next-key Locks）"></a>临键锁（Next-key Locks）</h3><p>临键锁&#x3D;间隙锁+行锁，于是临键锁的区域是一个左开右闭的区间。</p><p>隔离级别是可重复读时，select ... in share mode或select ... for update会使用临键锁，防止幻读。普通select语句是快照读，不能防止幻读。</p><h3 id="共享锁-排他锁（Shared-and-Exclusive-Locks）"><a href="#共享锁-排他锁（Shared-and-Exclusive-Locks）" class="headerlink" title="共享锁&#x2F;排他锁（Shared and Exclusive Locks）"></a>共享锁&#x2F;排他锁（Shared and Exclusive Locks）</h3><p>共享锁和排它锁都是行锁。共享锁用于事务并发读取，比如select ... in share mode。排它锁用于事务并发更新或删除。比如select ... for update</p><h3 id="意向共享锁-意向排他锁（Intention-Shared-and-Exclusive-Locks）"><a href="#意向共享锁-意向排他锁（Intention-Shared-and-Exclusive-Locks）" class="headerlink" title="意向共享锁&#x2F;意向排他锁（Intention Shared and Exclusive Locks）"></a>意向共享锁&#x2F;意向排他锁（Intention Shared and Exclusive Locks）</h3><p>意向共享锁和意向排他锁都是表级锁。</p><p>官方文档中说，事务获得共享锁前要先获得意向共享锁，获得排它锁前要先获得意向排它锁。</p><p>意向排它锁互相之间是兼容的。</p><h3 id="插入意向锁（Insert-Intention-Locks）"><a href="#插入意向锁（Insert-Intention-Locks）" class="headerlink" title="插入意向锁（Insert Intention Locks）"></a>插入意向锁（Insert Intention Locks）</h3><p>插入意向锁锁的是一个点，是一种特殊的间隙锁，用于并发插入。</p><p>插入意向锁和间隙锁互斥。插入意向锁互相不互斥。</p><h3 id="自增锁（Auto-inc-Locks）"><a href="#自增锁（Auto-inc-Locks）" class="headerlink" title="自增锁（Auto-inc Locks）"></a>自增锁（Auto-inc Locks）</h3><p>自增锁用于事务中插入自增字段。5.1版本前是表锁，5.1及以后版本是互斥轻量锁。</p><p>自增所相关的变量有：</p><p><strong>auto_increment_offset</strong>，初始值</p><p><strong>auto_increment_increment</strong>，每次增加的数量</p><p><strong>innodb_autoinc_lock_mode</strong>，自增锁模式</p><p>其中：</p><p>innodb_autoinc_lock_mode&#x3D;0，传统方式，每次都产生表锁。此为5.1版本前的默认配置。</p><p>innodb_autoinc_lock_mode&#x3D;1，连续方式。产生轻量锁，申请到自增锁就将锁释放，simple insert会获得批量的锁，保证连续插入。此为5.2版本后的默认配置。</p><p>innodb_autoinc_lock_mode&#x3D;2，交错锁定方式。不锁表，并发速度最快。但最终产生的序列号和执行的先后顺序可能不一致，也可能断裂。</p><h2 id="关于死锁的解锁"><a href="#关于死锁的解锁" class="headerlink" title="关于死锁的解锁"></a>关于死锁的解锁</h2><ul><li><p>InnoDB存储引擎会选择回滚undo量最小的事务【持有较少锁的事务(事务id较小的那个)】</p></li><li><p>选择直接kill掉进程</p><ul><li>查看进程：<code>show processlist</code></li><li>kill：<code>kill id</code></li><li>验证：<code>show OPEN TABLES where In_use &gt; 0;</code></li></ul></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/9ccf3750/">https://xiaowu95.wang/posts/9ccf3750/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo17.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/d26f694b/" title="SpringBoot整合Redis多数据源"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo4.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">SpringBoot整合Redis多数据源</div></div><div class="info-2"><div class="info-item-1">基于配置文件 实现 redis 动态数据源和动态数据库的切换 MultiRedisConnectionFactory123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118import org.springframework.beans.factory.DisposableBean;import org.springframework.beans.factory.InitializingBean;import org.springframework.dao.DataAccessException;import...</div></div></div></a><a class="pagination-related" href="/posts/f6f08909/" title="mac开发&amp;环境配置篇"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo4.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">mac开发&环境配置篇</div></div><div class="info-2"><div class="info-item-1">Usage habit Ice, to hide status bar do not use bar appearance, this will cause a bug to use alt + tab instead of the localized function: https://github.com/lwouis/alt-tab-macos to use scroll in windows style: https://github.com/pilotmoon/Scroll-Reverser config the Modifier key &amp; shortcuts: turn off off the shortcuts system setting → 键盘 → 键盘快捷键 → 修饰键 display all hide files or directory type on terminal: defaults write com.apple.finder AppleShowAllFiles YES type on...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/29ddf1e8/" title="MYSQL-记录函数和sql(长期)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-07-09</div><div class="info-item-2">MYSQL-记录函数和sql(长期)</div></div><div class="info-2"><div class="info-item-1">摘自小骨格子屋的 mysql中的instr()函数的用法 想要在字符串中查找某字符串可以使用instr()函数 instr()返回子字符串在字符串中首次出现的位置；如果没有找到，则返回0 用法：123str：从哪个字符串中搜索substr:要搜索的子字符串instr()函数不区分大小写 mysql instr()函数示例：1如图，在abcd字符串中查找是否含有字符串b，返回的字符串位置是2. 说明instr()函数返回的位置是从1开始的，如果找不到则返回0 查找字符串中包含“民”的记录 instr()函数与like运算符 在没有索引的情况下，instr()函数与like运算符的速度是一样的；在具有前缀搜索的LIKE运算符下，使用like运算符速度会更快一些 SUBSTRING(s，n，len) MySQL 中获取子串函数 SUBSTRING(s，n，len) 带有 len 参数的格式，从字符串 s 返回一个长度同 len 字符相同的子字符串，起始于位置 n。 也可能对 n 使用一个负值。假若这样，则子字符串的位置起始于字符串结尾的第 n 个字符，即倒数第 n...</div></div></div></a><a class="pagination-related" href="/posts/be843b28/" title="MySQL中EXPLAIN结果的参数详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo8.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-06-16</div><div class="info-item-2">MySQL中EXPLAIN结果的参数详解</div></div><div class="info-2"><div class="info-item-1">MySQL中EXPLAIN结果的参数详解 explain显示了mysql如何使用索引来处理select语句以及连接表。可以帮助选择更好的索引和写出更优化的查询语句。 EXPLAIN列的解释： select_type123456781） SIMPLE：简单的SELECT，不实用UNION或者子查询。2） PRIMARY：最外层SELECT。3） UNION：第二层，在SELECT之后使用了UNION。4） DEPENDENT UNION：UNION语句中的第二个SELECT，依赖于外部子查询。5） UNION RESULT：UNION的结果。6） SUBQUERY：子查询中的第一个SELECT。7） DEPENDENT SUBQUERY：子查询中的第一个SELECT，取决于外面的查询。8）...</div></div></div></a><a class="pagination-related" href="/posts/f2282f52/" title="MySQL用户权限总结"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-12-11</div><div class="info-item-2">MySQL用户权限总结</div></div><div class="info-2"><div class="info-item-1">转自: https://blog.csdn.net/yeahPeng11/article/details/121584343 一、MySQL用户权限 MySQL版本5.7 背景 在开发过程中数据库安装在云服务器，本地连接阿里云服务器中的MySQL就不能直接root用户连接，而每次数据库操作都要使用新建的用户与用户进行交互操作。 在使用非root用户的时，执行本地的sql文件，就需要一些权限，比如 SELECT,INSERT,UPDATE,DELETE,CREATE...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EMySQL%E7%9A%84%E6%AD%BB%E9%94%81"><span class="toc-number">1.</span> <span class="toc-text">关于MySQL的死锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E9%80%A0%E4%B8%80%E4%B8%AA%E6%AD%BB%E9%94%81%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">制造一个死锁的场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%80%E8%BF%91%E4%B8%80%E6%AC%A1%E6%AD%BB%E9%94%81%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-number">3.</span> <span class="toc-text">查看最近一次死锁的日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8-%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8show-engine-innodb-status%E6%9F%A5%E7%9C%8B%EF%BC%8C%E6%97%A0%E6%B3%95%E8%8E%B7%E5%8F%96%E9%98%BB%E5%A1%9E%E9%94%81%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">注: 直接使用show engine innodb status查看，无法获取阻塞锁线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E6%97%A5%E5%BF%97%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">死锁日志的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8-%E5%85%B3%E4%BA%8E%E6%97%A5%E5%BF%97%E5%B1%95%E7%A4%BA%E7%9A%840-11%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.</span> <span class="toc-text">注: 关于日志展示的0-11字段信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A11%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.</span> <span class="toc-text">事务1信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A11%E6%8C%81%E6%9C%89%E7%9A%84%E9%94%81"><span class="toc-number">4.3.</span> <span class="toc-text">事务1持有的锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A11%E6%AD%A3%E5%9C%A8%E7%AD%89%E5%BE%85%E7%9A%84%E9%94%81"><span class="toc-number">4.4.</span> <span class="toc-text">事务1正在等待的锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A12%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">事务2信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A12%E6%AD%A3%E5%9C%A8%E6%8C%81%E6%9C%89%E7%9A%84%E9%94%81"><span class="toc-number">4.6.</span> <span class="toc-text">事务2正在持有的锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A12%E6%AD%A3%E5%9C%A8%E7%AD%89%E5%BE%85%E7%9A%84%E9%94%81"><span class="toc-number">4.7.</span> <span class="toc-text">事务2正在等待的锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C"><span class="toc-number">4.8.</span> <span class="toc-text">死锁处理结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Emysql%E7%9A%84%E5%85%AB%E7%A7%8D%E9%94%81"><span class="toc-number">5.</span> <span class="toc-text">关于mysql的八种锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E9%94%81%EF%BC%88Record-Locks%EF%BC%89"><span class="toc-number">5.1.</span> <span class="toc-text">行锁（Record Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88Gap-Locks%EF%BC%89"><span class="toc-number">5.2.</span> <span class="toc-text">间隙锁（Gap Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E9%94%AE%E9%94%81%EF%BC%88Next-key-Locks%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">临键锁（Next-key Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81-%E6%8E%92%E4%BB%96%E9%94%81%EF%BC%88Shared-and-Exclusive-Locks%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">共享锁&#x2F;排他锁（Shared and Exclusive Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E5%85%B1%E4%BA%AB%E9%94%81-%E6%84%8F%E5%90%91%E6%8E%92%E4%BB%96%E9%94%81%EF%BC%88Intention-Shared-and-Exclusive-Locks%EF%BC%89"><span class="toc-number">5.5.</span> <span class="toc-text">意向共享锁&#x2F;意向排他锁（Intention Shared and Exclusive Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%84%8F%E5%90%91%E9%94%81%EF%BC%88Insert-Intention-Locks%EF%BC%89"><span class="toc-number">5.6.</span> <span class="toc-text">插入意向锁（Insert Intention Locks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%A2%9E%E9%94%81%EF%BC%88Auto-inc-Locks%EF%BC%89"><span class="toc-number">5.7.</span> <span class="toc-text">自增锁（Auto-inc Locks）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%AD%BB%E9%94%81%E7%9A%84%E8%A7%A3%E9%94%81"><span class="toc-number">6.</span> <span class="toc-text">关于死锁的解锁</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 TypeScript 创建 Koa 服务器"></a><div class="content"><a class="title" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器">使用 TypeScript 创建 Koa 服务器</a><time datetime="2025-10-11T06:00:11.000Z" title="发表于 2025-10-11 14:00:11">2025-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nodejs应用提取heap并加以分析的一些常用方法"></a><div class="content"><a class="title" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法">Nodejs应用提取heap并加以分析的一些常用方法</a><time datetime="2025-09-28T07:54:43.000Z" title="发表于 2025-09-28 15:54:43">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo17.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 小五</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=document.querySelectorAll("#article-container .chartjs-container");if(0===t.length)return;const e=(t,a)=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach((r=>{const n=t[r];"object"==typeof n&&null!==n&&(n[a]?t[r]=n[a]:e(n,a))}))},a=()=>{window.loadChartJS=!0,Array.from(t).forEach(((t,a)=>{const r=t.firstElementChild,n=t.getAttribute("data-chartjs-id")||"chartjs-"+a,d=t.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),e(i,m),new Chart(h,i)}))},r=()=>{window.loadChartJS?a():btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js").then(a)};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?r():document.addEventListener("DOMContentLoaded",r)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['link[rel="canonical"]','meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>e()))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404")}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.12.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.75.3/dist/instantsearch.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo25.jpg" alt="/img/nba-logo25.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo15.jpg" alt="/img/nba-logo15.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-04-06</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo17.jpg" alt="/img/nba-logo17.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="/img/nba-logo9.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" alt="/img/nba-logo30.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>