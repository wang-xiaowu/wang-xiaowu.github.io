<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>k8s大版本新特性一览(长期记录) | 小五的个人杂货铺</title><meta name="author" content="小五"><meta name="copyright" content="小五"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Kubernetes v1.22Kubernetes v1.22 已经在今天正式发布了，这是 2021 年的第二个正式发布的版本。此版本中共包含 53 项增强更新，其中 13 项达到 stable，24 项达到 beta 还有 16 项为 alpha。当然，也有 3 项特性被标记为废弃。 从今年的 4 月份，Kubernetes 的发布节奏由原来的每 3 个月一个版本修改成了每 4 个月一个版本，"><meta property="og:type" content="article"><meta property="og:title" content="k8s大版本新特性一览(长期记录)"><meta property="og:url" content="https://xiaowu95.wang/posts/1dca4389/"><meta property="og:site_name" content="小五的个人杂货铺"><meta property="og:description" content="Kubernetes v1.22Kubernetes v1.22 已经在今天正式发布了，这是 2021 年的第二个正式发布的版本。此版本中共包含 53 项增强更新，其中 13 项达到 stable，24 项达到 beta 还有 16 项为 alpha。当然，也有 3 项特性被标记为废弃。 从今年的 4 月份，Kubernetes 的发布节奏由原来的每 3 个月一个版本修改成了每 4 个月一个版本，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiaowu95.wang/img/nba-logo13.jpg"><meta property="article:published_time" content="2023-09-26T06:01:39.000Z"><meta property="article:modified_time" content="2023-12-11T09:21:34.000Z"><meta property="article:author" content="小五"><meta property="article:tag" content="k8s"><meta property="article:tag" content="容器化"><meta property="article:tag" content="k3s"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaowu95.wang/img/nba-logo13.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xiaowu95.wang/posts/1dca4389/"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="kHfLZxYQ7y3s3AR7gyJDdJkQvGNjQsvopp6N3gEEx0s"><meta name="baidu-site-verification" content="codeva-aVS4F6wAjS"><link rel="manifest" href="/wang-xiaowu/pwa/site.webmanifest"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/wang-xiaowu/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/wang-xiaowu/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/wang-xiaowu/pwa/favicon-16x16.png"><link rel="mask-icon" href="/wang-xiaowu/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.2.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const t={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:t,getScript:(e,t={})=>new Promise(((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach((([e,t])=>n.setAttribute(e,t))),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),getCSS:(e,t)=>new Promise(((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)})),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const o=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},a=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=o,btf.activateLightMode=a;const n=t.get("theme"),c=window.matchMedia("(prefers-color-scheme: dark)"),r=window.matchMedia("(prefers-color-scheme: light)");if(void 0===n){if(r.matches)a();else if(c.matches)o();else{const e=(new Date).getHours();e<=6||e>=18?o():a()}c.addEventListener("change",(()=>{void 0===t.get("theme")&&(e.matches?o():a())}))}else"light"===n?a():o();const d=t.get("aside-status");void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?86cb34987e15c900c39e12ebdf08c50d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),btf.addGlobalFn("pjaxComplete",(()=>{_hmt.push(["_trackPageview",window.location.pathname])}),"baidu_analytics")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MFQ47191J"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MFQ47191J"),btf.addGlobalFn("pjaxComplete",(()=>{gtag("config","G-1MFQ47191J",{page_path:window.location.pathname})}),"google_analytics")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"M91QAWRVY4",apiKey:"ecc30a5e06136e1cc491685e39801190",indexName:"xiaowu-blog",hitsPerPage:6,languages:{input_placeholder:"搜索文章",hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400,highlightFullpage:!0,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!0},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:150,languages:{author:"作者: 小五",link:"链接: ",source:"来源: 小五的个人杂货铺",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"k8s大版本新特性一览(长期记录)",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/font.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="/css/titleStyle.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/custom.css"><style>.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="alternate" href="/atom.xml" title="小五的个人杂货铺" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},btf.addGlobalFn("pjaxSend",(()=>{Pace.restart()}),"pace_restart")</script><link rel="stylesheet" href="/css/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/nba-logo13.jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小五的个人杂货铺</span></a><a class="nav-page-title" href="/"><span class="site-name">k8s大版本新特性一览(长期记录)</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/github/"><i class="fa-fw fa-solid fa-address-card"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="/ac/"><i class="fa-fw fa-solid fa-wind"></i> <span>便携小空调</span></a></div><div class="menus_item"><a class="site-page" href="/talking/"><i class="fa-fw fa-solid fa-walkie-talkie"></i> <span>博客短记</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i> <span>目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-otter"></i> <span>杂记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-film"></i> <span>影视|番剧</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book faa-fload"></i> <span>书单</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad faa-fload"></i> <span>游戏</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa-brands fa-bilibili"></i> <span>BiliBili追番</span></a></li><li><a class="site-page child" href="/cinemas/"><i class="fa-fw fa-solid fa-video"></i> <span>BiliBili追剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment-dots"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-user-group"></i> <span>友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-mug-saucer"></i> <span>Website Memo</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://console.leancloud.app/apps"><span>🚀 LeanCloud</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://vercel.com/dashboard"><span>🚀 Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://tongji.baidu.com/main/overview/10000432799/overview/index"><span>🚀 百度统计</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://ziyuan.baidu.com/dashboard/index"><span>🚀 百度站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://analytics.google.com/analytics/web/"><span>🚀 谷歌分析</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://search.google.com/search-console?hl=zh-cn"><span>🚀 谷歌站点管理</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.google.com/adsense/new/u/0/pub-1375421173355613/home"><span>🚀 谷歌广告联盟</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.algolia.com/"><span>🚀 Algolia</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://sms-activate.org/cn/"><span>🚀 Sms-activate</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://chatgpt.com/"><span>🚀 ChatGPT</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://poe.com/"><span>🚀 Poe聚合</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.idc.net/clientarea"><span>🚀 后浪云</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.west.cn/"><span>🚀 西部数据</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://shandianpro.com/#/dashboard"><span>🚀 闪电</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.huojian.homes/"><span>🚀 小火箭</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/winston779/gougou"><span>🚀 狗狗加速</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">k8s大版本新特性一览(长期记录)<a class="post-edit-link" href="https://github.com/wang-xiaowu/wang-xiaowu.github.io/issues/new?_posts/kubernetes/k8s大版本新特性一览(长期记录).md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-26T06:01:39.000Z" title="发表于 2023-09-26 14:01:39">2023-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-11T09:21:34.000Z" title="更新于 2023-12-11 17:21:34">2023-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">19.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离上一次更新该文章已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章所描述的內容可能已经发生变化，请留意。&quot;,&quot;postUpdate&quot;:&quot;2023-12-11 17:21:34&quot;}" hidden></div><h1 id="Kubernetes-v1-22"><a href="#Kubernetes-v1-22" class="headerlink" title="Kubernetes v1.22"></a>Kubernetes v1.22</h1><p>Kubernetes v1.22 已经在今天正式发布了，这是 2021 年的第二个正式发布的版本。此版本中共包含 53 项增强更新，其中 13 项达到 stable，24 项达到 beta 还有 16 项为 alpha。当然，也有 3 项特性被标记为废弃。</p><p>从今年的 4 月份，Kubernetes 的发布节奏由原来的每 3 个月一个版本修改成了每 4 个月一个版本，这也是第一个应用了此节奏的长周期版本。</p><h2 id="Server-side-Apply-特性达到-GA"><a href="#Server-side-Apply-特性达到-GA" class="headerlink" title="Server-side Apply 特性达到 GA"></a>Server-side Apply 特性达到 GA</h2><p>Server-side Apply 这个特性主要目标是把逻辑从 <code>kubectl apply</code> 移动到 kube-apiserver 中，这可以修复当前遇到的很多有关所有权冲突的问题。</p><p>Server-side Apply 当前是通过 <code>Kubernetes</code> 新增的 <code>.meta.managedFields</code> 属性来跟踪对象字段的更改的。</p><p>同时此特性的好处在于你可以直接通过 API 完成声明式配置的操作，而无需依赖于特定的 <code>kubectl apply</code> 命令，比如直接通过 <code>curl</code> 即可完成。</p><p>此功能的用法如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --server-side [--dry-run=server]</span><br></pre></td></tr></table></figure><h2 id="Pod-Security-Policy-的替代品"><a href="#Pod-Security-Policy-的替代品" class="headerlink" title="Pod Security Policy 的替代品"></a>Pod Security Policy 的替代品</h2><p>PodSecurity admission controller 是在 Kubernets v1.21 中被废弃的 Pod Security Policies 的替代品。</p><p>这个 admission controller 可以按 namespace 级别启用 Pod Security Standards ，可以有以下三种模式：</p><ul><li><strong>enforce</strong>: 违反策略的 Pod 将被拒绝；</li><li><strong>audit</strong>：违反策略的 Pod 将会添加审计注释，但其他情况下都允许；</li><li><strong>warn</strong>：违反策略的 Pod 将会触发面向用户的警告；</li></ul><p>可通过如下配置文件进行控制：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiserver.config.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AdmissionConfiguration</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodSecurity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">defaults:</span>  <span class="comment"># Defaults applied when a mode label is not set.</span></span><br><span class="line">      <span class="attr">enforce:</span>         <span class="string">&lt;default</span> <span class="string">enforce</span> <span class="string">policy</span> <span class="string">level&gt;</span></span><br><span class="line">      <span class="attr">enforce-version:</span> <span class="string">&lt;default</span> <span class="string">enforce</span> <span class="string">policy</span> <span class="string">version&gt;</span></span><br><span class="line">      <span class="attr">audit:</span>         <span class="string">&lt;default</span> <span class="string">audit</span> <span class="string">policy</span> <span class="string">level&gt;</span></span><br><span class="line">      <span class="attr">audit-version:</span> <span class="string">&lt;default</span> <span class="string">audit</span> <span class="string">policy</span> <span class="string">version&gt;</span></span><br><span class="line">      <span class="attr">warn:</span>          <span class="string">&lt;default</span> <span class="string">warn</span> <span class="string">policy</span> <span class="string">level&gt;</span></span><br><span class="line">      <span class="attr">warn-version:</span>  <span class="string">&lt;default</span> <span class="string">warn</span> <span class="string">policy</span> <span class="string">version&gt;</span></span><br><span class="line">    <span class="attr">exemptions:</span></span><br><span class="line">      <span class="attr">usernames:</span>         [ <span class="string">&lt;array</span> <span class="string">of</span> <span class="string">authenticated</span> <span class="string">usernames</span> <span class="string">to</span> <span class="string">exempt&gt;</span> ]</span><br><span class="line">      <span class="attr">runtimeClassNames:</span> [ <span class="string">&lt;array</span> <span class="string">of</span> <span class="string">runtime</span> <span class="string">class</span> <span class="string">names</span> <span class="string">to</span> <span class="string">exempt&gt;</span> ]</span><br><span class="line">      <span class="attr">namespaces:</span>        [ <span class="string">&lt;array</span> <span class="string">of</span> <span class="string">namespaces</span> <span class="string">to</span> <span class="string">exempt&gt;</span> ]</span><br></pre></td></tr></table></figure><h2 id="Node-swap-支持"><a href="#Node-swap-支持" class="headerlink" title="Node swap 支持"></a>Node swap 支持</h2><p>此特性现在是 Alpha 阶段。</p><p>虽然 swap 并不够快，但是现在有很多场景都是需要用到它的，尤其是一些 Java 和 Node 应用。</p><p>在 Kubernetes 的 issue 列表中有一个存在了 5 年左右的讨论，就是针对于能否开启 swap 支持的。当前这个特性一旦开启就是针对于整个 Node 的，并不能精确到某个 Pod 中。</p><p>你可以通过如下步骤启用此特性：</p><ul><li>在 Node 中启用 swap；</li><li>开启 kubelet 的 <code>NodeMemorySwap</code> 特性；</li><li>设置 <code>--fail-on-swap=false</code></li><li>可选在 Kubelet 的配置中增加 <code>MemorySwap.SwapBehavior=UnlimitedSwap</code></li></ul><p>更多内容可参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2400-node-swap">https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2400-node-swap</a></p><h2 id="外部客户端凭证提供工具"><a href="#外部客户端凭证提供工具" class="headerlink" title="外部客户端凭证提供工具"></a>外部客户端凭证提供工具</h2><p>这个功能允许 client-go 使用外部工具进行身份验证，比如 LDAP、Kerberos、OAuth2、SAML 等。这个特性是从 v1.10 开始引入的。</p><p>使用此特性的话，需要你在 kubeconfig 配置文件中作为 user 字段下的字段进行配置。比如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-user</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">&quot;example-client-go-exec-plugin&quot;</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">&quot;client.authentication.k8s.io/v1beta1&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;FOO&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;bar&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;arg1&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;arg2&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">provideClusterInfo:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>在 <code>user.exec</code>字段下配置可用的 client-go-exec plugin 即可。现在也有一个示例项目可供参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ankeesler/sample-exec-plugin">https://github.com/ankeesler/sample-exec-plugin</a></p><h2 id="可索引的-Job-API"><a href="#可索引的-Job-API" class="headerlink" title="可索引的 Job API"></a>可索引的 Job API</h2><p>在 Kubernetes v1.21 中新增的可索引 Job API 可以更加方便的调度并行化的 Job。现在可以使用如下的方式通过环境变量让 Job 中的 Pod 知道自己的索引：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">...</span>]</span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">subdomain:</span> <span class="string">my-job-svc</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.example.com/processing-image</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;./process&quot;</span>,  <span class="string">&quot;--index&quot;</span>, <span class="string">&quot;$JOB_COMPLETION_INDEX&quot;</span>, <span class="string">&quot;--hosts-pattern&quot;</span>, <span class="string">&quot;my-job-<span class="template-variable">&#123;&#123;.id&#125;&#125;</span>.my-job-svc&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="为-Job-API-增加-suspend-字段"><a href="#为-Job-API-增加-suspend-字段" class="headerlink" title="为 Job API 增加 suspend 字段"></a>为 Job API 增加 suspend 字段</h2><p>自 v1.21 起，Job 可以通过设置 <code>.spec.suspend=true</code> 字段来临时的挂起。可以比较方便的去进行控制，类似 Argo workflow 中，也可以对某个 workflow 进行挂起操作。</p><h2 id="CSR-的有效期"><a href="#CSR-的有效期" class="headerlink" title="CSR 的有效期"></a>CSR 的有效期</h2><p>通过在 <code>CertificateSigningRequestSpec</code> 中增加的 <code>ExpirationSeconds</code> 可以接受的最小值是 600（10分钟），这样就可以很好的控制其有效期了。现在默认的是 1 年。</p><h2 id="内存资源的-QoS"><a href="#内存资源的-QoS" class="headerlink" title="内存资源的 QoS"></a>内存资源的 QoS</h2><p>之前 Kubernetes 在使用 cgroups v1 ，对于 Pod 的 QoS 其实只适用于 CPU 资源。Kubernetes v1.22 中通过引入 cgroups v2 来提供了一个 alpha 特性，允许对内存资源也提供 QoS。（如果没记错，貌似是腾讯云团队提交的 KEP 吧）</p><p>当然，你也可以通过KIND 使用如下命令来快速的体验 Kubernetes v1.22 ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster --image=kindest/node:v1.22.0@sha256:b8bda84bb3a190e6e028b1760d277454a72267a5454b57db34437c34a588d047</span><br></pre></td></tr></table></figure><h1 id="Kubernetes-v1-23"><a href="#Kubernetes-v1-23" class="headerlink" title="Kubernetes v1.23"></a>Kubernetes v1.23</h1><p>Kubernetes v1.23 今天正式发布，这是 2021 年发布的第三个版本，也是 2021 年最后一个正式发布的版本。</p><p>此版本中主要包括 47 项增强更新，其中 11 项达到 stable, 17 项达到 beta 还有 19 项达到 alpha 。当然，也有 1 项被标记为废弃。相比于 v1.22 从数量上来说是少了一点（v1.22 有 53 项增强更新），但这并不影响这是一个很棒的版本！</p><p>在 Kubernetes 的发布周期变更为 <strong>每4个月一个版本</strong> 后，很明显的感觉就是不用在升级上面花费太多时间了，毕竟 Kubernetes 的升级操作是个体力活。</p><h2 id="新增-kubectl-alpha-events-命令"><a href="#新增-kubectl-alpha-events-命令" class="headerlink" title="新增 kubectl alpha events 命令"></a>新增 kubectl alpha events 命令</h2><p>在<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296608&idx=1&sn=f56f3a3ee090a37b98c0767de3bd14bf&chksm=f2eb9f3fc59c16292d26ace955fa910270afa8c45a67313f54f77ae285a03e049e70aa23d1c2&scene=21#wechat_redirect">《K8S 生态周报| Helm 新版本发布增强对 OCI 的支持》</a> 文章的上游进展中曾介绍了该功能。它是按照 KEP #1440 实施的。</p><blockquote><p>“</p><p>增加此命令主要是由于在不修改 <code>kubectl get</code> 的前提下，查看 <code>event</code> 有一些限制，所以直接增加 <code>kubectl events</code> 命令可以更方便的去获取到需要的信息，尤其是 event 是在 Kubernetes 中经常需要查看的一个信息。<code>kubectl get events</code> 比较典型的一些问题, 比如排序（虽然可以通过加参数解决）， watch，以及无法按照时间线方式去查看 events 等。</p><p>”</p></blockquote><p>来看看这个命令具体如何使用。</p><p>我们先来创建两个 Pod，分别叫 <code>redis</code> 和 <code>redis2</code> 。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(MoeLove) ➜ kubectl run redis --image=<span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span> </span><br><span class="line">pod/redis created</span><br><span class="line">(MoeLove) ➜ kubectl run redis2 --image=<span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span></span><br><span class="line">pod/redis2 created</span><br><span class="line">(MoeLove) ➜ kubectl  get pods</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE</span><br><span class="line">redis    1/1     Running   0          12m</span><br><span class="line">redis2   1/1     Running   0          2m23s</span><br></pre></td></tr></table></figure><p>执行 <code>kubectl alpha events</code> 可以看到当前 namespace 下的所有 events 。如果增加 <code>--for</code> 条件可以用来筛选只展示特定资源相关的 events 。同时 <strong>默认情况下就是按时间排序的</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(MoeLove) ➜ kubectl  alpha events</span><br><span class="line">LAST SEEN   TYPE     REASON      OBJECT       MESSAGE</span><br><span class="line">12m         Normal   Scheduled   Pod/redis    Successfully assigned default/redis to kind-control-plane</span><br><span class="line">12m         Normal   Pulling     Pod/redis    Pulling image <span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span></span><br><span class="line">12m         Normal   Pulled      Pod/redis    Successfully pulled image <span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span> <span class="keyword">in</span> 4.028873745s</span><br><span class="line">12m         Normal   Created     Pod/redis    Created container redis</span><br><span class="line">12m         Normal   Started     Pod/redis    Started container redis</span><br><span class="line">3m5s        Normal   Scheduled   Pod/redis2   Successfully assigned default/redis2 to kind-control-plane</span><br><span class="line">3m5s        Normal   Pulled      Pod/redis2   Container image <span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span> already present on machine</span><br><span class="line">3m4s        Normal   Created     Pod/redis2   Created container redis2</span><br><span class="line">3m4s        Normal   Started     Pod/redis2   Started container redis2</span><br><span class="line">(MoeLove) ➜ kubectl  alpha events --<span class="keyword">for</span> pod/redis2</span><br><span class="line">LAST SEEN   TYPE     REASON      OBJECT       MESSAGE</span><br><span class="line">3m23s       Normal   Scheduled   Pod/redis2   Successfully assigned default/redis2 to kind-control-plane</span><br><span class="line">3m23s       Normal   Pulled      Pod/redis2   Container image <span class="string">&quot;ghcr.io/tao12345666333/redis:alpine&quot;</span> already present on machine</span><br><span class="line">3m22s       Normal   Created     Pod/redis2   Created container redis2</span><br><span class="line">3m22s       Normal   Started     Pod/redis2   Started container redis2</span><br></pre></td></tr></table></figure><h2 id="IPv4-IPv6-双栈支持达到-GA"><a href="#IPv4-IPv6-双栈支持达到-GA" class="headerlink" title="IPv4&#x2F;IPv6 双栈支持达到 GA"></a>IPv4&#x2F;IPv6 双栈支持达到 GA</h2><p>在配置双栈网络的 Kubernetes 时，需要同时指定 <code>--node-cidr-mask-size-ipv4</code> 和 <code>--node-cidr-mask-size-ipv6</code> 以便于设置每个 Node 上的子网大小。在此之前我们都是直接使用 <code>--node-cidr-mask-size</code> 进行设置即可。</p><p>如果我们仍然使用单栈 Kubernetes 集群的话，正常来说不需要做什么调整，当然我们也可以使用上面提到的选项，来单独设置集群的 IPv4&#x2F;IPv6 子网。</p><h2 id="PodSecurity-Admission-达到-Beta"><a href="#PodSecurity-Admission-达到-Beta" class="headerlink" title="PodSecurity Admission 达到 Beta"></a>PodSecurity Admission 达到 Beta</h2><p>PodSecurity Admission 是之前的 PSP 的代替，关于 Kubernetes Admission 可以参考文章 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296994&idx=2&sn=60686fcebaacff30b9762a6229e85d12&chksm=f2eb81bdc59c08ab0f10013ed2bda48a7f3f5f3e0d335b7f1cdbbbce6e5b81656b487e9955d8&scene=21#wechat_redirect">《理清 Kubernetes 中 Admission 机制》</a>。</p><h2 id="IngressClass-支持-namespace-级别的参数"><a href="#IngressClass-支持-namespace-级别的参数" class="headerlink" title="IngressClass 支持 namespace 级别的参数"></a>IngressClass 支持 namespace 级别的参数</h2><p><code>IngressClass.Spec.Parameters.Namespace</code> 字段当前达到 GA ，这样就可以为 IngressClass 设置参数为 namespace 级别了。比如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"> <span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"> <span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">external-lb</span></span><br><span class="line"> <span class="attr">spec:</span></span><br><span class="line">   <span class="attr">controller:</span> <span class="string">example.com/ingress-controller</span></span><br><span class="line">   <span class="attr">parameters:</span></span><br><span class="line">     <span class="attr">apiGroup:</span> <span class="string">k8s.example.com</span></span><br><span class="line">     <span class="attr">kind:</span> <span class="string">IngressParameters</span></span><br><span class="line">     <span class="attr">name:</span> <span class="string">external-lb</span></span><br><span class="line">     <span class="attr">namespace:</span> <span class="string">external-configuration</span></span><br><span class="line">     <span class="attr">scope:</span> <span class="string">Namespace</span></span><br></pre></td></tr></table></figure><h2 id="Probe-中增加-gRPC-协议的支持"><a href="#Probe-中增加-gRPC-协议的支持" class="headerlink" title="Probe 中增加 gRPC 协议的支持"></a>Probe 中增加 gRPC 协议的支持</h2><p>通过 KEP #2727 ，在此版本中为 Pod.Spec.Container.{Liveness,Readiness,Startup} 的 Probe 添加了 gRPC 协议的支持。例如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">grpc:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">moelove-service</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p>可通过 <code>GRPCContainerProbe</code> feature gate 开启此特性。具体细节可参考 <code>#106463</code></p><h2 id="新增-OpenAPI-V3"><a href="#新增-OpenAPI-V3" class="headerlink" title="新增 OpenAPI V3"></a>新增 OpenAPI V3</h2><p>这个特性是 Alpha 级别，可通过 <code>OpenApiv3</code> feature gate 进行开启。</p><p>增加此特性主要是由于 CRD 目前可通过 OpenApi V3 进行定义，但是 api-server 目前还不支持。当从 OpenApi V3 转换为 V2 时，部分信息将会丢失。</p><p>更多详细信息可参考 KEP <code>#2896</code></p><h2 id="CRD-Validation-表达式语言"><a href="#CRD-Validation-表达式语言" class="headerlink" title="CRD Validation 表达式语言"></a>CRD Validation 表达式语言</h2><p>这是一项 Alpha 级别的特性，默认是不开启的。可通过增加 <code>CustomResourceValidationExpressions</code> feature gate 来进行开启。单独介绍此 Alpha 级别的特性是因为目前基于 Custom Resource Definitions (CRDs) 的方式对 Kubernetes 进行扩展已经成为主流，但是在 CRD 中目前能添加的校验规则有限，更多的场景都需要通过额外的 Admission 来完成。</p><p>此功能使用一种叫做 Common Expression Language (CEL) 的语言进行规则定义，通过 <code>x-kubernetes-validation-rules</code> 字段进行规则的添加。</p><p>例如，某个 CRDs 的内容如下，其中定义了 <code>minReplicas</code> 小于 <code>replicas</code> 并且 <code>replicas</code> 小于 <code>maxReplicas</code> 。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">openAPIV3Schema:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">  <span class="attr">properties:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">      <span class="attr">x-kubernetes-validation-rules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.minReplicas &lt;= self.replicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be greater than or equal to minReplicas.&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.replicas &lt;= self.maxReplicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be smaller than or equal to maxReplicas.&quot;</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">minReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">replicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">maxReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">minReplicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">replicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">maxReplicas</span> </span><br></pre></td></tr></table></figure><p>那么，当有如下的自定义资源创建时，Kubernetes 将会拒绝其请求。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;stable.example.com/v1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomDeployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-new-deploy-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p>并且返回如下错误：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The CustomDeployment &quot;my-new-deploy-object&quot; is invalid:</span><br><span class="line">* spec: Invalid value: map[string]interface &#123;&#125;&#123;&quot;maxReplicas&quot;:10, &quot;minReplicas&quot;:0, &quot;replicas&quot;:20&#125;: replicas should be smaller than or equal to maxReplicas.</span><br></pre></td></tr></table></figure><p>这样相比原来我们通过 Admission 的方式来进行校验就会方便的多。关于 Kubernetes Admission 可以参考文章 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296994&idx=2&sn=60686fcebaacff30b9762a6229e85d12&chksm=f2eb81bdc59c08ab0f10013ed2bda48a7f3f5f3e0d335b7f1cdbbbce6e5b81656b487e9955d8&scene=21#wechat_redirect">《理清 Kubernetes 中 Admission 机制》</a>。</p><h2 id="HPA-v2-API-达到-GA"><a href="#HPA-v2-API-达到-GA" class="headerlink" title="HPA v2 API 达到 GA"></a>HPA v2 API 达到 GA</h2><p>HPA v2 大约是在 5 年前首次提出，经过这 5 年的发展，终于在现在它达到了 GA 级别。</p><h1 id="Kubernetes-v1-24"><a href="#Kubernetes-v1-24" class="headerlink" title="Kubernetes v1.24"></a>Kubernetes v1.24</h1><h2 id="各beta-API默认关闭"><a href="#各beta-API默认关闭" class="headerlink" title="各beta API默认关闭"></a>各beta API默认关闭</h2><p>在默认情况下，新的各beta API不会在集群内得到启用。但全部原有beta API及其新版本将在1.24中继续默认启用</p><h2 id="OpenAPI-v3"><a href="#OpenAPI-v3" class="headerlink" title="OpenAPI v3"></a>OpenAPI v3</h2><p>Kubernetes 1.24开始为API的OpenAPI v3发布格式提供beta支持。</p><h2 id="存储容量与存储卷扩展双双迎来通用版本"><a href="#存储容量与存储卷扩展双双迎来通用版本" class="headerlink" title="存储容量与存储卷扩展双双迎来通用版本"></a>存储容量与存储卷扩展双双迎来通用版本</h2><p>存储容量跟踪通过CSIStorageCapacity对象公开当前可用的存储容量，并对使用后续绑定的CSI存储卷的pod进行调度增强。<br>存储卷扩展则新增对现有持久卷的重新调整功能。</p><h2 id="NonPreemptingPriority迎来稳定版"><a href="#NonPreemptingPriority迎来稳定版" class="headerlink" title="NonPreemptingPriority迎来稳定版"></a>NonPreemptingPriority迎来稳定版</h2><p>此功能为PriorityClasses添加了新的选项，可开启或关闭Pod抢占机制</p><h2 id="存储插件迁移"><a href="#存储插件迁移" class="headerlink" title="存储插件迁移"></a>存储插件迁移</h2><p>目前Kubernetes开发团队正在迁移树内存储插件，希望在实现CSI插件的同时、保持原有API的正常起效。Azure Disk与OpenStack Cinder等插件已经完成了迁移。</p><h2 id="gRPC探针升级至beta版"><a href="#gRPC探针升级至beta版" class="headerlink" title="gRPC探针升级至beta版"></a>gRPC探针升级至beta版</h2><p>在1.24版本中，gRPC探针功能已经进入beta阶段且默认启用。现在，大家可以在Kubernetes中为自己的gRPC应用程序原生配置启动、活动与就绪探测，而且无需公开HTTP商战或者使用额外的可执行文件。</p><h2 id="Kubelet证书提供程序升级至beta版"><a href="#Kubelet证书提供程序升级至beta版" class="headerlink" title="Kubelet证书提供程序升级至beta版"></a>Kubelet证书提供程序升级至beta版</h2><p>最初在Kubernetes 1.20版本中以alpha版亮相的kubelet镜像证书提供程序现已升级至beta版。现在，kubelet将使用exec插件动态检索容器镜像注册表的凭证，而不再将凭证存储在节点文件系统之上。</p><h2 id="避免为服务分配IP时发生冲突"><a href="#避免为服务分配IP时发生冲突" class="headerlink" title="避免为服务分配IP时发生冲突"></a>避免为服务分配IP时发生冲突</h2><p>Kubernetes 1.24引入了一项新的选择性功能，允许用户为服务的静态IP分配地址保留一个软范围。通过手动启用此项功能，集群将从您指定的服务IP池中自动获取地址，从而降低冲突风险。</p><p>也就是说，服务的ClusterIP能够以下列方式分配：<br>动态分配，即集群将在配置的服务IP范围内自动选择一个空闲IP。<br>静态分配，意味着用户需要在已配置的服务IP范围内指定一个IP。</p><blockquote><p>服务ClusterIP是唯一的；因此若尝试使用已被分配的ClusterIP进行服务创建，则会返回错误结果。</p></blockquote><h1 id="Kubernetes-v1-25"><a href="#Kubernetes-v1-25" class="headerlink" title="Kubernetes v1.25"></a>Kubernetes v1.25</h1><p>Kubernetes 正式发布了，包含了 40 项目增强更新。</p><p>本次 LOGO 的主要表达的意思是 <strong>尊重协作和开放的精神</strong> ，这种精神将我们凝聚到一起转变为能改变世界的力量。</p><p>其实我每期的 「k8s生态周报」都有一个叫上游进展的部分，所以很多值得关注的内容在之前的文章中已经发过了。</p><p>这篇中我会再额外介绍一些之前未涵盖的，和之前介绍过的值得关注的内容。</p><h2 id="core-CSI-Migration-达到-Stable"><a href="#core-CSI-Migration-达到-Stable" class="headerlink" title="core CSI Migration 达到 Stable"></a><strong>core CSI Migration 达到 Stable</strong></h2><p>Kubernetes 对 CSI 的支持是自 v1.9 开始引入的，到 2019 年的 v1.13 时已经正式 GA 。最近几个版本中，社区正在将原本的 in-tree 插件逐步废弃或删除，并迁移至使用 CSI 驱动的方式。</p><p>迁移至使用 CSI 的好处在于，能提高可维护性，并减少因 in-tree 代码导致的漏洞或者错误的发生。</p><p>但是迁移也并不是直接替换，社区考虑到用户的迁移成本，于是提出了一种解决方案：CSI Migration ，这个方案是将 in-tree API 转换为等效 CSI API，并将操作委托给 CSI 驱动程序的功能。目前该功能达到 GA，in-tree 的迁移也有很多进展。</p><ul><li>deprecate GlusterFS plugin from available in-tree drivers. by humblec · Pull Request <code>#111485</code> · kubernetes&#x2F;kubernetes</li></ul><p>在这个 PR 中废弃了 in-tree 的 GlusterFS 的 plugin，这其实是最早的 dynamic provisioner ，自 Kubernetes v1.4 版本开始引入。</p><p>在后来 CSI 驱动出现的时候，社区中也立刻出现了对应的驱动实现 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/gluster/gluster-csi-driver/">https://github.com/gluster/gluster-csi-driver/</a> ，只不过该项目并没有积极的进行维护。现在还有另一个比较推荐的替代方案，可以考虑使用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kadalu/kadalu/">https://github.com/kadalu/kadalu/</a> 此项目最新的版本为 v0.8.15 。</p><p>经过社区之前的讨论，还是决定在 v1.25 版本开始将 in-tree 的 GlusterFS plugin 标记为废弃，并在后续的版本中进行移除。</p><p>如果有正在使用此插件的小伙伴，我建议可以尽早的评估 kadalu 的可行性 &amp; 迁移成本。</p><ul><li>cleanup: Remove storageos volume plugins from k8s codebase by Jiawei0227 · Pull Request <code>#111620</code> · kubernetes&#x2F;kubernetes</li><li>cleanup: Remove flocker volume plugins from k8s codebase by Jiawei0227 · Pull Request <code>#111618</code> · kubernetes&#x2F;kubernetes</li><li>cleanup: Remove quobyte volume plugins from k8s codebase by Jiawei0227 · Pull Request <code>#111619</code> · kubernetes&#x2F;kubernetes</li></ul><p>上述的这几个 PR 所做的事情基本类似，是一些清理操作。将 Kubernetes 项目中 <code>StorageOS</code>，<code>Flocker</code> 和 <code>Quobyte</code> 等 in-tree 的卷插件都删除掉了。</p><p>其中 <code>StorageOS</code> 和 <code>Quobyte</code> 如果有在使用，建议往 CSI plugin 进行迁移，而 <code>Flocker</code> 则是由于不再维护了，所以并没有任何迁移计划。</p><h2 id="cgroup-v2-支持达到-GA"><a href="#cgroup-v2-支持达到-GA" class="headerlink" title="cgroup v2 支持达到 GA"></a><strong>cgroup v2 支持达到 GA</strong></h2><p>在 2019 年 GitChat 对我的访谈中让我聊 2020 年的技术趋势，我当时的主要观点摘录如下：</p><blockquote><p>“</p><p>作为云原生技术的基石，Kubernetes 在 2020 年的热度将会持续上升。而各个公司的集群规模，以及对容器技术的推进都将会持续加大。在经历了初步容器化后，更多的公司将面临的问题是稳定性和性能优化问题。与此同时，service mesh，serverless 等技术也都会逐步得到普遍应用。从底层次技术的角度来看，cgroups v2 将逐步普及，进而取代 cgroups v1，但这个过程可能需要两三年左右。整体而言，稳定性和性能优化将会是未来的主旋律。</p><p>”</p></blockquote><p>如今，3 年时间已经过去，Kubernetes v1.25 中对 cgroup v2 的支持已经达到 GA 。</p><h2 id="PodSecurity-特性达到-GA"><a href="#PodSecurity-特性达到-GA" class="headerlink" title="PodSecurity 特性达到 GA"></a><strong>PodSecurity 特性达到 GA</strong></h2><p>在 <code>#110459 · kubernetes/kubernetes</code> 中正式将 PodSecurity 特性升级到 GA 。如果我没有记错，这个 特性应该是从引入到 GA 最快的特性之一了。</p><p>PodSecurity 是自 Kubernetes v1.22 引入的 alpha 特性，作为 PodSecurityPolicy 的一个替代。在 v1.23 达到 beta 级别，通过上述 PR，在 v1.25 正式 GA ，并且默认启用，可以看到 整个发展过程还是很快的。</p><p>PodSecurity 定义了 3 种级别：</p><ul><li>Enforce：如果 Pod 违反策略，则不会被创建；</li><li>Audit：如果 Pod 违反策略，则在审计日志中会被记录，但是 Pod 仍将正常创建；</li><li>Warn：如果 Pod 违反策略，则会在 console 中打印 warning 信息，Pod 仍将正常创建；</li></ul><p>使用起来也很简单，只需要给 namespace 添加 <code>pod-security.kubernetes.io/&lt;mode&gt;=&lt;standard&gt;</code> 标签即可。</p><p>只要你的 Kubernetes 集群版本先升级到 v1.22 以上，并且开启 PodSecurity 特性，那么就可以按照 Migrate from PodSecurityPolicy to the Built-In PodSecurity Admission Controller | Kubernetes 进行迁移了。</p><h2 id="初步支持-user-namespaces"><a href="#初步支持-user-namespaces" class="headerlink" title="初步支持 user namespaces"></a><strong>初步支持 user namespaces</strong></h2><ul><li>Add support for user namespaces phase 1 (KEP 127) by rata · Pull Request <code>#111090</code> · kubernetes&#x2F;kubernetes</li></ul><p>这个 PR 实现了 KEP127 的第一阶段，KEP127 旨在为 Pod 添加 user namespaces 的支持。对 user namespaces 不太熟悉的小伙伴，可以看看我之前的系列文章：《搞懂容器技术的基石：namespace （上）》 和 《搞懂容器技术的基石：namespace （下）》 。</p><p>在 Kubernetes 中支持使用 user namespaces 的好处在于，可以在与主机有不同 UID&#x2F;GID 的 Pod 中运行进程，这样在 Pod 内的特权进程 实际是作为主机中的普通进程运行的。这样，假设 Pod 内的特权进程由于安全漏洞被攻破，对主机的影响也可以降到比较低。</p><p>直接相关的漏洞，比如 CVE-2019-5736 ，我也曾在 2019 年的文章 《runc 1.0-rc7 发布之际》 专门介绍过， 感兴趣的小伙伴可以到该文章中了解详情。</p><p>该实现是在 Pod 的 Spec 中添加了布尔类型的 <code>HostUsers</code> 字段，以决定是否启用主机的 user namespaces，默认是 true 。</p><p>此外，目前可预见的情况是，如果 Kubernetes 集群使用的 Linux 内核版本在 v5.19 以下的话，那么使用该特性可能会导致 Pod 的启动时间增加。</p><h2 id="CronJobTimeZone-达到-Beta-级别"><a href="#CronJobTimeZone-达到-Beta-级别" class="headerlink" title="CronJobTimeZone 达到 Beta 级别"></a><strong>CronJobTimeZone 达到 Beta 级别</strong></h2><ul><li>Promote CronJobTimeZone to beta by soltysh · Pull Request <code>#111435</code> · kubernetes&#x2F;kubernetes</li></ul><p>CronJob TimeZone 的特性达到了 Beta 阶段。不过根据 Kubernetes 最新的特性策略，该特性仍然需要手动开启 <code>CronJobTimeZone</code> feature gate 。</p><p>注意，CronJob 如果不设置 TimeZone 的话，默认使用的是 kube-controller-manager 进程的 TimeZone 。之前有遇到小伙伴在这个问题上浪费了一些时间。</p><h2 id="引入-alpha-特性-ContainerCheckpoint"><a href="#引入-alpha-特性-ContainerCheckpoint" class="headerlink" title="引入 alpha 特性 ContainerCheckpoint"></a><strong>引入 alpha 特性 ContainerCheckpoint</strong></h2><p>#104907 · kubernetes&#x2F;kubernetes 这是一个持续了将近一年的 PR，在这个 PR 中引入了一项新的特性：<code>ContainerCheckpoint</code>。</p><p>对 Docker 比较熟悉的小伙伴，可能知道在 Docker 中存在一个 <code>docker checkpoint</code> 的子命令。这个子命令实际上是可以帮助我们为某个正在运行的容器创建一个状态点的快照，并将其保存到磁盘中。</p><p>后续，我们可以使用此 checkpoint 启动容器，恢复其原先的状态，或者将容器迁移到其他的机器上。</p><p>同样的，在 Kubernetes 中提供的这个 <code>ContainerCheckpoint</code> 的新特性是自 v1.25 开始作为 alpha 特性加入的，默认是关闭的。利用此特性可以通过 kubelet 提供的 API，为 container 创建一个有状态的快照，然后将其移动到另一个节点上进行调试，或者其他类似的需求。</p><p>此处需要注意的是，创建 checkpoint 可能会产生一些安全隐患，比如 checkpoint 实际上是对当前运行中 container 的内存快照，所以如果在 container 的内存中包含了某些隐私数据，那么有可能在迁移到其他机器上也可以访问到。</p><p>另一方面，创建 checkpoint 会产生一些文件，这些文件是需要占用磁盘的。如果频繁的创建 checkpoint 则可能导致磁盘压力过大。checkpoint 的存档，默认情况下会放在 <code>/var/lib/kubelet/checkpoints</code> 目录下，并且以 <code>checkpoint-&lt;podFullName&gt;-&lt;containerName&gt;-&lt;timestamp&gt;.tar</code> 进行命名。</p><p>这个特性使用起来也很简单，直接给 Kubelet 发送一个请求即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /checkpoint/&#123;namespace&#125;/&#123;pod&#125;/&#123;container&#125;</span><br></pre></td></tr></table></figure><p>然后将获取到的归档文件，通过以下命令进行恢复：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl restore --import=&lt;archive&gt;</span><br></pre></td></tr></table></figure><h2 id="为-kubectl-引入-kuberc-配置文件"><a href="#为-kubectl-引入-kuberc-配置文件" class="headerlink" title="为 kubectl 引入 kuberc 配置文件"></a><strong>为 kubectl 引入 kuberc 配置文件</strong></h2><p>KEP-3104 这个 KEP 旨在为 kubectl 引入一个新的配置文件 <code>kuberc</code>，用来配置一些用户的自定义配置。这在很多的项目，或者工具中都有类似的用法。比如 Vim 中可以通过 <code>-u</code> 指定用户自己的配置文件，或者使用默认的 <code>~/.vimrc</code> 来完成自定义配置。</p><p>这样做的好处就在于可以让 <code>kubeconfig</code> 更加的专注，仅仅需要保留和集群、用户凭证相关的信息即可，对于用户的自定义配置则分离开来。具体而言，这个配置文件看起来就会是这样：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Preferences</span></span><br><span class="line"></span><br><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="attr">aliases:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alias:</span> <span class="string">getdbprod</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">what=database</span> <span class="string">--namespace</span> <span class="string">us-2-production</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">overrides:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">apply</span></span><br><span class="line">      <span class="attr">flags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server-side</span></span><br><span class="line">          <span class="attr">default:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">delete</span></span><br><span class="line">      <span class="attr">flags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">confirm</span></span><br><span class="line">          <span class="attr">default:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">      <span class="attr">flags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exec-auth-allowlist</span></span><br><span class="line">          <span class="attr">default:</span> <span class="string">/var/kubectl/exec/...</span></span><br></pre></td></tr></table></figure><p>看起来也比较直观，可以用来增加一些 <code>alias</code> 和覆盖一些默认的配置，这样大家不再需要定义很多的 alias，以后使用 kubectl 的时候敲的命令也能少很多。此特性未实现之前， 在这里顺便推荐另一个项目 kubectl-aliases，此项目中包含了很多 alias，可以让使用 kubectl 的过程更加简单。</p><p>但也有一些弊端，就像是每个 Vim 用户都要有自己的 vimrc 配置文件一样，这会养成一定的习惯。在一些没有自己自定义配置的机器上使用时，会有些不习惯。同时，这在排查问题时，也可能增加排查的链路（比如 kuberc 中增加了一个错误的配置之类的）。</p><p>举例来说，我在排查 Vim 的问题时候，通常会直接 <code>vim -u /dev/null</code> 这样，以防使用了任何自定义配置造成影响。那么后续如果这个功能完全实现了，那么大家在 排查问题的时候，需要注意使用 <code>kubectl --kuberc /dev/null</code> 类似这样的方式来避免本地自定义配置造成影响。</p><h2 id="为-kubectl-添加-subresource-的补全"><a href="#为-kubectl-添加-subresource-的补全" class="headerlink" title="为 kubectl 添加 --subresource 的补全"></a><strong>为 kubectl 添加 --subresource 的补全</strong></h2><ul><li>Add shell completion for new --subresource flag by marckhouzam · Pull Request <code>#109070</code> · kubernetes&#x2F;kubernetes</li></ul><p>在 Kubernetes v1.24 中，给 kubectl 增加了 subresource 的支持（指 <code>status</code> 和 <code>scale</code>），这样就可以很方便的直接对 subresource 进行操作了，而不需要每次都 <code>-o yaml</code> 之类的直接进行查看，或者通过 curl 之类的调用 API 来完成其他操作。使用了此特性后，可以有如下效果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># v1.24+</span></span><br><span class="line">tao@moelove:~$ kubectl get  -n apisix  --subresource status deploy apisix-ingress-controller </span><br><span class="line">NAME                        AGE</span><br><span class="line">apisix-ingress-controller   2d23h</span><br><span class="line"></span><br><span class="line">tao@moelove:~$ kubectl get  -n apisix  --subresource scale deploy apisix-ingress-controller  -ojson</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;autoscaling/v1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Scale&quot;</span>,</span><br><span class="line">    <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;creationTimestamp&quot;</span>: <span class="string">&quot;2022-08-04T18:57:45Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;apisix-ingress-controller&quot;</span>,</span><br><span class="line">        <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;apisix&quot;</span>,</span><br><span class="line">        <span class="string">&quot;resourceVersion&quot;</span>: <span class="string">&quot;1656&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uid&quot;</span>: <span class="string">&quot;7c191a14-ee55-4254-80ba-7c91b4c833bd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;replicas&quot;</span>: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;replicas&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;selector&quot;</span>: <span class="string">&quot;app.kubernetes.io/instance=apisix,app.kubernetes.io/name=ingress-controller&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是在此之前版本使用该参数的话，会直接提示错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># v1.23</span></span><br><span class="line">tao@moelove:~$ kubectl-v1.23 get  -n apisix  --subresource status deploy apisix-ingress-controller </span><br><span class="line">Error: unknown flag: --subresource</span><br><span class="line">See <span class="string">&#x27;kubectl get --help&#x27;</span> <span class="keyword">for</span> usage.</span><br></pre></td></tr></table></figure><p>此处我提到的这个在 v1.25 中的 PR 实际上是为了给 <code>--subresource</code> 提供一个命令补全的能力（虽然如上文提到的，目前就两种资源），还是比较方便的。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a><strong>其他</strong></h2><ul><li><code>#109074 · kubernetes/kubernetes</code></li></ul><p>kubeadm 中为 etcd 的 static Pod 增加了一个 <code>--experimental-initial-corrupt-check</code> 选项，可以用来确认 etcd member 中数据的一致性。这个特性预期在 etcd 的 v3.6 版本中会正式可用。此外，etcd 的 Release 页面也写了，当前不建议将 etcd 3.5.x 用于生产环境，如果尚未进行升级，可以先继续使用 3.4.x。如果已经升级了，那么可以自行增加此参数；</p><ul><li>Migrate Ginkgo from v1 to v2 · kubernetes&#x2F;kubernetes</li></ul><p>这个 PR 持续了将近三个月，主要是将 Kubernetes 项目中使用的 Ginkgo 从已经废弃的 v1 版本升级到 v2 版本。</p><p>其实目前很多项目都在积极的推进此事，但不同的项目对 Ginkgo 的依赖和使用程度不同，在这个 PR 中修改了超过 600 个文件，非常的庞大。而之前在 Apache APISIX Ingress controller 项目中，从 Ginkgo v1 升级到 v2 时，仅仅用了一周时间，修改文件不算太多。此外目前 Kubernetes Ingress-NGINX 项目也同样在进行此升级，可能工作量也不小。</p><ul><li>Introduce KUBECACHEDIR environment variable to override default discovery cache dir by ardaguclu · kubernetes&#x2F;kubernetes</li></ul><p>这个 PR 说起来是比较小的一个改动，但是它的影响却很大。</p><p>在这个 PR 中引入了一个新的 <code>KUBECACHEDIR</code> 环境变量，来替代默认的 <code>~/.kube/cache</code> 缓存目录。通过这个 PR 就有可能会导致用户在使用 kubectl 的时候，可以通过这个环境变量来跳过 缓存。进而可能会引起一些性能问题。</p><ul><li>kube-apiserver: default --enable-logs-handler flag to false · kubernetes&#x2F;kubernetes</li></ul><p>kube-apiserver 中的 <code>/logs</code> 由于安全问题，默认情况下会进行关闭，然后通过 <code>--enable-logs-handler</code> 标签进行启用。如果要进行日志采集的话，需要额外注意下。</p><ul><li><code>#111060 · kubernetes/kubernetes</code></li></ul><p>kube-proxy 的 container image 将要变更为 distroless 的了。这可以规避很多安全隐患，提升集群的安全性。</p><p>以上就是 Kubernetes v1.25 中比较值得关注的内容。在进行集群升级前一定要注意检查。好了，我们下期再见！</p><h1 id="Kubernetes-v1-26"><a href="#Kubernetes-v1-26" class="headerlink" title="Kubernetes v1.26"></a>Kubernetes v1.26</h1><p>Kubernetes v1.26 是 2022 年的最后一个大版本更新，包含了 37 项主要的更新。</p><p>8 月底正式发布的 v1.25 中包含 40 项。</p><p>在 v1.26 中包含了很多直接影响用户与 Kubernetes 交互相关的功能，比如以下内容中会介绍的允许跨 namespace 持久化卷快照引用；允许用户无需额外的 exporter 即可自定义 Service Level Indicator(SLI); kubectl events 达到 Beta；支持 Pod 所需资源就绪后再进行调度；支持使用 OpenAPI v3 等。</p><p>以及针对高性能负载运行在哪个物理 CPU 的场景支持。</p><h2 id="3294-允许跨-namespace-持久化卷快照引用"><a href="#3294-允许跨-namespace-持久化卷快照引用" class="headerlink" title="#3294 允许跨 namespace 持久化卷快照引用"></a><code>#3294</code> 允许跨 namespace 持久化卷快照引用</h2><p>在 Kubernetes 中，用户可以通过使用 <code>VolumeSnapshot</code> 特性，从卷快照创建新的持久化卷。这是非常有用的，比如说 DBA 可以在进行数据库大的变更&#x2F;迁移操作前，对持久化卷做一次快照，如果出现异常，则可以直接从该快照恢复数据库之前的状态。</p><p>例如通过以下方式可以动态的创建一个快照：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">snapshot.storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VolumeSnapshotClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-snapclass</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">testdriver.csi.k8s.io</span></span><br><span class="line"><span class="attr">deletionPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/snapshotter-secret-name:</span> <span class="string">mysecret</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/snapshotter-secret-namespace:</span> <span class="string">mysecretnamespace</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">snapshot.storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VolumeSnapshot</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-snapshot</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumeSnapshotClassName:</span> <span class="string">test-snapclass</span></span><br><span class="line">  <span class="attr">source:</span></span><br><span class="line">    <span class="attr">persistentVolumeClaimName:</span> <span class="string">test-pvc</span></span><br></pre></td></tr></table></figure><p>当然，这里也有些需要注意的点，该功能只能用于 CSI 存储驱动，并且该功能是自 Kubernetes v1.17 达到 beta，v1.20 正式 GA 的。</p><p>在 v1.26 中增加的特性是 <code>CrossNamespaceVolumeDataSource</code> 当前是 Alpha 阶段，允许创建持久化卷的时候，跨 namespace 引用卷快照。它的主要价值在于，比如想要做应用跨 namespace 迁移的时候，直接从另一个 namespace 对持久化卷做快照，然后使用快照创建 PVC 即可很轻松的完成迁移。例如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testvolumeclaim</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nstest1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">mystorageclass</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">dataSourceRef:</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">snapshot.storage.k8s.io</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">VolumeSnapshot</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testsnapshot</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">moelove</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><p>当然如果考虑授权相关问题的话，这里使用 Gateway API 的 ReferenceGrant 来控制授权。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReferenceGrant</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">moelove</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">from:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nstest1</span></span><br><span class="line">  <span class="attr">to:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">snapshot.storage.k8s.io</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">VolumeSnapshot</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testsnapshot</span></span><br></pre></td></tr></table></figure><p>我认为这是个很实用的功能。</p><h2 id="3488-允许使用-CEL-进行-Admission-Control"><a href="#3488-允许使用-CEL-进行-Admission-Control" class="headerlink" title="#3488 允许使用 CEL 进行 Admission Control"></a><code>#3488</code> 允许使用 CEL 进行 Admission Control</h2><p>这篇 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649297076&idx=1&sn=4d6a86220535a0aaa9fdbcbaf66625f4&chksm=f2eb816bc59c087db1ff984e94e449cb9bd6ee6efd18cf25cf946f3019532e56463629e2f1e0&scene=21#wechat_redirect">K8S 生态周报| Kubernetes v1.23.0 正式发布，新特性一览 | MoeLove</a> 文章中，曾介绍过 Kubernetes 中引入了 Common Expression Language (CEL) 进行 CRD Validation。该特性在 v1.25 达到 Beta。</p><p>例如，某个 CRDs 的内容如下，其中定义了 <code>minReplicas</code> 小于 <code>replicas</code> 并且 <code>replicas</code> 小于 <code>maxReplicas</code> 。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">openAPIV3Schema:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">  <span class="attr">properties:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">      <span class="attr">x-kubernetes-validation-rules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.minReplicas &lt;= self.replicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be greater than or equal to minReplicas.&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.replicas &lt;= self.maxReplicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be smaller than or equal to maxReplicas.&quot;</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">minReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">replicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">maxReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">minReplicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">replicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">maxReplicas</span> </span><br></pre></td></tr></table></figure><p>那么，当有如下的自定义资源创建时，Kubernetes 将会拒绝其请求。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;stable.example.com/v1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomDeployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-new-deploy-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p>并且返回如下错误：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">The</span> <span class="string">CustomDeployment</span> <span class="string">&quot;my-new-deploy-object&quot;</span> <span class="attr">is invalid:</span></span><br><span class="line"><span class="string">*</span> <span class="attr">spec: Invalid value:</span> <span class="string">map[string]interface</span> &#123;&#125;&#123;<span class="string">&quot;maxReplicas&quot;</span><span class="string">:10</span>, <span class="string">&quot;minReplicas&quot;</span><span class="string">:0</span>, <span class="string">&quot;replicas&quot;</span><span class="string">:20</span>&#125;<span class="string">:</span> <span class="string">replicas</span> <span class="string">should</span> <span class="string">be</span> <span class="string">smaller</span> <span class="string">than</span> <span class="string">or</span> <span class="string">equal</span> <span class="string">to</span> <span class="string">maxReplicas.</span></span><br></pre></td></tr></table></figure><p>这个过程看起来和 Admission controller 做的事情很像。当然，我之前也写了一篇文章 《<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296994&idx=2&sn=60686fcebaacff30b9762a6229e85d12&chksm=f2eb81bdc59c08ab0f10013ed2bda48a7f3f5f3e0d335b7f1cdbbbce6e5b81656b487e9955d8&scene=21#wechat_redirect">理清 Kubernetes 中的准入控制（Admission Controller) | MoeLove</a>》，有兴趣的小伙伴可以再翻看下。</p><p>回到我们聊到这个特性中，可以认为这是一种对 Admission webhook 的替代，用一种更加原生，直观，并且声明式的方式来进行管理。</p><p>这里引入了一个新的资源 <code>ValidatingAdmissionPolicy</code> ，使用起来如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;demo-policy.moelove.info&quot;</span></span><br><span class="line"><span class="attr">Spec:</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchConstraints:</span></span><br><span class="line">    <span class="attr">resourceRules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiGroups:</span>   [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">      <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">      <span class="attr">operations:</span>  [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span>   [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">validations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">expression:</span> <span class="string">&quot;object.spec.replicas &lt;= 2&quot;</span></span><br></pre></td></tr></table></figure><p>上述配置将会拒绝 replicas 不大于 2 的 Deployment。</p><p>这个特性的优势就在于无需额外的其他组件，除了需要学习 CEL 外，还是比较方便的。该特性目前是 alpha 级别。</p><h2 id="3545-改善-NUMA-中的拓扑管理"><a href="#3545-改善-NUMA-中的拓扑管理" class="headerlink" title="#3545 改善 NUMA 中的拓扑管理"></a><code>#3545</code> 改善 NUMA 中的拓扑管理</h2><p>在文章 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649295985&idx=1&sn=3167c6b2bc11f2e2a0e684f654ed8d75&chksm=f2eb9daec59c14b87fa906e866e7fe62b0c6ec2eedb94859c2036fd53aac5b1c8e31355e6c20&scene=21#wechat_redirect">K8S 生态周报| Kubernetes v1.21 发布, 带来新的内存管理器 | MoeLove</a> 中介绍，Kubernetes v1.21 中在 kubelet 中新增了一个内存管理器。</p><p>主要是为了应对多 NUMA 结构下的效率。多 NUMA 结构下，为了保证效率，所以会按内存和 CPU 的相对距离来按 node 定义是否为 local memory 或者说本地内存，同时由于实际位置不同，所以就可能会产生内存分配不均匀的情况了。比如，我们可以使用 numactl 管理工具查看下当前机器上的情况：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[tao@moelove ~]<span class="comment"># numactl -H</span></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 20 21 22 23 24 25 26 27 28 29</span><br><span class="line">node 0 size: 65186 MB</span><br><span class="line">node 0 free: 9769 MB</span><br><span class="line">node 1 cpus: 10 11 12 13 14 15 16 17 18 19 30 31 32 33 34 35 36 37 38 39</span><br><span class="line">node 1 size: 65536 MB</span><br><span class="line">node 1 free: 15206 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1 </span><br><span class="line">  0:  10  21 </span><br><span class="line">  1:  21  10 </span><br></pre></td></tr></table></figure><p>可以看到在我当前的这台机器上就存在着比较明显的内存分配不均的情况。所以当某个进程达到了其 local memory 的上限，那自然就会影响到它的性能。我最早折腾 NUMA 相关问题是在前些年大量使用 MongoDB 的时候，在这上面也花了些时间，不过这也不影响我对 MongoDB 的喜爱~</p><p>这次在 kubelet 中增加的内存管理器便可以很好的解决这个问题，可以在启动 kubelet 的时候通过 <code>--reserved-memory</code> 以及配合 <code>--memory-manager-policy</code> 等参数来一起设置。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--memory-manager-policy static --reserved-memory 0:memory=1Gi,hugepages-1M=2Gi --reserved-memory 1:memory=2Gi</span><br></pre></td></tr></table></figure><p>注意：<code>memory-manager-policy</code> 必须设置为 static，如果不设置则默认为 none，即不采取任何行为。</p><p>不过这个特性还在较早期的阶段，目前只为 <code>Guaranteed</code> QoS 类的 Pod 提供支持。另外，如果正确启用了此特性，则在机器的 <code>/var/lib/kubelet/memory_manager_state</code> 可以看到其详细信息。</p><img src="/img/loading.gif" data-lazy-src="/posts/1dca4389/640.png" title="图片"><p>最终将会影响到拓扑管理器。</p><p>然后在 Kubernetes v1.22 则继续在 kubelet 中增加了另一个 <code>--cpu-manager-policy-options</code> 选项，对应为 CPU 管理器。</p><p>在 v1.26 中增加的则是 <code>--topology-manager-policy-options</code> 来控制整体的拓扑管理。现在仅支持一个 <code>prefer-closest-numa-nodes=true</code> 配置，当开启此配置的时候，拓扑管理器将尽量在单个 NUMA 或者尽可能少的 NUMA 节点中对齐资源。</p><p>这对于高性能负载是非常重要的一个优化。建议关注。</p><h2 id="113274-为-Pod-调度增加调度就绪的机制"><a href="#113274-为-Pod-调度增加调度就绪的机制" class="headerlink" title="#113274 为 Pod 调度增加调度就绪的机制"></a><code>#113274</code> 为 Pod 调度增加调度就绪的机制</h2><p>这是 KEP 3521 的第一部分。</p><p>首先简单的回顾一下 Pod 的创建过程。</p><p>当 client 通过 kube-apiserver 创建成功 Pod 资源后，kube-scheduler 会去检查尚未被调度的 Pod，然后为其进行调度，分配 Node。之后 Node 获取到调度到该 Node 上的 Pod 然后进行创建。这里省略了很多细节，但其他的部分与我们此处要介绍的内容关系不太大，就不展开了。</p><p>根据上述的过程，我们可以发现，在 Pod 创建成功后，其实就默认该 Pod 是可以被调度了，kube-scheduler 就应该开始工作了。</p><p>但在实际的场景中，Pod 通常还会需要一些其他的资源，最典型的比如存储。在一些环境中，这些资源是需要预先进行创建的，<strong>尤其是在一些云厂商的场景中，还需要检查用户账户中是否还有余额可以用于创建云盘等</strong>。</p><p>一但前置的依赖无法满足，假如 kube-scheduler 已经完成了 Pod 的调度，那么 kubelet 侧就会处于尝试创建 Pod ，但失败的情况。</p><p>这个 KEP 的出现就可以很好的解决这个问题，增加了一个 Pod 是否准备好被调度的机制。如果前置依赖不满足，那么 Pod 就无需被调度，这也不会消耗资源。kube-scheduler 和 kubelet 都无需进行处理。待条件满足，Pod 再被调度和创建即可。</p><p>这个机制我个人感觉还是挺好的，甚至我可以有更灵活的策略来控制应用的副本。比如在大流量，需要动态扩容的场景下，我可以利用此机制预先创建一些 Pod 资源以及准备好它的依赖， 甚至可以在 Node 上准备好镜像等。当需要增加副本时，直接标记 Pod 可被调度， 这样就可以更快的在 Node 上拉起 Pod 了。</p><h2 id="移除-CRI-v1alpha2"><a href="#移除-CRI-v1alpha2" class="headerlink" title="移除 CRI v1alpha2"></a>移除 CRI v1alpha2</h2><p>在移除了 dockershim 的支持后， 现在终于删掉了 CRI v1alpha2 的代码，这意味着之后所有实现了 CRI 的运行时，都必须实现 CRI v1 的接口。</p><p>目前 containerd 的 CRI v1 接口已经实现了，所以在 Kubernetes v1.26 发布后，也可以放心的使用 containerd 作为其运行时。</p><p>不过，你是否还记得 cri-dockerd 呢？用于将 Docker 作为 Kubernetes 运行时的组件，现在由 Mirantis 进行维护， 此项目目前的维护者比较少，目前还只支持 CRI v1alpha2 ，所以，如果你在使用此项目让 Docker 作为运行时，并且想要升级到 Kubernetes v1.26 的话，这是不行的。</p><h2 id="111333-Auth-API-允许获取-User-属性"><a href="#111333-Auth-API-允许获取-User-属性" class="headerlink" title="#111333 Auth API 允许获取 User 属性"></a><code>#111333</code> Auth API 允许获取 User 属性</h2><p>这是 KEP-3325: Self subject attributes review API 实现的一部分。</p><p>大家想必都知道，Kubernetes 中并没有 User（用户）的资源，但是 Kubernetes 中有权限校验的方式，比如我们常用到的利用 x509 证书进行用户权限相关的校验，或者 通过外部的 OIDC 和 webhook 等进行校验。</p><p>此功能实际上是为了添加一个新的接口，以便于用户身份通过校验后，获取其所具有的属性。这样就可以简单的通过增加一个 <code>kubectl auth whoami</code> 的命令，来了解当前用户的相关信息了。这功能比较类似于我们做 OAuth 的时候，可能会做个 UserInfo 之类的接口，用来查看用户相关的属性。</p><p>该功能是通过在 <code>authentication.k8s.io</code> Group 下添加了 <code>SelfSubjectReview</code> 资源来实现的，具体如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SelfSubjectReview contains the user information that the kube-apiserver has about the user making this request.</span></span><br><span class="line"><span class="comment">// When using impersonation, users will receive the user info of the user being impersonated.</span></span><br><span class="line"><span class="keyword">type</span> SelfSubjectReview <span class="keyword">struct</span> &#123;</span><br><span class="line"> metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line"> <span class="comment">// Standard object&#x27;s metadata.</span></span><br><span class="line"> <span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line"> <span class="comment">// +optional</span></span><br><span class="line"> metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`</span></span><br><span class="line"> <span class="comment">// Status is filled in by the server with the user attributes.</span></span><br><span class="line"> Status SelfSubjectReviewStatus <span class="string">`json:&quot;status,omitempty&quot; protobuf:&quot;bytes,2,opt,name=status&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SelfSubjectReviewStatus is filled by the kube-apiserver and sent back to a user.</span></span><br><span class="line"><span class="keyword">type</span> SelfSubjectReviewStatus <span class="keyword">struct</span> &#123;</span><br><span class="line"> <span class="comment">// User attributes of the user making this request.</span></span><br><span class="line"> <span class="comment">// +optional</span></span><br><span class="line"> UserInfo v1.UserInfo <span class="string">`json:&quot;userInfo,omitempty&quot; protobuf:&quot;bytes,1,opt,name=userInfo&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此功能在 v1.26 版本开始引入，并作为 Alpha 特性提供，可通过 <code>APISelfSubjectReview</code> feature gate 控制是否启用。</p><p>同时，本次也在 kubectl 中添加了 <code>kubectl alpha auth whoami</code> 子命令，可直接查看当前用户的相关属性信息。当执行此命令后，会得到如下输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">authentication.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">SelfSubjectReview</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">userInfo:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">tao.moelove.info</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">a79aaf30-0c6a-66ed-881d-0888ac1266683</span></span><br><span class="line">    <span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">admins</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">speakers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">system:authenticated</span></span><br><span class="line">    <span class="attr">extra:</span></span><br><span class="line">      <span class="attr">skills:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">reading</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">learning</span></span><br><span class="line">      <span class="attr">subjects:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kubernetes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">containers</span></span><br></pre></td></tr></table></figure><h2 id="3386-减少-Kubelet-在-PLEG-中的-CPU-消耗"><a href="#3386-减少-Kubelet-在-PLEG-中的-CPU-消耗" class="headerlink" title="#3386 减少 Kubelet 在 PLEG 中的 CPU 消耗"></a><code>#3386</code> 减少 Kubelet 在 PLEG 中的 CPU 消耗</h2><p>这个主要是为了减少 Kubelet 在跟踪 Pod 状态 PLEG 时的 CPU 消耗。</p><p>它将减少 Kubelet 的一些定期轮询，而是尽可能的依赖于 CRI 的通知。</p><p>经过这个调整，也许在生产环境中遇到的 PLEG 问题也能少一点吧。</p><h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><ul><li>kubeadm: Add the option to cleanup the <code>tmp</code> directory by chendave · Pull Request <code>#112172</code> · kubernetes&#x2F;kubernetes</li></ul><p>kubeadm 新增 <code>cleanup-tmp-dir</code> 配置项，在 <code>kubeadm reset</code> 时，可以通过传递此参数将 kubeadm 产生的临时文件给清理干净。</p><ul><li>Avoid propagating &quot;search .&quot; into containers &#x2F;etc&#x2F;resolv.conf by dghubble · Pull Request <code>#112157</code> · kubernetes&#x2F;kubernetes</li></ul><p>从 Kubernetes v1.25 开始，<code>/etc/resolv.conf</code> 中的 <code>search .</code> 会被传递到容器内。</p><p>这会导致任意基于 musl libc 系统的 DNS 查询失败，比如任何基于 Alpinelinux 的镜像都会失败。</p><p>要验证自己的集群是否会受该问题影响，只需要查看系统的 <code>/etc/resolv.conf</code> 文件的内容即可。比如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nameserver</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.53</span></span><br><span class="line"><span class="string">options</span> <span class="string">edns0</span> <span class="string">trust-ad</span></span><br><span class="line"><span class="string">search</span> <span class="string">.</span></span><br></pre></td></tr></table></figure><p>如果是上述的情况，一般说明是被 systemd resove 接管了，并且会受到此处描述的问题所影响。</p><ul><li>Fix rollout history bug by brianpursley · Pull Request <code>#111093</code> · kubernetes&#x2F;kubernetes</li></ul><p>在执行 <code>kubectl rollout history</code> 的时候可以传递 <code>--revision=3</code> 拿到指定版本的信息。但是如果指定了 output format ，则 <code>--revision</code> 可能会失效。通过此 PR 便可解决此问题，但要到 v1.26 才会携带。</p><ul><li>Expose a pending pods summary in scheudler&#39;s dummper output by Huang-Wei · Pull Request <code>#111726</code> · kubernetes&#x2F;kubernetes</li></ul><p>调度程序可以 dump 出更多信息。</p><ul><li>Revert &quot;promote LocalStorageCapacityIsolationFSQuotaMonitoring to beta&quot; by rphillips · Pull Request <code>#112076</code> · kubernetes&#x2F;kubernetes</li></ul><p>由于 OpenShift 团队发现在使用它的时候存在一些问题, 将 <code>LocalStorageCapacityIsolationFSQuotaMonitoring</code> 重新回退到 Alpha 阶段。</p><ul><li>Removal of GlusterFS code from the repo by humblec · Pull Request <code>#112015</code> · kubernetes&#x2F;kubernetes</li></ul><p>在之前的 「K8S 生态周报」中我曾介绍过，在 v1.25 中将树内的 GlusterFS plugin 标记为废弃，并建议迁移至使用 CSI ， 如今这些插件已经被彻底删除了。</p><ul><li>kubelet: append options to pod if there are multi options in &#x2F;etc&#x2F;resolv.conf by pacoxu · Pull Request <code>#112414</code> · kubernetes&#x2F;kubernetes</li></ul><p>当前 kubelet 创建 Pod 的时候，如果 <code>/etc/resolv.conf</code> 中存在多行 options 配置，则只取最后一行。</p><p>例如 &#x2F;etc&#x2F;resolv.conf 包含的配置如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">options timeout:1 </span><br><span class="line">options attempts:3</span><br></pre></td></tr></table></figure><p>则 Pod 中的 &#x2F;etc&#x2F;resolv.conf 只包含如下内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options attempts:3</span><br></pre></td></tr></table></figure><p>但事实上即使在 &#x2F;etc&#x2F;resolv.conf 中配置多行 options ，DNS 也是可以正常工作的。所以当前的 kubelet 行为就不一致了。</p><p>通过这个 PR， 会将主机的 &#x2F;etc&#x2F;resolv.conf 中的多行配置合并为一行。如果还是上面的例子，则 Pod 内看到的就是如下内容了.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options timeout:1 attempts:3</span><br></pre></td></tr></table></figure><p>这里有个需要注意的点就是，Kubernetes 中的默认 DNS 策略并非 <code>default</code>，这个修改只是针对 <code>default</code> 策略的。</p><ul><li>kubeadm: Inherit <code>dry-run</code> flags for each sub-phases by chendave · Pull Request <code>#112945</code> · kubernetes&#x2F;kubernetes kubeadm 所有的阶段都支持了 dry-run 模式；</li><li>Add categories to kubectl api-resources wide output and add --categories flag by brianpursley · Pull Request <code>#111096</code> · kubernetes&#x2F;kubernetes 为 <code>kubectl api-resources -o wide</code> 的输出中增加了一列 &quot;Categories&quot;；</li><li>add <code>--concurrent-horizontal-pod-autoscaler-syncs</code> flag to kube-controller-manager by zroubalik · Pull Request #108501 · kubernetes&#x2F;kubernetes 为 kube-controller-manager 增加了 <code>--concurrent-horizontal-pod-autoscaler-syncs</code> 的参数，原先 HPA 中默认只有一个 worker，在大规模集群中处理效率很低。本次的 PR 可以通过此参数来自行配置 worker 数量，以便于提升效率；</li><li>Normalize HTTP lifecycle handlers with HTTP probers by jasimmons · Pull Request <code>#86139</code> · kubernetes&#x2F;kubernetes</li></ul><p>我们可以为 Pod 增加 <code>postStart</code> 和 <code>preStop</code> 的 Hook，并且其分别可以设置为 <code>Exec</code> 或 <code>HTTP</code> 模式。这个 PR 主要是在修改 HTTP 模式下的行为。</p><p>具体来说，HTTP 模式下的代码与 readiness&#x2F;liveness 下使用的并不一样，而且也不支持一些常见的功能，比如：</p><ul><li>设置自定义 HTTP header</li><li>使用 HTTPS 连接</li></ul><p>但经过此 PR ,终于将它们的行为进行了统一，但这毕竟是一个比较大的调整，如果你不希望应用此变更， 可以通过 <code>-feature-gates=ConsistentHTTPGetHandlers=false</code> 进行全局禁用，避免这个功能影响到你的环境。</p><ul><li>Escape terminal special characters in kubectl by dgl · Pull Request <code>#112553</code> · kubernetes&#x2F;kubernetes</li></ul><p>这个 PR 中对一些特殊字符进行了转义。这其实是一个比较有意思的内容，我来稍微介绍一下。</p><p>你可以在自己的终端中尝试执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f - &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;apiVersion&quot;: &quot;v1&quot;,</span></span><br><span class="line"><span class="string">    &quot;involvedObject&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;kind&quot;: &quot;Node&quot;,</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;node01&quot;,</span></span><br><span class="line"><span class="string">        &quot;uid&quot;: &quot;node01&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;kind&quot;: &quot;Event&quot;,</span></span><br><span class="line"><span class="string">    &quot;message&quot;: &quot;\u001b[2J\u001b[3J\u001b[1;1H\u001b[m spoofed \u001b[60C\u001b[1;0m. Done&quot;,</span></span><br><span class="line"><span class="string">    &quot;metadata&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;spoofEvent&quot;,</span></span><br><span class="line"><span class="string">        &quot;namespace&quot;: &quot;default&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;source&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;component&quot;: &quot;kubelet&quot;,</span></span><br><span class="line"><span class="string">        &quot;host&quot;: &quot;node01&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;type&quot;: &quot;Normal&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>这将会创建一条 event 记录，但是一但你执行 <code>kubectl get events</code> 你就会发现一些有趣的事情，屏幕上的记录被清空了。</p><p>这是由于 kubectl 在输出内容的时候并不会进行任何转义，比如上述示例中包含了一些特殊字符：</p><ul><li><code>\u001b[2J</code>：清屏</li><li><code>\u001b[60C</code>: 将光标向前移动 60</li></ul><p>当然还有一些其他的，我印象中我早年刚开始接触 Linux 不久后还花费了一些时间来学习这些东西，因为这些东西可以配置到终端里面，实现一些比如变换颜色之类的事情。</p><p>我翻了下我之前的文章，曾经还有将 bash 做过如下设置：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function git-branch-name &#123;</span><br><span class="line">  git symbolic-ref HEAD <span class="number">2</span>&gt;/dev/null | cut -d<span class="string">&quot;/&quot;</span> -f <span class="number">3</span></span><br><span class="line">  #git rev-parse --abbrev-ref HEAD</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function git-branch-prompt &#123;</span><br><span class="line">  local branch=<span class="string">`git-branch-name`</span></span><br><span class="line">  <span class="keyword">if</span> [ $branch ]; then printf <span class="string">&quot; [%s]&quot;</span> $branch; fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PS1=<span class="string">&quot;\u@\h \[\033[0;36m\]\W\[\033[0m\]\[\033[0;32m\]\$(git-branch-prompt)\[\033[0m\] \$ &quot;</span></span><br></pre></td></tr></table></figure><p>对此内容感兴趣的小伙伴可以试试看把上述内容贴到自己的 <code>.bashrc</code> 文件中，然后 <code>source</code> 一下看看。</p><p>回到这个 PR 中，之前这个问题还给分配成了 CVE-2021-25743， 修复的办法也比较简单，但是比较耗时耗力，就是对一些输出的位置做了转义操作。</p><p>不过可能还有一些遗漏的，比如 <code>kubectl logs</code> 之类的，可能也会受到影响，有兴趣的小伙伴可以去验证一下。</p><ul><li>(kubectl certificates): Remove certificates&#x2F;v1beta1 client usage by ardaguclu · Pull Request <code>#111990</code> · kubernetes&#x2F;kubernetes</li></ul><p><code>certificates.k8s.io/v1beta1</code> 自 Kubernetes v1.19 已被废弃，通过此 PR 移除，将在 v1.26 版本中生效。</p><p>以后使用 <code>certificates.k8s.io/v1</code> 即可。这个主要是影响 <code>kubectl certificate</code> 命令。</p><h1 id="Kubernetes-v1-27"><a href="#Kubernetes-v1-27" class="headerlink" title="Kubernetes v1.27"></a>Kubernetes v1.27</h1><p><strong>Kubernetes v1.27 是 2023 年的第一个大版本更新，包含了近 60 项主要的更新。</strong> 而 1.26 只有 37 项，所以这个版本可以说是一个变化非常显著的版本了。</p><p><strong>其中 18 个增强功能正在进入 Alpha 阶段，29 个将升级到 Beta 阶段，而另外 13 个则将升级到稳定版。</strong></p><p>尽管这个版本中包含了这么多的特性变更，但值得一提的是，这个版本应该算是第一个完全按照即定流程，恪守每个 deadline 的版本。之前的版本中，每次都或多或少会有一些变数，不过这也从侧面可以看到 release team 做了很多幕后的工作。</p><h2 id="SeccompDefault-达到-Stable"><a href="#SeccompDefault-达到-Stable" class="headerlink" title="SeccompDefault 达到 Stable"></a>SeccompDefault 达到 Stable</h2><p>如果想要默认使用 seccomp profile，则必须在每个想要使用它的节点上为 kubelet 启用 <code>--seccomp-default</code> 选项。如果启用了该选项，则 kubelet 将默认使用由容器运行时定义的 <code>RuntimeDefault</code> seccomp profile，而不是使用 <code>Unconfined</code>（禁用seccomp）模式。“</p><p>默认配置文件旨在提供强大的安全性设置，并保留工作负载功能。容器运行时的不同发布版本之间可能存在不同的默认配置文件。</p><p>印象里很早之前 Docker 的配置文件就因为修补安全漏洞而调整过。</p><h2 id="Pod-调度就绪机制达到-Beta"><a href="#Pod-调度就绪机制达到-Beta" class="headerlink" title="Pod 调度就绪机制达到 Beta"></a>Pod 调度就绪机制达到 Beta</h2><p>这个功能实际上是从 Kubernetes v1.26 开始增加的。是 KEP 3521 的第一部分。</p><p>首先我们来简单的回顾一下 Pod 的创建过程。</p><p>当 client 通过 kube-apiserver 创建成功 Pod 资源后，kube-scheduler 会去检查尚未被调度的 Pod，然后为其进行调度，分配 Node。之后 Node 获取到调度到该 Node 上的 Pod 然后进行创建。这里省略了很多细节，但其他的部分与我们此处要介绍的内容关系不太大，就不展开了。</p><p>根据上述的过程，我们可以发现，在 Pod 创建成功后，其实就默认该 Pod 是可以被调度了，kube-scheduler 就应该开始工作了。</p><p>但在实际的场景中，Pod 通常还会需要一些其他的资源，最典型的比如存储。在一些环境中，这些资源是需要预先进行创建的，<strong>尤其是在一些云厂商的场景中，还需要检查用户账户中是否还有余额可以用于创建云盘等</strong>。</p><p>一但前置的依赖无法满足，假如 kube-scheduler 已经完成了 Pod 的调度，那么 kubelet 侧就会处于尝试创建 Pod ，但失败的情况。</p><p>这个 KEP 的出现就可以很好的解决这个问题，增加了一个 Pod 是否准备好被调度的机制。如果前置依赖不满足，那么 Pod 就无需被调度，这也不会消耗资源。kube-scheduler 和 kubelet 都无需进行处理。待条件满足，Pod 再被调度和创建即可。</p><p>这个机制我个人感觉还是挺好的，甚至我可以有更灵活的策略来控制应用的副本。比如在大流量，需要动态扩容的场景下，我可以利用此机制预先创建一些 Pod 资源以及准备好它的依赖， 甚至可以在 Node 上准备好镜像等。当需要增加副本时，直接标记 Pod 可被调度，</p><p>使用时，通过配置 Pod 的 <code>.spec.schedulingGates</code> 即可。</p><h2 id="新增-NodeLogQuery-特性-KEP-2258"><a href="#新增-NodeLogQuery-特性-KEP-2258" class="headerlink" title="新增 NodeLogQuery 特性 - KEP-2258"></a>新增 NodeLogQuery 特性 - KEP-2258</h2><p>我们通常最习惯使用 <code>kubectl logs</code> 命令来获取 Kubernetes 集群中运行的应用的日志，也可以通过给它传递一些参数来调整它的过滤范围。</p><p>比如：<code>kubectl logs job/hello</code> 来指定获取 hello 这个 job 的日志；也可以增加 <code>-l</code> &#x2F; <code>--selector=&#39;&#39;</code> 来基于 label 进行过滤。</p><p>但这并没有扩展到 Node 级别的日志，无法直接获取到某个 Node 上的全部日志，要想得到这个结果需要写一段很复杂的 Shell 来完成。</p><p>当前 Kubernetes 社区已经逐渐提供了更多 Node 调试工具，旨在为调试 Node 故障提供统一体验，并更好地支持极简操作系统。通过 KEP 2258: add node log query by LorbusChris · Pull Request <code>#96120</code> · kubernetes&#x2F;kubernetes ，我们现在可以远程获取底层 Node 日志。与容器日志记录一样，这是Kubelet API的一部分。</p><p>对于Linux系统，它查询journald；对于Windows系统，则查询事件日志(Event Log)。目前还没有专门针对此功能的 kubectl 命令，但可以使用如下命令进行尝试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(MoeLove) ➜ kubectl get --raw <span class="string">&quot;/api/v2/nodes/<span class="variable">$NODE_NAME</span>/proxy/logs/?query=kubelet</span></span><br></pre></td></tr></table></figure><h2 id="基于-CEL-的-Admission-Control"><a href="#基于-CEL-的-Admission-Control" class="headerlink" title="基于 CEL 的 Admission Control"></a>基于 CEL 的 Admission Control</h2><p>对 Kubernetes 中的 Adminssion Control 感兴趣的小伙伴可以看看我之前的文章：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296994&idx=2&sn=60686fcebaacff30b9762a6229e85d12&chksm=f2eb81bdc59c08ab0f10013ed2bda48a7f3f5f3e0d335b7f1cdbbbce6e5b81656b487e9955d8&scene=21#wechat_redirect">理清 Kubernetes 中的准入控制（Admission Controller) | MoeLove</a></p><ul><li>KEP-3488: Implement secondary authz for ValidatingAdmissionPolicy by jpbetz · Pull Request <code>#116054</code> · kubernetes&#x2F;kubernetes</li><li>KEP-3488: Implement Enforcement Actions and Audit Annotations by jpbetz · Pull Request <code>#115973</code> · kubernetes&#x2F;kubernetes</li></ul><p>Kubernetes 在 v1.26 增加了一项很重要的特性，那就是允许使用 CEL 进行 Admission Control，具体内容可以参考文章：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649298102&idx=1&sn=2bef678dc8ece2b17c492a9a31450d6e&chksm=f2eb8569c59c0c7f3dad16f45941218c59310779759e275120311fe30ded91b88fa1d576028e&scene=21#wechat_redirect">Kubernetes v1.26 新特性一览 | MoeLove</a></p><p>其中引入了一个新的资源 ValidatingAdmissionPolicy ，使用起来如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1alpha1</span></span><br><span class="line"> <span class="attr">kind:</span> <span class="string">ValidatingAdmissionPolicy</span></span><br><span class="line"> <span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">&quot;demo-policy.moelove.info&quot;</span></span><br><span class="line"> <span class="attr">Spec:</span></span><br><span class="line">   <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">   <span class="attr">matchConstraints:</span></span><br><span class="line">     <span class="attr">resourceRules:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">apiGroups:</span>   [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">       <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">       <span class="attr">operations:</span>  [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">       <span class="attr">resources:</span>   [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">   <span class="attr">validations:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">expression:</span> <span class="string">&quot;object.spec.replicas &lt;= 2&quot;</span></span><br></pre></td></tr></table></figure><p>但是在当时也只是实现了 KEP-3488 的一部分。</p><p>在这个 PR 中是在实现 Authz 的部分，这允许用 CEL 表达式编写复杂的 admission control 规则， 放置在声明式资源中，而不是构建和部署 webhook。</p><p>虽然 admission webhook 一直是我们灵活的与第三方工具集成的基石，但是对于新用户来说，它们有很多复杂性，新的 CEL 系统有望接管仅需要对默认规则进行小修改的简单独立案例。</p><p>以前，表达式上下文会公开有关当前请求和目标资源的信息，现在通过这个 PR 可以在授权层中动态检查 RBAC 权限。一些有用的地方可能是使用 RBAC 进行每个字段的更新权限，允许 RBAC 检查特定对象而不使用 resourceNames 系统， 或基于请求者身份限制对程序敏感字段（例如 finalizers ）的访问而无需生成复杂的 RBAC 策略。</p><p>例如：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">authorizer.group(<span class="string">&#x27;&#x27;</span>).resource(<span class="string">&#x27;pods&#x27;</span>).namespace(<span class="string">&#x27;default&#x27;</span>).check(<span class="string">&#x27;create&#x27;</span>).allowed()</span><br><span class="line">authorizer.path(<span class="string">&#x27;/healthz&#x27;</span>).check(<span class="string">&#x27;GET&#x27;</span>).allowed()</span><br><span class="line">authorizer.requestResource.check(<span class="string">&#x27;my-custom-verb&#x27;</span>).allowed()</span><br></pre></td></tr></table></figure><p>本次还加入了<code>#115973</code>，该功能允许在失败时作为主要操作发出审计日志事件，或者如果需要更多数据，可以编写一个或多个CEL表达式，以提供详细的值， 这些值将发送到审计子系统。</p><p>这既可以在开发新策略时提供强大的调试选项，也可以进行运行时分析。其他 CEL admission 特性包括成本检查，以防止您使用所有这些新功能意外拒绝服务自己的 kube-apiserver，以及改进的类型检查。</p><p>总的来说，基于 CEL 的 admission 处理有了很多新的功能，希望进一步将 webhook 推入到一个有限的用例空间中（防止滥用）。</p><h2 id="Pod-In-place-原地伸缩能力"><a href="#Pod-In-place-原地伸缩能力" class="headerlink" title="Pod In-place 原地伸缩能力"></a>Pod In-place 原地伸缩能力</h2><p>这个功能允许在不重启 Pod 的情况下，更新 Pod 的 resources 配置。</p><ul><li>In-place Pod Vertical Scaling feature by vinaykul · Pull Request #102884 · kubernetes&#x2F;kubernetes</li></ul><p>经过 4 年的规划和至少 2 年的开发，在 Kubernetes v1.27 中终于推出了 Pod 的就地资源缩放的第一版。这个PR实现了核心缩放功能和一些相关的API处理。主要功能非常简单，现在可以在现有容器上编辑 <code>resources</code> 配置，而不会导致 API 错误。</p><p>在看到缩放请求后，Kubelet 会立即采取行动并检查节点是否有足够的资源来满足新的请求。如果是这样，它将 <code>Status.Resize</code> 字段设置为 InProgress，并继续进行 CRI 调用和其他内部更新。</p><p>如果新的大小不合适，将启动其他状态流，但总体目标相同，即尝试在可能的情况下提供请求的更改。还有一个新的 per-resource 缩放策略字段，可以设置为 <code>RestartNotRequired</code>（默认值）表示不需要重新启动（但某些运行时仍然可能需要这样做）， 或设置为 <code>Restart</code> 以强制关闭和重新启动容器（例如具有需要重新计算-Xmx 堆大小标志的 Java 应用）。</p><p>现在缺少一个显著的特性是基于缩放的驱逐。目前，Kubelet 不会自动处理它，但如果外部系统执行 Pod 删除，它将适当地作出反应。</p><p>尽管现在还处于比较早期的阶段，但至少我们看到了它的变化，期待后续的演进。</p><h2 id="一些废弃提醒"><a href="#一些废弃提醒" class="headerlink" title="一些废弃提醒"></a>一些废弃提醒</h2><h3 id="不再提供的API版本："><a href="#不再提供的API版本：" class="headerlink" title="不再提供的API版本："></a>不再提供的API版本：</h3><ul><li>Kubeadm <code>v1beta2</code>，可以使用 <code>kubeadm config migrate</code> 迁移到 <code>v1beta3</code>。</li><li><code>resource.k8s.io/v1alpha1.PodScheduling</code> ：请使用 <code>resource.k8s.io/v1alpha2.PodSchedulingContext</code>。</li><li>DynamicResourceManagement <code>v1alpha1</code>：请使用 <code>v1alpha2</code>。</li><li>CSIStorageCapacity：<code>storage.k8s.io/v1beta1</code>：请使用 v1。</li></ul><h3 id="已弃用，在下一个版本发布之前实现替代方案："><a href="#已弃用，在下一个版本发布之前实现替代方案：" class="headerlink" title="已弃用，在下一个版本发布之前实现替代方案："></a>已弃用，在下一个版本发布之前实现替代方案：</h3><ul><li><code>seccomp.security.alpha.kubernetes.io/pod</code> 和 <code>container.seccomp.security.alpha.kubernetes.io</code> annotations ：请改用 <code>securityContext.seccompProfile</code> 字段。</li><li><code>SecurityContextDeny</code> 准入插件。</li><li><code>service.kubernetes.io/topology-aware-hints</code> annotations：请改用 <code>service.kubernetes.io/topology-mode</code>。</li></ul><h3 id="已删除"><a href="#已删除" class="headerlink" title="已删除"></a>已删除</h3><ul><li><p>Feature gates:</p></li><li><ul><li><code>IPv6DualStack</code></li><li><code>ExpandCSIVolumes</code></li><li><code>ExpandInUsePersistentVolumes</code></li><li><code>ExpandPersistentVolumes</code></li><li><code>ControllerManagerLeaderMigration</code></li><li><code>CSI Migration</code></li><li><code>CSIInlineVolume</code></li><li><code>EphemeralContainers</code></li><li><code>LocalStorageCapacityIsolation</code></li><li><code>NetworkPolicyEndPort</code></li><li><code>StatefulSetMinReadySeconds</code></li><li><code>IdentifyPodOS</code></li><li><code>DaemonSetUpdateSurge</code></li></ul></li><li><p>appProtocol: <code>kubernetes.io/grpc</code>.</p></li><li><p>kube-apiserver 参数: <code>--master-service-namespace</code>.</p></li><li><p>CLI 参数: <code>--enable-taint-manager</code> 和 <code>--pod-eviction-timeout</code>.</p></li><li><p>kubelet 参数: <code>--container-runtime</code>, <code>--master-service-namespace</code>.</p></li><li><p>Azure disk in-tree storage plugin.</p></li><li><p>AWS kubelet credential provider: 使用 <code>ecr-credential-provider</code>.</p></li><li><p>Metrics:</p></li><li><ul><li><code>node_collector_evictions_number</code> 被 <code>node_collector_evictions_total</code> 替换</li><li><code>scheduler_e2e_scheduling_duration_seconds</code> 被 <code>scheduler_scheduling_attempt_duration_seconds</code> 替换</li></ul></li></ul><h1 id="Kubernetes-v1-28"><a href="#Kubernetes-v1-28" class="headerlink" title="Kubernetes v1.28"></a>Kubernetes v1.28</h1><p><strong>Kubernetes v1.28 是 2023 年的第二个大版本更新，包含了 46 项主要的更新。</strong> 而今年发布的第一个版本 v1.27 有近 60 项，所以可以看出来，在发布节奏调整后，每个 Kubernetes 版本中都会包含很多新的变化。</p><p>其中 20 个增强功能正在进入 Alpha 阶段，14 个将升级到 Beta 阶段，而另外 12 个则将升级到稳定版。</p><p>可以看出来很多都是新特性。</p><h2 id="Kubernetes-集群可以真正年度升级了"><a href="#Kubernetes-集群可以真正年度升级了" class="headerlink" title="Kubernetes 集群可以真正年度升级了"></a>Kubernetes 集群可以真正年度升级了</h2><p>我们知道 Kubernetes 集群的架构中 control plane 和 Node 分离的，虽然用户在部署集群的时候，通常会选择将 control plane 和 Node 部署为相同版本。 但是如果要进行集群版本升级的时候，就会发现 control plane 和 Node 在升级过程中是无法保持版本一致的。</p><p>举例来说：</p><ul><li>我部署了一套 v1.23 版本的 Kubernetes 集群，control plane 和 Node 目前都是 v1.23;</li><li>升级 control plane 到 v1.24;</li><li>这个时候 Node 还是 v1.23;</li><li>最后将 Node 也升级到 v1.24;</li></ul><p>在这个升级过程中，control plane 和 Node 有一段时间版本是不一致的，这会产生问题吗？</p><p>通常来说，对于大多数软件，如果是这种分离式架构，版本不一致是有可能存在问题的（这里我就不说某些系统&#x2F;软件了）。 但上述过程很明显是一定存在的，所以 <strong>Kubernetes 在这方面专门做了处理和兼容</strong> 。我们把这个策略叫作 Kubernetes 的版本偏差策略。</p><p>Kubernetes 中允许 control plane 和 Node 之间的版本存在 n-2 的偏差。比如：</p><ul><li>control plane 版本为 v1.27</li><li>Node 版本可以为 v1.27, v1.26 和 v1.25</li></ul><p>不过从 v1.28 开始，这个版本偏差策略扩展成了 n-3，比如：</p><ul><li>control plane 版本为 v1.28</li><li>Node 版本可以为 v1.28, v1.27, v1.26 和 v1.25</li></ul><p>解释完这个版本偏差策略后，我们来看下这个事情到底有多么重要。</p><p><strong>Kubernetes 当前的发布和支持策略，是用户可以在一年内持续升级到最新的补丁版本以获取安全修复，并且只要进行 3 个连续的版本升级，就可以追上最新支持的版本了。</strong></p><p>然而，由于 control plane 和 Node 之间测试&#x2F;支持偏差目前仅限于 n-2 个版本，因此每年的 3 个版本升级将不得不进行两次 Node 的升级，才能保持在受支持范围内。例如，从 v1.24 升级到 v1.27 ，这个场景正好是从 2022 年的第一个版本升级到 2023 年的第一个版本。</p><ul><li>control plane 和 Node 都是 v1.24;</li><li>control plane 升级 v1.24 - v1.25 - v1.26;</li><li>Node 升级 v1.24 - v1.26;</li><li>control plane 升级 v1.26 - v1.27</li><li>Node 升级 v1.26 - v1.27</li></ul><p>从这里可以看到 Node 要升级两次，事实上在 Kubernetes 集群的维护过程中，Node 版本的升级带来的影响是很大的， 比如原先运行在这些 Node 上的 Pod 需要重新调度&#x2F;重建等，虽然理想状况下对于业务应该没什么影响（但实际情况下...) 此外，随着集群规模的增加，这个 Node 升级的工作量也是很大的。</p><p>如果使用现在新的 n-3 偏差策略，我们来看看效果，还是从 v1.24 到 v1.27 （此处只是用做举例，从 v1.28 才生效）：</p><ul><li>control plane 和 Node 都是 v1.24;</li><li>control plane 升级 v1.24 - v1.25 - v1.26 - v1.27;</li><li>Node 升级 v1.24 - v1.27;</li></ul><p>这样的话，Node 只需要升级一次，很明显 <strong>节省了很多工作量，并且也可以减少对业务的影响</strong> ，这样也真正实现了 Kubernetes 的年度支持策略。</p><p>注意：首个可用 n-3 偏差策略的是 v1.28 ，它允许 control plane 是 v1.28 而 Node 最旧为 v1.25。</p><p>关于 Kubernetes 的版本偏差策略的详细说明可以参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/releases/version-skew-policy/">https://kubernetes.io/releases/version-skew-policy/</a></p><h2 id="基于-CEL-的-Admission-Control-达到-Beta"><a href="#基于-CEL-的-Admission-Control-达到-Beta" class="headerlink" title="基于 CEL 的 Admission Control 达到 Beta"></a>基于 CEL 的 Admission Control 达到 Beta</h2><p>对 Kubernetes 中的 Adminssion Control 感兴趣的小伙伴可以看文章：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649296994&idx=2&sn=60686fcebaacff30b9762a6229e85d12&chksm=f2eb81bdc59c08ab0f10013ed2bda48a7f3f5f3e0d335b7f1cdbbbce6e5b81656b487e9955d8&scene=21#wechat_redirect">理清 Kubernetes 中的准入控制（Admission Controller) | MoeLove</a></p><ul><li>KEP-3488: Implement secondary authz for ValidatingAdmissionPolicy by jpbetz · Pull Request <code>#116054</code> · kubernetes&#x2F;kubernetes</li><li>KEP-3488: Implement Enforcement Actions and Audit Annotations by jpbetz · Pull Request <code>#115973</code> · kubernetes&#x2F;kubernetes</li></ul><p>Kubernetes 在 v1.26 增加了一项很重要的特性，那就是允许使用 CEL 进行 Admission Control，具体内容可以参考文章：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&mid=2649298102&idx=1&sn=2bef678dc8ece2b17c492a9a31450d6e&chksm=f2eb8569c59c0c7f3dad16f45941218c59310779759e275120311fe30ded91b88fa1d576028e&scene=21#wechat_redirect">Kubernetes v1.26 新特性一览 | MoeLove</a></p><p>其中引入了一个新的资源 ValidatingAdmissionPolicy ，使用起来如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1alpha1</span></span><br><span class="line"> <span class="attr">kind:</span> <span class="string">ValidatingAdmissionPolicy</span></span><br><span class="line"> <span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">&quot;demo-policy.moelove.info&quot;</span></span><br><span class="line"> <span class="attr">Spec:</span></span><br><span class="line">   <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">   <span class="attr">matchConstraints:</span></span><br><span class="line">     <span class="attr">resourceRules:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">apiGroups:</span>   [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">       <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">       <span class="attr">operations:</span>  [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">       <span class="attr">resources:</span>   [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">   <span class="attr">validations:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">expression:</span> <span class="string">&quot;object.spec.replicas &lt;= 2&quot;</span></span><br></pre></td></tr></table></figure><p>但是在当时也只是实现了 KEP-3488 的一部分。</p><p>在这个 PR 中是在实现 Authz 的部分，这允许用 CEL 表达式编写复杂的 admission control 规则， 放置在声明式资源中，而不是构建和部署 webhook。</p><p>虽然 admission webhook 一直是我们灵活的与第三方工具集成的基石，但是对于新用户来说，它们有很多复杂性，新的 CEL 系统有望接管仅需要对默认规则进行小修改的简单独立案例。</p><p>以前，表达式上下文会公开有关当前请求和目标资源的信息，现在通过这个 PR 可以在授权层中动态检查 RBAC 权限。 一些有用的地方可能是使用 RBAC 进行每个字段的更新权限，允许 RBAC 检查特定对象而不使用 resourceNames 系统， 或基于请求者身份限制对程序敏感字段（例如 finalizers ）的访问而无需生成复杂的 RBAC 策略。</p><p>例如：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">authorizer.group(<span class="string">&#x27;&#x27;</span>).resource(<span class="string">&#x27;pods&#x27;</span>).namespace(<span class="string">&#x27;default&#x27;</span>).check(<span class="string">&#x27;create&#x27;</span>).allowed()</span><br><span class="line">authorizer.path(<span class="string">&#x27;/healthz&#x27;</span>).check(<span class="string">&#x27;GET&#x27;</span>).allowed()</span><br><span class="line">authorizer.requestResource.check(<span class="string">&#x27;my-custom-verb&#x27;</span>).allowed()</span><br></pre></td></tr></table></figure><p>在 v1.27 还加入了<code>#115973</code>，该功能允许在失败时作为主要操作发出审计日志事件，或者如果需要更多数据，可以编写一个或多个CEL表达式，以提供详细的值， 这些值将发送到审计子系统。</p><p>这既可以在开发新策略时提供强大的调试选项，也可以进行运行时分析。 其他 CEL admission 特性包括各种检查，以防止您使用所有这些新功能意外拒绝服务自己的 kube-apiserver，以及改进的类型检查。</p><p>本次升级到 Beta 阶段，API version 也就随之升级到了：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">admissionregistration.k8s.io/v1beta1</span></span><br></pre></td></tr></table></figure><p>此外，还引入了包括 ValidatingAdmissionPolicy: support namespace access by cici37 · Pull Request <code>#118267</code> · kubernetes&#x2F;kubernetes 等在内的特性，进一步将 webhook 推入到一个有限的用例空间中（防止滥用）。</p><h2 id="CRD-使用-CEL-进行-Validate-的特性再次达到-Beta"><a href="#CRD-使用-CEL-进行-Validate-的特性再次达到-Beta" class="headerlink" title="CRD 使用 CEL 进行 Validate 的特性再次达到 Beta"></a>CRD 使用 CEL 进行 Validate 的特性再次达到 Beta</h2><p>Kubernetes v1.23.0 正式发布后，引入了 Common Expression Language (CEL) 进行 CRD Validation。该特性计划在 v1.25 达到 Beta，这次是它第二次宣布达到 Beta 了。</p><p>例如，某个 CRDs 的内容如下，其中定义了 <code>minReplicas</code> 小于 <code>replicas</code> 并且 <code>replicas</code> 小于 <code>maxReplicas</code> 。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">openAPIV3Schema:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">  <span class="attr">properties:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">      <span class="attr">x-kubernetes-validations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.minReplicas &lt;= self.replicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be greater than or equal to minReplicas.&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">&quot;self.replicas &lt;= self.maxReplicas&quot;</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;replicas should be smaller than or equal to maxReplicas.&quot;</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">minReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">replicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="attr">maxReplicas:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">      <span class="attr">required:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">minReplicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">replicas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">maxReplicas</span> </span><br></pre></td></tr></table></figure><p>那么，当有如下的自定义资源创建时，Kubernetes 将会拒绝其请求。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;stable.example.com/v1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomDeployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-new-deploy-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p>并且返回如下错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The CustomDeployment <span class="string">&quot;my-new-deploy-object&quot;</span> is invalid:</span><br><span class="line">* spec: Invalid value: map[string]interface &#123;&#125;&#123;<span class="string">&quot;maxReplicas&quot;</span>:10, <span class="string">&quot;minReplicas&quot;</span>:0, <span class="string">&quot;replicas&quot;</span>:20&#125;: replicas should be smaller than or equal to maxReplicas.</span><br></pre></td></tr></table></figure><p>这次还增加了 [KEP-2876]Add reason and fieldPath into CRD validation rules by cici37 · Pull Request <code>#118041</code> · kubernetes&#x2F;kubernetes 这个 PR， 新增了 <code>fieldPath</code> 和 <code>reason</code> 字段的配置，可以更加方便使用。</p><p>其中 <code>reason</code> 字段可以传递给调用方的 HTTP status code，目前支持 <code>FieldValueInvalid</code>, <code>FieldValueForbidden</code>,<code>FieldValueRequired</code>, <code>FieldValueDuplicate</code>。如果未设置，默认使用 <code>FieldValueInvalid</code> 。</p><p>与之相关的，还有一个新增的 Alpha 特性 CRD Validation Ratcheting · Issue <code>#4008</code> · kubernetes&#x2F;enhancements</p><h2 id="非优雅的节点关闭特性达到-GA"><a href="#非优雅的节点关闭特性达到-GA" class="headerlink" title="非优雅的节点关闭特性达到 GA"></a>非优雅的节点关闭特性达到 GA</h2><p>当一个节点被关闭但没有被 Kubelet 的 Node Shutdown Manager 检测到时，StatefulSet 的 Pod 将会停留在正在终止状态，并且不能移动到新运行的节点上。</p><p>这是因为关闭节点上的 Kubelet 不可用来删除 Pod ，所以 StatefulSet 无法创建具有相同名称的新 Pod 。如果 Pod 使用卷，则 VolumeAttachments 将不会从原始关闭节点中删除，因此这些 Pod 使用的卷将无法附加到新运行的节点上。</p><p>结果是，在 StatefulSet 上运行应用程序将无法正常工作。如果原始关闭节重新启动，则 Pods 将被 Kubelet 删除，并在不同运行中创建新 Pods 。如果原始关闭节没有重新启动，则这些 Pods 将永远停留在正在终止状态下。</p><p>所谓的非优雅关闭节点的特性就是一种处理未被 Kubelet 的 Node Shutdown Manager 检测到的情况下进行 node 关闭的方法。 在此情况下强制删除 pods ，触发 VolumeAttachments 的删除，并在健康 Node 中创建 pod ，以便应用程序可以继续正常工作。 类似地，在遇到硬件故障或破损操作系统等不可恢复状态时也可以采取此方法。</p><p>这个特性的 feature gate 是 NodeOutOfServiceVolumeDetach，在旧版本的 kube-controller-manager 也可以自行开启。</p><p>目前它还需要人工操作，可以执行如下操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes &lt;node-name&gt; node.kubernetes.io/out-of-service=nodeshutdown:NoExecute</span><br></pre></td></tr></table></figure><p>这样非正常关闭的节点上的有状态应用的 Pod 只要没有匹配的容忍度，此污点将触发强制删除该节点上的 Pod。附加到关闭节点的持久卷将被分离，并且新的 Pod 将成功创建在另一个运行中的节点上。</p><p>这个特性还是很有用的。</p><h2 id="其他-2"><a href="#其他-2" class="headerlink" title="其他"></a>其他</h2><ul><li>in-tree 的 Ceph RBD， Ceph FS 的插件都废弃了，并且没有迁移 CSI 的计划；</li><li><strong>Sidecar container 的支持达到 alpha 级别；</strong></li><li>PodResources API 达到 GA；</li><li>Node swap 特性达到 Beta, 这是从 v1.22 引入的；</li></ul><h1 id="Kubernetes-v1-29"><a href="#Kubernetes-v1-29" class="headerlink" title="Kubernetes v1.29"></a>Kubernetes v1.29</h1><h2 id="KEP-2876-基于-CEL-的-CRD-规则校验正式达到-GA"><a href="#KEP-2876-基于-CEL-的-CRD-规则校验正式达到-GA" class="headerlink" title="KEP-2876: 基于 CEL 的 CRD 规则校验正式达到 GA"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-2876-%E5%9F%BA%E4%BA%8E-cel-%E7%9A%84-crd-%E8%A7%84%E5%88%99%E6%A0%A1%E9%AA%8C%E6%AD%A3%E5%BC%8F%E8%BE%BE%E5%88%B0-ga">KEP-2876: 基于 CEL 的 CRD 规则校验正式达到 GA</a></h2><p>这个特性对于所有在 Kubernetes 上进行开发的小伙伴来说应该都是非常重要的。 因为大多数情况下，我们都是通过 CRD 来实现 Kubernetes 中的功能扩展。</p><p>在通过 CRD 实现功能扩展的时候，为了能提供更好的用户体验，和更可靠的输入校验，就需要支持校验了。</p><p>CRD 目前原生支持两类校验能力：</p><ul><li>基于 CRD 结构定义的校验</li><li>OpenAPIv3 的校验规则</li></ul><p>例如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.13.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">categories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kong-ingress-controller</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">KongPluginList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">kongplugins</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kp</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">kongplugin</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">KongPlugin</span> <span class="string">is</span> <span class="string">the</span> <span class="string">Schema</span> <span class="string">for</span> <span class="string">the</span> <span class="string">kongplugins</span> <span class="string">API.</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">&#x27;APIVersion defines the versioned schema of this representation</span></span><br><span class="line"><span class="string">              of an object. Servers should convert recognized schemas to the latest</span></span><br><span class="line"><span class="string">              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27;</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">protocols:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">Protocols</span> <span class="string">configures</span> <span class="string">plugin</span> <span class="string">to</span> <span class="string">run</span> <span class="string">on</span> <span class="string">requests</span> <span class="string">received</span> <span class="string">on</span></span><br><span class="line">              <span class="string">specific</span> <span class="string">protocols.</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">KongProtocol</span> <span class="string">is</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">Kong</span> <span class="string">protocol.</span> <span class="string">This</span> <span class="string">alias</span> <span class="string">is</span> <span class="string">necessary</span></span><br><span class="line">                <span class="string">to</span> <span class="string">deal</span> <span class="string">with</span> <span class="string">https://github.com/kubernetes-sigs/controller-tools/issues/342</span></span><br><span class="line">              <span class="attr">enum:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">https</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">grpc</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">grpcs</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tls</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">udp</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">x-kubernetes-validations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">message:</span> <span class="string">Using</span> <span class="string">both</span> <span class="string">config</span> <span class="string">and</span> <span class="string">configFrom</span> <span class="string">fields</span> <span class="string">is</span> <span class="string">not</span> <span class="string">allowed.</span></span><br><span class="line">          <span class="attr">rule:</span> <span class="string">&#x27;!(has(self.config) &amp;&amp; has(self.configFrom))&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">message:</span> <span class="string">Using</span> <span class="string">both</span> <span class="string">configFrom</span> <span class="string">and</span> <span class="string">configPatches</span> <span class="string">fields</span> <span class="string">is</span> <span class="string">not</span> <span class="string">allowed.</span></span><br><span class="line">          <span class="attr">rule:</span> <span class="string">&#x27;!(has(self.configFrom) &amp;&amp; has(self.configPatches))&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">message:</span> <span class="string">The</span> <span class="string">plugin</span> <span class="string">field</span> <span class="string">is</span> <span class="string">immutable</span></span><br><span class="line">          <span class="attr">rule:</span> <span class="string">self.plugin</span> <span class="string">==</span> <span class="string">oldSelf.plugin</span></span><br></pre></td></tr></table></figure><p>以上示例中定义了一个名为 <code>KongPlugin</code> 的自定义资源，其中使用 <code>openAPIV3Schema</code> 定义了 OpenAPI schema 的校验规则。</p><p>但这些内置规则能达到的效果相对有限，如果想要实现更加丰富的校验规则&#x2F;特性，则可以使用：</p><ul><li>Admission Webhook: 关于 Adminssion webhook 可以参考我之前的文章 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2021/11/30/%E7%90%86%E6%B8%85-Kubernetes-%E4%B8%AD%E7%9A%84%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6Admission-Controller/">理清 Kubernetes 中的准入控制（Admission Controller) | MoeLove</a></li><li>使用自定义验证器：例如基于 Open Policy Agent(OPA) 的 Gatekeeper，关于 OPA 可以参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2021/12/06/Open-Policy-Agent-OPA-%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5/">Open Policy Agent (OPA) 入门实践 | MoeLove</a></li></ul><p>不过 <strong>无论是 Admission webhook 还是自定义验证器，它们与 CRD 自身都是分离的，并且这也会导致开发 CRD 的难度和后续的维护成本增加。</strong></p><p>为了能解决这些问题，Kubernetes 社区为 CRD 引入了一种基于 CEL（Common Expression Language）的校验规则，这个规则是可以直接 在 CRD 的声明文件中编写的，无需使用任何 Admission webhook 或者自定义验证器，大大简化了 CRD 的开发和维护成本。</p><p>我从社区刚开始想要引入这个功能起就一直在文章中宣传该功能了，持续关注的小伙伴对这个应该不算陌生了。 我大概查看了以下文章中都有介绍 Kubernetes 中 CEL 相关特性的演进过程，感兴趣的小伙伴可以逐篇阅读：</p><ul><li>两年前的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2021/12/08/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-Kubernetes-v1.23.0-%E6%AD%A3%E5%BC%8F%E5%8F%91%E5%B8%83%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/">K8S 生态周报| Kubernetes v1.23.0 正式发布，新特性一览 | MoeLove</a></li><li>一年前的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2022/12/09/Kubernetes-v1.26-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/">Kubernetes v1.26 新特性一览 | MoeLove</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/03/12/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-Kubernetes-%E5%9F%BA%E4%BA%8E-CEL-%E7%9A%84%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E5%86%8D%E6%B7%BB%E6%96%B0%E7%89%B9%E6%80%A7/">K8S 生态周报| Kubernetes 基于 CEL 的控制系统再添新特性 | MoeLove</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/04/03/Kubernetes-v1.27-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#%E5%9F%BA%E4%BA%8E-cel-%E7%9A%84-admission-control">Kubernetes v1.27 新特性一览 | MoeLove</a></li></ul><p>在 Kubernetes v1.29 版本中基于 CEL 的 CRD 校验能力达到 GA，只需要使用 <code>x-kubernetes-validations</code> 定义校验规则即可， 它足够轻量且安全，可以直接在 kube-apiserver 中运行，我们来看一个例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.13.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kongplugins.configuration.konghq.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">configuration.konghq.com</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">KongPlugin</span> <span class="string">is</span> <span class="string">the</span> <span class="string">Schema</span> <span class="string">for</span> <span class="string">the</span> <span class="string">kongplugins</span> <span class="string">API.</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">plugin:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">x-kubernetes-validations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">message:</span> <span class="string">Using</span> <span class="string">both</span> <span class="string">config</span> <span class="string">and</span> <span class="string">configFrom</span> <span class="string">fields</span> <span class="string">is</span> <span class="string">not</span> <span class="string">allowed.</span></span><br><span class="line">          <span class="attr">rule:</span> <span class="string">&#x27;!(has(self.config) &amp;&amp; has(self.configFrom))&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">message:</span> <span class="string">The</span> <span class="string">plugin</span> <span class="string">field</span> <span class="string">is</span> <span class="string">immutable</span></span><br><span class="line">          <span class="attr">rule:</span> <span class="string">self.plugin</span> <span class="string">==</span> <span class="string">oldSelf.plugin</span></span><br></pre></td></tr></table></figure><p>例如其中的这句 <code>self.plugin == oldSelf.plugin</code>，<code>self</code> 和 <code>oldSelf</code> 代表了变化前后的资源对象， 一旦定义了 <code>plugin</code> 字段的内容，则不允许修改它。</p><p>此外，CEL 还有非常丰富的特性，可以通过在线的 Playground 来体验它 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://playcel.undistro.io/">https://playcel.undistro.io/</a></p><p>正如我前面提到的，这个特性引入的时间已经两年多了，在 Kubernetes v1.25 中达到 Beta 并默认开启，如今终于达到了 GA。</p><p>额外一说，Kubernetes Gateway API 项目正在将它的所有 Admission webhook 删掉，全部使用基于 CEL 的规则进行校验， 这大概是目前社区中最大的一个用例了。</p><h2 id="KEP-3668-为动态和静态分配预留-NodePort-端口范围达到-stable"><a href="#KEP-3668-为动态和静态分配预留-NodePort-端口范围达到-stable" class="headerlink" title="KEP-3668: 为动态和静态分配预留 NodePort 端口范围达到 stable"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-3668-%E4%B8%BA%E5%8A%A8%E6%80%81%E5%92%8C%E9%9D%99%E6%80%81%E5%88%86%E9%85%8D%E9%A2%84%E7%95%99-nodeport-%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4%E8%BE%BE%E5%88%B0-stable">KEP-3668: 为动态和静态分配预留 NodePort 端口范围达到 stable</a></h2><p>众所周知 Kubernetes 原生的 Service 对象有一种 NodePort 的类型，用于将集群内的服务暴露到集群外。</p><p>在当前情况下，如果用户想要新建一个 NodePort，并为它固定的指定一个 Port，其实是存在一定的风险的。 有可能指定的 Port 已经被分配出去了，这样就会冲突，导致 Service 创建失败。</p><p>这个 KEP 提出了为 NodePort 类型的 Services 动、静态地预留一段可选区间，并且支持两种方式进行 Port 配置：</p><ul><li>自动化地随机生成（由 Kubernetes 按照规则自动生成）</li><li>手工设置（由用户根据需求自行设定）。</li></ul><p>举个例子：</p><p>kube-apiserver 可以通过 <code>--service-node-port-range</code> 控制 NodePort 可以使用的端口范围，默认是 <code>30000-32767</code>。在这个 KEP 中引入的计算公式是：<code>min(max($min, node-range-size/$step), $max)</code> ，也就是说：</p><ul><li>Service Node Port 范围: 30000-32767</li><li>范围大小: 32767 - 30000 &#x3D; 2767</li><li>Band Offset: min(max(16,2767&#x2F;32),128) &#x3D; min(86,128) &#x3D; 86</li><li>Static band start: 30000</li><li>Static band ends: 30086</li></ul><p>按照这种方式计算，也就是 30000-30086 作为 static 段，之后的作为 dynamic 段。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> ┌─────────────┬─────────────────────────────────────────────┐</span><br><span class="line"> │   static    │                    dynamic                  │</span><br><span class="line"> └─────────────┴─────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"> ◄────────────► ◄────────────────────────────────────────────►</span><br><span class="line">30000        30086                                          32767</span><br></pre></td></tr></table></figure><p>如果用户想要自己指定一个 NodePort 的端口，若在 static 范围内，则相对来说不容易出现冲突。</p><p>不过，总体来说这个特性实际上是一个 Kubernetes 内部的特性，多数情况下只要记住一个原则：“手动指定 NodePort 时尽量选择在 static 范围（前段）内即可”。如果用户指定的 Port 在 dynamic 范围内，如果该 Port 尚未被分配，则也可以创建成功。</p><p>这种计算方式实际上是来自于 KEP-3070，用于给 Service 分配 ClusterIP 使用的。</p><h2 id="KEP-753：SidecarContainers-特性达到-Beta-并默认启用"><a href="#KEP-753：SidecarContainers-特性达到-Beta-并默认启用" class="headerlink" title="KEP-753：SidecarContainers 特性达到 Beta 并默认启用"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-753sidecarcontainers-%E7%89%B9%E6%80%A7%E8%BE%BE%E5%88%B0-beta-%E5%B9%B6%E9%BB%98%E8%AE%A4%E5%90%AF%E7%94%A8">KEP-753：SidecarContainers 特性达到 Beta 并默认启用</a></h2><p>Sidecars 是一种辅助容器，它们能够给主容器添加额外功能。尽管这种模式在 Service Mesh 场景用例更多，但很多用户也会在非 Service Mesh 场景下使用，比如像日志记录、监控等场景。</p><p>但是之前 Sidecars 在这些场景中使用存在一些问题，比如当 Pod 删除的时候，由于 Sidecar 容器的生命周期管理的缺失，会导致这些服务和主容器的生命周期不同步，进而影响服务的可靠性。</p><p>这个 KEP 在 Pod 规范中将 Sidecar 容器定义为 init containers 的一部分，并且指定其具有“始终重启”策略。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">moelove-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">moelove/fluentbit</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure><p>在 Kubernetes v1.29 版本中该特性将默认启用，同时 Sidecar containers 的停止顺序将按照与它们启动时候相反的顺序来进行，这样一方面可以确保是主容器先停止的，另一方面也便于控制所有组件的生命周期。</p><h2 id="KEP-3960-PreStop-Hook-引入-Sleep-动作（Alpha）"><a href="#KEP-3960-PreStop-Hook-引入-Sleep-动作（Alpha）" class="headerlink" title="KEP-3960: PreStop Hook 引入 Sleep 动作（Alpha）"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-3960-prestop-hook-%E5%BC%95%E5%85%A5-sleep-%E5%8A%A8%E4%BD%9Calpha">KEP-3960: PreStop Hook 引入 Sleep 动作（Alpha）</a></h2><p>这个 KEP 也比较有意思，主要是为了简化一个最常见的需求。</p><p>很多应用 Pod 在关闭的时候，需要断开连接，以免影响用户流量。所以很多时候会在关闭前设置 PreStop 来进行一些相关的处理或者等待。</p><p>但是当前的 PreStop Hook 只支持 <code>exec</code> 和 <code>httpGet</code> 这两种，这个 KEP 是想要实现一种原生的 <code>sleep</code> 操作，例如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">sleep:</span></span><br><span class="line">              <span class="attr">seconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>这样就可以很简单了。在引入这个 KEP 之前，需要设置为类似 exec <code>sh -c &quot;sleep 5&quot;</code> 这样，这需要容器内还包含 <code>sleep</code> 这个命令才行。</p><p>不过这个特性目前处于 Alpha，能否最终 GA 还需要看看社区的反馈。</p><h2 id="KEP-4193：改善-service-account-token-绑定机制（Alpha）"><a href="#KEP-4193：改善-service-account-token-绑定机制（Alpha）" class="headerlink" title="KEP-4193：改善 service account token 绑定机制（Alpha）"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-4193%E6%94%B9%E5%96%84-service-account-token-%E7%BB%91%E5%AE%9A%E6%9C%BA%E5%88%B6alpha">KEP-4193：改善 service account token 绑定机制（Alpha）</a></h2><p>在 Kubernetes 中，service account token 是保障安全性不可或缺的一环。它们用于验证集群中各个工作负载，并且可以防止未经授权访问。</p><p>Kubernetes v1.29 中进一步加强了对这些令牌的安全保护：现在每个 service account 仅能与特定 Pod 实例相关联，在外泄后也无法被滥用。这种方式有效地将 service account 和 Pod 生命周期捆绑在一起，大大减少了攻击者利用盗取 token 进行攻击的可能。</p><p>在 v1.29 中 kube-apiserver 有如下相关的 feature gates 可以控制相关的特性，当然除了 KEP-4193 外，这个版本中也推进了 KEP-2799，减少了基于 secret 的 service account token。这有助于缩短 Token 的有效时间，尽可能的减少攻击面。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LegacyServiceAccountTokenCleanUp=true|false (BETA - default=true)</span><br><span class="line">ServiceAccountTokenJTI=true|false (ALPHA - default=false)</span><br><span class="line">ServiceAccountTokenNodeBinding=true|false (ALPHA - default=false)</span><br><span class="line">ServiceAccountTokenNodeBindingValidation=true|false (ALPHA - default=false)</span><br><span class="line">ServiceAccountTokenPodNodeInfo=true|false (ALPHA - default=false)</span><br></pre></td></tr></table></figure><h2 id="KEP-727：Kubelet-Resource-Metrics-达到-GA"><a href="#KEP-727：Kubelet-Resource-Metrics-达到-GA" class="headerlink" title="KEP-727：Kubelet Resource Metrics 达到 GA"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-727kubelet-resource-metrics-%E8%BE%BE%E5%88%B0-ga">KEP-727：Kubelet Resource Metrics 达到 GA</a></h2><p>这是一个有很长历史的 KEP 了，从开始提出到现在 GA 用了 5 年的时间，中间也发生了很多有趣的事情。这次主要涉及的部分是如下 metrics：</p><ul><li><code>container_cpu_usage_seconds_total</code></li><li><code>container_memory_working_set_bytes</code></li><li><code>container_start_time_seconds</code></li><li><code>node_cpu_usage_seconds_total</code></li><li><code>node_memory_working_set_bytes</code></li><li><code>pod_cpu_usage_seconds_total</code></li><li><code>pod_memory_working_set_bytes</code></li><li><code>resource_scrape_error</code></li></ul><p>以下是一个示例的输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># HELP container_cpu_usage_seconds_total [STABLE] Cumulative cpu time consumed by the container in core-seconds</span><br><span class="line"># TYPE container_cpu_usage_seconds_total counter</span><br><span class="line">container_cpu_usage_seconds_total&#123;container=&quot;coredns&quot;,namespace=&quot;kube-system&quot;,pod=&quot;coredns-55968cc89d-bhhbx&quot;&#125; 0.195744 1691361886865</span><br><span class="line"># HELP container_memory_working_set_bytes [STABLE] Current working set of the container in bytes</span><br><span class="line"># TYPE container_memory_working_set_bytes gauge</span><br><span class="line">container_memory_working_set_bytes&#123;container=&quot;coredns&quot;,namespace=&quot;kube-system&quot;,pod=&quot;coredns-55968cc89d-bhhbx&quot;&#125; 1.675264e+07 1691361886865</span><br><span class="line"># HELP container_start_time_seconds [STABLE] Start time of the container since unix epoch in seconds</span><br><span class="line"># TYPE container_start_time_seconds gauge</span><br><span class="line">container_start_time_seconds&#123;container=&quot;coredns&quot;,namespace=&quot;kube-system&quot;,pod=&quot;coredns-55968cc89d-bhhbx&quot;&#125; 1.6913618235901163e+09 1691361823590</span><br><span class="line"># HELP node_cpu_usage_seconds_total [STABLE] Cumulative cpu time consumed by the node in core-seconds</span><br><span class="line"># TYPE node_cpu_usage_seconds_total counter</span><br><span class="line">node_cpu_usage_seconds_total 514578.636 1691361887931</span><br><span class="line"># HELP node_memory_working_set_bytes [STABLE] Current working set of the node in bytes</span><br><span class="line"># TYPE node_memory_working_set_bytes gauge</span><br><span class="line">node_memory_working_set_bytes 1.9501084672e+10 1691361887931</span><br><span class="line"># HELP pod_cpu_usage_seconds_total [STABLE] Cumulative cpu time consumed by the pod in core-seconds</span><br><span class="line"># TYPE pod_cpu_usage_seconds_total counter</span><br><span class="line">pod_cpu_usage_seconds_total&#123;namespace=&quot;kube-system&quot;,pod=&quot;coredns-55968cc89d-bhhbx&quot;&#125; 1.30598 1691361880003</span><br><span class="line"># HELP pod_memory_working_set_bytes [STABLE] Current working set of the pod in bytes</span><br><span class="line"># TYPE pod_memory_working_set_bytes gauge</span><br><span class="line">pod_memory_working_set_bytes&#123;namespace=&quot;kube-system&quot;,pod=&quot;coredns-55968cc89d-bhhbx&quot;&#125; 1.6715776e+07 1691361880003</span><br><span class="line"># HELP resource_scrape_error [STABLE] 1 if there was an error while getting container metrics, 0 otherwise</span><br><span class="line"># TYPE resource_scrape_error gauge</span><br><span class="line">resource_scrape_error 0</span><br><span class="line"># HELP scrape_error [ALPHA] 1 if there was an error while getting container metrics, 0 otherwise</span><br><span class="line"># TYPE scrape_error gauge</span><br><span class="line">scrape_error 0</span><br></pre></td></tr></table></figure><h2 id="KEP-3466-Kubernetes-Component-Health-SLIs-达到-GA"><a href="#KEP-3466-Kubernetes-Component-Health-SLIs-达到-GA" class="headerlink" title="KEP-3466: Kubernetes Component Health SLIs 达到 GA"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:kep-3466-kubernetes-component-health-slis-%E8%BE%BE%E5%88%B0-ga">KEP-3466: Kubernetes Component Health SLIs 达到 GA</a></h2><p>这个 KEP 的主要目的是为了让每个组件暴露它们自己的健康状态，以便于可以根据其健康状态的 SLI 计算集群的 SLO。</p><p>很久之前 Kubernetes 中存在一个 ComponentStatus，可以用于查看集群中组件的状态。但正如下方所示，在 v1.19 已经实际上废弃了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">moelove@k8s-test:~$ kubectl  get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE   ERROR</span><br><span class="line">scheduler            Healthy   ok        </span><br><span class="line">etcd-0               Healthy   ok        </span><br><span class="line">controller-manager   Healthy   ok </span><br></pre></td></tr></table></figure><p>我们期望能通过这个 KEP 使用各个组件的健康状态作为 SLI，采集聚合后，计算出集群的 SLO。进而可以给出 SLA。（关于它们之间的关系有兴趣的小伙伴可以搜索下相关内容）</p><p>以下是一个示例的输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tao@moelove:/$ kubectl get --raw &quot;/metrics/slis&quot;</span><br><span class="line"># HELP kubernetes_healthcheck [STABLE] This metric records the result of a single healthcheck.</span><br><span class="line"># TYPE kubernetes_healthcheck gauge</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;etcd&quot;,type=&quot;healthz&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;etcd&quot;,type=&quot;livez&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;etcd&quot;,type=&quot;readyz&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;etcd-readiness&quot;,type=&quot;readyz&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;informer-sync&quot;,type=&quot;readyz&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;ping&quot;,type=&quot;healthz&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;ping&quot;,type=&quot;livez&quot;&#125; 1</span><br><span class="line">kubernetes_healthcheck&#123;name=&quot;ping&quot;,type=&quot;readyz&quot;&#125; 1</span><br></pre></td></tr></table></figure><h2 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98">已知问题</a></h2><p><code>EventedPLEG</code> 这个特性在 v1.27 中升级到了 Beta，但是在新版本的测试中发现了比较多的问题，所以现在将它默认禁用了，待社区修复后会再打开。<strong>建议在 v1.29 中先关闭此特性</strong></p><h2 id="其他-3"><a href="#其他-3" class="headerlink" title="其他"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://moelove.info/2023/12/10/Kubernetes-v1.29-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%80%E8%A7%88/#contents:%E5%85%B6%E4%BB%96">其他</a></h2><ul><li>KEP-2495: PV&#x2F;PVC <code>ReadWriteOncePod</code> 达到 GA</li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/enhancements/issues/3107">NodeExpandSecret</a> 特性达到 GA</li><li>kube-proxy 有了个 nftables 的新后端</li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang">小五</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://xiaowu95.wang/posts/1dca4389/">https://xiaowu95.wang/posts/1dca4389/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://xiaowu95.wang" target="_blank">小五的个人杂货铺</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a><a class="post-meta__tags" href="/tags/k3s/">k3s</a></div><div class="post-share"><div class="social-share" data-image="/img/nba-logo13.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/wxpay.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/ecb3c3a1/" title="k8s学习-kubectl命令行jsonpath的使用"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo26.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">k8s学习-kubectl命令行jsonpath的使用</div></div><div class="info-2"><div class="info-item-1">转自: https://blog.51cto.com/u_11555417/5521927 参考官网手册 说明 JSONPath 支持 | Kubernetes JSONPath 模板由 {} 包起来的 JSONPath 表达式组成。Kubectl 使用 JSONPath 表达式来过滤 JSON 对象中的特定字段并格式化输出。 除了原始的 JSONPath 模板语法，以下函数和语法也是有效的: 使用双引号将 JSONPath 表达式内的文本引起来。 使用range，end 运算符来迭代列表。 使用负片索引后退列表。负索引不会“环绕”列表，并且只要-index + listLength&gt; &#x3D; 0 就有效。 通过kubectl命令行配合jsonpath就能获取过滤到我们关注的信息。 函数 描述 示例 结果 text 纯文本 kind is &#123;.kind&#125; kind is List @ 当前对象 &#123;@&#125; 与输入相同 . or [] 子运算符 &#123;.kind&#125; or...</div></div></div></a><a class="pagination-related" href="/posts/b979a46f/" title="k8s在不同或相同namespace下服务间访问"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">k8s在不同或相同namespace下服务间访问</div></div><div class="info-2"><div class="info-item-1">同一个名称空间 k8s给每个内部微服务提供了一个内部使用的host，就是.。可以在代码中直接访问[http:&#x2F;&#x2F;.:],来达到访问另一个服务。如果是部署到默认namespace下的服务，namespace为“default”。 不同名称空间 无论是相同还是不同名称空间都可以通过&#123;SERVICE_NAME&#125;.&#123;NAMESPACE_NAME&#125;.svc.cluster.local或者&#123;SERVICE_NAME&#125;.&#123;NAMESPACE_NAME&#125;jinx访问 所以,Namespace是形成逻辑上的&quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。 例子: &quot;default.svc.cluster.local&quot;。&quot;default&quot; 是我们正在操作的命名空间。 &quot;svc&quot; 表示这是一个 Service。&quot;cluster.local&quot; 是你的集群域，在你自己的集群中可能会有所不同。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/bbffb116/" title="kubeconfig文件详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo21.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-09-26</div><div class="info-item-2">kubeconfig文件详解</div></div><div class="info-2"><div class="info-item-1">在node节点上可以执行kubectl命令吗？ 12[root@k8s-node1 ~]# kubectl get nodeThe connection to the server localhost:8080 was refused - did you specify the right host or port? localhost:8080 这个端口是k8s api（kube-apiserver非安全端口）的端口，*在master上面可以执行成功其实走的是配置文件。但是在node上连接的是本地的非安全端口。* 其实还有一个对外端口是6443，这个是kube-apiserver监听的，masterip:6443安全端口 12[root@k8s-master ~]# netstat -tpln | grep 6443tcp6 0 0 :::6443 :::* LISTEN 92617/kube-apiserve...</div></div></div></a><a class="pagination-related" href="/posts/67fd0ae0/" title="helm命令"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-01-10</div><div class="info-item-2">helm命令</div></div><div class="info-2"><div class="info-item-1">查看所有repo1helm repo list 删除repo1helm repo remove stable 添加repo1helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts 更新1helm repo update 下载指定版本Rancher 版本 tgz 压缩包到本地1helm fetch rancher-stable/rancher --version=v2.5.8 部署升级,把读取的部署参数使用 --set &lt;key&gt;=&lt;value&gt; 的方式添加到命令中1234helm upgrade rancher rancher-stable/rancher \--namespace cattle-system \--set ingress.tls.source=secret \--set hostname=&lt;domain_name&gt; helm命令大全 - 链接</div></div></div></a><a class="pagination-related" href="/posts/af2a1e86/" title="helm的安装"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-08-09</div><div class="info-item-2">helm的安装</div></div><div class="info-2"><div class="info-item-1">下载helm3.81wget https://get.helm.sh/helm-v3.8.0-linux-amd64.tar.gz 解压1tar -zxvf helm-v3.8.0-linux-amd64.tar.gz 赋权1mv linux-amd64/helm /usr/local/bin/helm &amp;&amp; chmod +x /usr/local/bin/helm</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小五</div><div class="author-info-description">Tomorrow will be better,Everything will be fine</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">550</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wang-xiaowu"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/random" target="_blank" title="随便逛逛"><i class="fa-solid fa-shuffle"></i></a><a class="social-icon" href="mailto:wangxiaowu950330@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/30655189?spm_id_from=333.1007.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-22"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes v1.22</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Server-side-Apply-%E7%89%B9%E6%80%A7%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">1.1.</span> <span class="toc-text">Server-side Apply 特性达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-Security-Policy-%E7%9A%84%E6%9B%BF%E4%BB%A3%E5%93%81"><span class="toc-number">1.2.</span> <span class="toc-text">Pod Security Policy 的替代品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-swap-%E6%94%AF%E6%8C%81"><span class="toc-number">1.3.</span> <span class="toc-text">Node swap 支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E8%AF%81%E6%8F%90%E4%BE%9B%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.</span> <span class="toc-text">外部客户端凭证提供工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E7%B4%A2%E5%BC%95%E7%9A%84-Job-API"><span class="toc-number">1.5.</span> <span class="toc-text">可索引的 Job API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA-Job-API-%E5%A2%9E%E5%8A%A0-suspend-%E5%AD%97%E6%AE%B5"><span class="toc-number">1.6.</span> <span class="toc-text">为 Job API 增加 suspend 字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSR-%E7%9A%84%E6%9C%89%E6%95%88%E6%9C%9F"><span class="toc-number">1.7.</span> <span class="toc-text">CSR 的有效期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E8%B5%84%E6%BA%90%E7%9A%84-QoS"><span class="toc-number">1.8.</span> <span class="toc-text">内存资源的 QoS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-23"><span class="toc-number">2.</span> <span class="toc-text">Kubernetes v1.23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E-kubectl-alpha-events-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.</span> <span class="toc-text">新增 kubectl alpha events 命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv4-IPv6-%E5%8F%8C%E6%A0%88%E6%94%AF%E6%8C%81%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">2.2.</span> <span class="toc-text">IPv4&#x2F;IPv6 双栈支持达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PodSecurity-Admission-%E8%BE%BE%E5%88%B0-Beta"><span class="toc-number">2.3.</span> <span class="toc-text">PodSecurity Admission 达到 Beta</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IngressClass-%E6%94%AF%E6%8C%81-namespace-%E7%BA%A7%E5%88%AB%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.</span> <span class="toc-text">IngressClass 支持 namespace 级别的参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Probe-%E4%B8%AD%E5%A2%9E%E5%8A%A0-gRPC-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">2.5.</span> <span class="toc-text">Probe 中增加 gRPC 协议的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E-OpenAPI-V3"><span class="toc-number">2.6.</span> <span class="toc-text">新增 OpenAPI V3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRD-Validation-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%AD%E8%A8%80"><span class="toc-number">2.7.</span> <span class="toc-text">CRD Validation 表达式语言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HPA-v2-API-%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">2.8.</span> <span class="toc-text">HPA v2 API 达到 GA</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-24"><span class="toc-number">3.</span> <span class="toc-text">Kubernetes v1.24</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84beta-API%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%AD"><span class="toc-number">3.1.</span> <span class="toc-text">各beta API默认关闭</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenAPI-v3"><span class="toc-number">3.2.</span> <span class="toc-text">OpenAPI v3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%AE%B9%E9%87%8F%E4%B8%8E%E5%AD%98%E5%82%A8%E5%8D%B7%E6%89%A9%E5%B1%95%E5%8F%8C%E5%8F%8C%E8%BF%8E%E6%9D%A5%E9%80%9A%E7%94%A8%E7%89%88%E6%9C%AC"><span class="toc-number">3.3.</span> <span class="toc-text">存储容量与存储卷扩展双双迎来通用版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NonPreemptingPriority%E8%BF%8E%E6%9D%A5%E7%A8%B3%E5%AE%9A%E7%89%88"><span class="toc-number">3.4.</span> <span class="toc-text">NonPreemptingPriority迎来稳定版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%8F%92%E4%BB%B6%E8%BF%81%E7%A7%BB"><span class="toc-number">3.5.</span> <span class="toc-text">存储插件迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC%E6%8E%A2%E9%92%88%E5%8D%87%E7%BA%A7%E8%87%B3beta%E7%89%88"><span class="toc-number">3.6.</span> <span class="toc-text">gRPC探针升级至beta版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubelet%E8%AF%81%E4%B9%A6%E6%8F%90%E4%BE%9B%E7%A8%8B%E5%BA%8F%E5%8D%87%E7%BA%A7%E8%87%B3beta%E7%89%88"><span class="toc-number">3.7.</span> <span class="toc-text">Kubelet证书提供程序升级至beta版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E4%B8%BA%E6%9C%8D%E5%8A%A1%E5%88%86%E9%85%8DIP%E6%97%B6%E5%8F%91%E7%94%9F%E5%86%B2%E7%AA%81"><span class="toc-number">3.8.</span> <span class="toc-text">避免为服务分配IP时发生冲突</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-25"><span class="toc-number">4.</span> <span class="toc-text">Kubernetes v1.25</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#core-CSI-Migration-%E8%BE%BE%E5%88%B0-Stable"><span class="toc-number">4.1.</span> <span class="toc-text">core CSI Migration 达到 Stable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cgroup-v2-%E6%94%AF%E6%8C%81%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">4.2.</span> <span class="toc-text">cgroup v2 支持达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PodSecurity-%E7%89%B9%E6%80%A7%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">4.3.</span> <span class="toc-text">PodSecurity 特性达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E6%94%AF%E6%8C%81-user-namespaces"><span class="toc-number">4.4.</span> <span class="toc-text">初步支持 user namespaces</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CronJobTimeZone-%E8%BE%BE%E5%88%B0-Beta-%E7%BA%A7%E5%88%AB"><span class="toc-number">4.5.</span> <span class="toc-text">CronJobTimeZone 达到 Beta 级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-alpha-%E7%89%B9%E6%80%A7-ContainerCheckpoint"><span class="toc-number">4.6.</span> <span class="toc-text">引入 alpha 特性 ContainerCheckpoint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA-kubectl-%E5%BC%95%E5%85%A5-kuberc-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.7.</span> <span class="toc-text">为 kubectl 引入 kuberc 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA-kubectl-%E6%B7%BB%E5%8A%A0-subresource-%E7%9A%84%E8%A1%A5%E5%85%A8"><span class="toc-number">4.8.</span> <span class="toc-text">为 kubectl 添加 --subresource 的补全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">4.9.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-26"><span class="toc-number">5.</span> <span class="toc-text">Kubernetes v1.26</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3294-%E5%85%81%E8%AE%B8%E8%B7%A8-namespace-%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%B7%E5%BF%AB%E7%85%A7%E5%BC%95%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">#3294 允许跨 namespace 持久化卷快照引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3488-%E5%85%81%E8%AE%B8%E4%BD%BF%E7%94%A8-CEL-%E8%BF%9B%E8%A1%8C-Admission-Control"><span class="toc-number">5.2.</span> <span class="toc-text">#3488 允许使用 CEL 进行 Admission Control</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3545-%E6%94%B9%E5%96%84-NUMA-%E4%B8%AD%E7%9A%84%E6%8B%93%E6%89%91%E7%AE%A1%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">#3545 改善 NUMA 中的拓扑管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#113274-%E4%B8%BA-Pod-%E8%B0%83%E5%BA%A6%E5%A2%9E%E5%8A%A0%E8%B0%83%E5%BA%A6%E5%B0%B1%E7%BB%AA%E7%9A%84%E6%9C%BA%E5%88%B6"><span class="toc-number">5.4.</span> <span class="toc-text">#113274 为 Pod 调度增加调度就绪的机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4-CRI-v1alpha2"><span class="toc-number">5.5.</span> <span class="toc-text">移除 CRI v1alpha2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#111333-Auth-API-%E5%85%81%E8%AE%B8%E8%8E%B7%E5%8F%96-User-%E5%B1%9E%E6%80%A7"><span class="toc-number">5.6.</span> <span class="toc-text">#111333 Auth API 允许获取 User 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3386-%E5%87%8F%E5%B0%91-Kubelet-%E5%9C%A8-PLEG-%E4%B8%AD%E7%9A%84-CPU-%E6%B6%88%E8%80%97"><span class="toc-number">5.7.</span> <span class="toc-text">#3386 减少 Kubelet 在 PLEG 中的 CPU 消耗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc-number">5.8.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-27"><span class="toc-number">6.</span> <span class="toc-text">Kubernetes v1.27</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SeccompDefault-%E8%BE%BE%E5%88%B0-Stable"><span class="toc-number">6.1.</span> <span class="toc-text">SeccompDefault 达到 Stable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-%E8%B0%83%E5%BA%A6%E5%B0%B1%E7%BB%AA%E6%9C%BA%E5%88%B6%E8%BE%BE%E5%88%B0-Beta"><span class="toc-number">6.2.</span> <span class="toc-text">Pod 调度就绪机制达到 Beta</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E-NodeLogQuery-%E7%89%B9%E6%80%A7-KEP-2258"><span class="toc-number">6.3.</span> <span class="toc-text">新增 NodeLogQuery 特性 - KEP-2258</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-CEL-%E7%9A%84-Admission-Control"><span class="toc-number">6.4.</span> <span class="toc-text">基于 CEL 的 Admission Control</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-In-place-%E5%8E%9F%E5%9C%B0%E4%BC%B8%E7%BC%A9%E8%83%BD%E5%8A%9B"><span class="toc-number">6.5.</span> <span class="toc-text">Pod In-place 原地伸缩能力</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%BA%9F%E5%BC%83%E6%8F%90%E9%86%92"><span class="toc-number">6.6.</span> <span class="toc-text">一些废弃提醒</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%86%8D%E6%8F%90%E4%BE%9B%E7%9A%84API%E7%89%88%E6%9C%AC%EF%BC%9A"><span class="toc-number">6.6.1.</span> <span class="toc-text">不再提供的API版本：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%B2%E5%BC%83%E7%94%A8%EF%BC%8C%E5%9C%A8%E4%B8%8B%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83%E4%B9%8B%E5%89%8D%E5%AE%9E%E7%8E%B0%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">6.6.2.</span> <span class="toc-text">已弃用，在下一个版本发布之前实现替代方案：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%B2%E5%88%A0%E9%99%A4"><span class="toc-number">6.6.3.</span> <span class="toc-text">已删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-28"><span class="toc-number">7.</span> <span class="toc-text">Kubernetes v1.28</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-%E9%9B%86%E7%BE%A4%E5%8F%AF%E4%BB%A5%E7%9C%9F%E6%AD%A3%E5%B9%B4%E5%BA%A6%E5%8D%87%E7%BA%A7%E4%BA%86"><span class="toc-number">7.1.</span> <span class="toc-text">Kubernetes 集群可以真正年度升级了</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-CEL-%E7%9A%84-Admission-Control-%E8%BE%BE%E5%88%B0-Beta"><span class="toc-number">7.2.</span> <span class="toc-text">基于 CEL 的 Admission Control 达到 Beta</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRD-%E4%BD%BF%E7%94%A8-CEL-%E8%BF%9B%E8%A1%8C-Validate-%E7%9A%84%E7%89%B9%E6%80%A7%E5%86%8D%E6%AC%A1%E8%BE%BE%E5%88%B0-Beta"><span class="toc-number">7.3.</span> <span class="toc-text">CRD 使用 CEL 进行 Validate 的特性再次达到 Beta</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E4%BC%98%E9%9B%85%E7%9A%84%E8%8A%82%E7%82%B9%E5%85%B3%E9%97%AD%E7%89%B9%E6%80%A7%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">7.4.</span> <span class="toc-text">非优雅的节点关闭特性达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-2"><span class="toc-number">7.5.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-v1-29"><span class="toc-number">8.</span> <span class="toc-text">Kubernetes v1.29</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-2876-%E5%9F%BA%E4%BA%8E-CEL-%E7%9A%84-CRD-%E8%A7%84%E5%88%99%E6%A0%A1%E9%AA%8C%E6%AD%A3%E5%BC%8F%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">8.1.</span> <span class="toc-text">KEP-2876: 基于 CEL 的 CRD 规则校验正式达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-3668-%E4%B8%BA%E5%8A%A8%E6%80%81%E5%92%8C%E9%9D%99%E6%80%81%E5%88%86%E9%85%8D%E9%A2%84%E7%95%99-NodePort-%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4%E8%BE%BE%E5%88%B0-stable"><span class="toc-number">8.2.</span> <span class="toc-text">KEP-3668: 为动态和静态分配预留 NodePort 端口范围达到 stable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-753%EF%BC%9ASidecarContainers-%E7%89%B9%E6%80%A7%E8%BE%BE%E5%88%B0-Beta-%E5%B9%B6%E9%BB%98%E8%AE%A4%E5%90%AF%E7%94%A8"><span class="toc-number">8.3.</span> <span class="toc-text">KEP-753：SidecarContainers 特性达到 Beta 并默认启用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-3960-PreStop-Hook-%E5%BC%95%E5%85%A5-Sleep-%E5%8A%A8%E4%BD%9C%EF%BC%88Alpha%EF%BC%89"><span class="toc-number">8.4.</span> <span class="toc-text">KEP-3960: PreStop Hook 引入 Sleep 动作（Alpha）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-4193%EF%BC%9A%E6%94%B9%E5%96%84-service-account-token-%E7%BB%91%E5%AE%9A%E6%9C%BA%E5%88%B6%EF%BC%88Alpha%EF%BC%89"><span class="toc-number">8.5.</span> <span class="toc-text">KEP-4193：改善 service account token 绑定机制（Alpha）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-727%EF%BC%9AKubelet-Resource-Metrics-%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">8.6.</span> <span class="toc-text">KEP-727：Kubelet Resource Metrics 达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KEP-3466-Kubernetes-Component-Health-SLIs-%E8%BE%BE%E5%88%B0-GA"><span class="toc-number">8.7.</span> <span class="toc-text">KEP-3466: Kubernetes Component Health SLIs 达到 GA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98"><span class="toc-number">8.8.</span> <span class="toc-text">已知问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-3"><span class="toc-number">8.9.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo16.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 TypeScript 创建 Koa 服务器"></a><div class="content"><a class="title" href="/posts/c75c82a0/" title="使用 TypeScript 创建 Koa 服务器">使用 TypeScript 创建 Koa 服务器</a><time datetime="2025-10-11T06:00:11.000Z" title="发表于 2025-10-11 14:00:11">2025-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法"><img src="/img/loading.gif" data-lazy-src="/img/nba-logo24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nodejs应用提取heap并加以分析的一些常用方法"></a><div class="content"><a class="title" href="/posts/c9d8bfa7/" title="Nodejs应用提取heap并加以分析的一些常用方法">Nodejs应用提取heap并加以分析的一些常用方法</a><time datetime="2025-09-28T07:54:43.000Z" title="发表于 2025-09-28 15:54:43">2025-09-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/nba-logo13.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 小五</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.foreverblog.cn/" rel="external nofollow noreferrer" target="_blank"><img src="/img/loading.gif" data-lazy-src="https://img.foreverblog.cn/logo_en_default.png" alt="十年之约" style="width:auto;height:16px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach(((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,i=mermaid.render(a,r),m=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof i?m(i):i.then((({svg:e})=>m(e)))}))})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t=document.querySelectorAll("#article-container .chartjs-container");if(0===t.length)return;const e=(t,a)=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach((r=>{const n=t[r];"object"==typeof n&&null!==n&&(n[a]?t[r]=n[a]:e(n,a))}))},a=()=>{window.loadChartJS=!0,Array.from(t).forEach(((t,a)=>{const r=t.firstElementChild,n=t.getAttribute("data-chartjs-id")||"chartjs-"+a,d=t.getAttribute("data-width"),o=document.getElementById(n);o&&o.parentNode.remove();const c=r.textContent,l=document.createElement("canvas");l.id=n;const s=document.createElement("div");s.className="chartjs-wrap",d&&(s.style.width=d),s.appendChild(l),r.insertAdjacentElement("afterend",s);const h=document.getElementById(n).getContext("2d"),i=JSON.parse(c),m="dark"===document.documentElement.getAttribute("data-theme")?"dark-mode":"light-mode";(t=>{"dark-mode"===t?(Chart.defaults.color="rgba(255, 255, 255, 0.8)",Chart.defaults.borderColor="rgba(255, 255, 255, 0.2)",Chart.defaults.scale.ticks.backdropColor="transparent"):(Chart.defaults.color="rgba(0, 0, 0, 0.8)",Chart.defaults.borderColor="rgba(0, 0, 0, 0.1)",Chart.defaults.scale.ticks.backdropColor="transparent")})(m),e(i,m),new Chart(h,i)}))},r=()=>{window.loadChartJS?a():btf.getScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js").then(a)};btf.addGlobalFn("themeChange",a,"chartjs"),btf.addGlobalFn("encrypt",a,"chartjs"),window.pjax?r():document.addEventListener("DOMContentLoaded",r)})()</script></div><div class="aplayer no-destroy" data-id="9061017364" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="false" muted></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>网站已更新最新版本</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/diytitle.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/metingjs/dist/Meting.min.js"></script><script>btf.addGlobalFn("pjaxSend",(()=>{if(window.aplayers)for(let a=0;a<window.aplayers.length;a++)window.aplayers[a].options.fixed||window.aplayers[a].destroy()}),"destroyAplayer"),btf.addGlobalFn("pjaxComplete",loadMeting,"runMetingJS")</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/talking/"]):not([href="/artitalk/"])',selectors:['link[rel="canonical"]','meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!0,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach((e=>e()))};document.addEventListener("pjax:send",(()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)})),document.addEventListener("pjax:complete",(()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})),e(window.globalFn.pjaxComplete)})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404")}))})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.12.0/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.75.3/dist/instantsearch.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@5.2.2/source/js/search/algolia.min.js"></script></div></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"==location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo25.jpg" alt="/img/nba-logo25.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-02-02</span><a class="blog-slider__title" href="posts/1bcb0ad4/">单环境,多分支并行开发方案(流量染色/istio)</a><div class="blog-slider__text">单环境,多分支并行开发方案(流量染色/istio)</div><a class="blog-slider__button" href="posts/1bcb0ad4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo15.jpg" alt="/img/nba-logo15.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-04-06</span><a class="blog-slider__title" href="posts/2a9d73ff/">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</a><div class="blog-slider__text">教你如何零成本从0到1，开发上线一个对接了openAI的机器人</div><a class="blog-slider__button" href="posts/2a9d73ff/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo3.jpg" alt="/img/nba-logo3.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-06-14</span><a class="blog-slider__title" href="posts/aa43cc95/">记录k8s环境下结合alinode的使用</a><div class="blog-slider__text">记录k8s环境下结合alinode的使用</div><a class="blog-slider__button" href="posts/aa43cc95/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo29.jpg" alt="/img/nba-logo29.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-13</span><a class="blog-slider__title" href="posts/15957791/">k8s环境下,nginx做websocket负载的方案梳理</a><div class="blog-slider__text">k8s环境下,nginx做websocket负载的方案梳理</div><a class="blog-slider__button" href="posts/15957791/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/4ecfb081/">记录一次k8s网络DNS问题排查过程</a><div class="blog-slider__text">记录一次k8s网络DNS问题排查过程</div><a class="blog-slider__button" href="posts/4ecfb081/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo12.jpg" alt="/img/nba-logo12.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2023-09-26</span><a class="blog-slider__title" href="posts/37032a87/">k3s高可用安装</a><div class="blog-slider__text">k3s高可用安装</div><a class="blog-slider__button" href="posts/37032a87/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo17.jpg" alt="/img/nba-logo17.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-11-27</span><a class="blog-slider__title" href="posts/20b19ed4/">分词搜索需求整理</a><div class="blog-slider__text">分词搜索需求整理</div><a class="blog-slider__button" href="posts/20b19ed4/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo9.jpg" alt="/img/nba-logo9.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-12-02</span><a class="blog-slider__title" href="posts/6de14387/">整理wsl2配合开发的一些配置</a><div class="blog-slider__text">整理wsl2配合开发的一些配置</div><a class="blog-slider__button" href="posts/6de14387/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "/img/loading.gif" data-lazy-src="/img/nba-logo30.jpg" alt="/img/nba-logo30.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" href="posts/fb9adcb6/">记录windows11+wsl2环境搭配</a><div class="blog-slider__text">windows11+wsl2开发环境配置</div><a class="blog-slider__button" href="posts/fb9adcb6/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';console.log("已挂载swiper"),parent.insertAdjacentHTML("afterbegin",child)}</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script><style></style><script data-pjax>function history_calendar_injector_config(){var i=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载history_calendar"),i.insertAdjacentHTML("afterbegin",'<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>')}document.getElementsByClassName("sticky_layout")[0]&&"/"===location.pathname&&history_calendar_injector_config()</script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!0},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>